<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç”Ÿæ´»ç´€éŒ„ï½œçœŸå¤ªé™½æ™‚è¨ˆ</title>
<style>
:root{
  --bg:#0f0d14; --card:#17151f; --ink:#eceaf2; --muted:#a9a6b3; --border:#2b2637;
  --accent:#b78ad3; --maxw:980px;
}
*{box-sizing:border-box}
body{margin:0; font-family:ui-sans-serif,system-ui,"Noto Sans TC","Microsoft JhengHei"; color:var(--ink); background:linear-gradient(160deg,#13111a,#191627)}
.wrap{max-width:var(--maxw); margin:0 auto; padding:18px 14px}
.badge{display:inline-flex; align-items:center; gap:6px; font-size:.82rem; padding:4px 10px; border:1px solid var(--border); border-radius:999px; background:#1f1a2b}
.badge.dim{opacity:.7}
.btn{display:inline-flex; align-items:center; gap:8px; background:var(--accent); color:#120d18; border:none; border-radius:12px; padding:12px 14px; cursor:pointer; font-weight:700}
.btn.ghost{background:transparent; color:#fff; border:1px solid var(--border)}
.card{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.35); padding:14px}
.hint{color:var(--muted)}
.input,textarea{width:100%; background:#1e1a28; color:#fff; border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-size:1rem}
textarea{min-height:160px; line-height:1.6; resize:vertical}
.k{color:var(--muted); font-weight:600; margin:8px 0 4px}

/* ====== åˆ—è¡¨ View ====== */
#view-list .top{display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:space-between}
.clock{flex:1 1 500px; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
.time{font-size:clamp(36px,9vw,64px); font-weight:800; letter-spacing:.02em}
.sub{margin-top:6px; color:var(--muted); font-size:.98rem; display:flex; gap:10px; flex-wrap:wrap}
.grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px}
.title {
  display: flex;
  flex-direction: column;
  align-items: center; /* æ¨™é¡Œé‚„æ˜¯ç½®ä¸­ */
  text-align: center;
}

.title-text {
  font-size: 1.1rem;
  font-weight: 700;
  margin-bottom: 4px; /* æ¨™é¡Œå’Œæ™‚é–“çš„è·é›¢ */
}

.time-row {
  align-self: flex-start; /* æ™‚é–“é å·¦ */
  font-size: 0.9rem;
  color: #aaa; /* ç°ä¸€é»ï¼Œè¦–è¦ºå±¤ç´šä½ */
  margin-bottom: 8px; /* å’Œå¹²æ”¯å¾½ç« æ‹‰é–‹è·é›¢ */
}
/* æ¨™é¡Œå€æ”¹æˆç›´å‘æ’ç‰ˆã€å¯¬åº¦æ’æ»¿å¡ç‰‡ */
.title.stack{
  display:flex;
  flex-direction:column;
  align-items:center;   /* æ¨™é¡Œä»ç½®ä¸­ */
  gap:4px;
  width:100%;           /* è®“æ™‚é–“çš„é å·¦èƒ½è²¼é½Šå¡ç‰‡å·¦ç·£ */
  margin-bottom:12px;   /* èˆ‡ä¸‹æ–¹å¹²æ”¯æ‹‰é–‹è·é›¢ */
}

.title.stack .title-text{
  text-align:center;
}

/* æ™‚é–“é€™é¡†è—¥ä¸¸ï¼šåœ¨å®¹å™¨å…§é å·¦ */
.time-badge{
  align-self:flex-start; /* é—œéµï¼šé å·¦ */
  margin-top:2px;
  margin-bottom:6px;     /* èˆ‡å¹²æ”¯å†æ‹‰ä¸€é»è·é›¢ */
}
.meta{color:var(--muted); font-size:.86rem; display:flex; gap:8px; flex-wrap:wrap}
.tools{display:flex; gap:8px; margin-top:8px}
.tool{background:transparent; border:1px solid var(--border); color:#fff; border-radius:10px; padding:6px 10px; cursor:pointer}
pre{white-space:pre-wrap; word-break:break-word; margin:8px 0 0}
.empty{text-align:center; color:var(--muted); padding:26px 10px}
.thumb{width:100%; aspect-ratio:16/9; object-fit:cover; border-radius:10px; border:1px solid var(--border); margin-top:6px}

/* æ–°å¢ modal */
.modal{position:fixed; inset:0; display:none; place-items:center; z-index:1000; background:rgba(0,0,0,.45); backdrop-filter:blur(2px)}
.modal.show{display:grid}
.modal-box{width:min(92vw,800px); background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px}
.bar{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
.row{display:flex; gap:10px; flex-wrap:wrap}
.preview-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(90px,1fr)); gap:8px}
.preview-grid img{width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:10px; border:1px solid var(--border)}

/* ====== è©³æƒ… Viewï¼ˆå–®é ï¼‰ ====== */
.detail-head{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
.detail-title{font-size:1.2rem; font-weight:800; margin:0 0 6px}
.detail-meta{color:var(--muted); display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px}
/* === è©³æƒ…é åœ–ç‰‡æ ¼ï¼šä¸‰å€‹ä¸€æ’ã€è¶…éè‡ªå‹•æ›è¡Œã€å›ºå®šå°ºå¯¸ === */
#view-detail #dGallery{
  display: grid;
  grid-template-columns: repeat(3, 0fr); /* æ°¸é ä¸‰æ¬„ */
  gap: 8px;                               /* åœ–ç‰‡é–“è· */
  align-items: start;
}

/* åœ–ç‰‡ï¼šæ–¹å½¢ã€ç­‰é«˜ç­‰å¯¬ã€å¡«æ»¿è£åˆ‡ï¼ˆè¦å®Œæ•´å¡é€²å»å°±æŠŠ cover æ”¹æˆ containï¼‰ */
#view-detail #dGallery img{
  width: auto;
  height: 64px;          /* å›ºå®šé«˜åº¦ï¼Œä½ æƒ³æ”¾å¤§å°±èª¿æ•´é€™æ•¸å€¼ */
  object-fit: contain;      /* å¡«æ»¿è£åˆ‡ï¼Œæƒ³å®Œæ•´é¡¯ç¤ºæ”¹æˆ contain */
  border-radius: 10px;
  display: block;
  background: transparent;
  border: none;
}
/* é‡æ–°å®šç¾©åœ–ç‰‡å€ï¼šä¸æ¡†ã€ä¸åº•è‰²ã€ç…§åŸåœ–å¤§å°é¡¯ç¤ºï¼ˆä½†ä¸è¶…éç‰ˆé¢å¯¬åº¦ï¼‰ */
.gallery{display:block; margin-top:8px}
/* åˆ—è¡¨å¡ç‰‡å…§åœ–ç‰‡ï¼ˆç¸®ç•¥åœ–ï¼‰ */
/* ç¸®åœ–å€ï¼šä¸€æ’æ’æ’ã€å¯æ›è¡Œ â”€ ç‚ºäº†è®“é»åœ¨åœ–ã€Œå¤–é¢ã€ä¸æ“ åˆ°æŒ‰éˆ•ï¼Œå¢Šä¸€é»åº•éƒ¨ */
.card .gallery{
  position:relative;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-start;
  padding-bottom:18px;         /* çµ¦ä¸‹æ–¹é»èˆ‡è™›ç·šç•™ç©ºé–“ */
}

/* å–®ä¸€ç¸®åœ–å¤–å±¤ï¼šç•¶å®šä½å®¹å™¨ï¼Œä¹Ÿç•™å‡ºä¸‹é¢çš„ç©ºé–“ */
.thumb-wrap{
  position:relative;
  display:inline-block;
  line-height:0;
  margin-bottom:18px;          /* è®“ä¸‹é¢çš„é»ä¸å£“åˆ°å¾Œé¢çš„å…§å®¹ */
}

/* ç¸®åœ–æœ¬èº«ï¼ˆä¿æŒä½ çš„å°ºå¯¸é™åˆ¶ï¼‰ */
.card .gallery img{
  display:block;
  width:auto; height:auto;
  max-width:120px;
  max-height:90px;
  object-fit:contain;
  border:none; background:transparent; border-radius:6px;
  margin:0;
}

/* â€”â€” é»ï¼šåœ¨ç¸®åœ–ã€Œå¤–é¢ã€çš„ä¸‹æ–¹æ­£ä¸­å¤® â€”â€” */
.thumb-wrap::before{
  content:"";
  position:absolute;
  left:50%;
  top:calc(100% + 6px);        /* 100% = ç¸®åœ–åº•éƒ¨ï¼Œå†å¾€ä¸‹ 6px */
  transform:translateX(-50%);
  width:8px; height:8px;
  border-radius:50%;
  background:var(--accent);
  box-shadow:0 0 10px var(--accent);
  pointer-events:none;
  z-index:2;
}

/* â€”â€” åˆ°ä¸‹ä¸€å€‹é»çš„è™›ç·šï¼ˆæœ€å¾Œä¸€å¼µä¸ç•«ï¼‰ â€”â€” */
.thumb-wrap:not(:last-child)::after{
  content:"";
  position:absolute;
  left:50%;
  top:calc(100% + 10px);       /* èˆ‡ä¸Šé¢é‚£é¡†é»åŒä¸€æ¢æ°´å¹³ç·š */
  transform:translateX(0);
  width:var(--linkw, 0px);     /* JS æœƒå¡å…¥å¯¦éš›è·é›¢ï¼›é è¨­ 0 é¿å…äº‚ç·š */
  border-top:2px dashed var(--accent);
  opacity:.95;
  pointer-events:none;
  z-index:1;
}
</style>
<style>
   /* å›ºå®šå°ºå¯¸åˆ—è¡¨å¡ç‰‡ */
/* --- å›ºå®šåˆ—è¡¨å¡ç‰‡åº•éƒ¨å·¥å…·åˆ— --- */
.card.list-card{
  position: relative;
  height: 290px;               /* ä½ çš„æ—¢æœ‰é«˜åº¦ï¼Œå¯è‡ªè¡Œèª¿æ•´ */
  padding-bottom: 56px;        /* â†“ é ç•™å·¥å…·åˆ—é«˜åº¦ + é–“è·ï¼ˆå¯ä¾å¯¦éš›èª¿æ•´ï¼‰ */
  overflow: hidden;            /* è¶…å‡ºçš„å…§å®¹ç›´æ¥è£æ‰ï¼Œä¸æœƒå£“åˆ°æŒ‰éˆ• */
}

/* å·¥å…·åˆ—å›ºå®šåœ¨å¡ç‰‡åº•éƒ¨ï¼Œæ°¸é å¯è¦‹ */
.tools.stick{
  position: absolute;
  left: 14px;                  /* èˆ‡å¡ç‰‡å…§è·ä¸€è‡´ */
  right: 14px;
  bottom: 12px;                /* èˆ‡å¡ç‰‡å…§è·ä¸€è‡´ */
  margin-top: 0;               /* å–æ¶ˆä¹‹å‰ç”¨ä¾†æ¨åº•çš„ margin */
  padding-top: 0;
  display: flex;
  gap: 8px;
}

/* ä¸­æ®µå…§å®¹ä¸è¦æ’é«˜å¡ç‰‡ */
.content-block{
  overflow: hidden;            /* è¶…å‡ºå¡ç‰‡å¯è¦–ç¯„åœçš„å…§å®¹è£æ‰ */
}

/* æ¨™é¡Œåˆ—æ²¿ç”¨ä½ åŸæœ¬çš„ .title æ¨£å¼å³å¯ */

/* ä¸­æ®µï¼šå…©è¡Œæ‘˜è¦ + å³å´å°åœ– */
.content-row{
  display:flex; gap:10px; align-items:flex-start;
  flex:1 1 auto;               /* æŠŠä¸­æ®µæ’é–‹ï¼Œè®“å·¥å…·åˆ—èƒ½è²¼åº• */
  margin-top:6px;
}
.excerpt {
  flex: 1 1 auto;
  min-width: 0;
  white-space: pre-wrap; /* ä¿ç•™æ›è¡Œ */
  line-height: 1.5;
  color: var(--ink);

  /* é‡å° WebKitï¼ˆChromeã€Safariã€Edgeï¼‰ */
    display: -webkit-box; /* ç”¨ WebKit çš„ç›’å­æ¨¡å‹ */
  display: box; /* æ¨™æº–åŒ–çš„å ä½å±¬æ€§ï¼Œè®“ç·¨è¼¯å™¨ä¸å ±éŒ¯ */
  -webkit-box-orient: vertical; /* ç§æœ‰å±¬æ€§ */
  box-orient: vertical; /* æ¨™æº–åŒ–çš„å ä½å±¬æ€§ */
  
  overflow: hidden;
  /* VS Code å°é€™å€‹æœƒè­¦å‘Šï¼ŒåŠ å€‹æ¨™æº–å±¬æ€§ä¸¦åˆ—å°±å¥½äº† */
  line-clamp: 2; /* æ¨™æº–å ä½ï¼Œéƒ¨åˆ†ç€è¦½å™¨å¿½ç•¥ */
  -webkit-line-clamp: 2; /* çœŸæ­£èµ·ä½œç”¨çš„ */

  /* é‡å° Firefox / å…¶ä»–ä¸æ”¯æ´ line-clamp çš„ç€è¦½å™¨ */
  overflow: hidden;
  text-overflow: ellipsis;
  max-height: calc(1.5em * 2); /* è¡Œé«˜ Ã— å…©è¡Œ */
}
.thumb-small{
  width:72px; height:72px;      /* å°ç¸®åœ–å°ºå¯¸ */
  object-fit:cover;
  border-radius:8px; border:1px solid var(--border);
  flex:0 0 auto;
}
/* åˆ—è¡¨å¡ç‰‡ç¸®ç•¥åœ–ï¼šå›ºå®šå°ºå¯¸ */
/* ç¸®åœ–åˆ—å¤–å±¤ï¼Œå›ºå®šé«˜åº¦ */
.thumb-bar{
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  height: 80px;          /* â† ä½ æƒ³è¦çš„ç¸®åœ–å€é«˜åº¦ï¼Œä¿æŒä¸è®Š */
  align-items: center;   /* è®“ç¸®åœ–åœ¨é€™å€‹é«˜åº¦è£¡å‚ç›´ç½®ä¸­ */
  overflow: hidden;      /* è¶…éå°±éš±è—ï¼Œä¸æœƒæ’é«˜ */
}

.twrap{                 /* ä½ å·²ç¶“æœ‰ twrapï¼Œé€™è£¡ä¿éšªå†æ”¾ä¸€æ¬¡æ²’é—œä¿‚ */
  position:relative;
  display:inline-block;
  line-height:0;
}

/* çœŸçš„æ§åˆ¶ç¸®ç•¥åœ–å¤§å°çš„æ˜¯é€™å€‹ */
.thumb-mini{
  width: 70px;           /* æƒ³è¦å¤šå¤§æ”¹é€™è£¡ï¼ˆä¾‹å¦‚ 72ã€96ã€120ï¼‰ */
  height:70px;
  object-fit: cover;    /* ä¿æŒæ¯”ä¾‹å®Œæ•´é¡¯ç¤ºï¼Œå¯èƒ½ç•™ç™½ */
  background: transparent;/* å¯çœç•¥ï¼Œåƒ…ä¿æŒè¦–è¦ºä¹¾æ·¨ */   /* å¡«æ»¿è£åˆ‡ï¼›æƒ³å®Œæ•´å¡é€²å»æ”¹æˆ contain */
  border-radius:8px;
  flex:0 0 auto;
}
/* è§’æ¨™ï¼šé‚„æœ‰å¹¾å¼µæœªé¡¯ç¤º */
.thumb-more{
  position:absolute;
  right:4px;
  bottom:4px;
  padding:2px 6px;
  font-size:.78rem;
  line-height:1;
  color:#fff;
  background:rgba(0,0,0,.55);
  border:1px solid var(--border);
  border-radius:999px;
  pointer-events:none;
}
/* åº•éƒ¨ä¸‰å€‹æŒ‰éˆ•å›ºå®šåœ¨å¡ç‰‡åº•éƒ¨ */
.tools.stick{
  margin-top:auto;              /* æŠŠå·¥å…·åˆ—æ¨åˆ°æœ€åº• */
  padding-top:8px;
}
</style>
<!--============================-->
<style>
    /* æ¨™é¡Œæ©«æ’ */
.heading{
  display:flex;
  align-items:center;
  gap:10px;
  margin:16px 0 8px;
}
.heading-title{ margin:0; }

/* è¨˜éŒ„æŒ‡ç¤ºå™¨ï¼šé»â€”ç·šâ€”é»â€¦ */
.record-timeline{
  display:inline-flex;
  align-items:center;
  gap:8px;                 /* é»èˆ‡ç·šä¹‹é–“çš„é–“è· */
}

/* é» */
.record-timeline .dot{
  width:8px; height:8px; border-radius:50%;
  background:var(--accent);
  box-shadow:0 0 8px var(--accent);
  flex:0 0 auto;
}

/* è™›ç·šæ®µï¼šä½¿ç”¨é‡è¤‡ç·šæ€§æ¼¸å±¤åšå‡ºã€Œè™›ç·šã€ */
.record-timeline .seg{
  height:2px; width:34px;               /* æƒ³æ›´é•·/æ›´çŸ­æ”¹é€™è£¡ */
  background:
    repeating-linear-gradient(
      to right,
      var(--accent) 0 6px,
      transparent 6px 12px
    );
  opacity:.65;
  filter:drop-shadow(0 0 0 var(--accent));
  animation: timelinePulse 1.6s ease-in-out infinite;
  flex:0 0 auto;
}

/* ä¸€ä¸‹æš—ä¸€ä¸‹äº® */
@keyframes timelinePulse{
  0%,100% { opacity:.45; filter:drop-shadow(0 0 0 var(--accent)); }
  50%     { opacity:1;   filter:drop-shadow(0 0 6px var(--accent)); }
}
/* é›²ç«¯åˆ†äº«æŒ‡ç¤ºé»ï¼ˆæ©™è‰²æœƒé–ƒï¼‰ */

/* è®“æ‰€æœ‰å¡ç‰‡å¯æ”¾å³ä¸Šè§’å¾½æ¨™ */
.card{ position: relative; }

/* æ©™è‰²æœƒé–ƒçš„å°é»ï¼ˆé¡¯ç¤ºæ–¼å¡ç‰‡å³ä¸Šè§’ï¼‰ */
.flag-dot{
  position:absolute;
  top:8px; right:8px;           /* å¯ä¾å–œå¥½å¾®èª¿ */
  width:10px; height:10px;
  border-radius:50%;
  background:#ff9b2f;
  box-shadow:0 0 10px rgba(255,155,47,.9);
  animation: flagBlink 1.3s ease-in-out infinite;
  z-index: 10;
}
/* æ©™é»æ—çš„åˆ†äº«æ¬¡æ•¸ */
.flag-count{
  position:absolute;
  top:6px; right:22px;          /* å°±åœ¨æ©™é»å³é‚Š */
  min-width:16px;
  height:16px;
  border-radius:999px;
  padding:0 5px;
  font-size:11px;
  line-height:16px;
  color:#120d18;
  background:#ffd28a;           /* æ©™é»çš„è¦ªæˆšè‰² */
  border:1px solid rgba(0,0,0,.25);
  text-align:center;
  z-index:10;
  font-weight:700;
}
@keyframes flagBlink{
  0%,100%{ opacity:.45; filter:drop-shadow(0 0 0 #ff9b2f); }
  50%    { opacity:1;   filter:drop-shadow(0 0 6px #ff9b2f); }
}

/* è®“å®¹å™¨èƒ½æ”¾å®šä½å…ƒç´ ï¼ˆç¸®åœ–èˆ‡è©³æƒ…åœ–çš„å¤–å±¤ï¼‰ */
.twrap, .picwrap{ position:relative; display:inline-block; }

/* === å…¨åŸŸï¼šå­—ç´šã€å¤–è·åœ¨å„è£ç½®ä¹‹é–“è‡ªé©æ‡‰ === */
:root{
  --page-pad: clamp(12px, 3vw, 24px);
}
.wrap{
  padding-left: var(--page-pad);
  padding-right: var(--page-pad);
}
.time{
  font-size: clamp(28px, 6vw, 52px); /* ä¿ç•™åŸæœ¬çš„ç¸®æ”¾æ„Ÿ */
}

/* è®“åœ–ç‰‡ã€å½±ç‰‡ã€è¡¨æ ¼ä¸çˆ†ç‰ˆ */
img, video{
  max-width:100%;
  height:auto;
}

/* è¡Œå‹•å„ªå…ˆï¼šæ™‚é–“ç·šå°å¡å¯¬åº¦ã€ç¸®åœ–ã€æŒ‰éˆ•è§¸æ§å¤§å° */
.titem{
  width: clamp(220px, 70vw, 300px);
}
.tcard{
  min-height: 240px; /* åŸæœ¬çš„å€¼ï¼Œè¡Œå‹•è£ç½®ä¹Ÿ ok */
}
.tcard .gallery img{
  width:72px;
  height:72px;
  object-fit:cover;
  border-radius:6px;
}
.btn{
  padding: 10px 14px;
}
.badge{
  padding: 6px 10px;
}

/* æ©«å‘æ»‘å‹•æ…£æ€§ + å°é½Š */
.trow{
  -webkit-overflow-scrolling: touch;
  scroll-snap-type: x mandatory;
}
.titem{
  scroll-snap-align: start;
}

/* === ä¸­å‹ä»¥ä¸Šè¢å¹•ï¼ˆå¹³æ¿æ©«å‘/å°ç­†é›»ï¼‰â‰¥ 768px === */
@media (min-width: 768px){
  .top{
    align-items: center;
  }

  .titem{
    width: 320px;
  }
  .tcard{
    min-height: 260px;
  }
  .tcard .gallery img{
    width:84px;
    height:84px;
  }

  .search-input{
    flex: 2 1 420px;
  }
}

/* === æ¡Œé¢å¤§è¢å¹• â‰¥ 1024px === */
@media (min-width: 1024px){
  :root{
    --page-pad: 24px;
  }

  .titem{
    width: 360px;
  }
  .tcard{
    min-height: 280px;
  }
  .tcard .gallery img{
    width:96px;
    height:96px;
  }

  .group{
    padding: 18px;
  }
}
.A{
  text-decoration: none;
  color: #eceaf2;
}
</style>
</head>
<body>

<!-- ============ Viewï¼šåˆ—è¡¨ ============ -->
<main id="view-list">
  <div class="wrap">
    <div class="top">
      <div class="clock">
        <div id="time" class="time">--:--:--</div>
        <div class="sub">
          <span id="dateBadge" class="badge">â€”</span>
          <span id="ganzhiBadge" class="badge">æ—¥ï¼šâ€”ã€€æ™‚ï¼šâ€”</span>
          <span id="locBadge" class="badge dim">å®šä½ä¸­â€¦</span>
          <span id="precBadge" class="badge dim">â€”</span>
        </div>
      </div>
      <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-start">
        <button id="openRec" class="btn">ğŸ  ç´€éŒ„</button>
        <button id="goCloud" class="btn ghost">â˜ï¸ å» LimCloud</button>
        <button id="goCloud" class="btn ghost"><a href="help.html" class="A">ğŸ¾è¿”å›</a></button>
      </div>
    </div>

    <!-- æ¨™é¡Œ + è¨˜éŒ„æŒ‡ç¤ºå™¨ -->
  <div class="heading">
  <h3 class="heading-title">æˆ‘çš„ç´€éŒ„</h3>
  <div id="recTimeline" class="record-timeline" aria-label="è¨˜éŒ„æ•¸æŒ‡ç¤º"></div>
</div>
    <div id="list" class="grid"></div>
    <div id="empty" class="card empty" style="display:none">é‚„æ²’æœ‰ä»»ä½•ç´€éŒ„ï¼ŒæŒ‰å³ä¸Šçš„ã€ŒğŸ  ç´€éŒ„ã€é–‹å§‹å§ï¼</div>
    <div class="hint">èªªæ˜ï¼šè¨˜éŒ„æœƒé›™é‡å‚™ä»½</div>
  </div>
</main>

<!-- ============ Viewï¼šè©³æƒ…ï¼ˆå–®é ï¼‰ ============ -->
<main id="view-detail">
  <div class="wrap">
    <div class="detail-head">
      <button id="backBtn" class="btn ghost">â† è¿”å›</button>
      <div style="display:flex; gap:8px">
        <button id="btnShare" class="btn">åˆ†äº«è‡³ LimCloud</button>
        <button id="btnDelete" class="btn ghost">åˆªé™¤æ­¤ç´€éŒ„</button>
      </div>
    </div>

    <article class="card">
      <h1 id="dTitle" class="detail-title">â€”</h1>
      <div id="dMeta" class="detail-meta"></div>
      <pre id="dContent"></pre>
      <div id="dGallery" class="gallery"></div>
      <div class="hint" style="margin-top:12px">æç¤ºï¼šé»åœ–ç‰‡å¯åœ¨æ–°åˆ†é é–‹å•ŸåŸåœ–ã€‚</div>
    </article>
  </div>
</main>

<!-- ============ æ–°å¢ç´€éŒ„ Modal ============ -->
<div id="modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="bar">
      <h3 style="margin:0">æ–°å¢ç´€éŒ„</h3>
      <button id="close" class="btn ghost">é—œé–‰</button>
    </div>
    <div class="k">æ¨™é¡Œï¼ˆå¯ç•™ç©ºï¼‰</div>
    <input id="title" class="input" placeholder="ä»Šå¤©æƒ³è¨˜ä¸‹ä»€éº¼ï¼Ÿ" autocomplete="off">
    <div class="k">å…§å®¹ï¼ˆå¿…å¡«ï¼‰</div>
    <textarea id="content" placeholder="å¯«é»æ–‡å­—æ‰å¯ä»¥å„²å­˜å–”ï½" autocomplete="off"></textarea>
    <div class="k">åœ–ç‰‡ï¼ˆå¯å¤šé¸ï¼Œæœ€å¤š 6 å¼µï¼Œæ¯å¼µ â‰¤ 2MBï¼‰</div>
    <input id="photos" type="file" accept="image/*" multiple>
    <div id="photosPreview" class="preview-grid"></div>
    <div class="k">å°‡æœƒå„²å­˜çš„æ™‚é–“æ¨™è¨˜</div>
    <div id="stamp" class="badge dim">â€”</div>
    <div style="display:flex; gap:8px; margin-top:12px">
      <button id="save" class="btn">å„²å­˜</button>
      <button id="clearForm" class="btn ghost">æ¸…ç©º</button>
    </div>
  </div>
</div>

<!-- ============ ç™»å…¥ / è¨»å†Šï¼ˆèˆ‡ä½ å…ˆå‰ä¸€è‡´ï¼‰ ============ -->
<div id="loginModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="bar"><h3 style="margin:0">ç™»å…¥</h3><button id="loginClose" class="btn ghost">é—œé–‰</button></div>
    <div class="row">
      <input id="loginEmail" class="input" type="email" inputmode="email" placeholder="é›»å­éƒµç®±ï¼ˆå¿…å¡«ï¼‰" autocomplete="email">
      <input id="loginPass" class="input" type="password" placeholder="å¯†ç¢¼ï¼ˆå¿…å¡«ï¼‰" autocomplete="current-password">
    </div>
    <div style="display:flex; justify-content:flex-end; margin-top:8px">  <button id="gotoSignup" class="btn ghost">è¨»å†Š</button>
        <button id="loginDo" class="btn">ç™»å…¥</button></div>
    <div id="loginMsg" class="hint"></div>
  </div>
</div>
<div id="signupModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="bar"><h3 style="margin:0">å»ºç«‹å¸³è™Ÿ</h3><button id="signupClose" class="btn ghost">é—œé–‰</button></div>
    <div class="row">
      <input id="signupEmail" class="input" type="email" placeholder="é›»å­éƒµç®±ï¼ˆå¿…å¡«ï¼‰" autocomplete="email">
      <input id="signupPass" class="input" type="password" placeholder="å¯†ç¢¼ï¼ˆè‡³å°‘ 6 ä½è‹±æ•¸ï¼‰" autocomplete="new-password">
      <input id="signupNick" class="input" placeholder="æš±ç¨±ï¼ˆå¿…å¡«ï¼Œ1â€“30å­—ï¼‰" maxlength="30">
      <div class="k">é ­è²¼ï¼ˆå¯é¸ï¼‰</div>
      <label for="signupAvatarInput" style="display:inline-block; cursor:pointer; border:1px solid var(--border); border-radius:12px; padding:8px; background:#1f1a2b">
        <img id="signupAvatarPreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cg fill='%23b78ad3'%3E%3Ccircle cx='60' cy='46' r='22'/%3E%3Cpath d='M16 108a44 44 0 0 1 88 0z'/%3E%3C/g%3E%3C/svg%3E" alt="é ­è²¼é è¦½" style="width:96px;height:96px;border-radius:50%;object-fit:cover;display:block">
      </label>
      <input id="signupAvatarInput" type="file" accept="image/*" style="display:none">
      <div class="hint">æ”¯æ´ jpg / png / gifï¼Œå»ºè­° &lt; 2MBã€‚</div>
    </div>
    <div style="display:flex; justify-content:flex-end; margin-top:8px"><button id="signupDo" class="btn">è¨»å†Š</button></div>
    <div id="signupMsg" class="hint"></div>
  </div>
</div>
<script>
  function linkDots(){
    document.querySelectorAll('.trow').forEach(row=>{
      const items = Array.from(row.children);
      for (let i=0; i<items.length; i++){
        const curTail  = items[i]?.querySelector('.ts .ts-dot.tail');
        if (!curTail) continue;

        if (i === items.length - 1){
          curTail.style.removeProperty('--linkw'); // æœ€å¾Œä¸€å¼µä¸è¦ç·š
          continue;
        }
        const nextHead = items[i+1]?.querySelector('.ts .ts-dot.head');
        if (!nextHead) continue;

        const a = curTail.getBoundingClientRect();
        const b = nextHead.getBoundingClientRect();
        const w = Math.max(0, b.left - a.right);   // å°¾é»å³ç·£ â†’ ä¸‹ä¸€å¼µé ­é»å·¦ç·£
        curTail.style.setProperty('--linkw', w + 'px');
      }
    });
  }

  // æä¾›ç›¸å®¹èˆŠå
  window.linkThumbs = window.linkThumbs || linkDots;

  // åˆæ¬¡èˆ‡ç¸®æ”¾æ™‚é‡ç®—
  document.addEventListener('DOMContentLoaded', linkDots);
  window.addEventListener('resize', linkDots);
</script>
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4/dist/av-min.js"></script>
<script>
/* ========= LeanCloud ========= */
const LC = { APP_ID:'0juO0jzBkrv1Oi04bHljaWDW-gzGzoHsz', APP_KEY:'kFMz8niEbd8BlPbFKDyTZC2Q', SERVER:'https://0juo0jzb.lc-cn-n1-shared.com' };
AV.init({ appId:LC.APP_ID, appKey:LC.APP_KEY, serverURL:LC.SERVER });
// ä¾ Cloud.html å­˜çš„ Session Token è‡ªå‹•ç™»å…¥
(async function tryAutoLoginFromToken(){
  try{
    if (AV.User.current()) return;
    const token = localStorage.getItem('LC_SESSION_TOKEN');
    if (!token) return;
    await AV.User.become(token);            // â˜… ç”¨ token è®Šæˆç™»å…¥ç‹€æ…‹
    console.info('[Auth] become by token ok');
    await fetchShareCounts();
  }catch(err){
    console.warn('[Auth] auto login failed:', err);
    localStorage.removeItem('LC_SESSION_TOKEN'); // éæœŸå°±æ¸…æ‰ï¼Œé¿å…å¡ä½
  }
})();
/* ========= å¤ªé™½æ™‚è¨ˆ / å¹²æ”¯ ========= */
function dayOfYear(d){const s=new Date(d.getFullYear(),0,1);return Math.floor((d-s)/86400000)+1}
function equationOfTime(date){const n=dayOfYear(date),B=2*Math.PI*(n-81)/364;return 9.87*Math.sin(2*B)-7.53*Math.cos(B)-1.5*Math.sin(B)}
function tzCenterMeridian(){const offMin=-new Date().getTimezoneOffset();return 15*(offMin/60)}
function calcTrueSolar(now,lon,has){const LSTM=tzCenterMeridian(),eot=equationOfTime(now);const off=eot+4*(lon-LSTM);const s=new Date(now.getTime()+off*60*1000);const hh=String(s.getHours()).padStart(2,'0'),mm=String(s.getMinutes()).padStart(2,'0'),ss=String(s.getSeconds()).padStart(2,'0');return{solar:s,text:`${hh}:${mm}:${ss}`,approx:!has}}
const stems=["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"], branch=["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];
function toJDN(y,m,d){if(m<=2){y--;m+=12}const A=Math.floor(y/100),B=2-A+Math.floor(A/4);return Math.floor(365.25*(y+4716))+Math.floor(30.6001*(m+1))+d+B-1524}
function ganzhiIndexFromJDN(jdn){return(jdn+49)%60}
function hourBranchIndex(h){let H=Math.floor(h);if(H===23)H=-1;return Math.floor((H+1)/2)}
function hourStemIndex(d,h){const start=[0,2,4,6,8][d%5];return(start+h)%10}
function getGanzhiForTrueSolar(solar, hours){const y=solar.getFullYear(),m=solar.getMonth()+1,d=solar.getDate();const add=(hours>=23)?1:0;const jdn=toJDN(y,m,d)+add;const dayIdx=ganzhiIndexFromJDN(jdn);const dayGan=stems[dayIdx%10],dayZhi=branch[dayIdx%12];const hb=hourBranchIndex(hours);const hourGan=stems[hourStemIndex(dayIdx%10,hb)],hourZhi=branch[hb];return{day:dayGan+dayZhi,hour:hourGan+hourZhi}}

/* ========= ç‹€æ…‹ & DOM ========= */
let state={hasGeo:false,lon:0,lat:0};
const viewList=document.getElementById('view-list');
const viewDetail=document.getElementById('view-detail');
const backBtn=document.getElementById('backBtn');
const dTitle=document.getElementById('dTitle');
const dMeta=document.getElementById('dMeta');
const dContent=document.getElementById('dContent');
const dGallery=document.getElementById('dGallery');
const btnShare=document.getElementById('btnShare');
const btnDelete=document.getElementById('btnDelete');

const timeEl=document.getElementById('time'), dateBadge=document.getElementById('dateBadge'), gzBadge=document.getElementById('ganzhiBadge'), locBadge=document.getElementById('locBadge'), precBadge=document.getElementById('precBadge'), stampEl=document.getElementById('stamp');
const openBtn=document.getElementById('openRec'), modal=document.getElementById('modal'), closeBtn=document.getElementById('close'), saveBtn=document.getElementById('save'), clearFormBtn=document.getElementById('clearForm'), titleEl=document.getElementById('title'), contentEl=document.getElementById('content'), photosInput=document.getElementById('photos'), photosPreview=document.getElementById('photosPreview');
const listEl=document.getElementById('list'), emptyEl=document.getElementById('empty');

/* ========= å®šä½ & æ™‚é˜ ========= */
function initGeo(){ if(!navigator.geolocation){locBadge.textContent='ç„¡æ³•ä½¿ç”¨å®šä½ï¼ˆä»¥æ™‚å€ä¼°ç®—ï¼‰'; return;}
 navigator.geolocation.getCurrentPosition(
  p=>{state.hasGeo=true; state.lat=p.coords.latitude; state.lon=p.coords.longitude; locBadge.textContent=`ğŸ“ ${state.lat.toFixed(4)}, ${state.lon.toFixed(4)}`},
  _=>{locBadge.textContent='æœªæˆæ¬Šå®šä½ï¼ˆä»¥æ™‚å€ä¼°ç®—ï¼‰'},
  {enableHighAccuracy:false, maximumAge:3600_000, timeout:8000}
 )}
function tick(){const now=new Date(); const lon=state.hasGeo?state.lon:tzCenterMeridian(); const ts=calcTrueSolar(now,lon,state.hasGeo);
 timeEl && (timeEl.textContent=ts.text+(ts.approx?" â‰ˆ":"")); precBadge && (precBadge.textContent=ts.approx?"ç²¾åº¦ï¼šä¼°ç®—ï¼ˆç„¡å®šä½ï¼‰":"ç²¾åº¦ï¼šä¾å®šä½è¨ˆç®—");
 const dstr=now.toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'short'}); dateBadge && (dateBadge.textContent=dstr+'ï½œçœŸå¤ªé™½æ™‚');
 const h=ts.solar.getHours()+ts.solar.getMinutes()/60+ts.solar.getSeconds()/3600; const {day, hour}=getGanzhiForTrueSolar(ts.solar,h); gzBadge && (gzBadge.textContent=`æ—¥ï¼š${day}ã€€æ™‚ï¼š${hour}`);
 stampEl && (stampEl.textContent=`${dstr}ï½œ${ts.text}${ts.approx?' â‰ˆ':''}ï½œæ—¥${day} æ™‚${hour}`) }
setInterval(tick,1000);

/* ========= æ–°å¢ç´€éŒ„ modal ========= */
function openModal(){ modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; titleEl.value=''; contentEl.value=''; photosInput.value=''; photosPreview.innerHTML=''; contentEl.focus(); }
function closeModal(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
openBtn.addEventListener('click', openModal); closeBtn.addEventListener('click', closeModal);
modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });
window.addEventListener('keydown', e=>{ if(e.key==='Escape' && modal.classList.contains('show')) closeModal(); });
clearFormBtn.addEventListener('click', ()=>{ titleEl.value=''; contentEl.value=''; photosInput.value=''; photosPreview.innerHTML=''; contentEl.focus(); });

/* åœ–ç‰‡é è¦½ */
const MAX_FILES=6, MAX_SIZE=2*1024*1024;
photosInput.addEventListener('change', ()=>{
  photosPreview.innerHTML='';
  const files=Array.from(photosInput.files||[]).slice(0,MAX_FILES);
  files.forEach(f=>{
    if(f.size>MAX_SIZE){ alert(`ã€Œ${f.name}ã€è¶…é 2MB`); return; }
    const r=new FileReader(); r.onload=e=>{ const img=document.createElement('img'); img.src=e.target.result; photosPreview.appendChild(img); }; r.readAsDataURL(f);
  });
});
function persistSession(user){
  try{
    if (user) localStorage.setItem('LC_SESSION_TOKEN', user.getSessionToken());
  }catch(e){ console.warn('persistSession failed', e); }
}
/* ========= ç™»å…¥ / è¨»å†Š ========= */
const loginModal=document.getElementById('loginModal'), loginClose=document.getElementById('loginClose'), loginEmail=document.getElementById('loginEmail'), loginPass=document.getElementById('loginPass'), loginDo=document.getElementById('loginDo'), loginMsg=document.getElementById('loginMsg');
const signupModal=document.getElementById('signupModal'), signupClose=document.getElementById('signupClose'), signupEmail=document.getElementById('signupEmail'), signupPass=document.getElementById('signupPass'), signupNick=document.getElementById('signupNick'), signupDo=document.getElementById('signupDo'), signupMsg=document.getElementById('signupMsg'), signupAvatarInput=document.getElementById('signupAvatarInput'), signupAvatarPreview=document.getElementById('signupAvatarPreview'); let pickedSignupAvatarFile=null;
function openLogin(pref=''){loginEmail.value=pref||''; loginPass.value=''; loginMsg.textContent=''; loginModal.classList.add('show'); loginModal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; loginEmail.focus();}
function closeLogin(){loginModal.classList.remove('show'); loginModal.setAttribute('aria-hidden','true'); document.body.style.overflow='';}
function openSignup(pref=''){signupEmail.value=pref||''; signupPass.value=''; signupNick.value=''; signupMsg.textContent=''; pickedSignupAvatarFile=null; signupAvatarInput.value=''; signupAvatarPreview.src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cg fill='%23b78ad3'%3E%3Ccircle cx='60' cy='46' r='22'/%3E%3Cpath d='M16 108a44 44 0 0 1 88 0z'/%3E%3C/g%3E%3C/svg%3E"; signupModal.classList.add('show'); signupModal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; signupEmail.focus();}
function closeSignup(){signupModal.classList.remove('show'); signupModal.setAttribute('aria-hidden','true'); document.body.style.overflow='';}
loginClose.addEventListener('click', closeLogin); signupClose.addEventListener('click', closeSignup);
loginModal.addEventListener('click', e=>{ if(e.target===loginModal) closeLogin(); }); signupModal.addEventListener('click', e=>{ if(e.target===signupModal) closeSignup(); });
window.addEventListener('keydown', e=>{ if(e.key==='Escape'){ if(loginModal.classList.contains('show')) closeLogin(); if(signupModal.classList.contains('show')) closeSignup(); }});
function isEmail(s){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s)} function isAlnum6Plus(s){return/^[A-Za-z0-9]{6,}$/.test(s)}
let afterLogin=null; function requireLogin(thenDo){ if(AV.User.current()){ thenDo(); return; } afterLogin=thenDo; openLogin(); }
loginDo.addEventListener('click', async ()=>{
  const email = (loginEmail.value || '').trim();
  const pass  = (loginPass.value  || '').trim();

  if(!isEmail(email)){ loginMsg.textContent='è«‹å¡«å¯«æ­£ç¢ºçš„é›»å­éƒµç®±'; return; }
  if(!isAlnum6Plus(pass)){ loginMsg.textContent='å¯†ç¢¼è‡³å°‘ 6 ä½è‹±æ•¸'; return; }

  loginDo.disabled = true;
  loginMsg.textContent = 'ç™»å…¥ä¸­â€¦';
  try{
    const u = await AV.User.logIn(email, pass);

    // å’Œ Cloud.html ä¸€æ¨£ï¼šè‹¥æ²’å­˜ email å°±è£œä¸Š
    if (isEmail(email) && !u.getEmail()){ u.setEmail(email); await u.save(); }

    // â˜… å­˜ Session Tokenï¼Œè®“ record.html / Cloud.html å¯å½¼æ­¤è‡ªå‹•ç™»å…¥
    persistSession(u);

    closeLogin();
    await fetchShareCounts();
    afterLogin?.();   // åŸ·è¡ŒåŸå…ˆæƒ³åšçš„å‹•ä½œï¼ˆä¾‹å¦‚è·³ Cloud.htmlï¼‰
    afterLogin = null;
  }catch(err){
    if(err.code === 211){  // ä½¿ç”¨è€…ä¸å­˜åœ¨ â†’ å¼•å°è¨»å†Š
      closeLogin();
      openSignup(email);
      signupMsg.textContent = 'æ­¤å¸³è™Ÿå°šæœªè¨»å†Šï¼Œè«‹å…ˆå»ºç«‹å¸³è™Ÿ';
    }else if(err.code === 210){
      loginMsg.textContent = 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
    }else{
      loginMsg.textContent = `ç™»å…¥å¤±æ•—ï¼š${err.message || err.code || 'æœªçŸ¥éŒ¯èª¤'}`;
    }
  }finally{
    loginDo.disabled = false;
  }
});
signupAvatarInput.addEventListener('change', ()=>{ const f=signupAvatarInput.files?.[0]; if(!f) return; if(f.size>2*1024*1024){ alert('åœ–ç‰‡å¤ªå¤§ï¼Œè«‹å°æ–¼ 2MB'); signupAvatarInput.value=''; return;} pickedSignupAvatarFile=f; const r=new FileReader(); r.onload=e=>signupAvatarPreview.src=e.target.result; r.readAsDataURL(f); });
async function uploadSignupAvatarIfAny(){ if(!pickedSignupAvatarFile) return null; const file=new AV.File(pickedSignupAvatarFile.name,pickedSignupAvatarFile); await file.save(); return file.url(); }
signupDo.addEventListener('click', async ()=>{
  const email = (signupEmail.value || '').trim();
  const pass  = (signupPass.value  || '').trim();
  const nick  = (signupNick.value  || '').trim();

  if(!isEmail(email)){ signupMsg.textContent='è«‹å¡«å¯«æ­£ç¢ºçš„é›»å­éƒµç®±'; return; }
  if(!isAlnum6Plus(pass)){ signupMsg.textContent='å¯†ç¢¼è‡³å°‘ 6 ä½è‹±æ•¸'; return; }
  if(!nick){ signupMsg.textContent='è«‹å¡«å¯«æš±ç¨±'; return; }

  signupDo.disabled = true;
  signupMsg.textContent = 'å»ºç«‹ä¸­â€¦';
  try{
    // æœ‰æŒ‘é ­è²¼å°±å…ˆä¸Šå‚³
    const avatarUrl = await uploadSignupAvatarIfAny();

    // å»ºç«‹å¸³è™Ÿï¼ˆæ¬„ä½èˆ‡ Cloud.html å°é½Šï¼‰
    const user = new AV.User();
    user.setUsername(email);
    user.setPassword(pass);
    user.setEmail(email);
    user.set('nickname', nick);
    if (avatarUrl) user.set('avatar', avatarUrl);

    await user.signUp();

    // â˜… ç«‹åˆ»å­˜ Tokenï¼Œä¹‹å¾Œå…©é å¯è‡ªå‹•å¸¶ç™»å…¥ç‹€æ…‹
    persistSession(user);

    closeSignup();
    afterLogin?.();
    afterLogin = null;
  }catch(err){
    if(err.code === 202){   // å·²å­˜åœ¨ â†’ å›ç™»å…¥
      closeSignup();
      openLogin(email);
      loginMsg.textContent = 'æ­¤å¸³è™Ÿå·²è¨»å†Šï¼Œè«‹ç›´æ¥ç™»å…¥';
    }else{
      signupMsg.textContent = `è¨»å†Šå¤±æ•—ï¼š${err.message || err.code || 'æœªçŸ¥éŒ¯èª¤'}`;
    }
  }finally{
    signupDo.disabled = false;
  }
});
//================================
/* ========= åˆ†äº«è¨ˆæ•¸ï¼ˆCloud åŒæ­¥ï¼‰ ========= */
let shareCounts = new Map();   // key: originId(=æœ¬åœ° rec.id), val: æ•¸é‡

function setFlagCount(cardEl, count){
  // åœ¨ä¸€å¼µ .card ä¸Šæ›´æ–°æ©™é»ï¼‹æ•¸å­—ï¼›count=0 å°±ç§»é™¤
  const dot   = cardEl.querySelector('.flag-dot');
  const badge = cardEl.querySelector('.flag-count');

  if (count > 0){
    if (!dot){
      const d = document.createElement('i');
      d.className = 'flag-dot';
      d.setAttribute('aria-hidden','true');
      cardEl.appendChild(d);
    }
    let b = badge;
    if (!b){
      b = document.createElement('span');
      b.className = 'flag-count';
      cardEl.appendChild(b);
    }
    badge ? (badge.textContent = String(count)) : (b.textContent = String(count));
  }else{
    dot?.remove();
    badge?.remove();
  }
}

// é‡æ–°å¥—ç”¨æ‰€æœ‰å¡ç‰‡èˆ‡è©³æƒ…é çš„å¾½ç« 
function renderShareIndicators(){
  // åˆ—è¡¨å¡ç‰‡
  document.querySelectorAll('#list .card.list-card').forEach(card=>{
    const id = card.dataset.id;
    setFlagCount(card, shareCounts.get(id) || 0);
  });
  // è©³æƒ…å¡ç‰‡ï¼ˆå¦‚æœç›®å‰åœ¨è©³æƒ…é ï¼‰
  const id = parseHash();  // ä½ åŸæœ¬çš„è§£æå‡½å¼
  if (id){
    const detailCard = document.querySelector('#view-detail .card');
    if (detailCard) setFlagCount(detailCard, shareCounts.get(id) || 0);
  }
}

// å¾ Cloud æŠ“å›æˆ‘ç™¼éçš„è²¼æ–‡ï¼Œä¾ originId èšåˆæˆè¨ˆæ•¸è¡¨
async function fetchShareCounts(){
  const u = AV.User.current();
  shareCounts = new Map();
  if (!u){ renderShareIndicators(); return; }

  const q = new AV.Query('Cloud');
  q.equalTo('authorId', u.id);
  q.select(['originGroup', 'originId']);  // å…©å€‹éƒ½å–ï¼Œç‚ºäº†ç›¸å®¹èˆŠè³‡æ–™
  q.limit(1000);

  const rows = await q.find();
  rows.forEach(o=>{
    // æ–°è³‡æ–™ï¼šæœ‰ originGroupï¼›èˆŠè³‡æ–™ï¼šåªæœ‰ originId â†’ æ‹† '#'
    const group =
      o.get('originGroup') ||
      (String(o.get('originId')||'').split('#')[0]);

    if (!group) return;
    shareCounts.set(group, (shareCounts.get(group) || 0) + 1);
  });

  renderShareIndicators();
}
/* ========= æœ¬åœ°å­˜å– ========= */
const KEY='records_v2_images';
function loadRecords(){ try{return JSON.parse(localStorage.getItem(KEY)||'[]')}catch{return[]} }
function saveRecords(arr){ localStorage.setItem(KEY, JSON.stringify(arr)) }
// ====== åŒ¿åé›²åŒæ­¥ï¼ˆç¬¬äºŒå€‹ LeanCloud æ‡‰ç”¨ï¼Œèµ° RESTï¼Œä¸å‹•ä½ ç¾æœ‰ AV.initï¼‰======

// é€™çµ„æ˜¯ã€ŒåŒ¿åå„²å­˜ã€é‚£å€‹æ‡‰ç”¨ï¼ˆä¸æ˜¯ LimCloud é‚£çµ„ï¼‰
const ANON_LC = {
  APP_ID:  'WFWfFV7tyEZwqestvU0Dc1wN-gzGzoHsz',
  APP_KEY: '4d1bNdqyNS0QL8RXart4BnJx',
  REST:    'https://wfwffv7t.lc-cn-n1-shared.com'
};
const CLOUD_KEY = 'records_v2_images'; // å°±ç”¨æœ¬åœ°åŒä¸€æŠŠ key

function getDeviceId(){
  const k = 'SG_DEVICE_ID';
  let id = localStorage.getItem(k);
  if (!id){
    id = (crypto.randomUUID?.() || ('sg_' + Math.random().toString(36).slice(2) + Date.now()));
    localStorage.setItem(k, id);
  }
  return id;
}

// é€šç”¨ï¼šå‘¼å«é›²å‡½æ•¸ï¼ˆRESTï¼‰
async function anonRpc(fnName, payload){
  const res = await fetch(`${ANON_LC.REST}/1.1/functions/${fnName}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-LC-Id': ANON_LC.APP_ID,
      'X-LC-Key': ANON_LC.APP_KEY
    },
    body: JSON.stringify(payload || {})
  });
  if (!res.ok){
    const t = await res.text().catch(()=> '');
    throw new Error(`Anon RPC ${fnName} failed: ${res.status} ${t}`);
  }
  return res.json(); // { result: ... }
}

// è®€é›²ç«¯æœ€æ–°
async function cloudFetch(){
  try{
    const { result } = await anonRpc('getAnon', { key: CLOUD_KEY /* è¦æ¯å°è£ç½®å„å­˜å„çš„å°±åŠ  clientId:getDeviceId() */ });
    return Array.isArray(result?.data) ? result.data : [];
  }catch(e){
    console.warn('[cloudFetch] fail', e);
    return null;
  }
}

// å­˜é›²ç«¯ï¼ˆé˜²æŠ– 0.6sï¼‰
const saveDebounced = (() => {
  let t = 0;
  return (payload) => {
    clearTimeout(t);
    t = setTimeout(async () => {
      try{
        await anonRpc('saveAnon', {
          key: CLOUD_KEY,
          clientId: getDeviceId(),
          data: payload
        });
      }catch(e){
        console.warn('[cloudSave] fail', e);
      }
    }, 600);
  };
})();

// â˜†â˜† ä¸å–ä»£ä½ çš„åŸå‡½å¼ï¼šåªæ˜¯åŒ…ä¸€å±¤ï¼Œåœ¨æœ¬åœ°å­˜æª”å¾ŒåŒæ­¥åˆ°åŒ¿åé›²ç«¯ â˜†â˜†
const __origSaveRecords = window.saveRecords;
window.saveRecords = function(arr){
  // å…ˆç…§èˆŠå­˜æœ¬åœ°ï¼ˆä½ çš„åŸåŠŸèƒ½ï¼ŒåŒ…å« LimCloud åˆ†äº«å¾½ç« ç­‰å®Œå…¨ä¸è®Šï¼‰
  __origSaveRecords(arr);

  // å†æŠŠç¸®æ¸›å¾Œçš„è³‡æ–™åŒæ­¥é›²ç«¯ï¼ˆä¹Ÿå¯ç›´æ¥å‚³ arrï¼‰
  try{
    const slim = Array.isArray(arr) ? arr.map(x => ({
      id:x.id, created:x.created, title:x.title, content:x.content,
      images:x.images, dateStr:x.dateStr, solarStr:x.solarStr,
      approx:x.approx, gzDay:x.gzDay, gzHour:x.gzHour
    })) : [];
    saveDebounced(slim);
  }catch(e){}
};

// é¦–æ¬¡é–‹é ï¼šé›²ç«¯ â†’ æœ¬åœ° â†’ é‡ç•«åˆ—è¡¨ï¼ˆè‹¥é›²ç«¯ç„¡è³‡æ–™æœƒè·³éï¼‰
(async function bootstrapCloudSync(){
  const remote = await cloudFetch();
  if (remote && Array.isArray(remote)){
    try{ localStorage.setItem('records_v2_images', JSON.stringify(remote)); }catch(e){}
  }
  try{ renderList(); }catch(e){}
})();
async function filesToDataURLs(files){
  const xs=Array.from(files||[]).slice(0,MAX_FILES);
  const tasks=xs.map(f=>new Promise((res,rej)=>{ if(f.size>MAX_SIZE) return rej(new Error(`${f.name} è¶…é 2MB`)); const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=rej; r.readAsDataURL(f); }));
  const rs=await Promise.allSettled(tasks); return rs.filter(r=>r.status==='fulfilled').map(r=>r.value);
}
function esc(s=''){
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}
/* ========= åˆ—è¡¨æ¸²æŸ“ & äº‹ä»¶ ========= */
function renderList(){
  const arr = loadRecords();
  renderTimeline(arr.length);
  listEl.innerHTML = '';
  if (!arr.length){ emptyEl.style.display='block'; return; }
  emptyEl.style.display='none';

  arr.sort((a,b)=> b.created - a.created);

  arr.forEach(it=>{
    const card = document.createElement('div');
    card.className = 'card list-card';
    card.dataset.id = it.id;

    const title   = it.title || 'ï¼ˆç„¡æ¨™é¡Œï¼‰';
    const content = (it.content || '').trim();
    const thumbs  = Array.isArray(it.images) ? it.images : [];
    const firstImg = thumbs.length ? thumbs[0] : '';

    // â€”â€” æ¨™é¡Œåˆ—ï¼ˆä¿ç•™åŸæœ¬çš„æ—¥æœŸ/çœŸå¤ªé™½æ™‚å¾½ç« ï¼‰â€”â€”
    const titleRow =
  '<div class="title stack">' +                                  // å¤šåŠ  stack
    '<div class="title-text">' + esc(title) + '</div>' +         // æ¨™é¡Œç½®ä¸­
    '<span class="badge dim time-badge">' +                      // â† é‚„æ˜¯è—¥ä¸¸
      esc(it.dateStr||'') + 'ï½œ' + esc(it.solarStr||'') +
      (it.approx ? ' â‰ˆ' : '') +
    '</span>' +
  '</div>';

    // â€”â€” å¹²æ”¯ï¼ˆä¿ç•™ï¼‰â€”â€”
    const meta =
      '<div class="meta">' +
        '<span class="badge">æ—¥ï¼š' + esc(it.gzDay||'') + '</span>' +
        '<span class="badge">æ™‚ï¼š' + esc(it.gzHour||'') + '</span>' +
      '</div>';

// â€”â€” å…§å®¹å€ï¼šå…©è¡Œæ‘˜è¦ï¼ˆä¸Šï¼‰+ ç¸®åœ–åˆ—ï¼ˆä¸‹ï¼‰ â€”â€” 
// åªå–ç¬¬ä¸€å¼µç•¶å°é¢
const cover = thumbs[0];
const extra = Math.max(0, thumbs.length - 1);

const thumbsBar = cover
  ? '<div class="thumb-bar">' +
      '<span class="twrap">' +
        '<img class="thumb-mini" src="' + esc(cover) + '" alt="" loading="lazy">' +
        (extra ? '<span class="thumb-more">+' + extra + '</span>' : '') +
      '</span>' +
    '</div>'
  : '';

const mid =
  '<div class="content-block">' +
    '<div class="excerpt">' + esc(content) + '</div>' +
    thumbsBar +
  '</div>';

    // â€”â€” å·¥å…·åˆ—å›ºå®šåœ¨åº• â€”â€” 
    const tools =
      '<div class="tools stick">' +
        '<button class="tool" data-act="del"   data-id="' + it.id + '">åˆªé™¤</button>' +
        '<button class="tool" data-act="copy"  data-id="' + it.id + '">è¤‡è£½æ–‡å­—</button>' +
        '<button class="tool" data-act="share" data-id="' + it.id + '">åˆ†äº«è‡³ LimCloud</button>' +
      '</div>';

    card.innerHTML = titleRow + meta + mid + tools;

    // é»æ•´å¼µå¡ç‰‡ -> é€²å…¥è©³æƒ…ï¼ˆé»å·¥å…·éˆ•é™¤å¤–ï¼‰
    card.addEventListener('click', (e)=>{
      if (e.target.closest('.tool')) return;
      location.hash = `#/detail/${encodeURIComponent(it.id)}`;
    });

    listEl.appendChild(card);
    setFlagCount(card, shareCounts.get(it.id) || 0);

// è®“ç¸®åœ–é–“çš„è™›ç·šé•·åº¦æ­£ç¢ºï¼ˆåŒä¸€æ’æ‰é€£ï¼‰
const bar = card.querySelector('.thumb-bar');
if (bar){
  // ç­‰åœ–ç‰‡è¼‰å…¥å¾Œå†é‡
  bar.querySelectorAll('img').forEach(img=>{
    img.addEventListener('load', ()=>linkDots(bar), {once:true});
  });
  // åˆå§‹å…ˆé‡ä¸€æ¬¡ï¼ˆé¿å… cacheï¼‰
  requestAnimationFrame(()=>linkDots(bar));
}
  });

  // å·¥å…·åˆ—äº‹ä»¶ï¼ˆæ²¿ç”¨ä½ åŸæœ¬çš„é‚è¼¯ï¼‰
  listEl.querySelectorAll('button.tool').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id  = btn.dataset.id;
      const act = btn.dataset.act;
      const arr = loadRecords();
      const idx = arr.findIndex(x=>x.id===id);
      if (idx<0) return;

      if (act==='del'){
        if (confirm('è¦åˆªé™¤é€™å‰‡ç´€éŒ„å—ï¼Ÿ')){
          arr.splice(idx,1); saveRecords(arr); renderList();
        }
      }else if (act==='copy'){
        navigator.clipboard?.writeText(arr[idx].content || '').then(()=>{
          btn.textContent='å·²è¤‡è£½'; setTimeout(()=>btn.textContent='è¤‡è£½æ–‡å­—',800);
        });
      }else if (act==='share'){
  requireLogin(async ()=>{
    const original = btn.textContent;
    btn.textContent = 'ä¸Šå‚³ä¸­â€¦';
    btn.disabled = true;
    try{
      await uploadToCloud(arr[idx]);
      // â˜… æ¨™è¨˜é€™ç­†å·²åˆ†äº« & ä¿å­˜
      arr[idx].shared = true;
      saveRecords(arr);
      renderList();

      btn.textContent = 'å·²åˆ†äº«';
      setTimeout(()=>{ btn.textContent = original; btn.disabled=false; }, 1200);
    }catch(e){
      alert(e.message || 'ä¸Šå‚³å¤±æ•—');
      btn.textContent = original;
      btn.disabled = false;
    }
  });
}
    });
  });
}
/* ========= è¨ˆç®—ç¸®åœ–ä¹‹é–“é€£ç·šé•·åº¦ ========= */
/* ä¾ç´€éŒ„æ•¸é‡ï¼Œåœ¨æ¨™é¡Œæ—ç•«å‡º é»â€”ç·šâ€”é» æŒ‡ç¤ºå™¨ */
function renderTimeline(count){
  const box = document.getElementById('recTimeline');
  if(!box) return;
  box.innerHTML = '';
  if (count <= 0) return;

  for (let i = 0; i < count; i++){
    const dot = document.createElement('span');
    dot.className = 'dot';
    box.appendChild(dot);

    if (i < count - 1){
      const seg = document.createElement('span');
      seg.className = 'seg';
      box.appendChild(seg);
    }
  }
}

// è¦–çª—å¤§å°è®ŠåŒ–æ™‚é‡æ–°è¨ˆç®—
window.addEventListener('resize', () => {
  document.querySelectorAll('.thumb-bar').forEach(bar => linkThumbs(bar));
});
// ç™»å…¥è¦–çª—ä¸­çš„ã€Œè¨»å†Šã€æŒ‰éˆ•ï¼šé—œé–‰ç™»å…¥ â†’ é–‹å•Ÿè¨»å†Šï¼ˆå¸¶å…¥å·²è¼¸å…¥çš„ emailï¼‰
document.getElementById('gotoSignup').addEventListener('click', ()=>{
  const pre = (loginEmail.value || '').trim();
  closeLogin();
  openSignup(pre);
});
/* ========= å„²å­˜ ========= */
saveBtn.addEventListener('click', async ()=>{
  const content=contentEl.value.trim(); if(!content){ contentEl.focus(); contentEl.placeholder='è«‹å…ˆè¼¸å…¥ä¸€äº›æ–‡å­—å†å„²å­˜å–”ï½'; return; }
  const title=titleEl.value.trim();
  const now=new Date(); const lon=state.hasGeo?state.lon:tzCenterMeridian(); const ts=calcTrueSolar(now,lon,state.hasGeo);
  const dstr=now.toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'short'});
  const solarHours=ts.solar.getHours()+ts.solar.getMinutes()/60+ts.solar.getSeconds()/3600;
  const {day:gzDay,hour:gzHour}=getGanzhiForTrueSolar(ts.solar,solarHours);
  const id=(crypto.randomUUID?crypto.randomUUID():String(Date.now())+Math.random().toString(16).slice(2));
  const images=await filesToDataURLs(photosInput.files);
  const rec={ id, created:Date.now(), title, content, images, dateStr:dstr, solarStr:ts.text, approx:ts.approx, gzDay, gzHour };
  const arr=loadRecords(); arr.push(rec); saveRecords(arr); closeModal(); renderList();
});

/* ========= åˆ†äº«åˆ°é›²ç«¯ï¼ˆå«åœ–ç‰‡ & ç™¼ä½ˆæ™‚é–“/ä½œè€…/ACLï¼‰ ========= */
function dataURLtoBlob(dataURL){
  const [meta,b64]=dataURL.split(',');
  const mime=(meta.match(/data:(.*);base64/)||[])[1]||'application/octet-stream';
  const bin=atob(b64); const u8=new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
  return new Blob([u8],{type:mime});
}

async function uploadToCloud(rec){
  // å¿…é ˆç™»å…¥
  const u = AV.User.current();
  if(!u) throw new Error('è«‹å…ˆç™»å…¥');

  // ===== ç™¼ä½ˆç•¶ä¸‹çš„çœŸå¤ªé™½æ™‚ï¼‹å¹²æ”¯ï¼ˆè·Ÿä½ åŸæœ¬ä¸€æ¨£ï¼‰=====
  const now = new Date();
  const lon = state.hasGeo ? state.lon : tzCenterMeridian();
  const ts  = calcTrueSolar(now, lon, state.hasGeo);
  const pubDateStr  = now.toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'short'});
  const h = ts.solar.getHours() + ts.solar.getMinutes()/60 + ts.solar.getSeconds()/3600;
  const { day: pubGZDay, hour: pubGZHour } = getGanzhiForTrueSolar(ts.solar, h);

  // ===== ä¸Šå‚³åœ–ç‰‡ï¼ˆè·Ÿä½ åŸæœ¬ä¸€æ¨£ï¼‰=====
  const imageUrls = [];
  if (rec.images?.length){
    for(const d of rec.images){
      const f = new AV.File(`rec_${Date.now()}_${Math.random().toString(16).slice(2)}.jpg`, dataURLtoBlob(d));
      await f.save();
      imageUrls.push(f.url());
    }
  }

  // ===== åœ¨å»ºç«‹ post ä¹‹å‰ï¼Œå…ˆç®—ç›®å‰å·²åˆ†äº«å¹¾æ¬¡ï¼ˆé—œéµï¼‰=====
  const countQ = new AV.Query('Cloud');
  countQ.equalTo('authorId', u.id);
  countQ.equalTo('originGroup', rec.id);    // ç”¨åˆ†çµ„éµç®—æ•¸é‡
  const existed = await countQ.count();
  const shareNo = existed + 1;

  // ===== å»ºç«‹ Cloud ç‰©ä»¶ =====
  const post = new (AV.Object.extend('Cloud'))();

  // â€”â€” å‰µä½œè³‡è¨Šï¼ˆä¿ç•™åŸæœ¬ï¼‰
  post.set('title',    rec.title || '');
  post.set('content',  rec.content || '');
  post.set('dateStr',  rec.dateStr || '');
  post.set('solarStr', rec.solarStr || '');
  post.set('gzDay',    rec.gzDay || '');
  post.set('gzHour',   rec.gzHour || '');
  post.set('approx',   !!rec.approx);

  // â€”â€” ç™¼ä½ˆè³‡è¨Šï¼ˆç¾åœ¨ï¼‰
  post.set('pubDateStr',  pubDateStr);
  post.set('pubSolarStr', ts.text);
  post.set('pubGZDay',    pubGZDay);
  post.set('pubGZHour',   pubGZHour);
  post.set('pubApprox',   !!ts.approx);

  // â€”â€” åœ–ç‰‡èˆ‡ä½œè€… â€”â€” 
  post.set('images',       imageUrls);
  post.set('authorId',     u.id);
  post.set('authorName',   u.get('nickname') || u.getUsername() || '');
  post.set('authorAvatar', u.get('avatar') || '');

  // â€”â€” â˜… é‡é»ï¼šé¿å…å”¯ä¸€ç´¢å¼•è¡çªã€åˆèƒ½è¨ˆæ•¸ â€”â€” 
  post.set('originGroup', rec.id);                 // åˆ†çµ„éµï¼šç”¨ä¾†è¨ˆæ•¸
  post.set('originId', `${rec.id}#${shareNo}`);    // å”¯ä¸€éµï¼šåˆ†çµ„éµ + æµæ°´è™Ÿ
  post.set('shareNo', shareNo);                    // ï¼ˆå¯é¸ï¼‰ç´€éŒ„ç¬¬å¹¾æ¬¡

  // ACL
  const acl = new AV.ACL();
  acl.setPublicReadAccess(true);
  acl.setWriteAccess(u, true);
  post.setACL(acl);

  try{
    await post.save();
  }catch(e){
    if(e.code === 111){ // å¾Œå°å‹åˆ¥ä¸åˆæ™‚çš„é€€å›ç­–ç•¥ï¼ˆæ²¿ç”¨ä½ çš„ï¼‰
      post.set('approx',    String(!!rec.approx));
      post.set('pubApprox', String(!!ts.approx));
      await post.save();
    }else{
      throw e;
    }
  }

  // ä¸Šå‚³æˆåŠŸ â†’ ç«‹åˆ»åˆ·æ–°è¨ˆæ•¸å¾½ç« 
  try{ await fetchShareCounts(); }catch(_){}
  return { ok:true };
}
/* ========= å» LimCloud ========= */
document.getElementById('goCloud').addEventListener('click', ()=>{ requireLogin(()=>{ location.href='cloud.html'; }); });

/* ========= å–®é è·¯ç”± ========= */
function parseHash(){ const m=location.hash.match(/^#\/detail\/(.+)$/); return m?decodeURIComponent(m[1]):null; }
let currentDetailId=null;

function showList(){ viewDetail.style.display='none'; viewList.style.display='block'; currentDetailId=null; }
function showDetail(id){
  const arr = loadRecords();
  const rec = arr.find(x => x.id === id);
  if(!rec){ alert('æ‰¾ä¸åˆ°é€™å‰‡ç´€éŒ„'); showList(); return; }

  viewList.style.display='none';
  viewDetail.style.display='block';

  dTitle.textContent = rec.title || 'ï¼ˆç„¡æ¨™é¡Œï¼‰';
  dMeta.innerHTML = `<span>${rec.dateStr}ï½œ${rec.solarStr}${rec.approx?' â‰ˆ':''}</span>ã€€<span>æ—¥ï¼š${rec.gzDay}</span>ã€€<span>æ™‚ï¼š${rec.gzHour}</span>`;
  dContent.textContent = rec.content;

  // é‡æ–°ç•«åœ–
// é‡æ–°ç•«åœ–ï¼ˆæ”¯æ´ data:URL åœ¨æ–°åˆ†é é¡¯ç¤ºï¼‰
dGallery.innerHTML = '';
(rec.images || []).forEach((src, i) => {
  const wrap = document.createElement('span');
  wrap.className = 'picwrap';

  const a = document.createElement('a');
  a.target = '_blank';
  a.rel = 'noopener';

  // dataURL â†’ Blob URLï¼ˆé¿å… iOS/Safari ç›´æ¥é–‹ data: ç©ºç™½ï¼‰
  let href = src;
  let revokeLater = null;

  if (typeof src === 'string' && src.startsWith('data:image/')) {
    try{
      const blob = dataURLtoBlob(src);                 // ä½ æª”æ¡ˆè£¡å·²ç¶“æœ‰é€™å€‹å‡½å¼
      href = URL.createObjectURL(blob);
      revokeLater = href;                               // é»å®Œå† revoke
    }catch(e){
      // è½‰æ›å¤±æ•—å°±å›é€€ç”¨åŸå§‹ data:ï¼Œè‡³å°‘ä¸æœƒå£
      href = src;
    }
  }

  a.href = href;

  // é»äº†ä¹‹å¾Œéä¸€æœƒå…’å›æ”¶ URLï¼Œé¿å…è¨˜æ†¶é«”å ç”¨
  if (revokeLater) {
    a.addEventListener('click', () => {
      setTimeout(() => URL.revokeObjectURL(revokeLater), 3000);
    }, { once: true });
  }

  const img = document.createElement('img');
  img.loading = 'lazy';
  img.src = src;   // åœ–ç‰‡æœ¬èº«ç…§èˆŠç”¨åŸå§‹ src é¡¯ç¤ºç¸®åœ–
  img.alt = '';

  a.appendChild(img);
  wrap.appendChild(a);
  dGallery.appendChild(wrap);
});

  // ç”¨é›²ç«¯çš„åˆ†äº«è¨ˆæ•¸ä¾†ç•«æ©™é»ï¼‹æ•¸å­—ï¼ˆä¸ç”¨èˆŠçš„ rec.shared åˆ¤æ–·äº†ï¼‰
  const detailCard = document.querySelector('#view-detail .card');
  if (detailCard) setFlagCount(detailCard, shareCounts.get(id) || 0);

  // åˆ†äº«æŒ‰éˆ•
  btnShare.onclick = ()=>requireLogin(async ()=>{
    btnShare.disabled = true; btnShare.textContent = 'ä¸Šå‚³ä¸­â€¦';
    try{
      await uploadToCloud(rec);

      // åŒæ­¥æŠŠ localStorage é€™ç­†æ¨™è¨˜å·²åˆ†äº«ï¼ˆä¿ç•™ï¼‰
      const arrAll = loadRecords();
      const i = arrAll.findIndex(x=>x.id===id);
      if (i >= 0){
        arrAll[i].shared = true;
        saveRecords(arrAll);
        Object.assign(rec, arrAll[i]);
      }

      // é‡ç•«è©³æƒ…ï¼ˆè®“å¾½ç« /ç›¸ç‰‡éƒ½æ­£ç¢ºï¼‰
      showDetail(id);

      btnShare.textContent='å·²åˆ†äº«';
      setTimeout(()=>{ btnShare.textContent='åˆ†äº«è‡³ LimCloud'; btnShare.disabled=false; },1000);
    }catch(e){
      alert(e.message||'ä¸Šå‚³å¤±æ•—');
      btnShare.disabled=false; btnShare.textContent='åˆ†äº«è‡³ LimCloud';
    }
  });

  // åˆªé™¤æŒ‰éˆ•ï¼ˆä¿ç•™ï¼‰
  btnDelete.onclick = ()=>{
    if(confirm('ç¢ºå®šåˆªé™¤é€™å‰‡ç´€éŒ„ï¼Ÿ')){
      const idx=arr.findIndex(x=>x.id===id);
      if(idx>=0){ arr.splice(idx,1); saveRecords(arr); location.hash=''; }
    }
  };
}

//===---------===
function route(){ const id=parseHash(); if(id) showDetail(id); else showList(); }
window.addEventListener('hashchange', route);
backBtn.addEventListener('click', ()=>{ location.hash=''; });
/* ========= å•Ÿå‹• ========= */
function start(){ initGeo(); tick(); renderList(); route(); fetchShareCounts(); } // â˜… å¤šé€™å€‹
start();

</script>
<!--=================-->
<p style="text-align: center; font-size: 13px; color: #999; margin-top: 40px;">
  ğŸ¾ Â© 2024 yinnlimçš„å°å®‡å®™ï½œå…§å®¹èˆ‡è¨­è¨ˆçš†ç”±ç³–ç³–æœ¬äººç”¨æ„›è£½ä½œ ğŸ’<br>
  æœªç¶“æˆæ¬Šè«‹å‹¿éš¨æ„ä½¿ç”¨ã€ç›œè½‰å–” ğŸ™…â€â™€ï¸ è¬è¬ä½ çš„å°Šé‡èˆ‡æº«æŸ” ğŸ’Œ
</p>
</body>
</html>