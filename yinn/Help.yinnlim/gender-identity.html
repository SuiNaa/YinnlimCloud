<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sunlit Grove èŠå¤©å®¤</title>
<meta name="color-scheme" content="dark">
<style>
:root{
  --bg:#0f0d14; --card:#17151f; --ink:#eceaf2; --muted:#a9a6b3; --border:#2b2637; --accent:#b78ad3;
  --mine:#3b2b57; --other:#1f1a2b; --maxw:1040px;
  --online:#b78ad3;  /* ç´«è‰²ï¼ˆåœ¨ç·šï¼‰ */
  --offline:#a35555; /* é»¯ç´…ï¼ˆé›¢ç·šï¼‰ */
}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,"Noto Sans TC","Microsoft JhengHei";background:linear-gradient(160deg,#13111a,#191627);color:var(--ink)}
.wrap{max-width:var(--maxw);margin:0 auto;padding:18px 14px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.badge{display:inline-flex;
  align-items:center;
  gap:6px;font-size:.82rem;
  padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:#1f1a2b}
.btn{display:inline-flex;align-items:center;gap:8px;background:var(--accent);color:#120d18;border:none;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;color:#fff;border:1px solid var(--border)}
.btn.small{padding:8px 10px;font-weight:600}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
/* ç‰ˆé¢ï¼šå·¦å´åå–® + å³å´èŠå¤© */
.layout{display:grid;grid-template-columns:260px 1fr;gap:12px}
@media (max-width:900px){ .layout{grid-template-columns:1fr} .sidebar{order:2} }
/* å´æ¬„ï¼šæˆå“¡æ¸…å–® */
.sidebar{padding:10px 0;max-height:calc(100vh - 160px);min-height:420px;overflow:auto}
.side-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}
.people{list-style:none;margin:0;padding:6px}
.person{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:10px}
.person:hover{background:#1a1624}
.p-avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
.p-name{flex:1 1 auto;font-weight:700;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:.94rem}
.dot{width:10px;height:10px;border-radius:50%;flex:0 0 auto;box-shadow:0 0 0 transparent;border:1px solid rgba(0,0,0,.25)}
.dot.online{background:var(--online); box-shadow:0 0 10px var(--online), 0 0 4px var(--online)}
.dot.offline{background:var(--offline); opacity:.65}
/* èŠå¤©å€ */
.chat{display:flex;flex-direction:column;height:calc(100vh - 160px);min-height:420px}
.chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}
.chat-body{flex:1 1 auto;overflow:auto;padding:10px 12px;scroll-behavior:smooth}
/* å¤–å±¤ä¸€åˆ—ï¼šé ­è²¼ + å…§å®¹ */
/* ä¸€å‰‡è¨Šæ¯ï¼šå…©æ¬„ä½ˆå±€ï¼šé ­è²¼ + å…§å®¹ */
/* ä¸€å‰‡è¨Šæ¯ï¼šå›ºå®šå…©æ¬„ï¼šé ­è²¼ + å…§å®¹ï¼ˆæ°£æ³¡+æ™‚é–“ï¼‰ */
.msg{
  display:grid;
  grid-template-columns: 36px auto;          /* é ­è²¼å›ºå®š 36pxï¼Œå…§å®¹è‡ªé©æ‡‰ */
  grid-template-areas: "avatar content";
  align-items:start;
  column-gap:6px;                             /* æƒ³æ›´è²¼å°±æ”¹ 4 æˆ– 2 */
  margin:8px 0;
  max-width:80%;
}

/* è‡ªå·±çš„è¨Šæ¯ï¼šæŠŠå…©æ¬„å°èª¿ï¼Œå…§å®¹åœ¨å·¦ã€é ­è²¼åœ¨å³ï¼›æ•´çµ„é å³ */
.msg.you{
  grid-template-columns: auto 36px;
  grid-template-areas: "content avatar";
  margin-left:auto;
}

/* é ­è²¼ */
.msg .avatar{
  grid-area: avatar;
  width:36px;height:36px;border-radius:50%;
  object-fit:cover;border:1px solid var(--border);
}

/* å…§å®¹å®¹å™¨ï¼ˆåŒ…æ°£æ³¡ï¼‹æ™‚é–“ï¼‰ */
.msg .content{
  grid-area: content;
  display:flex;
  flex-direction:column;
  max-width:min(72vw,560px);                  /* ä¸Šé™ï¼Œé¿å…è¶…å¯¬ */
  align-items:flex-start;                     /* åˆ¥äººçš„æ°£æ³¡é å·¦ */
}
.msg.you .content{ align-items:flex-end; }    /* è‡ªå·±çš„æ°£æ³¡é å³ */

/* æ°£æ³¡ï¼šå¯¬åº¦ç”±å…§å®¹æ±ºå®šï¼Œè²¼è‘—é ­è²¼ */
.msg .bubble{
  display:inline-block;
  width:fit-content;                          /* å…§å®¹æ±ºå®šå¯¬åº¦ */
  max-width:100%;
  margin:0;                                   /* ä¸è¦å†æœ‰å·¦å³é¡å¤–é–“è· */
  padding:10px 12px;border-radius:12px;line-height:1.5;
  white-space:pre-wrap;word-break:break-word;border:1px solid var(--border);
}
.msg.you   .bubble{ background:var(--mine); }
.msg.other .bubble{ background:var(--other); }

/* æ™‚é–“/æš±ç¨±æ”¾åœ¨æ°£æ³¡ä¸‹æ–¹ï¼Œä¸æ’å¯¬ */
.meta{ display:block; font-size:.8rem; color:var(--muted); margin-top:4px }
/**/
.bubble{
  display:inline-block;         /* è®“å¯¬åº¦ç”±å…§å®¹æ±ºå®š */
  width:fit-content;            /* å…§å®¹å¤šå¯¡æ±ºå®šå¯¬åº¦ */
  max-width:min(72vw, 560px);   /* è¨­å€‹ä¸Šé™ï¼Œæ‰‹æ©Ÿèˆ‡æ¡Œæ©Ÿéƒ½å¥½çœ‹ */
  padding:10px 12px;
  border-radius:12px;
  line-height:1.5;
  white-space:pre-wrap;
  word-break:break-word;
  border:1px solid var(--border);
}
.msg.you .bubble{background:var(--mine)}
.msg.other .bubble{background:var(--other)}
.meta{font-size:.8rem;color:var(--muted);margin-top:4px}
.author{font-weight:700}
.time{opacity:.9}
.chat-foot{display:flex;gap:8px;padding:10px 12px;border-top:1px solid var(--border)}
.input{
  flex:1 1 auto;
  background:#1e1a28; color:#fff;
  border:1px solid var(--border); border-radius:12px;
  padding:10px 12px; font-size:1rem;
  line-height:1.5;
  resize:none;            /* ç¦æ­¢æ‹–æ‹‰æ”¹å¤§å° */
  overflow-y:auto;        /* è¶…éé«˜åº¦æ‰å‡ºç¾æ²è»¸ */
  min-height:40px;
  max-height:160px;       /* ä½ æƒ³è¦çš„æœ€é«˜è¡Œæ•¸ä¸Šé™ */
}
.hint{color:var(--muted);margin-top:8px}
.empty{color:var(--muted);text-align:center;padding:12px 6px}
/* å³ä¸Šè§’ç™»å…¥å±•ç¤º */
.userbox{display:flex;align-items:center;gap:10px}
.userbox .uavatar{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
.uname{font-weight:700}
/* Modal */
.modal{position:fixed;inset:0;display:none;place-items:center;z-index:1000;background:rgba(0,0,0,.45);backdrop-filter:blur(2px)}
.modal.show{display:grid}
.modal-box{width:min(92vw,520px);background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
.bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.H{text-decoration: none;}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
  <div style="display:flex;align-items:center;gap:10px">
    <h1 style="margin:0;font-size:clamp(20px,4.6vw,28px)">Sunlit Grove èŠå¤©å®¤</h1>
    <button id="btnHome" class="btn small ghost">ğŸ¾è¿”å›Grove Hub</button>
    <button id="z" class="btn small ghost">å»LinCloud</button>
  </div>
  <div id="authArea">
    <span id="loginState" class="badge">æœªç™»å…¥</span>
    <button id="btnLogin" class="btn small">ç™»å…¥</button>
    <button id="btnLogout" class="btn small ghost" style="display:none">ç™»å‡º</button>
  </div>
</div>
<!---->
<script>
    document.getElementById('btnHome').addEventListener('click', () => {
  window.location.href = 'help.html';  // æˆ–æ”¹æˆä½ ä¸»é çš„å¯¦éš›è·¯å¾‘
});
document.getElementById('z').addEventListener('click', () => {
    window.location.href='cloud.html';
});
    </script>
<!---->
  <div class="layout">
    <!-- å´æ¬„ï¼šç·šä¸Š/é›¢ç·šæ¸…å–® -->
    <aside class="card sidebar">
      <div class="side-head">
        <div class="C">
        <div class="badge">æˆå“¡</div>
        <div class="badge"><a href="" class="H">åˆ·æ–°åˆ—è¡¨</a></div>
        <span id="onlineCount" class="hint"></span>
      </div>
      </div>
      <ul id="people" class="people"></ul>
    </aside>

    <!-- èŠå¤©ä¸»é«” -->
    <section class="card chat">
      <div class="chat-head">
        <div class="badge">GroveèŠå¤©</div>
        <button id="loadMore" class="btn small ghost">è¼‰å…¥æ›´æ—©</button>
      </div>
      <div id="list" class="chat-body"><div class="empty">é‚„æ²’æœ‰è¨Šæ¯ï¼Œæ‰“å€‹æ‹›å‘¼å§ï½</div></div>
      <div class="chat-foot">
       <textarea id="msgInput" class="input" rows="1" placeholder="è¼¸å…¥è¨Šæ¯ï¼ŒEnter é€å‡ºï¼ŒShift+Enter æ›è¡Œ"></textarea>
        <button id="send" class="btn">é€å‡º</button>
      </div>
    </section>
  </div>

  <div class="hint">è¦å‰‡ï¼šè«‹å‹å–„ã€å‹¿ç™¼å€‹è³‡ï¼é•æ³•å…§å®¹ã€‚ç®¡ç†å“¡å¯åˆªé™¤ä¸ç•¶è¨Šæ¯ã€‚</div>
</div>

<!-- ç™»å…¥ / è¨»å†Š Modalï¼ˆèˆ‡ Cloud.html åŒé«”é©—ï¼‰ -->
<div id="loginModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="bar"><h3 style="margin:0">ç™»å…¥</h3><button id="loginClose" class="btn ghost">é—œé–‰</button></div>
    <div class="row">
      <input id="loginEmail" class="input" type="email" inputmode="email" placeholder="é›»å­éƒµç®±ï¼ˆå¿…å¡«ï¼‰" autocomplete="email">
      <input id="loginPass" class="input" type="password" placeholder="å¯†ç¢¼ï¼ˆå¿…å¡«ï¼‰" autocomplete="current-password">
    </div>
    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px">
      <button id="gotoSignup" class="btn ghost">è¨»å†Š</button>
      <button id="loginDo" class="btn">ç™»å…¥</button>
    </div>
    <div id="loginMsg" class="hint"></div>
  </div>
</div>

<div id="signupModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="bar"><h3 style="margin:0">å»ºç«‹å¸³è™Ÿ</h3><button id="signupClose" class="btn ghost">é—œé–‰</button></div>
    <div class="row">
      <input id="signupEmail" class="input" type="email" placeholder="é›»å­éƒµç®±ï¼ˆå¿…å¡«ï¼‰" autocomplete="email">
      <input id="signupPass" class="input" type="password" placeholder="å¯†ç¢¼ï¼ˆè‡³å°‘ 6 ä½è‹±æ•¸ï¼‰" autocomplete="new-password">
      <input id="signupNick" class="input" placeholder="æš±ç¨±ï¼ˆå¿…å¡«ï¼Œ1â€“30å­—ï¼‰" maxlength="30">
      <!-- é ­è²¼ï¼ˆæ–°å¢ï¼‰ -->
      <div class="k" style="width:100%;color:var(--muted);font-weight:600">é ­è²¼ï¼ˆå¯é¸ï¼‰</div>
      <label for="signupAvatarInput" style="display:inline-block; cursor:pointer; border:1px solid var(--border); border-radius:12px; padding:8px; background:#1f1a2b">
        <img id="signupAvatarPreview"
             src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='96' height='96'%3E%3Crect width='96' height='96' fill='%232b2637'/%3E%3C/svg%3E"
             alt="é ­è²¼é è¦½"
             style="width:96px;height:96px;border-radius:50%;object-fit:cover;display:block">
      </label>
      <input id="signupAvatarInput" type="file" accept="image/*" style="display:none">
      <div class="hint" style="width:100%">æ”¯æ´ jpg / png / gifï¼Œå»ºè­° &lt; 2MBã€‚</div>
    </div>
    <div style="display:flex; justify-content:flex-end; margin-top:8px">
      <button id="signupDo" class="btn">è¨»å†Š</button>
    </div>
    <div id="signupMsg" class="hint"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4/dist/av-min.js"></script>
<script>
/** ====== LeanCloud ====== */
const LC = {
  APP_ID:'0juO0jzBkrv1Oi04bHljaWDW-gzGzoHsz',
  APP_KEY:'kFMz8niEbd8BlPbFKDyTZC2Q',
  SERVER:'https://0juo0jzb.lc-cn-n1-shared.com'
};
AV.init({ appId: LC.APP_ID, appKey: LC.APP_KEY, serverURL: LC.SERVER });

/** ====== DOM/State ====== */
const UI = {
  people: document.getElementById('people'),
  onlineCount: document.getElementById('onlineCount'),
  list: document.getElementById('list'),
  input: document.getElementById('msgInput'),
  send: document.getElementById('send'),
  loadMore: document.getElementById('loadMore'),
  authArea: document.getElementById('authArea'),
};

let state = {
  roomId: 'main',
  liveSub: null,
  oldest: null,
  fetching: false,
  people: new Map(), // key: userId, value: {userId,name,avatar}
};

/** ====== å°å·¥å…·ï¼ˆç™»å…¥ç‹€æ…‹ï¼‰ ====== */
function isEmail(s){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s)}
function isAlnum6Plus(s){return/^[A-Za-z0-9]{6,}$/.test(s)}
function persistSession(user){ try{ if(user) localStorage.setItem('LC_SESSION_TOKEN', user.getSessionToken()); }catch{} }

async function autoLoginFromToken(){
  try{
    if (AV.User.current()) return;
    const token = localStorage.getItem('LC_SESSION_TOKEN');
    if (!token) return;
    await AV.User.become(token);
  }catch{ localStorage.removeItem('LC_SESSION_TOKEN'); }
}

/** ====== Authï¼ˆå³ä¸Šè§’ï¼‰ ====== */
const loginModal=document.getElementById('loginModal'), loginClose=document.getElementById('loginClose'),
      loginEmail=document.getElementById('loginEmail'), loginPass=document.getElementById('loginPass'),
      loginDo=document.getElementById('loginDo'), loginMsg=document.getElementById('loginMsg');
const signupModal=document.getElementById('signupModal'), signupClose=document.getElementById('signupClose'),
      signupEmail=document.getElementById('signupEmail'), signupPass=document.getElementById('signupPass'),
      signupNick=document.getElementById('signupNick'), signupDo=document.getElementById('signupDo'),
      signupMsg=document.getElementById('signupMsg');

function openLogin(){ loginEmail.value='';loginPass.value='';loginMsg.textContent=''; loginModal.classList.add('show'); document.body.style.overflow='hidden';}
function closeLogin(){ loginModal.classList.remove('show'); document.body.style.overflow='';}
function openSignup(pref=''){ signupEmail.value=pref||''; signupPass.value=''; signupNick.value=''; signupMsg.textContent='';
  signupModal.classList.add('show'); document.body.style.overflow='hidden';}
function closeSignup(){ signupModal.classList.remove('show'); document.body.style.overflow='';}
loginClose.addEventListener('click', closeLogin); signupClose?.addEventListener('click', closeSignup);
document.getElementById('gotoSignup').addEventListener('click', ()=>{ closeLogin(); openSignup(loginEmail.value||''); });

function renderAuthArea(){
  const u = AV.User.current();
  if (!u){
    UI.authArea.innerHTML = `<button id="btnLogin" class="btn small">ç™»å…¥</button>`;
    document.getElementById('btnLogin').addEventListener('click', openLogin);
  }else{
    const nick = u.get('nickname') || u.getUsername() || 'ä½¿ç”¨è€…';
    const avatar = u.get('avatar') || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2228%22 height=%2228%22><rect width=%2228%22 height=%2228%22 fill=%22%232b2637%22/></svg>';
    UI.authArea.innerHTML = `
      <div class="userbox">
        <img class="uavatar" src="${avatar}" alt="">
        <span class="uname">${nick}</span>
        <button id="btnLogout" class="btn small ghost">ç™»å‡º</button>
      </div>`;
    document.getElementById('btnLogout').addEventListener('click', async ()=>{
      await AV.User.logOut();
      localStorage.removeItem('LC_SESSION_TOKEN');
      location.reload(); // ç™»å‡ºå¾Œæ•´é åˆ·æ–°
    });
  }
}

/** ====== æˆå“¡æ¸…å–®ï¼ˆåªå¾ _User å–ï¼Œä¸é¡¯ç¤ºåœ¨ç·šç‹€æ…‹ï¼‰ ====== */
function renderPeopleList(){
  const arr = Array.from(state.people.values())
    .sort((a,b)=> (a.name||'').localeCompare(b.name||'','zh-Hant'));
  UI.people.innerHTML = '';
  arr.forEach(p=>{
    const li = document.createElement('li');
    li.className = 'person';
    li.innerHTML = `
      <img class="p-avatar" src="${p.avatar || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2228%22 height=%2228%22><rect width=%2228%22 height=%2228%22 fill=%22%232b2637%22/></svg>'}" alt="">
      <span class="p-name">${p.name || 'â€”'}</span>
    `;
    UI.people.appendChild(li);
  });
  UI.onlineCount.textContent = ''; // ä¸é¡¯ç¤ºåœ¨ç·šæ•¸
}

async function fetchAllMembers(){
  try{
    const q = new AV.Query(AV.User);     // â† é€™è¡Œæ˜¯é—œéµï¼šæŸ¥ _User ç”¨ AV.User
    q.select(['nickname','avatar']);     // åªæ‹¿å…¬é–‹éœ€è¦çš„æ¬„ä½
    q.limit(1000);                       // å¤ ä½ ç¾åœ¨ç”¨ï¼›å¤šäººå†åšåˆ†é 
    const rows = await q.find();

    if (!rows.length) {
      UI.people.innerHTML = '<li class="empty">ç›®å‰æ²’æœ‰å¯é¡¯ç¤ºçš„æˆå“¡ï¼ˆ_User æœªé–‹æ”¾æŸ¥è©¢æˆ–å°šç„¡è¨»å†Šï¼‰</li>';
      return;
    }

    const map = new Map();
    rows.forEach(u=>{
      map.set(u.id, {
        userId: u.id,
        name:   u.get('nickname') || '(æœªè¨­å®šæš±ç¨±)',
        avatar: u.get('avatar') || ''
      });
    });
    state.people = map;
    renderPeopleList();
  }catch(e){
    // æŠŠéŒ¯èª¤åŸå› ç›´æ¥é¡¯ç¤ºåœ¨å´æ¬„ï¼Œæ–¹ä¾¿ä½ æ’æŸ¥ï¼ˆä¾‹å¦‚ 119 æ¬Šé™éŒ¯èª¤ï¼‰
    console.warn('[Members] fetchAllMembers failed:', e);
    UI.people.innerHTML =
      `<li class="empty">è¼‰å…¥æˆå“¡å¤±æ•—ï¼š${e && (e.message || e.code) || 'æœªçŸ¥éŒ¯èª¤'}<br>
      è«‹åˆ° LeanCloud å¾Œå°æŠŠ _User çš„ Find/Get é–‹çµ¦ Publicï¼Œä¸¦é–‹æ”¾ nicknameã€avatar å¯è®€ã€‚</li>`;
  }
}

/** ====== èŠå¤©ï¼ˆæ²¿ç”¨åŸæœ¬ï¼‰ ====== */
const ChatMessage = AV.Object.extend('ChatMessage');

async function sendMessage(text){
  const u = AV.User.current();
  if(!u){ openLogin(); return; }
  text = String(text || '').trim();
  if(!text) return;

  try{
    const msg = new ChatMessage();     // â† ç”¨å·²å®šç¾©çš„ Class
    msg.set('roomId', state.roomId);
    msg.set('text', text);
    msg.set('authorId', u.id);
    msg.set('authorName', u.get('nickname') || u.getUsername() || 'åŒ¿å');
    msg.set('authorAvatar', u.get('avatar') || '');

    const acl = new AV.ACL();
    acl.setPublicReadAccess(true);
    acl.setWriteAccess(u, true);
    msg.setACL(acl);

    const saved = await msg.save();
    renderMsg(saved, 'append');
    scrollToBottom();
  }catch(e){
    console.error('[sendMessage] failed', e);
    throw e; // å¾€å¤–ä¸Ÿçµ¦ä¸Šé¢ alert
  }
}

function renderMsg(o, where='append'){
  const me = AV.User.current()?.id;
  const you = o.get('authorId') === me;

  const div = document.createElement('div');
  div.className = 'msg ' + (you ? 'you' : 'other');
  div.dataset.id = o.id;

  const avatar = document.createElement('img');
  avatar.className='avatar';
  avatar.src = o.get('authorAvatar') || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2236%22 height=%2236%22><rect width=%2236%22 height=%2236%22 fill=%22%232b2637%22/></svg>';
  avatar.alt = '';

  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = o.get('text') || '';

  const meta = document.createElement('div');
  meta.className = 'meta';
  const name = document.createElement('span'); name.className='author'; name.textContent = o.get('authorName') || 'â€”';
  const time = document.createElement('span'); time.className='time';
  const t = o.createdAt ? new Date(o.createdAt) : new Date();
  time.textContent = 'ã€€' + t.toLocaleString('zh-TW', {hour12:false});
  meta.appendChild(name); meta.appendChild(time);

  // åªæœ‰è‡ªå·±çš„è¨Šæ¯æ‰é¡¯ç¤ºåˆªé™¤
  if (you){
    const del = document.createElement('button');
    del.textContent = 'åˆªé™¤';
    del.className = 'btn small ghost';
    del.style.marginLeft = '8px';
    del.addEventListener('click', async ()=>{
      if(!confirm('ç¢ºå®šåˆªé™¤æ­¤è¨Šæ¯ï¼Ÿ')) return;
      try{
        await AV.Object.createWithoutData('ChatMessage', o.id).destroy();
        div.remove();
      }catch(e){
        console.error('[delete] failed', e);
        alert('åˆªé™¤å¤±æ•—ï¼š' + (e.code || '') + ' ' + (e.message || e));
      }
    });
    meta.appendChild(del);
  }

  const box = document.createElement('div');
  box.className = 'content';
  box.appendChild(bubble); box.appendChild(meta);

  div.appendChild(avatar); div.appendChild(box);

  UI.list.querySelector('.empty')?.remove();
  if (where === 'prepend') UI.list.prepend(div); else UI.list.appendChild(div);
}
function scrollToBottom(){ UI.list.scrollTop = UI.list.scrollHeight + 100; }

async function fetchLatest(limit=50){
  if(state.fetching) return; state.fetching=true;
  const q = new AV.Query('ChatMessage');
  q.equalTo('roomId', state.roomId);
  q.descending('createdAt'); q.limit(limit);
  const rows = await q.find();
  UI.list.innerHTML = rows.length ? '' : '<div class="empty">é‚„æ²’æœ‰è¨Šæ¯ï¼Œæ‰“å€‹æ‹›å‘¼å§ï½</div>';
  rows.reverse().forEach(o=>renderMsg(o,'append'));
  state.oldest = rows[0]?.createdAt || null;
  state.fetching=false;
  scrollToBottom();
}
async function loadOlder(limit=30){
  if(!state.oldest || state.fetching) return;
  state.fetching=true;
  const q = new AV.Query('ChatMessage');
  q.equalTo('roomId', state.roomId);
  q.lessThan('createdAt', state.oldest);
  q.descending('createdAt'); q.limit(limit);
  const rows = await q.find();
  rows.forEach(o=>renderMsg(o,'prepend'));
  if(rows.length) state.oldest = rows[rows.length-1].createdAt;
  state.fetching=false;
}
async function subscribeLive(){
  try{ await state.liveSub?.unsubscribe(); }catch{}
  state.liveSub = null;

  try{
    const q = new AV.Query('ChatMessage').equalTo('roomId', state.roomId);
    const sub = await q.subscribe();
    state.liveSub = sub;

    // æ–°è¨Šæ¯
    sub.on('create', (o)=>{ renderMsg(o,'append'); scrollToBottom(); });

    // âœ… åˆªé™¤äº‹ä»¶ï¼šæŠŠç•«é¢ä¸Šçš„é‚£ä¸€å‰‡ç§»é™¤
    sub.on('delete', (o)=>{
      const el = UI.list.querySelector(`[data-id="${o.id}"]`);
      if (el) el.remove();
    });

    // ï¼ˆå¯é¸ï¼‰æ›´æ–°äº‹ä»¶ï¼šæœ‰äººç·¨è¼¯è¨Šæ¯æ™‚åŒæ­¥
    sub.on('update', (o)=>{
      const el = UI.list.querySelector(`[data-id="${o.id}"] .bubble`);
      if (el) el.textContent = o.get('text') || '';
    });

  }catch(e){
    console.warn('[LiveQuery] ä¸å¯ç”¨ï¼Œæ”¹ç”¨è¼ªè©¢', e);

    // ===== 2) è¼ªè©¢ fallbackï¼šåŒæ­¥åˆªé™¤ =====
    setInterval(async ()=>{
      // å–ã€Œè¶³å¤ å¤šã€çš„æœ€æ–°è¨Šæ¯ï¼Œè‡³å°‘è¦†è“‹ä½ ç•«é¢ä¸Šçœ‹å¾—åˆ°çš„æ•¸é‡
      const want = Math.max(200, UI.list.querySelectorAll('.msg').length + 20);

      const q = new AV.Query('ChatMessage')
        .equalTo('roomId', state.roomId)
        .descending('createdAt')
        .limit(want);

      const rows = await q.find();

      // å…ˆè£œä¸Šæ–°è¨Šæ¯
      const aliveSet = new Set();
      rows.reverse().forEach(o=>{
        aliveSet.add(o.id);
        if(!UI.list.querySelector(`[data-id="${o.id}"]`)){
          renderMsg(o,'append');
        }
      });

      // âœ… å†æŠŠã€Œé›²ç«¯å·²ä¸å­˜åœ¨ã€çš„è¨Šæ¯ç§»é™¤ï¼ˆåªé‡å°æœ€æ–° want ç¯„åœï¼‰
      Array.from(UI.list.querySelectorAll('.msg')).forEach(el=>{
        const id = el.dataset.id;
        // åªç§»é™¤æœ€è¿‘ç¯„åœä¸­ã€Œä¸åœ¨ aliveSetã€çš„ï¼›è¼ƒèˆŠï¼ˆä¸åœ¨æœ€è¿‘ wantï¼‰å‰‡ä¿ç•™
        if (!aliveSet.has(id)) {
          // åˆ¤æ–·ä¸€ä¸‹é€™å‰‡è¨Šæ¯æ˜¯ä¸æ˜¯è½åœ¨ã€Œæœ€è¿‘ wantã€ç¯„åœï¼ˆä»¥ DOM é †åºä¼°ï¼‰
          // å¦‚æœä½ çš„èŠå¤©çª—é€šå¸¸åªæ”¾æœ€è¿‘å¹¾ç™¾å‰‡ï¼Œé€™æ®µå°±è¶³å¤ äº†
          el.remove();
        }
      });

    }, 4000);
  }
}

/** ====== äº‹ä»¶ ====== */
document.getElementById('loginDo').addEventListener('click', async ()=>{
  const email=(loginEmail.value||'').trim(), pass=(loginPass.value||'').trim();
  if(!isEmail(email)) return loginMsg.textContent='è«‹å¡«å¯«æ­£ç¢ºçš„é›»å­éƒµç®±';
  if(!isAlnum6Plus(pass)) return loginMsg.textContent='å¯†ç¢¼è‡³å°‘ 6 ä½è‹±æ•¸';
  loginDo.disabled=true; loginMsg.textContent='ç™»å…¥ä¸­â€¦';
  try{
    const u = await AV.User.logIn(email, pass);
    if (isEmail(email) && !u.getEmail()){ u.setEmail(email); await u.save(); }
    persistSession(u);
    location.reload(); // ç™»å…¥å¾Œåˆ·æ–°
  }catch(e){
    loginMsg.textContent = (e.code===210)?'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤':(e.message||'ç™»å…¥å¤±æ•—');
  }finally{ loginDo.disabled=false; }
});

signupDo.addEventListener('click', async ()=>{
  const email=(signupEmail.value||'').trim(),
        pass=(signupPass.value||'').trim(),
        nick=(signupNick.value||'').trim();
  if(!isEmail(email)) return signupMsg.textContent='è«‹å¡«å¯«æ­£ç¢ºçš„é›»å­éƒµç®±';
  if(!isAlnum6Plus(pass)) return signupMsg.textContent='å¯†ç¢¼è‡³å°‘ 6 ä½è‹±æ•¸';
  if(!nick) return signupMsg.textContent='è«‹å¡«å¯«æš±ç¨±';

  async function uploadSignupAvatarIfAny(){
    const input = document.getElementById('signupAvatarInput');
    const f = input?.files?.[0];
    if(!f) return null;
    const file = new AV.File(f.name, f);
    await file.save();
    return file.url();
  }

  signupDo.disabled=true; signupMsg.textContent='å»ºç«‹ä¸­â€¦';
  try{
    const avatarUrl = await uploadSignupAvatarIfAny();
    const user = new AV.User();
    user.setUsername(email);
    user.setPassword(pass);
    user.setEmail(email);
    user.set('nickname', nick);
    if (avatarUrl) user.set('avatar', avatarUrl);
    await user.signUp();

    try{ localStorage.setItem('LC_SESSION_TOKEN', user.getSessionToken()); }catch{}
    location.reload(); // è¨»å†Šå¾Œåˆ·æ–°
  }catch(e){
    signupMsg.textContent = e.message || 'è¨»å†Šå¤±æ•—';
  }finally{
    signupDo.disabled=false;
  }
});
// é€å‡ºæŒ‰éˆ•ï¼ˆé»æ“Šï¼‰
document.getElementById('send').addEventListener('click', async ()=>{
  const input = document.getElementById('msgInput');
  const btn = document.getElementById('send');
  const v = (input.value || '').trim();
  if (!v) return;

  btn.disabled = true;
  try {
    await sendMessage(v);
    input.value = '';
  } catch (e) {
    console.error('[UI] send failed:', e);
    alert('é€å‡ºå¤±æ•—ï¼š' + (e.code || '') + ' ' + (e.message || e));
  } finally {
    btn.disabled = false;
  }
});

// åœ¨è¼¸å…¥æ¡†æŒ‰ Enter é€å‡º
document.getElementById('msgInput').addEventListener('keydown', (e)=>{
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    document.getElementById('send').click();
  }
});
// è‡ªå‹•é•·é«˜
const autoGrow = (el)=>{
  el.style.height = 'auto';
  const newH = Math.min(el.scrollHeight, 160); // èˆ‡ CSS çš„ max-height ä¸€è‡´
  el.style.height = newH + 'px';
};
const msgInputEl = document.getElementById('msgInput');
msgInputEl.addEventListener('input', ()=>autoGrow(msgInputEl));
setTimeout(()=>autoGrow(msgInputEl)); // åˆå§‹å‘¼å«ä¸€æ¬¡

// Enter é€å‡ºï¼ŒShift+Enter æ›è¡Œ
msgInputEl.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    document.getElementById('send').click();
  }
});
/** ====== å•Ÿå‹• ====== */
(async function start(){
  let peopleSub = null;   // æˆå“¡ LiveQuery è¨‚é–±
let peoplePoll = null;  // è¼ªè©¢è¨ˆæ™‚å™¨

async function subscribePeopleLive(){
  try { await peopleSub?.unsubscribe(); } catch {}
  peopleSub = null;

  try{
    // ç›´æ¥è¨‚é–± _Userï¼ˆLeanCloud å…è¨±ï¼Œå‰ææ˜¯ LiveQuery é–‹å•Ÿï¼‹æ¬Šé™å…è¨±ï¼‰
    const q = new AV.Query(AV.User);
    q.select(['nickname','avatar']);
    const sub = await q.subscribe();
    peopleSub = sub;

    // æ–°å¢ä½¿ç”¨è€…
    sub.on('create', (u)=>{
      state.people.set(u.id, {
        userId: u.id,
        name: u.get('nickname') || '(æœªè¨­å®šæš±ç¨±)',
        avatar: u.get('avatar') || ''
      });
      renderPeopleList();
    });

    // è³‡æ–™è®Šæ›´ï¼ˆæš±ç¨±ï¼é ­è²¼ï¼‰
    sub.on('update', (u)=>{
      const old = state.people.get(u.id) || {userId:u.id};
      state.people.set(u.id, {
        ...old,
        name: u.get('nickname') || '(æœªè¨­å®šæš±ç¨±)',
        avatar: u.get('avatar') || ''
      });
      renderPeopleList();
    });

    // åˆªé™¤ï¼ˆè¨»éŠ·ï¼‰
    sub.on('delete', (u)=>{
      state.people.delete(u.id);
      renderPeopleList();
    });

  }catch(e){
    console.warn('[People] LiveQuery ä¸å¯ç”¨ï¼Œæ”¹ç”¨è¼ªè©¢', e);
    // ===== è¼ªè©¢å‚™æ´ï¼šæ¯ 30 ç§’æ•´æ’ˆä¸€æ¬¡ï¼Œåšé›†åˆå·®ç•° =====
    clearInterval(peoplePoll);
    peoplePoll = setInterval(syncPeopleOnce, 5_000);
    // å…ˆè·‘ä¸€æ¬¡ï¼Œé¦¬ä¸ŠåŒæ­¥
    syncPeopleOnce();
  }
}

// è¼ªè©¢æ™‚ç”¨ï¼šæŠŠé ç«¯æ•´æ‰¹èˆ‡æœ¬åœ° map åšã€Œå¢ï¼æ”¹ï¼åˆªã€å·®ç•°åŒæ­¥
async function syncPeopleOnce(){
  try{
    const q = new AV.Query(AV.User);
    q.select(['nickname','avatar']);
    q.limit(1000);
    const rows = await q.find();

    const newMap = new Map();
    rows.forEach(u=>{
      newMap.set(u.id, {
        userId: u.id,
        name: u.get('nickname') || '(æœªè¨­å®šæš±ç¨±)',
        avatar: u.get('avatar') || ''
      });
    });

    // æ¯”å°å·®ç•°ï¼ˆæ–°å¢/æ›´æ–°/åˆªé™¤ï¼‰
    let changed = false;

    // æ–°å¢æˆ–æ›´æ–°
    newMap.forEach((v, id)=>{
      const old = state.people.get(id);
      if (!old || old.name !== v.name || old.avatar !== v.avatar){
        state.people.set(id, v);
        changed = true;
      }
    });

    // åˆªé™¤ï¼ˆæœ¬åœ°æœ‰ä½†é ç«¯æ²’ï¼‰
    Array.from(state.people.keys()).forEach(id=>{
      if(!newMap.has(id)){
        state.people.delete(id);
        changed = true;
      }
    });

    if (changed) renderPeopleList();
  }catch(err){
    console.warn('[People] sync failed:', err);
  }
}
  await autoLoginFromToken();
  renderAuthArea();

  // åªæ’ˆæˆå“¡ï¼Œä¸é¡¯ç¤ºåœ¨ç·š
  await fetchAllMembers();
  await fetchAllMembers();     // ç¬¬ä¸€æ¬¡å¡«æ»¿
  subscribePeopleLive();       // ä¹‹å¾ŒæŒçºŒåŒæ­¥ï¼ˆLive æˆ–è¼ªè©¢ï¼‰

  // èŠå¤©
  await fetchLatest();
  await subscribeLive();
})();
// ä½¿ç”¨è€…è¨»å†Š / ç™»å‡º / åˆªå¸³å¾Œï¼Œé‡æŠ“ä¸€æ¬¡æˆå“¡
document.getElementById('signupDo')?.addEventListener('click', ()=> setTimeout(syncPeopleOnce, 1500));
document.getElementById('btnLogout')?.addEventListener('click', ()=> setTimeout(syncPeopleOnce, 1500));

// é‡æ–°èšç„¦é ç±¤æ™‚ä¹ŸåŒæ­¥ï¼ˆè·¨åˆ†é è®Šæ›´æ™‚å¾ˆå¥½ç”¨ï¼‰
document.addEventListener('visibilitychange', ()=>{ 
  if(!document.hidden) syncPeopleOnce(); 
});
</script>
<!--=================-->
<p style="text-align: center; font-size: 13px; color: #999; margin-top: 40px;">
  ğŸ¾ Â© 2024 yinnlimçš„å°å®‡å®™ï½œå…§å®¹èˆ‡è¨­è¨ˆçš†ç”±ç³–ç³–æœ¬äººç”¨æ„›è£½ä½œ ğŸ’<br>
  æœªç¶“æˆæ¬Šè«‹å‹¿éš¨æ„ä½¿ç”¨ã€ç›œè½‰å–” ğŸ™…â€â™€ï¸ è¬è¬ä½ çš„å°Šé‡èˆ‡æº«æŸ” ğŸ’Œ
</p>
</body>
</html>