<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cloudï½œé›²ç«¯è²¼æ–‡ç‰†</title>
<link rel="icon" href="/favicon.ico" />
<style>
  :root{
    --bg1:#14121a; --bg2:#1a1722;
    --card:rgba(255,255,255,.06);
    --text:#efe9ff; --muted:#b9b5c8;
    --accent:#b78ad3; --edge:rgba(255,255,255,.12);
    --shadow:0 12px 30px rgba(0,0,0,.35);
    --maxw:1040px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--text);
    background:
      radial-gradient(1000px 600px at 70% -10%, rgba(153,227,254,.25), transparent 60%),
      linear-gradient(160deg,var(--bg1),var(--bg2));
    font-family: ui-sans-serif, system-ui, "Noto Sans TC","Microsoft JhengHei", Arial, sans-serif;
    min-height:100dvh;
  }
  .wrap{max-width:var(--maxw); margin:0 auto; padding:18px 16px}
  .top{display:flex; flex-wrap:wrap; gap:10px; align-items:baseline; margin-bottom:12px}
  .time{
  font-size:clamp(28px,6vw,52px);
  font-weight:800;
  letter-spacing:.02em;
  white-space:nowrap;
  font-variant-numeric: tabular-nums;   /* ä½¿ç”¨ç­‰å¯¬æ•¸å­— */
  font-feature-settings: "tnum";
  width: 7.3ch;                          /* é ç•™ã€Œ00:00:00 â‰ˆã€çš„æœ€å¤§å¯¬åº¦ */
  text-align:right;                     /* å…§å®¹é å³ï¼Œè¦–è¦ºæ›´ç©©å®š */
  line-height:1;                        /* é¿å…è¡Œé«˜é€ æˆçš„ä¸Šä¸‹è·³å‹• */
}
  .badges{ display:flex; gap:8px; flex-wrap:wrap }
  .badge{ font-size:.85rem; padding:6px 10px; border:1px solid var(--edge); border-radius:999px; background:rgba(255,255,255,.06) }
  .badge.dim{ color:var(--muted) }
  .list{ display:grid; grid-template-columns: repeat(auto-fill,minmax(280px,1fr)); gap:12px }
  .card{
    background:var(--card); border:1px solid var(--edge); border-radius:14px;
    box-shadow:var(--shadow); padding:14px; display:flex; flex-direction:column; min-height:180px;
  }
  /* å¡ç‰‡æ¨™é¡Œï¼šåªé¡¯ç¤º 1 è¡Œï¼Œè¶…å‡ºçœç•¥ï¼ˆç„¡è­¦å‘Šï¼‰ */
/* å¡ç‰‡æ¨™é¡Œï¼š1 è¡Œ + çœç•¥è™Ÿï¼ˆä¸æœƒè­¦å‘Šï¼‰ */
.card .title{
  font-weight:700; font-size:1.05rem; margin-bottom:6px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* å…§æ–‡ï¼šå›ºå®š 2 è¡Œé«˜åº¦ + è¦–è¦ºçœç•¥è™Ÿï¼ˆç„¡å‰ç¶´ã€é›¶è­¦å‘Šï¼‰ */
.card .content{
  --lines: 2;        /* è¦å¹¾è¡Œå°±åœ¨é€™è£¡æ”¹ */
  --lh: 1.55;        /* èˆ‡ä½ çš„ line-height ä¸€è‡´ */
  line-height: calc(var(--lh) * 1em);
  max-height: calc(var(--lines) * var(--lh) * 1em);
  overflow: hidden;
  position: relative;           /* çµ¦ ::after åƒè€ƒ */
}

/* å³ä¸‹è§’åšä¸€å€‹æ·¡å…¥èƒŒæ™¯ä¸¦æ”¾ä¸Šä¸€å€‹ã€Œâ€¦ã€ */
.groups > .group .card .content::after { 
  content:'........';
  position: absolute;
  right: 6px;
  bottom: 0;
  height: calc(var(--lh) * 1em);
  display: inline-block;
  padding-left: .35em;
  /* å¾é€æ˜æ·¡åˆ°å¡ç‰‡åº•è‰²ï¼Œé¿å…çªå…€ï¼›var(--card) å°±æ˜¯ä½ å¡ç‰‡èƒŒæ™¯ */
  background: linear-gradient(90deg, transparent, var(--card));
}

/* ç¸®ç•¥åœ–ï¼šåªæ”¾ç¬¬ 1 å¼µï¼Œåšå¾—å¾ˆå° */
.card .gallery{ margin-top:8px; display:flex; gap:8px; justify-content:flex-start }


/* å¡ç‰‡å¯é» */
.card{ cursor:pointer }
  .meta{ display:flex; gap:6px; flex-wrap:wrap; margin:6px 0 10px }
  .content{
    white-space:pre-wrap; line-height:1.55; color:var(--text);
    display:-webkit-box; line-clamp: 8; /* éƒ¨åˆ†ç€è¦½å™¨æ”¯æ´ */
  overflow:hidden;
  display: -webkit-box;
-webkit-box-orient: vertical;
overflow: hidden;
  }
  .btn{ 
    background:transparent; 
    color:var(--text); 
    border:1px solid var(--edge); 
    border-radius:10px; 
    padding:8px 12px;
    cursor:pointer             
  }
  .btn.more{ width:100%; margin-top:14px }
  .empty{ color:var(--muted); text-align:center; padding:30px 0 }
  #backToTop {
  position: fixed;
  bottom: 40px;
  right: 40px;
  z-index: 99;
  display: none;        /* é è¨­éš±è— */
  background: #bb8cd3;  /* ä½ çš„ä¸»é¡Œè‰² */
  color: #fff;
  border: none;
  cursor: pointer;
  height: 40px;         /* å›ºå®šé«˜åº¦ */
  padding: 0 20px;      /* å·¦å³æ¯”é«˜åº¦å¤§ */
  border-radius: 20px;  /* é«˜åº¦çš„ä¸€åŠ â†’ è—¥ä¸¸ */
  font-size: 14px;
  font-weight: bold;
  transition: opacity 0.3s, transform 0.2s;
}

#backToTop:hover {
  opacity: 0.85;
  transform: translateY(-2px);
}
/* ===== åˆ·æ–°æŒ‰éˆ• ===== */
/* ===== æ²’æœ‰èƒŒæ™¯çš„æ°£æ³¡åˆ·æ–°æŒ‰éˆ• ===== */
#refreshBtn {
  display: none;
  position: fixed;
  bottom: 100px;     /* è·é›¢åº•éƒ¨ */
  right: 40px;       /* è·é›¢å³é‚Š */
  z-index: 99;
  font-size: 28px;   /* ğŸ«§ å¤§å° */
  background: none;  /* æ²’èƒŒæ™¯ */
  border: none;      /* æ²’é‚Šæ¡† */
  cursor: pointer;
  padding: 0;
  line-height: 1;
  transition: transform 0.2s ease;
}

#refreshBtn:hover {
  transform: scale(1.3);  /* æ»‘éæ”¾å¤§ä¸€é»é» */
}
</style>
<style>
    /* ä½¿ç”¨è€…åˆ—ï¼ˆæ™‚é˜ä¸‹æ–¹ï¼‰ */
.userbar{
  display:flex; align-items:center; gap:10px; margin-top:6px;
}
.userbar img{
  width:32px; height:32px; border-radius:50%; object-fit:cover; border:1px solid var(--edge);
}
.userbar .name{ font-weight:700 }
.userbar .muted{ color:var(--muted); font-size:.9rem }
.userbar .btn{ padding:6px 10px; border-radius:10px }

/* ç°¡æ˜“ç™»å…¥å½ˆçª— */
.modal{ position:fixed; inset:0; display:none; place-items:center; z-index:1000;
  background:rgba(0,0,0,.45); -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px);}
.modal.show{ display:grid }
.modal-box{ width:min(92vw,480px); background:var(--card); border:1px solid var(--edge);
  border-radius:14px; padding:14px; box-shadow:var(--shadow) }
.modal .row{ display:flex; gap:8px; flex-wrap:wrap }
.input{ width:100%; background:rgba(255,255,255,.06); color:var(--text);
  border:1px solid var(--edge); border-radius:10px; padding:10px 12px; }
.modal .bar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }
/*=================*/
.avatar-picker{
  display:inline-block; cursor:pointer; border:1px solid var(--edge);
  border-radius:12px; padding:8px; background:rgba(255,255,255,.06);
}
#avatarPreview{
  width:96px; height:96px; border-radius:50%; object-fit:cover; display:block;
}
.seg-btn{
  background:transparent; color:var(--text); border:1px solid var(--edge);
  border-radius:999px; padding:6px 10px; cursor:pointer
}
.seg-btn.active{ background:var(--accent); color:#120d18; border-color:transparent }
.dimmed{ opacity:.5; pointer-events:none; }
/*===========*/
/* ç¸®ç•¥åœ–ç•«å»Šï¼šé å·¦ã€åœ¨å…§æ–‡ä¸‹é¢ */
.card .gallery{
  margin-top:8px;
  display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-start;
}

/* ä½œè€…åˆ— */
.author{
  display:flex; align-items:center; gap:8px; margin:8px 0 6px;
  color:var(--muted); font-size:.9rem;
}
.author img{ width:24px; height:24px; border-radius:50%; object-fit:cover; border:1px solid var(--edge) }

/* è©³æƒ…é ï¼ˆå–®é ï¼‰ */
#detailView{ display:none; }
.detail-wrap{ max-width:var(--maxw); margin:0 auto; padding:18px 16px }
.detail-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px }
.detail-title{ font-size:1.2rem; font-weight:800; margin:0 0 6px }
.detail-meta{ color:var(--muted); display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px }

     .searchbar{ display:flex; gap:8px; align-items:center; margin:6px 0 10px }
.search-input{
  flex:1 1 260px; background:rgba(255,255,255,.06); color:var(--text);
  border:1px solid var(--edge); border-radius:10px; padding:10px 12px;
}
/* === è©³æƒ…é åœ–ç‰‡ï¼šå›ºå®šå°ºå¯¸ã€ä¸‰å¼µä¸€æ’ã€è¶…éè‡ªå‹•æ›è¡Œ === */
.detail-gallery {
  display: grid;
  grid-template-columns: repeat(3, 0fr); /* æ°¸é ä¸‰æ¬„ */
  gap: 8px;                               /* åœ–ç‰‡é–“è· */
  align-items: start;
}

.detail-gallery img{
  width: auto;
  height: 64px;          /* å›ºå®šé«˜åº¦ï¼Œä½ æƒ³æ”¾å¤§å°±èª¿æ•´é€™æ•¸å€¼ */
  object-fit: contain;      /* å¡«æ»¿è£åˆ‡ï¼Œæƒ³å®Œæ•´é¡¯ç¤ºæ”¹æˆ contain */
  border-radius: 10px;
  display: block;
  background: transparent;
  border: none;
}
</style>
<style>
    /* è®“ â‰ˆ æ¼‚åœ¨æ—¥æœŸ badge ä¸Šæ–¹çš„å°æç¤º */
.badges { position: relative; }
#dateBadge { position: relative; }

/* é è¨­ä¸é¡¯ç¤º */
#dateBadge::before{
  content:'â‰ˆ';
  position:absolute;
  top:-0.9em;        /* æ§åˆ¶åœ¨æ—¥æœŸä¸Šæ–¹ */
  right:6px;         /* ä½ å¯ä»¥æ”¹æˆ left:6px çœ‹ç¿’æ…£ */
  font-size:.7em;    /* æ¯”æ—¥æœŸå°ä¸€é» */
  color:var(--muted);
  opacity:0;
  transition:opacity .15s ease;
  pointer-events:none;
}

/* æœ‰è¿‘ä¼¼ï¼ˆä¼°ç®—ï¼‰æ™‚æ‰é¡¯ç¤º */
#dateBadge[data-approx="1"]::before { opacity:.95; }
/* ä¿æŒä½ åŸæœ¬çš„ .time ä¸è®Šï¼åªåŠ é€™å…©æ®µ */
/* 1) è®“ #time æˆç‚ºå®šä½å®¹å™¨ */
#time { position: relative; }

/* 2) æµ®åœ¨ç§’æ•¸å³ä¸Šçš„ â‰ˆ */
#time::after{
  content:'â‰ˆ';
  position:absolute;
  top:-0.7em;       /* å¾€ä¸Šå¤šæŠ¬ä¸€é» */
  right:-1ch;       /* å¾€å³æ¨å‡ºç§’æ•¸å¤–é¢ */
  font-size:.55em;
  line-height:1;
  color:var(--muted);
  opacity:0;
  pointer-events:none;
  transition:opacity .15s ease;
}
#time.approx::after { opacity:.95; }  /* éœ€è¦æ™‚é¡¯ç¤º */
</style>
<style>
    /*ç·š00000000------------000*/
    /* === ä¾ä½œè€…åˆ†ç¾¤ + ç´«å¤–ç·šè‰²æ™‚é–“ç·š === */
.groups{ display:block }               /* è®“å®¹å™¨æ”¹ç‚ºå–®æ¬„ç›´å¼ */
.group{ background:var(--card); border:1px solid var(--edge); border-radius:14px; padding:14px; margin-bottom:14px; box-shadow:var(--shadow)}
.group-head{ display:flex; align-items:center; gap:10px; margin-bottom:8px }
.group-head img{ width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid var(--edge) }
.group-head .name{ font-weight:800 }
.group-head .sub{ color:var(--muted); font-size:.9rem }

.timeline{ position:relative; margin:6px 0 0 14px; padding-left:18px; list-style:none }
.timeline::before{
  content:''; position:absolute; left:0; top:0; bottom:0;
  width:2px; border-left:2px dashed var(--accent); opacity:.9;   /* ç´«å¤–ç·šè‰²ï¼ˆ=accentï¼‰ */
}
.node{ position:relative; margin:10px 0 }
.node .dot{
  position:absolute; left:-11px; top:.55em; width:10px; height:10px; border-radius:50%;
  background:var(--accent); box-shadow:0 0 10px var(--accent);
}
.node .post{ border:1px solid var(--edge); border-radius:12px; padding:10px; background:rgba(255,255,255,.04) }
.node .pub{ font-size:.85rem; color:var(--muted); margin-bottom:6px }  /* ç™¼ä½ˆæ™‚é–“ */
.node .title{ font-weight:700; margin-bottom:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.node .content{ white-space:pre-wrap; line-height:1.5; max-height:calc(1.5em*4); overflow:hidden; position:relative }
.node .content::after{ content:'â€¦â€¦'; position:absolute; right:6px; bottom:0; background:linear-gradient(90deg,transparent,rgba(255,255,255,.04)); padding-left:.3em }
/* ç¸®ç•¥åœ–æ¨£å¼ï¼ˆå’ŒèˆŠå¡ç‰‡ä¸€è‡´ï¼‰ */
.node .gallery{
  margin-top:8px;
  display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-start;
}

.node .actions{ display:flex; 
gap:8px; 
justify-content:flex-end; 
margin-top:8px 
}
/**/
/* === ä½¿ç”¨è€…ç¾¤çµ„ï¼ˆé ­è²¼+æš±ç¨±ï¼Œä¸Šæ–¹ï¼‰ === */
.user-group{
  background:var(--card);
  border:1px solid var(--edge);
  border-radius:14px;
  box-shadow:var(--shadow);
  padding:12px;
  margin-bottom:14px;
}
.user-head{
  display:flex; align-items:center; gap:10px; margin-bottom:8px;
}
.user-head img{ width:36px; height:36px; border-radius:50%; object-fit:cover; border:1px solid var(--edge) }
.user-head .name{ font-weight:800; }

/* === æ©«å‘æ™‚é–“ç·šï¼šä¸Šæ–¹ä¸€æ¢ç·šï¼Œé …ç›®æ©«å‘æ’ç‰ˆï¼Œè¶…å‡ºæˆªæ–· === */
.timeline{
  position:relative;
  padding:14px 4px 8px;
  overflow:hidden;            /* é‡è¦ï¼šè¢å¹•ä¸å¤ å¯¬ç›´æ¥æˆªæ–· */
}
.timeline::before{
  content:"";
  position:absolute;
  left:0; right:0; top:24px;  /* ç·šçš„é«˜åº¦ */
  height:2px;
  background:linear-gradient(90deg, rgba(183,138,211,.9), rgba(183,138,211,.25));
  pointer-events:none;
}

/* ä¸€æ’æ©«å‘çš„è²¼æ–‡ç¯€é» */
/* å–ä»£åŸæœ¬çš„ .trow */
/* å–ä»£åŸæœ¬çš„ .trow â€”â€” é—œéµæ˜¯è¨˜ä½ gap å€¼ä¾›é€£ç·šä½¿ç”¨ */
.trow{
  --tgap: 12px;                 /* èˆ‡ .trow çš„ gap ç›¸åŒï¼Œå…©å¡ä¹‹é–“çš„è·é›¢ */
  display:flex;
  gap: var(--tgap);
  overflow-x:auto;
  overflow-y:hidden;
  -webkit-overflow-scrolling: touch;
}

/* é—œæ‰èˆŠç‰ˆã€Œå¡ç‰‡å·¦é‚Šçš„é»ã€ */
.titem::before{ display:none; }

/* æ™‚é–“è¡Œï¼ˆä¿æŒä½ åŸæœ¬è¨­å®šï¼‰ */
.titem .ts{
  position:relative;
  display:inline-flex;
  align-items:center;
  white-space:nowrap;
  color:var(--muted);
  font-size:.82rem;
  margin-bottom:6px;
  z-index:2;
}

/* å…©é¡†é»ï¼šå·¦(head) å³(tail) */
.titem .ts .ts-dot{
  width:8px; height:8px; border-radius:50%;
  background:var(--accent);
  box-shadow:0 0 10px var(--accent);
  flex:0 0 auto;
}
.titem .ts .ts-dot.head{ margin-right:6px; }
.titem .ts .ts-dot.tail{ margin-left:6px; position:relative; z-index:2; }

/* å¾ã€Œå°¾é»ã€æ¥åˆ°ä¸‹ä¸€å¼µçš„ã€Œé ­é»ã€ */
.titem:not(:last-child) .ts .ts-dot.tail::after{
  content:"";
  position:absolute;
  top:50%; left:100%;
  transform:translateY(-50%);
  width: var(--linkw, var(--tgap));   /* JS æœƒå¡æœ€ç²¾æº–çš„é•·åº¦ï¼›æ²’å¡å°±ç”¨ gap */
  border-top:2px dashed var(--accent);
  opacity:.95;
  pointer-events:none;
  z-index:2;
}
/* æ¯å€‹ç¯€é»ï¼ˆå°å¡ï¼‰ */
.titem{
  position:relative;
  flex:0 0 auto;
    width:300px;               /* â† åŸæœ¬æ˜¯ 170 */
}

/* === å›ºå®š Cloud åˆ—è¡¨ç¸®ç•¥åœ–å¤§å°ï¼ˆä¸æ”¹å¤–è§€ï¼Œåªå›ºå®šå°ºå¯¸ï¼‰ === */
</style>
<style>
/* ===== åˆ—è¡¨å¡ç‰‡ï¼šç¸®ç•¥åœ–åˆ—ï¼ˆèˆ‡ record.html ä¸€è‡´ï¼‰ ===== */
.thumb-bar{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.twrap{
  position:relative;
  display:inline-block;
  line-height:0;
}

.thumb-mini{
  width:70px;
  height:70px;
  object-fit:contain;     /* è¦è£åˆ‡æ»¿ç‰ˆå¯æ”¹ cover */
  border-radius:6px;
  background:transparent;
  flex:0 0 auto;
}
.thumb-more{
  position:absolute;
  right:4px;
  bottom:4px;
  padding:2px 6px;
  font-size:.78rem;
  line-height:1;
  color:#fff;
  background:rgba(0,0,0,.55);
  border-radius:999px;
  pointer-events:none;
  border:1px solid var(--edge);
}

/* ===== è©³æƒ…é åœ–ç‰‡ï¼ˆèˆ‡ record.html ä¸€è‡´ï¼‰ ===== */
.gallery{                  /* ç”¨çµ±ä¸€çš„ .gallery è¦†è“‹ detail ç”¨æ³• */
  display:block;
  margin-top:8px;
}
.picwrap{
  position:relative;
  display:inline-block;
  margin:8px 0;
}
.gallery img{
  display:block;
  max-width:100%;
  height:auto;
  border:none;
  background:transparent;
  border-radius:10px;
}
</style>
<style>
  /* === Cloud æ™‚é–“ç·šå°å¡ï¼šæ¨™é¡Œ + å…©è¡Œæ‘˜è¦ + çœç•¥è™Ÿï¼Œä¸è¢«ç¸®åœ–/è£é£¾è“‹ä½ === */
.tcard{
  border:1px solid var(--edge);
  border-radius:12px; 
  position: relative; 
  padding:10px; background:rgba(255,255,255,.04);
  display: flex;
  flex-direction: column;
  height: 280px;   
}

/* è®“æ¨™é¡Œ / meta / æ‘˜è¦ æ°¸é åœ¨ä¸Šå±¤ */
.tcard .title,
.tcard .meta,
.tcard .excerpt{
  position: relative;
  z-index: 2;
}

/* ç¸®åœ–å±¤ç´šæ¯”æ–‡å­—ä½ï¼Œé¿å…è“‹åˆ°æ¨™é¡Œ */
.tcard .thumb-bar,
.tcard .gallery{
  position: relative;
  z-index: 1;
}

/* æ¨™é¡Œï¼šå–®è¡Œçœç•¥ + ç½®ä¸­ */
.tcard .title{
  margin: 0 0 6px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-align: center;
  font-weight: 800;
}

/* å…©è¡Œæ‘˜è¦ï¼ˆiOS éœ€è¦ -webkit- å‰ç¶´ï¼‰ */
.tcard .excerpt{
  flex: 1 1 auto;
  min-width: 0;
  white-space: pre-wrap; /* ä¿ç•™æ›è¡Œ */
  line-height: 1.5;
  color: var(--ink);

  /* é‡å° WebKitï¼ˆChromeã€Safariã€Edgeï¼‰ */
    display: -webkit-box; /* ç”¨ WebKit çš„ç›’å­æ¨¡å‹ */
  display: box; /* æ¨™æº–åŒ–çš„å ä½å±¬æ€§ï¼Œè®“ç·¨è¼¯å™¨ä¸å ±éŒ¯ */
  -webkit-box-orient: vertical; /* ç§æœ‰å±¬æ€§ */
  box-orient: vertical; /* æ¨™æº–åŒ–çš„å ä½å±¬æ€§ */
  
  overflow: hidden;
  /* VS Code å°é€™å€‹æœƒè­¦å‘Šï¼ŒåŠ å€‹æ¨™æº–å±¬æ€§ä¸¦åˆ—å°±å¥½äº† */
  line-clamp: 2; /* æ¨™æº–å ä½ï¼Œéƒ¨åˆ†ç€è¦½å™¨å¿½ç•¥ */
  -webkit-line-clamp: 2; /* çœŸæ­£èµ·ä½œç”¨çš„ */

  /* é‡å° Firefox / å…¶ä»–ä¸æ”¯æ´ line-clamp çš„ç€è¦½å™¨ */
  overflow: hidden;
  text-overflow: ellipsis;
  max-height: calc(1.5em * 2); /* è¡Œé«˜ Ã— å…©è¡Œ */        /* çµ¦ ::after ç”¨ */
}

/* å›ºå®šã€Œåˆªé™¤ã€åˆ°å¡ç‰‡å³ä¸‹è§’ï¼Œä¸å‹• JS/HTML */
.tcard .actions{
  position: absolute;
  right: 8px;
  bottom: 8px;
  margin: 0;          /* ç§»é™¤åŸæœ¬çš„ margin-top:8px ä½”ä½ */
  z-index: 20;        /* è“‹éç¸®åœ–ä¸Šçš„ +N æ¨™ç±¤ */
}

/* ä¿éšªï¼šä»»ä½•èˆŠçš„ content é®ç½©ä¸è¦å½±éŸ¿å°å¡ */
.tcard .content::after{ display:none !important; }
</style>
</head>
<body>
  <div class="wrap">
    <header class="top" aria-live="polite">
      <div class="time" id="time">--:--:--</div>
      <div class="badges">
        <span class="badge" id="dateBadge">â€”</span>
        <span class="badge" id="gzBadge">â€”</span>
        <span class="badge dim" id="precBadge">â€”</span>
        <span class="badge dim" id="locBadge">â€”</span>
        <span class="badge dim" id="cloudStatus">é›²ç«¯ï¼šé€£ç·šä¸­â€¦</span>
      </div>
      <!-- ä½¿ç”¨è€…åˆ—ï¼ˆç™»å…¥å¾Œæœƒé¡¯ç¤ºé ­è²¼ï¼‹æš±ç¨±ï¼›æœªç™»å…¥é¡¯ç¤ºæŒ‰éˆ•ï¼‰ -->
        <div id="userBar" class="userbar" aria-live="polite">
        <img id="userAvatar" src="" alt="" style="display:none">
     <div>
        <div id="userName" class="name" style="display:none"></div>
        <div id="userHint" class="muted">å°šæœªç™»å…¥</div>
     </div>
        <div style="margin-left:auto; display:flex; gap:8px">
        <button type="button" id="openLogin"  class="seg-btn active">ç™»å…¥</button>
        <button type="button" id="openSignup" class="seg-btn">è¨»å†Š</button>
        <button id="openProf" class="btn" style="display:none">è¨­å®š</button>
        <button id="logoutBtn" class="btn" style="display:none">ç™»å‡º</button>
        <button id="deleteAccount" class="btn" style="background:#b21f2d;color:#fff">è¨»éŠ·</button>
        <a href="record.html">
        <button class="btn" style="background:#b30eea;color:#6bceff">å›åˆ°è¨˜éŒ„</button>
        </a>
       </div>
    </div>
    </header>
    <button id="o" class="seg-btn">å»Grove</button>
    <button id="L" class="seg-btn">Grove HubğŸ”™</button>
    <script>
      document.getElementById('o').addEventListener('click', () => {
  window.location.href = 'gender-identity.html';  // æˆ–æ”¹æˆä½ ä¸»é çš„å¯¦éš›è·¯å¾‘
});
document.getElementById('L').addEventListener('click', () => {
  window.location.href = 'help.html';  // æˆ–æ”¹æˆä½ ä¸»é çš„å¯¦éš›è·¯å¾‘
});
    </script>
<div class="searchbar">
  <input id="searchKey" class="search-input" placeholder="æœå°‹æš±ç¨±æˆ–æ¨™é¡Œâ€¦ï¼ˆEnter åŸ·è¡Œï¼‰" />
  <button id="searchBtn" class="btn">æœå°‹</button>
  <button id="clearBtn"  class="btn" style="margin-left:6px">æ¸…é™¤</button>
</div>
    <section id="cloudList" class="groups" role="list"></section>
    <div id="empty" class="empty" style="display:none">ç›®å‰é‚„æ²’æœ‰å…§å®¹ã€‚</div>
    <button id="loadMore" class="btn more">è¼‰å…¥æ›´å¤š</button>
  </div>
<!-- ç™»å…¥ Modalï¼ˆç„¡æš±ç¨±ã€ç„¡é ­è²¼ï¼‰ -->
<div id="loginModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="bar">
      <strong>ç™»å…¥</strong>
      <button id="loginClose" class="btn">é—œé–‰</button>
    </div>
    <div class="row">
      <input id="loginEmail" class="input" type="email" inputmode="email"
             placeholder="é›»å­éƒµç®±ï¼ˆå¿…å¡«ï¼‰" autocomplete="email">
      <input id="loginPass" class="input" type="password" placeholder="å¯†ç¢¼ï¼ˆå¿…å¡«ï¼‰" autocomplete="current-password">
    </div>
    <div class="row" style="margin-top:8px; justify-content:flex-end">
      <button id="loginDo" class="btn">ç™»å…¥</button>
    </div>
    <div id="loginMsg" class="muted" style="margin-top:6px"></div>
  </div>
</div>

<!-- è¨»å†Š Modalï¼ˆæœ‰æš±ç¨±ã€å¯æŒ‘é ­è²¼ï¼‰ -->
<div id="signupModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="bar">
      <strong>å»ºç«‹å¸³è™Ÿ</strong>
      <button id="signupClose" class="btn">é—œé–‰</button>
    </div>
    <div class="row">
      <input id="signupEmail" class="input" type="email" inputmode="email"
             placeholder="é›»å­éƒµç®±ï¼ˆå¿…å¡«ï¼‰" autocomplete="email">
      <input id="signupPass" class="input" type="password" placeholder="å¯†ç¢¼ï¼ˆè‡³å°‘ 6 ä½è‹±æ•¸ï¼‰" autocomplete="new-password">
      <input id="signupNick" class="input" placeholder="æš±ç¨±ï¼ˆå¯é¸ï¼‰" maxlength="30">

      <div class="k">é ­è²¼ï¼ˆå¯é¸ï¼‰</div>
      <label for="signupAvatarInput" class="avatar-picker" title="é»æ“Šé¸æ“‡é ­è²¼">
        <img id="signupAvatarPreview"
             src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cg fill='%23b78ad3'%3E%3Ccircle cx='60' cy='46' r='22'/%3E%3Cpath d='M16 108a44 44 0 0 1 88 0z'/%3E%3C/g%3E%3C/svg%3E"
             alt="é ­è²¼é è¦½">
      </label>
      <input id="signupAvatarInput" type="file" accept="image/*" style="display:none">
      <div class="note">æ”¯æ´ jpg / png / gifï¼Œå»ºè­° &lt; 2MBã€‚</div>
    </div>
    <div class="row" style="margin-top:8px; justify-content:flex-end">
      <button id="signupDo" class="btn">è¨»å†Š</button>
    </div>
    <div id="signupMsg" class="muted" style="margin-top:6px"></div>
  </div>
</div>
<!-- å€‹äººè¨­å®šï¼ˆä¿®æ”¹æš±ç¨±ï¼é ­è²¼ï¼‰ -->
<div id="profModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="bar">
      <strong>å€‹äººè¨­å®š</strong>
      <button id="profClose" class="btn">é—œé–‰</button>
    </div>

    <div class="row">
      <div class="k">æš±ç¨±</div>
      <input id="profNick" class="input" placeholder="è¼¸å…¥æ–°çš„æš±ç¨±ï¼ˆ1â€“30å­—ï¼‰" maxlength="30">

      <div class="k">é ­è²¼</div>
      <label for="avatarInput2" class="avatar-picker" title="é»æ“Šé¸æ“‡é ­è²¼">
        <img id="avatarPreview2"
             src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cg fill='%23b78ad3'%3E%3Ccircle cx='60' cy='46' r='22'/%3E%3Cpath d='M16 108a44 44 0 0 1 88 0z'/%3E%3C/g%3E%3C/svg%3E"
             alt="é ­è²¼é è¦½">
      </label>
      <input id="avatarInput2" type="file" accept="image/*" style="display:none">
      <div class="note">æ”¯æ´ jpg / png / gifï¼Œå»ºè­° &lt; 2MBã€‚</div>
    </div>

    <div class="row" style="margin-top:8px; justify-content:flex-end">
      <button id="profSave" class="btn">å„²å­˜è®Šæ›´</button>
    </div>
    <div id="profMsg" class="muted" style="margin-top:6px"></div>
  </div>
</div>
<!-- å–®é è©³æƒ… View -->
 <main id="detailView">
  <div class="detail-wrap">
    <div class="detail-head">
      <button id="backList" class="btn">â† è¿”å›</button>
      <div id="detailOwnerTools" style="display:none; gap:8px">
        <button id="delPost" class="btn">åˆªé™¤æ­¤è²¼æ–‡</button>
      </div>
    </div>

    <article class="card">
      <div class="author" id="dAuthor"></div>
      <h1 class="detail-title" id="dTitle">â€”</h1>
      <div class="detail-meta" id="dMeta"></div>
      <pre id="dContent"></pre>
      <div class="detail-gallery" id="dGallery"> </div>
      <div class="muted" style="margin-top:8px">æç¤ºï¼šé»åœ–ç‰‡å¯åœ¨æ–°åˆ†é é–‹å•ŸåŸåœ–ã€‚</div>
    </article>
  </div>
</main>
  <!-- LeanCloud JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4/dist/av-min.js"></script>

  <script>
  /* ========= çœŸå¤ªé™½æ™‚ + å¹²æ”¯ï¼ˆ23:00 æ›æ—¥ï¼‰ ========= */
  function dayOfYear(d){ const s=new Date(d.getFullYear(),0,1); return Math.floor((d-s)/86400000)+1; }
  function equationOfTime(date){ const n=dayOfYear(date), B=2*Math.PI*(n-81)/364; return 9.87*Math.sin(2*B)-7.53*Math.cos(B)-1.5*Math.sin(B); }
  function tzCenterMeridian(){ const offMin=-new Date().getTimezoneOffset(); return 15*(offMin/60); }
  function calcTrueSolar(nowLocal, lonDeg, hasGeo){
    const LSTM=tzCenterMeridian(), eot=equationOfTime(nowLocal);
    const offsetMin = eot + 4*(lonDeg - LSTM);
    const solar = new Date(nowLocal.getTime()+offsetMin*60*1000);
    const hh=String(solar.getHours()).padStart(2,'0'), mm=String(solar.getMinutes()).padStart(2,'0'), ss=String(solar.getSeconds()).padStart(2,'0');
    return { solar, text:`${hh}:${mm}:${ss}`, approx:!hasGeo };
  }
  const stems=["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"], branch=["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];
  // å…¬æ›† â†’ JDNï¼ˆåªå–æ—¥æœŸï¼‰
  function toJDN(y,m,d){ if(m<=2){y--;m+=12;} const A=Math.floor(y/100),B=2-A+Math.floor(A/4); return Math.floor(365.25*(y+4716))+Math.floor(30.6001*(m+1))+d+B-1524; }
  function gzIndexFromJDN(jdn){ return (jdn+49)%60; }
  function hourBranchIndex(h){ let H=Math.floor(h); if(H===23) H=-1; return Math.floor((H+1)/2); }
  function hourStemIndex(dayStemIdx, hourBrIdx){ const start=[0,2,4,6,8][dayStemIdx%5]; return (start+hourBrIdx)%10; }
  function getGanzhiForTrueSolar(solarDate, solarHours){
    const y=solarDate.getFullYear(), m=solarDate.getMonth()+1, d=solarDate.getDate();
    const addDay = (solarHours>=23)?1:0;
    const jdn = toJDN(y,m,d)+addDay;
    const dayIdx=gzIndexFromJDN(jdn), dayGan=stems[dayIdx%10], dayZhi=branch[dayIdx%12];
    const hBrIdx=hourBranchIndex(solarHours), hourGan=stems[hourStemIndex(dayIdx%10,hBrIdx)], hourZhi=branch[hBrIdx];
    return { day: dayGan+dayZhi, hour: hourGan+hourZhi };
  }

  /* ========= æ™‚é˜ ========= */
  const timeEl=document.getElementById('time'), dateBadge=document.getElementById('dateBadge'),
        gzBadge=document.getElementById('gzBadge'), locBadge=document.getElementById('locBadge'),
        precBadge=document.getElementById('precBadge');
  let GEO={has:false, lon:tzCenterMeridian(), lat:0};
  function initGeo(){
    if(!navigator.geolocation){ locBadge.textContent='ç„¡å®šä½ï¼ˆä¼°ç®—ï¼‰'; return; }
    navigator.geolocation.getCurrentPosition(
      pos=>{ GEO.has=true; GEO.lat=pos.coords.latitude; GEO.lon=pos.coords.longitude; locBadge.textContent=`ğŸ“ ${GEO.lat.toFixed(4)}, ${GEO.lon.toFixed(4)}`; },
      _=>{ GEO.has=false; locBadge.textContent='æœªæˆæ¬Šå®šä½ï¼ˆä¼°ç®—ï¼‰'; },
      {enableHighAccuracy:false, maximumAge:3600_000, timeout:8000}
    );
  }
  function tick(){
    const now=new Date();
    const ts=calcTrueSolar(now, GEO.lon, GEO.has);
    timeEl.textContent = ts.text;  // â‰ˆ ä¸å†æ”¾åœ¨æ™‚é˜è£¡
    precBadge.textContent = ts.approx ? "ç²¾åº¦ï¼šä¼°ç®—" : "ç²¾åº¦ï¼šä¾å®šä½";
    const solarHours = ts.solar.getHours() + ts.solar.getMinutes()/60 + ts.solar.getSeconds()/3600;
    const {day:gzDay, hour:gzHour} = getGanzhiForTrueSolar(ts.solar, solarHours);
    gzBadge.textContent = `æ—¥ï¼š${gzDay}ã€€æ™‚ï¼š${gzHour}`;
    const dstr = now.toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'short'});
dateBadge.textContent = `${dstr}ï½œçœŸå¤ªé™½æ™‚`;

// å‘Šè¨´ CSS æ˜¯å¦é¡¯ç¤º â‰ˆ
dateBadge.setAttribute('data-approx', ts.approx ? '1' : '0');
timeEl.textContent = ts.text;  // ä¿æŒæ™‚é˜å­—ç´šèˆ‡å¯¬åº¦
if (ts.approx) timeEl.classList.add('approx');
else timeEl.classList.remove('approx');

    }
  initGeo(); tick(); setInterval(tick,1000);
/* å…¼å®¹èˆŠ/æ–°æ¬„ä½åï¼Œçµ„ã€ŒYYYY/MM/DDï½œHH:MM:SSã€ */
function buildPubDisplay(x){
  // x å¯ä»¥æ˜¯ AV.Object æˆ– plain objectï¼ˆrecï¼‰
  const get = (k)=> (typeof x.get === 'function' ? x.get(k) : x[k]) || '';
  const date  = get('pubDateStr')  || get('pubDate');      // å…©ç¨®éƒ½è©¦
  const solar = get('pubSolarStr') || get('pubSolar');     // å…©ç¨®éƒ½è©¦
  if (!date && !solar) return '';
  return `${date}${date && solar ? 'ï½œ' : ''}${solar}`;
}
  /* ========= LeanCloud é€£ç·š ========= */
  const cloudStatus=document.getElementById('cloudStatus');
  AV.init({
    appId: '0juO0jzBkrv1Oi04bHljaWDW-gzGzoHsz',
    appKey: 'kFMz8niEbd8BlPbFKDyTZC2Q',
    serverURL: 'https://0juo0jzb.lc-cn-n1-shared.com'
  });
function persistSession(user){
  try{
    if (user) localStorage.setItem('LC_SESSION_TOKEN', user.getSessionToken());
  }catch(e){ console.warn('persistSession failed', e); }
}
function clearSession(){
  try{ localStorage.removeItem('LC_SESSION_TOKEN'); }catch{}
}
  async function healthCheck(){
    try{
      const q=new AV.Query('Cloud'); q.limit(1);
      await q.find();
      cloudStatus.textContent='é›²ç«¯ï¼šå·²é€£ç·š'; cloudStatus.classList.remove('dim');
      console.info('[LeanCloud] ready');
    }catch(err){
      console.error('[LeanCloud] é€£ç·šå¤±æ•—ï¼š', err);
      let hint='';
      switch(err.code){
        case 401: hint='ï¼ˆæ¬Šé™ä¸è¶³ï¼šåˆ° Cloud é¡åˆ¥é–‹æ”¾ find/get çµ¦æ‰€æœ‰ç”¨æˆ¶ï¼Œæˆ–é–‹æ”¾é è¨­è®€æ¬Šé™ï¼‰'; break;
        case 403: hint='ï¼ˆç¶²åŸŸä¸åœ¨ç™½åå–®ï¼šè¨­å®šâ†’å®‰å…¨åŸŸååŠ ä¸Šæ­¤é å®Œæ•´ä¾†æºå«å”è­°èˆ‡ç«¯å£ï¼‰'; break;
        case 404: hint='ï¼ˆserverURL æˆ– AppID/Key ä¸æ­£ç¢ºï¼šæª¢æŸ¥ AV.initï¼‰'; break;
        default:  hint=`ï¼ˆcode: ${err.code ?? 'æœªçŸ¥'}ï¼‰`;
      }
      cloudStatus.textContent='é›²ç«¯ï¼šé€£ç·šå¤±æ•— ' + hint;
      cloudStatus.classList.add('dim');
    }
  }
  healthCheck();
  //=========
/* ========= é–‹çª—/é—œçª—ï¼ˆç™»å…¥ / è¨»å†Šï¼‰ ========= */
const openLoginBtn  = document.getElementById('openLogin');
const openSignupBtn = document.getElementById('openSignup');

const loginModal  = document.getElementById('loginModal');
const loginClose  = document.getElementById('loginClose');
const loginEmail  = document.getElementById('loginEmail');
const loginPass   = document.getElementById('loginPass');
const loginDo     = document.getElementById('loginDo');
const loginMsg    = document.getElementById('loginMsg');

const signupModal = document.getElementById('signupModal');
const signupClose = document.getElementById('signupClose');
const signupEmail = document.getElementById('signupEmail');
const signupPass  = document.getElementById('signupPass');
const signupNick  = document.getElementById('signupNick');
const signupDo    = document.getElementById('signupDo');
const signupMsg   = document.getElementById('signupMsg');

function openLogin(prefillEmail=''){
  loginEmail.value = prefillEmail;
  loginPass.value  = '';
  loginMsg.textContent = '';
  loginModal.classList.add('show');
  loginModal.setAttribute('aria-hidden','false');
  loginEmail.focus();
}
function closeLogin(){
  loginModal.classList.remove('show');
  loginModal.setAttribute('aria-hidden','true');
}
function openSignup(prefillEmail=''){
  signupEmail.value = prefillEmail;
  signupPass.value  = '';
  signupNick.value  = '';
  signupMsg.textContent = '';
  pickedSignupAvatarFile = null;
  signupAvatarInput.value = '';
  signupAvatarPreview.src =
    "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cg fill='%23b78ad3'%3E%3Ccircle cx='60' cy='46' r='22'/%3E%3Cpath d='M16 108a44 44 0 0 1 88 0z'/%3E%3C/g%3E%3C/svg%3E";
  signupModal.classList.add('show');
  signupModal.setAttribute('aria-hidden','false');
  signupEmail.focus();
}
function closeSignup(){
  signupModal.classList.remove('show');
  signupModal.setAttribute('aria-hidden','true');
}

openLoginBtn.addEventListener('click',  ()=>openLogin());
openSignupBtn.addEventListener('click', ()=>openSignup());
loginClose.addEventListener('click', closeLogin);
signupClose.addEventListener('click', closeSignup);
loginModal.addEventListener('click', e=>{ if(e.target===loginModal) closeLogin(); });
signupModal.addEventListener('click', e=>{ if(e.target===signupModal) closeSignup(); });
window.addEventListener('keydown', e=>{
  if(e.key==='Escape'){
    if(loginModal.classList.contains('show')) closeLogin();
    if(signupModal.classList.contains('show')) closeSignup();
  }
});

/* ========= é©—è­‰å·¥å…· ========= */
function isEmail(s){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s); }
function isAlnum6Plus(s){ return /^[A-Za-z0-9]{6,}$/.test(s); }

/* ========= ç™»å…¥æµç¨‹ï¼ˆä¸å­˜åœ¨å°±å¼•å°è¨»å†Šï¼‰ ========= */
loginDo.addEventListener('click', async ()=>{
  const email = loginEmail.value.trim();
  const pass  = loginPass.value.trim();

  if(!isEmail(email)){ loginMsg.textContent='è«‹å¡«å¯«æ­£ç¢ºçš„é›»å­éƒµç®±'; loginEmail.focus(); return; }
  if(!isAlnum6Plus(pass)){ loginMsg.textContent='å¯†ç¢¼è‡³å°‘ 6 ä½è‹±æ•¸'; loginPass.focus(); return; }

  loginDo.disabled = true; loginMsg.textContent='ç™»å…¥ä¸­â€¦';
  try{
    const user = await AV.User.logIn(email, pass);
if(isEmail(email) && !user.getEmail()){ user.setEmail(email); await user.save(); }
persistSession(user);           // â˜… å­˜ token
showUserInfo(user);
closeLogin();
  }catch(err){
    console.error(err);
    if(err.code === 211){ // ä½¿ç”¨è€…ä¸å­˜åœ¨ â†’ å»è¨»å†Š
      closeLogin();
      openSignup(email);
      signupMsg.textContent = 'é€™å€‹å¸³è™Ÿå°šæœªè¨»å†Šï¼Œè«‹å…ˆå»ºç«‹å¸³è™Ÿ';
    }else if(err.code === 210){
      loginMsg.textContent = 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
    }else{
      loginMsg.textContent = `ç™»å…¥å¤±æ•—ï¼š${err.message || err.code || 'æœªçŸ¥éŒ¯èª¤'}`;
    }
  }finally{
    loginDo.disabled = false;
  }
});

/* ========= è¨»å†Šï¼šé ­è²¼æŒ‘é¸ / ä¸Šå‚³ ========= */
const signupAvatarInput   = document.getElementById('signupAvatarInput');
const signupAvatarPreview = document.getElementById('signupAvatarPreview');
let pickedSignupAvatarFile = null;

signupAvatarInput.addEventListener('change', ()=>{
  const f = signupAvatarInput.files?.[0];
  if(!f) return;
  const MAX = 2*1024*1024; // ä½ è¦æ”¹ä¸Šé™å°±æ”¹é€™è£¡ï¼ˆç›®å‰ 2MBï¼‰
  if(f.size > MAX){ alert('åœ–ç‰‡å¤ªå¤§ï¼Œè«‹å°æ–¼ 2MB'); signupAvatarInput.value=''; return; }
  pickedSignupAvatarFile = f;
  const r = new FileReader();
  r.onload = e => { signupAvatarPreview.src = e.target.result; };
  r.readAsDataURL(f);
});

async function uploadSignupAvatarIfAny(){
  if(!pickedSignupAvatarFile) return null;
  const file = new AV.File(pickedSignupAvatarFile.name, pickedSignupAvatarFile);
  await file.save();
  return file.url();
}

/* ========= è¨»å†Šæµç¨‹ï¼ˆå·²å­˜åœ¨â†’è·³ç™»å…¥ï¼‰ ========= */
signupDo.addEventListener('click', async ()=>{
  const email = signupEmail.value.trim();
  const pass  = signupPass.value.trim();
  const nick  = signupNick.value.trim();

  if(!isEmail(email)){ signupMsg.textContent='è«‹å¡«å¯«æ­£ç¢ºçš„é›»å­éƒµç®±'; signupEmail.focus(); return; }
  if(!isAlnum6Plus(pass)){ signupMsg.textContent='å¯†ç¢¼è‡³å°‘ 6 ä½è‹±æ•¸'; signupPass.focus(); return; }
  if(!nick){ signupMsg.textContent='è«‹å¡«å¯«æš±ç¨±'; signupNick.focus(); return; }

  signupDo.disabled = true; signupMsg.textContent='å»ºç«‹ä¸­â€¦';
  try{
    const avatarUrl = await uploadSignupAvatarIfAny();
    const user = new AV.User();
    user.setUsername(email);
    user.setPassword(pass);
    user.setEmail(email);
    user.set('nickname', nick);
    if(avatarUrl) user.set('avatar', avatarUrl);

    await user.signUp();
persistSession(user);          // â˜… å­˜ token
showUserInfo(user);
closeSignup();
  }catch(err){
    console.error(err);
    if(err.code === 202){ // å·²å­˜åœ¨ â†’ å»ç™»å…¥
      closeSignup();
      openLogin(email);
      loginMsg.textContent = 'æ­¤å¸³è™Ÿå·²è¨»å†Šï¼Œè«‹ç›´æ¥ç™»å…¥';
    }else{
      signupMsg.textContent = `è¨»å†Šå¤±æ•—ï¼š${err.message || err.code || 'æœªçŸ¥éŒ¯èª¤'}`;
    }
  }finally{
    signupDo.disabled = false;
  }
  await user.signUp();

// âœ… è¨»å†Šå®Œç‚ºæ–°ç”¨æˆ¶è¨­ç½®å‹å–„çš„é è¨­ ACLï¼ˆè‡ªå·±å¯å¯«ã€æ‰€æœ‰äººå¯è®€ï¼‰
const acl = new AV.ACL();
acl.setPublicReadAccess(true);
acl.setWriteAccess(user, true);
user.setACL(acl);
await user.save();
});

/* ========= ä½¿ç”¨è€…åˆ—é¡¯ç¤º ========= */
const userAvatar = document.getElementById('userAvatar');
const userName   = document.getElementById('userName');
const userHint   = document.getElementById('userHint');
const logoutBtn  = document.getElementById('logoutBtn');
const DEFAULT_AVATAR = 'https://i.imgur.com/7h9vW7N.png';

function showUserInfo(u){
  if(!u){
    userAvatar.style.display='none';
    userName.style.display='none';
    userHint.style.display='';
    userHint.textContent='å°šæœªç™»å…¥';
    refreshUserBarButtons(null);
    return;
  }
  const nick = u.get('nickname') || u.getUsername();
  const ava  = u.get('avatar')   || DEFAULT_AVATAR;

  userAvatar.src = ava;
  userAvatar.style.display='';
  userName.textContent = nick;
  userName.style.display='';
  userHint.style.display='none';
  refreshUserBarButtons(u);
}

/* ç™»å‡º */
logoutBtn.addEventListener('click', async ()=>{
  await AV.User.logOut();
  clearSession();              // â˜… æ¸… token
  showUserInfo(null);
});

/* é é¢è¼‰å…¥æ™‚åŒæ­¥ä½¿ç”¨è€…åˆ— */
showUserInfo(AV.User.current());

/* ========= å€‹äººè¨­å®šï¼šä¿®æ”¹æš±ç¨±ï¼é ­è²¼ ========= */
const openProf   = document.getElementById('openProf');
const profModal  = document.getElementById('profModal');
const profClose  = document.getElementById('profClose');
const profNick   = document.getElementById('profNick');
const profSave   = document.getElementById('profSave');
const profMsg    = document.getElementById('profMsg');

// ç¬¬äºŒçµ„é ­è²¼é¸æª”ï¼é è¦½ï¼ˆä¸å½±éŸ¿ç™»å…¥å½ˆçª—é‚£ä¸€çµ„ï¼‰
const avatarInput2   = document.getElementById('avatarInput2');
const avatarPreview2 = document.getElementById('avatarPreview2');
let pickedAvatarFile2 = null;

function refreshUserBarButtons(u){
  const logged = !!u;
  document.getElementById('openLogin').style.display  = logged ? 'none' : '';
  document.getElementById('openSignup').style.display = logged ? 'none' : '';
  document.getElementById('openProf').style.display   = logged ? '' : 'none';
  document.getElementById('logoutBtn').style.display  = logged ? '' : 'none';
}
const _origShowUserInfo = showUserInfo;
showUserInfo = function(u){ _origShowUserInfo(u); refreshUserBarButtons(u); };
refreshUserBarButtons(AV.User.current());

// é–‹å•Ÿè¨­å®šé¢æ¿ï¼šå¸¶å…¥ç›®å‰æš±ç¨±èˆ‡é ­è²¼
function openProfModal(){
  const u = AV.User.current();
  if(!u){ alert('è«‹å…ˆç™»å…¥'); return; }

  profMsg.textContent = '';
  profNick.value = u.get('nickname') || u.getUsername() || '';

  const ava = u.get('avatar') || '';
  avatarPreview2.src = ava || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cg fill='%23b78ad3'%3E%3Ccircle cx='60' cy='46' r='22'/%3E%3Cpath d='M16 108a44 44 0 0 1 88 0z'/%3E%3C/g%3E%3C/svg%3E";
  pickedAvatarFile2 = null;
  avatarInput2.value = '';

  profModal.classList.add('show');
  profModal.setAttribute('aria-hidden','false');
}
function closeProf(){ profModal.classList.remove('show'); profModal.setAttribute('aria-hidden','true'); }

openProf.addEventListener('click', openProfModal);
profClose.addEventListener('click', closeProf);
profModal.addEventListener('click', e=>{ if(e.target===profModal) closeProf(); });

// é¸æª”å³æ™‚é è¦½
avatarInput2.addEventListener('change', ()=>{
  const f = avatarInput2.files?.[0];
  if(!f) return;
  const MAX = 2 * 1024 * 1024;
  if(f.size > MAX){ alert('åœ–ç‰‡å¤ªå¤§ï¼Œè«‹å°æ–¼ 2MB'); avatarInput2.value=''; return; }
  pickedAvatarFile2 = f;

  const reader = new FileReader();
  reader.onload = e => { avatarPreview2.src = e.target.result; };
  reader.readAsDataURL(f);
});

// å°å·¥å…·ï¼šæŠŠ File ä¸Šå‚³åˆ° LeanCloudï¼Œå›å‚³å…¬é–‹ URL
async function uploadAvatarFile(file){
  const af = new AV.File(file.name, file);
  await af.save();
  return af.url();
}

// å„²å­˜è®Šæ›´
profSave.addEventListener('click', async ()=>{
  const u = AV.User.current();
  if(!u){ profMsg.textContent = 'å°šæœªç™»å…¥'; return; }

  let nick = profNick.value.trim();
  if(nick.length === 0 || nick.length > 30){
    profMsg.textContent = 'æš±ç¨±é•·åº¦éœ€ 1â€“30 å­—';
    return;
  }

  profSave.disabled = true; profMsg.textContent = 'å„²å­˜ä¸­â€¦';

  try{
    // å¦‚æœæŒ‘äº†æ–°é ­è²¼å°±å…ˆä¸Šå‚³
    let newAvatarUrl = null;
    if(pickedAvatarFile2){
      newAvatarUrl = await uploadAvatarFile(pickedAvatarFile2);
    }

    // å¯«å›ä½¿ç”¨è€…
    u.set('nickname', nick);
    if(newAvatarUrl) u.set('avatar', newAvatarUrl);
    await u.save();

    // æ›´æ–°é é¢ä¸Šçš„é ­è²¼èˆ‡æš±ç¨±ï¼ˆæ²¿ç”¨ä½ çš„åŸå‡½å¼ï¼‰
    showUserInfo(u);
    profMsg.textContent = 'å·²æ›´æ–°ã€‚';
    setTimeout(closeProf, 600);
  }catch(err){
    console.error(err);
    profMsg.textContent = `å¤±æ•—ï¼š${err.message || err.code || 'æœªçŸ¥éŒ¯èª¤'}`;
  }finally{
    profSave.disabled = false;
  }
});
document.getElementById('deleteAccount').addEventListener('click', async () => {
  const u = AV.User.current();
  if (!u) return alert('å°šæœªç™»å…¥');

  if (!confirm('âš ï¸ é€™æœƒåˆªé™¤ä½ çš„å¸³è™Ÿèˆ‡æ‰€æœ‰è²¼æ–‡ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚ç¢ºå®šå—ï¼Ÿ')) return;
  if (!confirm('æœ€å¾Œç¢ºèªï¼šçœŸçš„è¦æ°¸ä¹…åˆªé™¤ï¼Ÿ')) return;

  const sessionToken = u.getSessionToken();

  // 1) å…ˆåˆªè‡ªå·±çš„è²¼æ–‡ï¼ˆé¡åˆ¥ï¼šCloudï¼›ç”¨ authorId æ¯”å°ï¼‰
  try {
    while (true) {
      const q = new AV.Query('Cloud');
      q.equalTo('authorId', u.id);
      q.limit(100);               // åˆ†æ‰¹åˆª
      const rows = await q.find();
      if (!rows.length) break;
      await AV.Object.destroyAll(rows);  // éœ€æ“æœ‰è€…å¯å¯« ACL
    }
  } catch (e) {
    console.warn('åˆªè²¼æ–‡æ™‚æœ‰å¤±æ•—çš„é …ç›®ï¼ˆç•¥éï¼‰:', e);
  }

  // 2) å˜—è©¦ç›´æ¥åˆªé™¤å¸³æˆ¶æœ¬èº«ï¼ˆå‰ç«¯ï¼‰
  try {
    await u.destroy();            // éœ€è¦ _User é¡ï¼šdelete=ã€Œç™»å…¥ç”¨æˆ¶ã€ï¼Œä¸”æ­¤ user ACL å…è¨±æœ¬äººå¯«å…¥
  } catch (e) {
    alert('åˆªé™¤å¸³æˆ¶å¤±æ•—ï¼š' + (e.message || e.code || 'æœªçŸ¥éŒ¯èª¤') +
          '\n\nè«‹åˆ°æ§åˆ¶å°æŠŠã€Œ_User é¡çš„ delete æ¬Šé™ã€è¨­ç‚ºã€Œç™»å…¥ç”¨æˆ¶ã€ï¼Œä¸”ä½¿ç”¨è€…ç‰©ä»¶ ACL è¦å…è¨±æœ¬äººå¯«å…¥ã€‚');
    return;
  }

  // 3) é©—è­‰èˆŠ session å¤±æ•ˆï¼ˆèƒ½ become å°±ä»£è¡¨æ²’åˆªæ‰ï¼‰
  try {
    await AV.User.become(sessionToken);
    alert('åˆªé™¤å¤±æ•—ï¼šèˆŠç™»å…¥ä»æœ‰æ•ˆï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
    return;
  } catch (_) {
    // å¤±æ•ˆä»£è¡¨çœŸçš„åˆªæ‰äº†
  }

  // 4) æ”¶å°¾ï¼šæ¸…æœ¬åœ°ã€ç™»å‡ºã€åˆ·æ–°
  try { localStorage.removeItem('LC_SESSION_TOKEN'); } catch {}
  await AV.User.logOut();
  alert('âœ… å¸³è™Ÿèˆ‡è²¼æ–‡å·²è¨»éŠ·ã€‚');
  location.reload();
});
// åˆå§‹ï¼šä¾ç›®å‰ç™»å…¥ç‹€æ…‹èª¿æ•´æŒ‰éˆ•å¯è¦‹æ€§
refreshUserBarButtons(AV.User.current());
  /* ========= è¼‰å…¥åˆ—è¡¨ï¼ˆåˆ†é ï¼‰ ========= */
const listEl = document.getElementById('cloudList');
const emptyEl = document.getElementById('empty');
const loadMoreBtn = document.getElementById('loadMore');
let PAGE = 0, SIZE = 20, BUSY = false, DONE = false;

let SEARCH = ''; // â† ç›®å‰æœå°‹é—œéµå­—ï¼ˆç©ºå­—ä¸²è¡¨ç¤ºä¸éæ¿¾ï¼‰
const searchInput = document.getElementById('searchKey');
const searchBtn   = document.getElementById('searchBtn');
const clearBtn    = document.getElementById('clearBtn');

/* å°å·¥å…·ï¼šHTML é€ƒè„«ï¼ˆåªä¿ç•™ä¸€å€‹å®šç¾©å³å¯ï¼‰ */
function esc(s=''){
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function resetAndLoad(){
  // æ¸…ç©ºç•«é¢ & ç‹€æ…‹
  listEl.innerHTML = '';
  PAGE = 0; DONE = false;
  groupMap.clear(); // â˜… æ¸…ä½œè€…ç¾¤çµ„å¿«å–
  loadPage();
}
function doSearch(){
  SEARCH = (searchInput.value || '').trim();
  resetAndLoad();
}
searchBtn.addEventListener('click', doSearch);
searchInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') doSearch(); });
clearBtn.addEventListener('click', ()=>{
  searchInput.value = '';
  if (SEARCH !== ''){ SEARCH = ''; resetAndLoad(); }
});

/* ====== ä½œè€…åˆ†ç¾¤ï¼šçµæ§‹èˆ‡æ’åº ====== */
const groupMap = new Map(); // key: groupKey â†’ {wrap, timeline, author}

function authorFromRow(o){
  return {
    id    : o.get('authorId') || '',
    name  : o.get('authorName') || 'åŒ¿å',
    avatar: o.get('authorAvatar') || 'https://i.imgur.com/7h9vW7N.png'
  };
}
// ç¾¤çµ„éµï¼šå„ªå…ˆç”¨ authorIdï¼Œæ²’æœ‰å°±é€€å›æš±ç¨±
function groupKeyOf(a){ return a.id ? `id:${a.id}` : `anon:${a.name}`; }

function ensureGroup(a){
  const key = groupKeyOf(a);
  if (groupMap.has(key)) return groupMap.get(key);

  const wrap = document.createElement('section');
  wrap.className = 'group';
  wrap.dataset.group = key;
  wrap.innerHTML = `
    <div class="group-head">
      <img src="${a.avatar}" alt="">
      <div>
        <div class="name">${esc(a.name)}</div>
        <div class="sub">æ­¤äººçš„è²¼æ–‡</div>
      </div>
    </div>
    <div class="timeline">
      <div class="trow"></div>
    </div>
  `;
  listEl.appendChild(wrap);

  const pack = { wrap, timeline: wrap.querySelector('.trow'), author: a };

  // â˜…â˜…â˜… åªåœ¨é€™è£¡ï¼ˆpack å»ºå¥½å¾Œï¼‰ç¶ä¸€æ¬¡ scroll ç›£è½ â˜…â˜…â˜…
  const row = pack.timeline;
  if (!row._linkBound){
    row._linkBound = true;
    let ticking = false;
    row.addEventListener('scroll', ()=>{
      if(!ticking){
        requestAnimationFrame(()=>{ linkDots(); ticking = false; });
        ticking = true;
      }
    });
  }
  // â˜…â˜…â˜… çµæŸ â˜…â˜…â˜…

  groupMap.set(key, pack);
  return pack;
}

// æ’å…¥åˆ°è©²ä½œè€…çš„æ°´å¹³åˆ—ï¼Œä¾æ™‚é–“æ–°â†’èˆŠ
function insertNodeSorted(rowEl, nodeEl, tms){
  nodeEl.dataset.tms = String(tms);
  const nodes = Array.from(rowEl.children);
  const idx = nodes.findIndex(n => Number(n.dataset.tms) < tms);
  if (idx === -1) rowEl.appendChild(nodeEl);
  else rowEl.insertBefore(nodeEl, nodes[idx]);
}

/* ====== UIå°å·¥å…·ï¼ˆæ”¹ï¼šè¼¸å‡ºæ•´å€‹ç•«å»Šï¼Œè€Œä¸æ˜¯åªæœ‰ç¬¬ä¸€å¼µï¼‰ ====== */
/* ====== åˆ—è¡¨ç”¨ç¸®ç•¥åœ–ï¼ˆåªé¡¯ç¤ºç¬¬ä¸€å¼µï¼Œå³ä¸‹ +Nï¼‰ ====== */
function galleryHTML(imgs){
  if (!imgs || !imgs.length) return '';
  const cover = imgs[0];
  const extra = Math.max(0, imgs.length - 1);
  return (
    '<div class="thumb-bar">' +
      '<span class="twrap">' +
        '<img class="thumb-mini" src="' + esc(cover) + '" alt="" loading="lazy">' +
        (extra ? '<span class="thumb-more">+' + extra + '</span>' : '') +
      '</span>' +
    '</div>'
  );
}
/* ====== ä¾ä½œè€…åˆ†ç¾¤ + æ°´å¹³ç´«å¤–ç·šæ™‚é–“ç·š æ¸²æŸ“ ====== */
async function loadPage(){
  if (BUSY || DONE) return;
  BUSY = true; loadMoreBtn.textContent = 'è¼‰å…¥ä¸­â€¦';

  try{
    // æŸ¥è©¢ï¼ˆæ”¯æ´æ¨™é¡Œ / æš±ç¨±é—œéµå­—ï¼‰
    let q;
    if (SEARCH){
      const qTitle  = new AV.Query('Cloud').contains('title', SEARCH);
      const qAuthor = new AV.Query('Cloud').contains('authorName', SEARCH);
      q = AV.Query.or(qTitle, qAuthor);
    }else{
      q = new AV.Query('Cloud');
    }
    q.descending('createdAt').skip(PAGE*SIZE).limit(SIZE);

    const rows = await q.find();

    if (PAGE === 0){
      listEl.innerHTML = '';
      emptyEl.style.display = rows.length ? 'none' : 'block';
      loadMoreBtn.style.display = rows.length ? '' : 'none';
    }

    rows.forEach(o=>{
      const a = authorFromRow(o);
      const { timeline } = ensureGroup(a);  // timeline = è©²ä½œè€…çš„ .trow

      const title   = o.get('title')   || 'ï¼ˆç„¡æ¨™é¡Œï¼‰';
      const content = o.get('content') || '';
      const imgs    = o.get('images')  || [];

      // ç™¼ä½ˆæ™‚é–“ï¼ˆä½ çš„ç¾æœ‰å·¥å…·ï¼‰
      const pubStr = buildPubDisplay(o);

      // å‰µä½œæ™‚é–“ï¼‹å¹²æ”¯ï¼ˆä¸Šå‚³æ™‚å°±å·²å­˜ï¼‰
      const createDate  = o.get('dateStr')  || '';
      const createSolar = o.get('solarStr') || '';
      const approx      = !!o.get('approx');
      const gzDay       = o.get('gzDay')    || '';
      const gzHour      = o.get('gzHour')   || '';

      // ç¯€é»å¡ç‰‡ï¼ˆæ©«å‘ itemï¼‰
      const item = document.createElement('div');
      item.className = 'titem';
      item.dataset.id = o.id;
     const me      = AV.User.current();
     const isOwner = !!(me && a.id && me.id === a.id);

    item.innerHTML = `
  <div class="ts">
    <span class="ts-dot head" aria-hidden="true"></span>
    ${esc(pubStr)}
    <span class="ts-dot tail" aria-hidden="true"></span>
  </div>
  <div class="tcard">
    <div class="title">ğŸ§ƒ ${esc(title)}</div>
    <div class="meta" style="display:flex; gap:6px; flex-wrap:wrap; margin:4px 0 6px">
      <span class="badge dim">å‰µä½œï¼š${esc(createDate)}ï½œ${esc(createSolar)}${approx?' â‰ˆ':''}</span>
      <span class="badge">æ—¥ï¼š${esc(gzDay)}</span>
      <span class="badge">æ™‚ï¼š${esc(gzHour)}</span>
    </div>
    <div class="excerpt">${esc(content)}</div>
    ${ galleryHTML(imgs) }
    ${ isOwner ? `<div class="actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                    <button class="btn" data-act="del">åˆªé™¤</button>
                  </div>` : '' }
  </div>
`;
// åœç”¨ actions çš„å†’æ³¡ & ç¶å®šåˆªé™¤
const actions = item.querySelector('.actions');
if (actions){
  actions.addEventListener('click', e => e.stopPropagation());
  const delBtn = actions.querySelector('[data-act="del"]');
  delBtn.addEventListener('click', async ()=>{
  if(!confirm('ç¢ºå®šåˆªé™¤æ­¤è²¼æ–‡ï¼Ÿ')) return;

  try{
    await o.destroy();          // åˆªå¾Œ server æˆåŠŸ
    // å…ˆæ‹¿åˆ°é€™å€‹ä½œè€…ç¾¤çµ„ï¼ˆåˆªä¹‹å‰å…ˆæŠ“ pack æ‰ä¸æœƒæ‰¾ä¸åˆ°ï¼‰
    const groupKey = groupKeyOf(a);
    const pack     = groupMap.get(groupKey);

    // å¾ç•«é¢ç§»é™¤é€™å¼µå¡
    item.remove();

    // å¦‚æœè©²ä½œè€…é€™ä¸€åˆ—ä¸€å¼µä¸å‰©ï¼Œæ•´å€‹ç¾¤çµ„å€å¡Šä¹Ÿç§»æ‰
    if (pack && pack.timeline.querySelectorAll('.titem').length === 0){
      pack.wrap.remove();
      groupMap.delete(groupKey);
    }

    // åˆ¤æ–·ã€Œæ˜¯å¦åˆªåˆ°è‡ªå·±æœ€å¾Œä¸€ç¯‡ã€â†’ åªå‰© 0 ç¯‡å°±æ•´é é‡æ•´ä¸€æ¬¡
    const me = AV.User.current();
    if (me && a.id && me.id === a.id){
      const q = new AV.Query('Cloud');
      q.equalTo('authorId', me.id);
      const left = await q.count();      // æˆ‘åœ¨é›²ç«¯å‰©å¹¾ç¯‡
      if (left === 0){
        location.reload();               // âœ… æœ€å¾Œä¸€ç¯‡ â†’ åˆ·æ–°
        return;
      }
    }

    // ä¸æ˜¯æœ€å¾Œä¸€ç¯‡ â†’ è¼•é‡é‡ç®—é€£ç·šèˆ‡è¼‰å…¥æ›´å¤šéˆ•
    if (document.querySelectorAll('.titem').length === 0){
      // å…¨ç«™éƒ½æ²’å…§å®¹äº†ï¼ˆæ¥µå°‘è¦‹ï¼‰â†’ é¡¯ç¤ºç©ºç‹€æ…‹
      emptyEl.style.display = 'block';
      loadMoreBtn.style.display = 'none';
    }else{
      requestAnimationFrame(linkDots);
    }
  }catch(err){
    alert('åˆªé™¤å¤±æ•—ï¼š' + (err.message || err.code || 'æœªçŸ¥éŒ¯èª¤'));
  }
});

}

      // é»å¡ç‰‡ â†’ è©³æƒ…
      item.addEventListener('click', ()=>{ location.hash = `#/post/${o.id}`; });

      // ç”¨ createdAt æ’åºï¼ˆæ–°â†’èˆŠï¼‰
      const created = o.createdAt || o.get('createdAt') || new Date();
      const tms = (created instanceof Date ? created : new Date(created)).getTime();
      insertNodeSorted(timeline, item, tms);
    });
    requestAnimationFrame(linkDots);
    // åˆ†é æ§åˆ¶
    if (rows.length < SIZE){
      DONE = true; loadMoreBtn.textContent = 'æ²’æœ‰æ›´å¤šäº†'; loadMoreBtn.disabled = true;
    }else{
      PAGE++; loadMoreBtn.textContent = 'è¼‰å…¥æ›´å¤š';
    }
  }catch(err){
    console.error('[Cloud.load] éŒ¯èª¤ï¼š', err);
    emptyEl.style.display='block';
    emptyEl.textContent = 'è¼‰å…¥å¤±æ•—ï¼š' + (err.message || err.code || 'æœªçŸ¥éŒ¯èª¤');
  }finally{
    BUSY = false;
  }
}
loadMoreBtn.addEventListener('click', loadPage);
loadPage(); // é¦–æ¬¡è¼‰å…¥
window.addEventListener('resize', linkDots);
// ç¶ä¸€æ¬¡å°±å¥½
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.trow').forEach(row=>{
    let ticking = false;
    row.addEventListener('scroll', ()=>{
      if(!ticking){
        requestAnimationFrame(()=>{ linkDots(); ticking = false; });
        ticking = true;
      }
    });
  });
});
linkDots();
// é‡æ¯åˆ—ä¸Šã€Œæœ¬å¡å°¾é» â†’ ä¸‹ä¸€å¡é ­é»ã€çš„æ°´å¹³è·é›¢ï¼Œå¯«åˆ° --linkw
function linkDots(){
  document.querySelectorAll('.trow').forEach(row=>{
    const items = Array.from(row.children);
    for(let i=0; i<items.length; i++){
      const curTail  = items[i]?.querySelector('.ts .ts-dot.tail');
      if(!curTail) continue;

      if(i === items.length - 1){
        curTail.style.removeProperty('--linkw');   // æœ€å¾Œä¸€å¼µä¸è¦ç·š
        continue;
      }

      const nextHead = items[i+1]?.querySelector('.ts .ts-dot.head');
      if(!nextHead) continue;

      const a = curTail.getBoundingClientRect();
      const b = nextHead.getBoundingClientRect();
      const w = Math.max(0, b.left - a.right);     // å°¾é»å³ç·£ â†’ ä¸‹ä¸€å¼µé ­é»å·¦ç·£
      curTail.style.setProperty('--linkw', w + 'px');
    }
  });
}
// é€ƒè„«å·¥å…·
function esc(s=''){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

const listView = document.querySelector('.wrap').parentElement;  // ä½ çš„åˆ—è¡¨ main
const detailView = document.getElementById('detailView');
const backList = document.getElementById('backList');
const dAuthor = document.getElementById('dAuthor');
const dTitle  = document.getElementById('dTitle');
const dMeta   = document.getElementById('dMeta');
const dContent= document.getElementById('dContent');
const dGallery= document.getElementById('dGallery');
const detailOwnerTools = document.getElementById('detailOwnerTools');
const delPost = document.getElementById('delPost');

let currentDetailId = null;

function openDetail(rec){
  currentDetailId = rec.objectId;

  // ä½œè€…
  dAuthor.innerHTML = `
    ${rec.authorAvatar ? `<img src="${rec.authorAvatar}" alt="">` : ''}
    <span>${esc(rec.authorName||'')}</span>
  `;

  // æ¨™é¡Œ & å…©çµ„æ™‚é–“
  dTitle.textContent = rec.title || 'ï¼ˆç„¡æ¨™é¡Œï¼‰';
  dMeta.innerHTML = `
    <span>å‰µä½œï¼š${esc(rec.dateStr)}ï½œ${esc(rec.solarStr)}${rec.approx?' â‰ˆ':''}</span>
    <span>æ—¥ï¼š${esc(rec.gzDay)}</span>
    <span>æ™‚ï¼š${esc(rec.gzHour)}</span>
    <span style="margin-left:6px">ï½œ</span>
    <span>ç™¼ä½ˆï¼š${esc(buildPubDisplay(rec))}${rec.pubApprox?' â‰ˆ':''}</span>
    <span>æ—¥ï¼š${esc(rec.pubGZDay)}</span>
    <span>æ™‚ï¼š${esc(rec.pubGZHr)}</span>
  `;
  dContent.textContent = rec.content || '';
  dGallery.innerHTML = '';
  (rec.images||[]).forEach(src=>{
    const img = document.createElement('img');
    img.src = src; img.loading = 'lazy'; img.alt = '';
    img.addEventListener('click', ()=>window.open(src,'_blank'));
    dGallery.appendChild(img);
  });

  // åªæœ‰ä½œè€…é¡¯ç¤ºåˆªé™¤éˆ•
  const me = AV.User.current();
  const isOwner = !!(me && rec.authorId && me.id === rec.authorId);
  detailOwnerTools.style.display = isOwner ? 'flex' : 'none';

  listView.style.display = 'none';
  detailView.style.display = 'block';

  // åˆªé™¤
delPost.onclick = async () => {
  if (!confirm('ç¢ºå®šåˆªé™¤æ­¤è²¼æ–‡ï¼Ÿ')) return;
  try {
    const obj = AV.Object.createWithoutData('Cloud', currentDetailId);
    await obj.destroy();                               // çœŸæ­£åˆªæ‰

    // â˜… è¨­å®šè¿”å›å¾Œè¦åˆ·æ–°
    sessionStorage.setItem('CLOUD_SHOULD_RELOAD', '1');

    // â˜… å›åˆ°åˆ—è¡¨ï¼ˆä¸å¼·åˆ¶æ•´é é‡è¼‰ï¼Œäº¤çµ¦åˆ—è¡¨é‚è¼¯åˆ·æ–°ï¼‰
    location.hash = '';
  } catch (e) {
    alert('åˆªé™¤å¤±æ•—ï¼š' + (e.message || e.code || 'æœªçŸ¥éŒ¯èª¤'));
  }
};
}
backList.addEventListener('click', ()=>{
  detailView.style.display='none';
  listView.style.display='block';
});
/* ========= é ­è²¼æŒ‘é¸ / ä¸Šå‚³ ========= */
/* ========= è©³æƒ…å®¹å™¨ï¼ˆå–®é ï¼‰ ========= */
const _listWrap = document.querySelector('.wrap'); // æ—¢æœ‰åˆ—è¡¨å¤–æ¡†
const _detailWrap = document.createElement('div');
_detailWrap.style.display = 'none';
_detailWrap.innerHTML = `
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin:10px 0 12px">
      <button id="postBack" class="btn">â† è¿”å›</button>
      <div id="postOwnerBtns" style="display:flex;gap:8px"></div>
    </div>
    <article id="postCard" class="card"></article>
  </div>
`;
document.body.appendChild(_detailWrap);

function showListView(){
  _detailWrap.style.display = 'none';
  _listWrap.style.display = 'block';
}
    // è©³æƒ…åœ–ç‰‡ï¼šèˆ‡ record.html ç›¸åŒçš„çµæ§‹ï¼ˆpicwrap + å¯é»é–‹ï¼‰
    const g = document.getElementById('postGallery');
    if (g){
      g.innerHTML = '';
      imgs.forEach(src=>{
        const wrap = document.createElement('span');
        wrap.className = 'picwrap';
        const img = document.createElement('img');
        img.loading = 'lazy';
        img.src = src;
        img.alt = '';
        img.addEventListener('click', ()=>window.open(src, '_blank'));
        wrap.appendChild(img);
        g.appendChild(wrap);
      });
    }
function showDetailView(){
  _listWrap.style.display = 'none';
  _detailWrap.style.display = 'block';
}
document.getElementById('postBack').addEventListener('click', ()=>{ location.hash = ''; });

/* ========= è©³æƒ…æ¸²æŸ“ ========= */
async function renderPost(objectId){
  try{
    const obj = await new AV.Query('Cloud').get(objectId);
    const me  = AV.User.current();

    const ownerId   = obj.get('authorId') || '';
    const iAmOwner  = !!me && me.id === ownerId;

    const author = {
      name  : obj.get('authorName')   || 'åŒ¿å',
      avatar: obj.get('authorAvatar') || 'https://i.imgur.com/7h9vW7N.png'
    };

    const title   = obj.get('title')   || 'ï¼ˆç„¡æ¨™é¡Œï¼‰';
    const content = obj.get('content') || '';
    const imgs    = obj.get('images')  || [];

    // ç™¼ä½ˆæ™‚é–“ï¼ˆçœŸå¤ªé™½æ™‚ï¼‰
   const pubStr = buildPubDisplay(obj);

    // å‰µä½œæ™‚é–“ï¼‹å¹²æ”¯ï¼ˆä¸Šå‚³æ™‚å°±å­˜å¥½çš„ï¼‰
    const createDate  = obj.get('dateStr')  || '';
    const createSolar = obj.get('solarStr') || '';
    const approx      = !!obj.get('approx');
    const gzDay       = obj.get('gzDay')    || '';
    const gzHour      = obj.get('gzHour')   || '';

    const postCard = document.getElementById('postCard');
    postCard.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <img src="${author.avatar}" alt="" style="width:32px;height:32px;border-radius:50%;object-fit:cover;border:1px solid var(--edge)">
        <div style="font-weight:700">${esc(author.name)}</div>
        <div class="badge dim" style="margin-left:auto">${esc(pubStr)}</div>
      </div>

      <div class="title" style="font-weight:800;font-size:1.2rem">ğŸ§ƒ${esc(title)}</div>

      <div class="meta">
        <span class="badge dim">å‰µä½œï¼š${esc(createDate)}ï½œ${esc(createSolar)}${approx?' â‰ˆ':''}</span>
        <span class="badge">æ—¥ï¼š${esc(gzDay)}</span>
        <span class="badge">æ™‚ï¼š${esc(gzHour)}</span>
      </div>

     <div class="content">${esc(content)}</div>

                  ${
        imgs.length
          ? `<div class="detail-gallery">
     ${imgs.map(u=>`<img src="${u}" alt="" loading="lazy">`).join('')}
   </div>`
          : ''
      }
    `;

       // æ“æœ‰è€…å·¥å…·åˆ—ï¼šå»ºç«‹ã€Œåˆªé™¤ã€æŒ‰éˆ•
    const ownerBar = document.getElementById('postOwnerBtns');
    ownerBar.innerHTML = '';
    if (iAmOwner) {
      const delBtn = document.createElement('button');
      delBtn.className = 'btn';
      delBtn.textContent = 'åˆªé™¤';
      delBtn.addEventListener('click', async () => {
        if (!confirm('ç¢ºå®šåˆªé™¤é€™å‰‡è²¼æ–‡ï¼Ÿ')) return;
        try {
          await obj.destroy();
          // å‘Šè¨´åˆ—è¡¨ï¼šè¿”å›æ™‚è¦åˆ·æ–°
          sessionStorage.setItem('CLOUD_SHOULD_RELOAD', '1');
          // å›åˆ°åˆ—è¡¨ï¼›route() æœƒåµæ¸¬æ——æ¨™ä¸¦ resetAndLoad()
          location.hash = '';
        } catch (err) {
          alert('åˆªé™¤å¤±æ•—ï¼š' + (err.message || err.code || 'æœªçŸ¥éŒ¯èª¤'));
        }
      });
      ownerBar.appendChild(delBtn);
    }

    showDetailView();
  }catch(err){
    console.error(err);
    alert('è®€å–è²¼æ–‡å¤±æ•—'); showListView();
  }
}

/* ========= Hash è·¯ç”± =========
   LeanCloud çš„ objectId æ˜¯è‹±æ•¸æ··åˆï¼Œé€™è£¡æ”¾å¯¬æ¯”å° */
/* ========= Hash è·¯ç”± =========
   LeanCloud çš„ objectId æ˜¯è‹±æ•¸æ··åˆï¼Œé€™è£¡æ”¾å¯¬æ¯”å° */
function route(){
  const m = location.hash.match(/^#\/post\/([A-Za-z0-9_-]+)$/);
  if (m) {
    // é€²å…¥è©³æƒ…
    renderPost(m[1]);
  } else {
    // å›åˆ°åˆ—è¡¨
    showListView(); // â† é€™è¡Œæœƒé—œæ‰ _detailWrapã€é¡¯ç¤ºåˆ—è¡¨

    // è‹¥è©³æƒ…é å‰›åˆªéï¼Œå›ä¾†å°±åˆ·æ–°åˆ—è¡¨
    if (sessionStorage.getItem('CLOUD_SHOULD_RELOAD') === '1') {
      sessionStorage.removeItem('CLOUD_SHOULD_RELOAD');
      resetAndLoad();
    }
  }
}
window.addEventListener('hashchange', route);
route(); // åˆå§‹
// ä¿éšªï¼šæœ‰äº›ç€è¦½å™¨è¿”å›æœƒç”¨å¿«å–ç•«é¢ï¼Œç”¨ pageshow å†æª¢ä¸€æ¬¡
window.addEventListener('pageshow', () => {
  if (sessionStorage.getItem('CLOUD_SHOULD_RELOAD') === '1') {
    sessionStorage.removeItem('CLOUD_SHOULD_RELOAD');
    resetAndLoad();
  }
});
  </script>
    <button id="backToTop" title="å›åˆ°é ‚ç«¯">ğŸ§ƒğŸ”</button>
  <script>
    // ç•¶é é¢æ»¾å‹•è¶…é 200pxï¼Œé¡¯ç¤ºæŒ‰éˆ•
window.onscroll = function() {
  let btn = document.getElementById("backToTop");
  if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
    btn.style.display = "block";
  } else {
    btn.style.display = "none";
  }
};

// é»æ“ŠæŒ‰éˆ•å¹³æ»‘æ»¾å‹•åˆ°é ‚ç«¯
document.getElementById("backToTop").addEventListener("click", function() {
  window.scrollTo({
    top: 0,
    behavior: "smooth"
  });
});
  </script>
  <button id="refreshBtn" title="é‡æ–°æ•´ç†">ğŸ«§</button>
<script>
  const refreshBtn = document.getElementById("refreshBtn");

  // æ²åˆ°ä¸€å®šè·é›¢æ‰é¡¯ç¤º
  window.addEventListener("scroll", () => {
    if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
      refreshBtn.style.display = "block";
    } else {
      refreshBtn.style.display = "none";
    }
  });

  // é»æ“Š â†’ åˆ·æ–°åˆ—è¡¨ï¼ˆç­‰æ–¼ resetAndLoadï¼‰
  refreshBtn.addEventListener("click", () => {
    // å¦‚æœä½ åªæƒ³åˆ·æ–°ç¸®ç•¥åœ–è€Œä¸æ˜¯æ•´å€‹é é¢ï¼š
    resetAndLoad();

    // å¦‚æœä½ è¦å¼·åˆ¶æ•´é é‡æ•´ï¼Œå°±æ”¹æˆï¼š
    // location.reload();
  });
</script>
<!--=================-->
<p style="text-align: center; font-size: 13px; color: #999; margin-top: 40px;">
  ğŸ¾ Â© 2024 yinnlimçš„å°å®‡å®™ï½œå…§å®¹èˆ‡è¨­è¨ˆçš†ç”±ç³–ç³–æœ¬äººç”¨æ„›è£½ä½œ ğŸ’<br>
  æœªç¶“æˆæ¬Šè«‹å‹¿éš¨æ„ä½¿ç”¨ã€ç›œè½‰å–” ğŸ™…â€â™€ï¸ è¬è¬ä½ çš„å°Šé‡èˆ‡æº«æŸ” ğŸ’Œ
</p>
</body>
</html>