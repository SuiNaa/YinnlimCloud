<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cloud｜雲端貼文牆</title>
<link rel="icon" href="/favicon.ico" />
<style>
  :root{
    --bg1:#14121a; --bg2:#1a1722;
    --card:rgba(255,255,255,.06);
    --text:#efe9ff; --muted:#b9b5c8;
    --accent:#b78ad3; --edge:rgba(255,255,255,.12);
    --shadow:0 12px 30px rgba(0,0,0,.35);
    --maxw:1040px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--text);
    background:
      radial-gradient(1000px 600px at 70% -10%, rgba(153,227,254,.25), transparent 60%),
      linear-gradient(160deg,var(--bg1),var(--bg2));
    font-family: ui-sans-serif, system-ui, "Noto Sans TC","Microsoft JhengHei", Arial, sans-serif;
    min-height:100dvh;
  }
  .wrap{max-width:var(--maxw); margin:0 auto; padding:18px 16px}
  .top{display:flex; flex-wrap:wrap; gap:10px; align-items:baseline; margin-bottom:12px}
  .time{
  font-size:clamp(28px,6vw,52px);
  font-weight:800;
  letter-spacing:.02em;
  white-space:nowrap;
  font-variant-numeric: tabular-nums;   /* 使用等寬數字 */
  font-feature-settings: "tnum";
  width: 7.3ch;                          /* 預留「00:00:00 ≈」的最大寬度 */
  text-align:right;                     /* 內容靠右，視覺更穩定 */
  line-height:1;                        /* 避免行高造成的上下跳動 */
}
  .badges{ display:flex; gap:8px; flex-wrap:wrap }
  .badge{ font-size:.85rem; padding:6px 10px; border:1px solid var(--edge); border-radius:999px; background:rgba(255,255,255,.06) }
  .badge.dim{ color:var(--muted) }
  .list{ display:grid; grid-template-columns: repeat(auto-fill,minmax(280px,1fr)); gap:12px }
  .card{
    background:var(--card); border:1px solid var(--edge); border-radius:14px;
    box-shadow:var(--shadow); padding:14px; display:flex; flex-direction:column; min-height:180px;
  }
  /* 卡片標題：只顯示 1 行，超出省略（無警告） */
/* 卡片標題：1 行 + 省略號（不會警告） */
.card .title{
  font-weight:700; font-size:1.05rem; margin-bottom:6px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* 內文：固定 2 行高度 + 視覺省略號（無前綴、零警告） */
.card .content{
  --lines: 2;        /* 要幾行就在這裡改 */
  --lh: 1.55;        /* 與你的 line-height 一致 */
  line-height: calc(var(--lh) * 1em);
  max-height: calc(var(--lines) * var(--lh) * 1em);
  overflow: hidden;
  position: relative;           /* 給 ::after 參考 */
}

/* 右下角做一個淡入背景並放上一個「…」 */
.groups > .group .card .content::after { 
  content:'........';
  position: absolute;
  right: 6px;
  bottom: 0;
  height: calc(var(--lh) * 1em);
  display: inline-block;
  padding-left: .35em;
  /* 從透明淡到卡片底色，避免突兀；var(--card) 就是你卡片背景 */
  background: linear-gradient(90deg, transparent, var(--card));
}

/* 縮略圖：只放第 1 張，做得很小 */
.card .gallery{ margin-top:8px; display:flex; gap:8px; justify-content:flex-start }


/* 卡片可點 */
.card{ cursor:pointer }
  .meta{ display:flex; gap:6px; flex-wrap:wrap; margin:6px 0 10px }
  .content{
    white-space:pre-wrap; line-height:1.55; color:var(--text);
    display:-webkit-box; line-clamp: 8; /* 部分瀏覽器支援 */
  overflow:hidden;
  display: -webkit-box;
-webkit-box-orient: vertical;
overflow: hidden;
  }
  .btn{ 
    background:transparent; 
    color:var(--text); 
    border:1px solid var(--edge); 
    border-radius:10px; 
    padding:8px 12px;
    cursor:pointer             
  }
  .btn.more{ width:100%; margin-top:14px }
  .empty{ color:var(--muted); text-align:center; padding:30px 0 }
  #backToTop {
  position: fixed;
  bottom: 40px;
  right: 40px;
  z-index: 99;
  display: none;        /* 預設隱藏 */
  background: #bb8cd3;  /* 你的主題色 */
  color: #fff;
  border: none;
  cursor: pointer;
  height: 40px;         /* 固定高度 */
  padding: 0 20px;      /* 左右比高度大 */
  border-radius: 20px;  /* 高度的一半 → 藥丸 */
  font-size: 14px;
  font-weight: bold;
  transition: opacity 0.3s, transform 0.2s;
}

#backToTop:hover {
  opacity: 0.85;
  transform: translateY(-2px);
}
/* ===== 刷新按鈕 ===== */
/* ===== 沒有背景的氣泡刷新按鈕 ===== */
#refreshBtn {
  display: none;
  position: fixed;
  bottom: 100px;     /* 距離底部 */
  right: 40px;       /* 距離右邊 */
  z-index: 99;
  font-size: 28px;   /* 🫧 大小 */
  background: none;  /* 沒背景 */
  border: none;      /* 沒邊框 */
  cursor: pointer;
  padding: 0;
  line-height: 1;
  transition: transform 0.2s ease;
}

#refreshBtn:hover {
  transform: scale(1.3);  /* 滑過放大一點點 */
}
</style>
<style>
    /* 使用者列（時鐘下方） */
.userbar{
  display:flex; align-items:center; gap:10px; margin-top:6px;
}
.userbar img{
  width:32px; height:32px; border-radius:50%; object-fit:cover; border:1px solid var(--edge);
}
.userbar .name{ font-weight:700 }
.userbar .muted{ color:var(--muted); font-size:.9rem }
.userbar .btn{ padding:6px 10px; border-radius:10px }

/* 簡易登入彈窗 */
.modal{ position:fixed; inset:0; display:none; place-items:center; z-index:1000;
  background:rgba(0,0,0,.45); -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px);}
.modal.show{ display:grid }
.modal-box{ width:min(92vw,480px); background:var(--card); border:1px solid var(--edge);
  border-radius:14px; padding:14px; box-shadow:var(--shadow) }
.modal .row{ display:flex; gap:8px; flex-wrap:wrap }
.input{ width:100%; background:rgba(255,255,255,.06); color:var(--text);
  border:1px solid var(--edge); border-radius:10px; padding:10px 12px; }
.modal .bar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }
/*=================*/
.avatar-picker{
  display:inline-block; cursor:pointer; border:1px solid var(--edge);
  border-radius:12px; padding:8px; background:rgba(255,255,255,.06);
}
#avatarPreview{
  width:96px; height:96px; border-radius:50%; object-fit:cover; display:block;
}
.seg-btn{
  background:transparent; color:var(--text); border:1px solid var(--edge);
  border-radius:999px; padding:6px 10px; cursor:pointer
}
.seg-btn.active{ background:var(--accent); color:#120d18; border-color:transparent }
.dimmed{ opacity:.5; pointer-events:none; }
/*===========*/
/* 縮略圖畫廊：靠左、在內文下面 */
.card .gallery{
  margin-top:8px;
  display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-start;
}

/* 作者列 */
.author{
  display:flex; align-items:center; gap:8px; margin:8px 0 6px;
  color:var(--muted); font-size:.9rem;
}
.author img{ width:24px; height:24px; border-radius:50%; object-fit:cover; border:1px solid var(--edge) }

/* 詳情頁（單頁） */
#detailView{ display:none; }
.detail-wrap{ max-width:var(--maxw); margin:0 auto; padding:18px 16px }
.detail-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px }
.detail-title{ font-size:1.2rem; font-weight:800; margin:0 0 6px }
.detail-meta{ color:var(--muted); display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px }

     .searchbar{ display:flex; gap:8px; align-items:center; margin:6px 0 10px }
.search-input{
  flex:1 1 260px; background:rgba(255,255,255,.06); color:var(--text);
  border:1px solid var(--edge); border-radius:10px; padding:10px 12px;
}
/* === 詳情頁圖片：固定尺寸、三張一排、超過自動換行 === */
.detail-gallery {
  display: grid;
  grid-template-columns: repeat(3, 0fr); /* 永遠三欄 */
  gap: 8px;                               /* 圖片間距 */
  align-items: start;
}

.detail-gallery img{
  width: auto;
  height: 64px;          /* 固定高度，你想放大就調整這數值 */
  object-fit: contain;      /* 填滿裁切，想完整顯示改成 contain */
  border-radius: 10px;
  display: block;
  background: transparent;
  border: none;
}
</style>
<style>
    /* 讓 ≈ 漂在日期 badge 上方的小提示 */
.badges { position: relative; }
#dateBadge { position: relative; }

/* 預設不顯示 */
#dateBadge::before{
  content:'≈';
  position:absolute;
  top:-0.9em;        /* 控制在日期上方 */
  right:6px;         /* 你可以改成 left:6px 看習慣 */
  font-size:.7em;    /* 比日期小一點 */
  color:var(--muted);
  opacity:0;
  transition:opacity .15s ease;
  pointer-events:none;
}

/* 有近似（估算）時才顯示 */
#dateBadge[data-approx="1"]::before { opacity:.95; }
/* 保持你原本的 .time 不變！只加這兩段 */
/* 1) 讓 #time 成為定位容器 */
#time { position: relative; }

/* 2) 浮在秒數右上的 ≈ */
#time::after{
  content:'≈';
  position:absolute;
  top:-0.7em;       /* 往上多抬一點 */
  right:-1ch;       /* 往右推出秒數外面 */
  font-size:.55em;
  line-height:1;
  color:var(--muted);
  opacity:0;
  pointer-events:none;
  transition:opacity .15s ease;
}
#time.approx::after { opacity:.95; }  /* 需要時顯示 */
</style>
<style>
    /*線00000000------------000*/
    /* === 依作者分群 + 紫外線色時間線 === */
.groups{ display:block }               /* 讓容器改為單欄直式 */
.group{ background:var(--card); border:1px solid var(--edge); border-radius:14px; padding:14px; margin-bottom:14px; box-shadow:var(--shadow)}
.group-head{ display:flex; align-items:center; gap:10px; margin-bottom:8px }
.group-head img{ width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid var(--edge) }
.group-head .name{ font-weight:800 }
.group-head .sub{ color:var(--muted); font-size:.9rem }

.timeline{ position:relative; margin:6px 0 0 14px; padding-left:18px; list-style:none }
.timeline::before{
  content:''; position:absolute; left:0; top:0; bottom:0;
  width:2px; border-left:2px dashed var(--accent); opacity:.9;   /* 紫外線色（=accent） */
}
.node{ position:relative; margin:10px 0 }
.node .dot{
  position:absolute; left:-11px; top:.55em; width:10px; height:10px; border-radius:50%;
  background:var(--accent); box-shadow:0 0 10px var(--accent);
}
.node .post{ border:1px solid var(--edge); border-radius:12px; padding:10px; background:rgba(255,255,255,.04) }
.node .pub{ font-size:.85rem; color:var(--muted); margin-bottom:6px }  /* 發佈時間 */
.node .title{ font-weight:700; margin-bottom:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.node .content{ white-space:pre-wrap; line-height:1.5; max-height:calc(1.5em*4); overflow:hidden; position:relative }
.node .content::after{ content:'……'; position:absolute; right:6px; bottom:0; background:linear-gradient(90deg,transparent,rgba(255,255,255,.04)); padding-left:.3em }
/* 縮略圖樣式（和舊卡片一致） */
.node .gallery{
  margin-top:8px;
  display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-start;
}

.node .actions{ display:flex; 
gap:8px; 
justify-content:flex-end; 
margin-top:8px 
}
/**/
/* === 使用者群組（頭貼+暱稱，上方） === */
.user-group{
  background:var(--card);
  border:1px solid var(--edge);
  border-radius:14px;
  box-shadow:var(--shadow);
  padding:12px;
  margin-bottom:14px;
}
.user-head{
  display:flex; align-items:center; gap:10px; margin-bottom:8px;
}
.user-head img{ width:36px; height:36px; border-radius:50%; object-fit:cover; border:1px solid var(--edge) }
.user-head .name{ font-weight:800; }

/* === 橫向時間線：上方一條線，項目橫向排版，超出截斷 === */
.timeline{
  position:relative;
  padding:14px 4px 8px;
  overflow:hidden;            /* 重要：螢幕不夠寬直接截斷 */
}
.timeline::before{
  content:"";
  position:absolute;
  left:0; right:0; top:24px;  /* 線的高度 */
  height:2px;
  background:linear-gradient(90deg, rgba(183,138,211,.9), rgba(183,138,211,.25));
  pointer-events:none;
}

/* 一排橫向的貼文節點 */
/* 取代原本的 .trow */
/* 取代原本的 .trow —— 關鍵是記住 gap 值供連線使用 */
.trow{
  --tgap: 12px;                 /* 與 .trow 的 gap 相同，兩卡之間的距離 */
  display:flex;
  gap: var(--tgap);
  overflow-x:auto;
  overflow-y:hidden;
  -webkit-overflow-scrolling: touch;
}

/* 關掉舊版「卡片左邊的點」 */
.titem::before{ display:none; }

/* 時間行（保持你原本設定） */
.titem .ts{
  position:relative;
  display:inline-flex;
  align-items:center;
  white-space:nowrap;
  color:var(--muted);
  font-size:.82rem;
  margin-bottom:6px;
  z-index:2;
}

/* 兩顆點：左(head) 右(tail) */
.titem .ts .ts-dot{
  width:8px; height:8px; border-radius:50%;
  background:var(--accent);
  box-shadow:0 0 10px var(--accent);
  flex:0 0 auto;
}
.titem .ts .ts-dot.head{ margin-right:6px; }
.titem .ts .ts-dot.tail{ margin-left:6px; position:relative; z-index:2; }

/* 從「尾點」接到下一張的「頭點」 */
.titem:not(:last-child) .ts .ts-dot.tail::after{
  content:"";
  position:absolute;
  top:50%; left:100%;
  transform:translateY(-50%);
  width: var(--linkw, var(--tgap));   /* JS 會塞最精準的長度；沒塞就用 gap */
  border-top:2px dashed var(--accent);
  opacity:.95;
  pointer-events:none;
  z-index:2;
}
/* 每個節點（小卡） */
.titem{
  position:relative;
  flex:0 0 auto;
    width:300px;               /* ← 原本是 170 */
}

/* === 固定 Cloud 列表縮略圖大小（不改外觀，只固定尺寸） === */
</style>
<style>
/* ===== 列表卡片：縮略圖列（與 record.html 一致） ===== */
.thumb-bar{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.twrap{
  position:relative;
  display:inline-block;
  line-height:0;
}

.thumb-mini{
  width:70px;
  height:70px;
  object-fit:contain;     /* 要裁切滿版可改 cover */
  border-radius:6px;
  background:transparent;
  flex:0 0 auto;
}
.thumb-more{
  position:absolute;
  right:4px;
  bottom:4px;
  padding:2px 6px;
  font-size:.78rem;
  line-height:1;
  color:#fff;
  background:rgba(0,0,0,.55);
  border-radius:999px;
  pointer-events:none;
  border:1px solid var(--edge);
}

/* ===== 詳情頁圖片（與 record.html 一致） ===== */
.gallery{                  /* 用統一的 .gallery 覆蓋 detail 用法 */
  display:block;
  margin-top:8px;
}
.picwrap{
  position:relative;
  display:inline-block;
  margin:8px 0;
}
.gallery img{
  display:block;
  max-width:100%;
  height:auto;
  border:none;
  background:transparent;
  border-radius:10px;
}
</style>
<style>
  /* === Cloud 時間線小卡：標題 + 兩行摘要 + 省略號，不被縮圖/裝飾蓋住 === */
.tcard{
  border:1px solid var(--edge);
  border-radius:12px; 
  position: relative; 
  padding:10px; background:rgba(255,255,255,.04);
  display: flex;
  flex-direction: column;
  height: 280px;   
}

/* 讓標題 / meta / 摘要 永遠在上層 */
.tcard .title,
.tcard .meta,
.tcard .excerpt{
  position: relative;
  z-index: 2;
}

/* 縮圖層級比文字低，避免蓋到標題 */
.tcard .thumb-bar,
.tcard .gallery{
  position: relative;
  z-index: 1;
}

/* 標題：單行省略 + 置中 */
.tcard .title{
  margin: 0 0 6px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-align: center;
  font-weight: 800;
}

/* 兩行摘要（iOS 需要 -webkit- 前綴） */
.tcard .excerpt{
  flex: 1 1 auto;
  min-width: 0;
  white-space: pre-wrap; /* 保留換行 */
  line-height: 1.5;
  color: var(--ink);

  /* 針對 WebKit（Chrome、Safari、Edge） */
    display: -webkit-box; /* 用 WebKit 的盒子模型 */
  display: box; /* 標準化的占位屬性，讓編輯器不報錯 */
  -webkit-box-orient: vertical; /* 私有屬性 */
  box-orient: vertical; /* 標準化的占位屬性 */
  
  overflow: hidden;
  /* VS Code 對這個會警告，加個標準屬性並列就好了 */
  line-clamp: 2; /* 標準占位，部分瀏覽器忽略 */
  -webkit-line-clamp: 2; /* 真正起作用的 */

  /* 針對 Firefox / 其他不支援 line-clamp 的瀏覽器 */
  overflow: hidden;
  text-overflow: ellipsis;
  max-height: calc(1.5em * 2); /* 行高 × 兩行 */        /* 給 ::after 用 */
}

/* 固定「刪除」到卡片右下角，不動 JS/HTML */
.tcard .actions{
  position: absolute;
  right: 8px;
  bottom: 8px;
  margin: 0;          /* 移除原本的 margin-top:8px 佔位 */
  z-index: 20;        /* 蓋過縮圖上的 +N 標籤 */
}

/* 保險：任何舊的 content 遮罩不要影響小卡 */
.tcard .content::after{ display:none !important; }
</style>
</head>
<body>
  <div class="wrap">
    <header class="top" aria-live="polite">
      <div class="time" id="time">--:--:--</div>
      <div class="badges">
        <span class="badge" id="dateBadge">—</span>
        <span class="badge" id="gzBadge">—</span>
        <span class="badge dim" id="precBadge">—</span>
        <span class="badge dim" id="locBadge">—</span>
        <span class="badge dim" id="cloudStatus">雲端：連線中…</span>
      </div>
      <!-- 使用者列（登入後會顯示頭貼＋暱稱；未登入顯示按鈕） -->
        <div id="userBar" class="userbar" aria-live="polite">
        <img id="userAvatar" src="" alt="" style="display:none">
     <div>
        <div id="userName" class="name" style="display:none"></div>
        <div id="userHint" class="muted">尚未登入</div>
     </div>
        <div style="margin-left:auto; display:flex; gap:8px">
        <button type="button" id="openLogin"  class="seg-btn active">登入</button>
        <button type="button" id="openSignup" class="seg-btn">註冊</button>
        <button id="openProf" class="btn" style="display:none">設定</button>
        <button id="logoutBtn" class="btn" style="display:none">登出</button>
        <button id="deleteAccount" class="btn" style="background:#b21f2d;color:#fff">註銷</button>
        <a href="record.html">
        <button class="btn" style="background:#b30eea;color:#6bceff">回到記錄</button>
        </a>
       </div>
    </div>
    </header>
    <button id="o" class="seg-btn">去Grove</button>
    <button id="L" class="seg-btn">Grove Hub🔙</button>
    <script>
      document.getElementById('o').addEventListener('click', () => {
  window.location.href = 'gender-identity.html';  // 或改成你主頁的實際路徑
});
document.getElementById('L').addEventListener('click', () => {
  window.location.href = 'help.html';  // 或改成你主頁的實際路徑
});
    </script>
<div class="searchbar">
  <input id="searchKey" class="search-input" placeholder="搜尋暱稱或標題…（Enter 執行）" />
  <button id="searchBtn" class="btn">搜尋</button>
  <button id="clearBtn"  class="btn" style="margin-left:6px">清除</button>
</div>
    <section id="cloudList" class="groups" role="list"></section>
    <div id="empty" class="empty" style="display:none">目前還沒有內容。</div>
    <button id="loadMore" class="btn more">載入更多</button>
  </div>
<!-- 登入 Modal（無暱稱、無頭貼） -->
<div id="loginModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="bar">
      <strong>登入</strong>
      <button id="loginClose" class="btn">關閉</button>
    </div>
    <div class="row">
      <input id="loginEmail" class="input" type="email" inputmode="email"
             placeholder="電子郵箱（必填）" autocomplete="email">
      <input id="loginPass" class="input" type="password" placeholder="密碼（必填）" autocomplete="current-password">
    </div>
    <div class="row" style="margin-top:8px; justify-content:flex-end">
      <button id="loginDo" class="btn">登入</button>
    </div>
    <div id="loginMsg" class="muted" style="margin-top:6px"></div>
  </div>
</div>

<!-- 註冊 Modal（有暱稱、可挑頭貼） -->
<div id="signupModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="bar">
      <strong>建立帳號</strong>
      <button id="signupClose" class="btn">關閉</button>
    </div>
    <div class="row">
      <input id="signupEmail" class="input" type="email" inputmode="email"
             placeholder="電子郵箱（必填）" autocomplete="email">
      <input id="signupPass" class="input" type="password" placeholder="密碼（至少 6 位英數）" autocomplete="new-password">
      <input id="signupNick" class="input" placeholder="暱稱（可選）" maxlength="30">

      <div class="k">頭貼（可選）</div>
      <label for="signupAvatarInput" class="avatar-picker" title="點擊選擇頭貼">
        <img id="signupAvatarPreview"
             src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cg fill='%23b78ad3'%3E%3Ccircle cx='60' cy='46' r='22'/%3E%3Cpath d='M16 108a44 44 0 0 1 88 0z'/%3E%3C/g%3E%3C/svg%3E"
             alt="頭貼預覽">
      </label>
      <input id="signupAvatarInput" type="file" accept="image/*" style="display:none">
      <div class="note">支援 jpg / png / gif，建議 &lt; 2MB。</div>
    </div>
    <div class="row" style="margin-top:8px; justify-content:flex-end">
      <button id="signupDo" class="btn">註冊</button>
    </div>
    <div id="signupMsg" class="muted" style="margin-top:6px"></div>
  </div>
</div>
<!-- 個人設定（修改暱稱／頭貼） -->
<div id="profModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="bar">
      <strong>個人設定</strong>
      <button id="profClose" class="btn">關閉</button>
    </div>

    <div class="row">
      <div class="k">暱稱</div>
      <input id="profNick" class="input" placeholder="輸入新的暱稱（1–30字）" maxlength="30">

      <div class="k">頭貼</div>
      <label for="avatarInput2" class="avatar-picker" title="點擊選擇頭貼">
        <img id="avatarPreview2"
             src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cg fill='%23b78ad3'%3E%3Ccircle cx='60' cy='46' r='22'/%3E%3Cpath d='M16 108a44 44 0 0 1 88 0z'/%3E%3C/g%3E%3C/svg%3E"
             alt="頭貼預覽">
      </label>
      <input id="avatarInput2" type="file" accept="image/*" style="display:none">
      <div class="note">支援 jpg / png / gif，建議 &lt; 2MB。</div>
    </div>

    <div class="row" style="margin-top:8px; justify-content:flex-end">
      <button id="profSave" class="btn">儲存變更</button>
    </div>
    <div id="profMsg" class="muted" style="margin-top:6px"></div>
  </div>
</div>
<!-- 單頁詳情 View -->
 <main id="detailView">
  <div class="detail-wrap">
    <div class="detail-head">
      <button id="backList" class="btn">← 返回</button>
      <div id="detailOwnerTools" style="display:none; gap:8px">
        <button id="delPost" class="btn">刪除此貼文</button>
      </div>
    </div>

    <article class="card">
      <div class="author" id="dAuthor"></div>
      <h1 class="detail-title" id="dTitle">—</h1>
      <div class="detail-meta" id="dMeta"></div>
      <pre id="dContent"></pre>
      <div class="detail-gallery" id="dGallery"> </div>
      <div class="muted" style="margin-top:8px">提示：點圖片可在新分頁開啟原圖。</div>
    </article>
  </div>
</main>
  <!-- LeanCloud JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4/dist/av-min.js"></script>

  <script>
  /* ========= 真太陽時 + 干支（23:00 換日） ========= */
  function dayOfYear(d){ const s=new Date(d.getFullYear(),0,1); return Math.floor((d-s)/86400000)+1; }
  function equationOfTime(date){ const n=dayOfYear(date), B=2*Math.PI*(n-81)/364; return 9.87*Math.sin(2*B)-7.53*Math.cos(B)-1.5*Math.sin(B); }
  function tzCenterMeridian(){ const offMin=-new Date().getTimezoneOffset(); return 15*(offMin/60); }
  function calcTrueSolar(nowLocal, lonDeg, hasGeo){
    const LSTM=tzCenterMeridian(), eot=equationOfTime(nowLocal);
    const offsetMin = eot + 4*(lonDeg - LSTM);
    const solar = new Date(nowLocal.getTime()+offsetMin*60*1000);
    const hh=String(solar.getHours()).padStart(2,'0'), mm=String(solar.getMinutes()).padStart(2,'0'), ss=String(solar.getSeconds()).padStart(2,'0');
    return { solar, text:`${hh}:${mm}:${ss}`, approx:!hasGeo };
  }
  const stems=["甲","乙","丙","丁","戊","己","庚","辛","壬","癸"], branch=["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"];
  // 公曆 → JDN（只取日期）
  function toJDN(y,m,d){ if(m<=2){y--;m+=12;} const A=Math.floor(y/100),B=2-A+Math.floor(A/4); return Math.floor(365.25*(y+4716))+Math.floor(30.6001*(m+1))+d+B-1524; }
  function gzIndexFromJDN(jdn){ return (jdn+49)%60; }
  function hourBranchIndex(h){ let H=Math.floor(h); if(H===23) H=-1; return Math.floor((H+1)/2); }
  function hourStemIndex(dayStemIdx, hourBrIdx){ const start=[0,2,4,6,8][dayStemIdx%5]; return (start+hourBrIdx)%10; }
  function getGanzhiForTrueSolar(solarDate, solarHours){
    const y=solarDate.getFullYear(), m=solarDate.getMonth()+1, d=solarDate.getDate();
    const addDay = (solarHours>=23)?1:0;
    const jdn = toJDN(y,m,d)+addDay;
    const dayIdx=gzIndexFromJDN(jdn), dayGan=stems[dayIdx%10], dayZhi=branch[dayIdx%12];
    const hBrIdx=hourBranchIndex(solarHours), hourGan=stems[hourStemIndex(dayIdx%10,hBrIdx)], hourZhi=branch[hBrIdx];
    return { day: dayGan+dayZhi, hour: hourGan+hourZhi };
  }

  /* ========= 時鐘 ========= */
  const timeEl=document.getElementById('time'), dateBadge=document.getElementById('dateBadge'),
        gzBadge=document.getElementById('gzBadge'), locBadge=document.getElementById('locBadge'),
        precBadge=document.getElementById('precBadge');
  let GEO={has:false, lon:tzCenterMeridian(), lat:0};
  function initGeo(){
    if(!navigator.geolocation){ locBadge.textContent='無定位（估算）'; return; }
    navigator.geolocation.getCurrentPosition(
      pos=>{ GEO.has=true; GEO.lat=pos.coords.latitude; GEO.lon=pos.coords.longitude; locBadge.textContent=`📍 ${GEO.lat.toFixed(4)}, ${GEO.lon.toFixed(4)}`; },
      _=>{ GEO.has=false; locBadge.textContent='未授權定位（估算）'; },
      {enableHighAccuracy:false, maximumAge:3600_000, timeout:8000}
    );
  }
  function tick(){
    const now=new Date();
    const ts=calcTrueSolar(now, GEO.lon, GEO.has);
    timeEl.textContent = ts.text;  // ≈ 不再放在時鐘裡
    precBadge.textContent = ts.approx ? "精度：估算" : "精度：依定位";
    const solarHours = ts.solar.getHours() + ts.solar.getMinutes()/60 + ts.solar.getSeconds()/3600;
    const {day:gzDay, hour:gzHour} = getGanzhiForTrueSolar(ts.solar, solarHours);
    gzBadge.textContent = `日：${gzDay}　時：${gzHour}`;
    const dstr = now.toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'short'});
dateBadge.textContent = `${dstr}｜真太陽時`;

// 告訴 CSS 是否顯示 ≈
dateBadge.setAttribute('data-approx', ts.approx ? '1' : '0');
timeEl.textContent = ts.text;  // 保持時鐘字級與寬度
if (ts.approx) timeEl.classList.add('approx');
else timeEl.classList.remove('approx');

    }
  initGeo(); tick(); setInterval(tick,1000);
/* 兼容舊/新欄位名，組「YYYY/MM/DD｜HH:MM:SS」 */
function buildPubDisplay(x){
  // x 可以是 AV.Object 或 plain object（rec）
  const get = (k)=> (typeof x.get === 'function' ? x.get(k) : x[k]) || '';
  const date  = get('pubDateStr')  || get('pubDate');      // 兩種都試
  const solar = get('pubSolarStr') || get('pubSolar');     // 兩種都試
  if (!date && !solar) return '';
  return `${date}${date && solar ? '｜' : ''}${solar}`;
}
  /* ========= LeanCloud 連線 ========= */
  const cloudStatus=document.getElementById('cloudStatus');
  AV.init({
    appId: '0juO0jzBkrv1Oi04bHljaWDW-gzGzoHsz',
    appKey: 'kFMz8niEbd8BlPbFKDyTZC2Q',
    serverURL: 'https://0juo0jzb.lc-cn-n1-shared.com'
  });
function persistSession(user){
  try{
    if (user) localStorage.setItem('LC_SESSION_TOKEN', user.getSessionToken());
  }catch(e){ console.warn('persistSession failed', e); }
}
function clearSession(){
  try{ localStorage.removeItem('LC_SESSION_TOKEN'); }catch{}
}
  async function healthCheck(){
    try{
      const q=new AV.Query('Cloud'); q.limit(1);
      await q.find();
      cloudStatus.textContent='雲端：已連線'; cloudStatus.classList.remove('dim');
      console.info('[LeanCloud] ready');
    }catch(err){
      console.error('[LeanCloud] 連線失敗：', err);
      let hint='';
      switch(err.code){
        case 401: hint='（權限不足：到 Cloud 類別開放 find/get 給所有用戶，或開放預設讀權限）'; break;
        case 403: hint='（網域不在白名單：設定→安全域名加上此頁完整來源含協議與端口）'; break;
        case 404: hint='（serverURL 或 AppID/Key 不正確：檢查 AV.init）'; break;
        default:  hint=`（code: ${err.code ?? '未知'}）`;
      }
      cloudStatus.textContent='雲端：連線失敗 ' + hint;
      cloudStatus.classList.add('dim');
    }
  }
  healthCheck();
  //=========
/* ========= 開窗/關窗（登入 / 註冊） ========= */
const openLoginBtn  = document.getElementById('openLogin');
const openSignupBtn = document.getElementById('openSignup');

const loginModal  = document.getElementById('loginModal');
const loginClose  = document.getElementById('loginClose');
const loginEmail  = document.getElementById('loginEmail');
const loginPass   = document.getElementById('loginPass');
const loginDo     = document.getElementById('loginDo');
const loginMsg    = document.getElementById('loginMsg');

const signupModal = document.getElementById('signupModal');
const signupClose = document.getElementById('signupClose');
const signupEmail = document.getElementById('signupEmail');
const signupPass  = document.getElementById('signupPass');
const signupNick  = document.getElementById('signupNick');
const signupDo    = document.getElementById('signupDo');
const signupMsg   = document.getElementById('signupMsg');

function openLogin(prefillEmail=''){
  loginEmail.value = prefillEmail;
  loginPass.value  = '';
  loginMsg.textContent = '';
  loginModal.classList.add('show');
  loginModal.setAttribute('aria-hidden','false');
  loginEmail.focus();
}
function closeLogin(){
  loginModal.classList.remove('show');
  loginModal.setAttribute('aria-hidden','true');
}
function openSignup(prefillEmail=''){
  signupEmail.value = prefillEmail;
  signupPass.value  = '';
  signupNick.value  = '';
  signupMsg.textContent = '';
  pickedSignupAvatarFile = null;
  signupAvatarInput.value = '';
  signupAvatarPreview.src =
    "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cg fill='%23b78ad3'%3E%3Ccircle cx='60' cy='46' r='22'/%3E%3Cpath d='M16 108a44 44 0 0 1 88 0z'/%3E%3C/g%3E%3C/svg%3E";
  signupModal.classList.add('show');
  signupModal.setAttribute('aria-hidden','false');
  signupEmail.focus();
}
function closeSignup(){
  signupModal.classList.remove('show');
  signupModal.setAttribute('aria-hidden','true');
}

openLoginBtn.addEventListener('click',  ()=>openLogin());
openSignupBtn.addEventListener('click', ()=>openSignup());
loginClose.addEventListener('click', closeLogin);
signupClose.addEventListener('click', closeSignup);
loginModal.addEventListener('click', e=>{ if(e.target===loginModal) closeLogin(); });
signupModal.addEventListener('click', e=>{ if(e.target===signupModal) closeSignup(); });
window.addEventListener('keydown', e=>{
  if(e.key==='Escape'){
    if(loginModal.classList.contains('show')) closeLogin();
    if(signupModal.classList.contains('show')) closeSignup();
  }
});

/* ========= 驗證工具 ========= */
function isEmail(s){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s); }
function isAlnum6Plus(s){ return /^[A-Za-z0-9]{6,}$/.test(s); }

/* ========= 登入流程（不存在就引導註冊） ========= */
loginDo.addEventListener('click', async ()=>{
  const email = loginEmail.value.trim();
  const pass  = loginPass.value.trim();

  if(!isEmail(email)){ loginMsg.textContent='請填寫正確的電子郵箱'; loginEmail.focus(); return; }
  if(!isAlnum6Plus(pass)){ loginMsg.textContent='密碼至少 6 位英數'; loginPass.focus(); return; }

  loginDo.disabled = true; loginMsg.textContent='登入中…';
  try{
    const user = await AV.User.logIn(email, pass);
if(isEmail(email) && !user.getEmail()){ user.setEmail(email); await user.save(); }
persistSession(user);           // ★ 存 token
showUserInfo(user);
closeLogin();
  }catch(err){
    console.error(err);
    if(err.code === 211){ // 使用者不存在 → 去註冊
      closeLogin();
      openSignup(email);
      signupMsg.textContent = '這個帳號尚未註冊，請先建立帳號';
    }else if(err.code === 210){
      loginMsg.textContent = '帳號或密碼錯誤';
    }else{
      loginMsg.textContent = `登入失敗：${err.message || err.code || '未知錯誤'}`;
    }
  }finally{
    loginDo.disabled = false;
  }
});

/* ========= 註冊：頭貼挑選 / 上傳 ========= */
const signupAvatarInput   = document.getElementById('signupAvatarInput');
const signupAvatarPreview = document.getElementById('signupAvatarPreview');
let pickedSignupAvatarFile = null;

signupAvatarInput.addEventListener('change', ()=>{
  const f = signupAvatarInput.files?.[0];
  if(!f) return;
  const MAX = 2*1024*1024; // 你要改上限就改這裡（目前 2MB）
  if(f.size > MAX){ alert('圖片太大，請小於 2MB'); signupAvatarInput.value=''; return; }
  pickedSignupAvatarFile = f;
  const r = new FileReader();
  r.onload = e => { signupAvatarPreview.src = e.target.result; };
  r.readAsDataURL(f);
});

async function uploadSignupAvatarIfAny(){
  if(!pickedSignupAvatarFile) return null;
  const file = new AV.File(pickedSignupAvatarFile.name, pickedSignupAvatarFile);
  await file.save();
  return file.url();
}

/* ========= 註冊流程（已存在→跳登入） ========= */
signupDo.addEventListener('click', async ()=>{
  const email = signupEmail.value.trim();
  const pass  = signupPass.value.trim();
  const nick  = signupNick.value.trim();

  if(!isEmail(email)){ signupMsg.textContent='請填寫正確的電子郵箱'; signupEmail.focus(); return; }
  if(!isAlnum6Plus(pass)){ signupMsg.textContent='密碼至少 6 位英數'; signupPass.focus(); return; }
  if(!nick){ signupMsg.textContent='請填寫暱稱'; signupNick.focus(); return; }

  signupDo.disabled = true; signupMsg.textContent='建立中…';
  try{
    const avatarUrl = await uploadSignupAvatarIfAny();
    const user = new AV.User();
    user.setUsername(email);
    user.setPassword(pass);
    user.setEmail(email);
    user.set('nickname', nick);
    if(avatarUrl) user.set('avatar', avatarUrl);

    await user.signUp();
persistSession(user);          // ★ 存 token
showUserInfo(user);
closeSignup();
  }catch(err){
    console.error(err);
    if(err.code === 202){ // 已存在 → 去登入
      closeSignup();
      openLogin(email);
      loginMsg.textContent = '此帳號已註冊，請直接登入';
    }else{
      signupMsg.textContent = `註冊失敗：${err.message || err.code || '未知錯誤'}`;
    }
  }finally{
    signupDo.disabled = false;
  }
  await user.signUp();

// ✅ 註冊完為新用戶設置友善的預設 ACL（自己可寫、所有人可讀）
const acl = new AV.ACL();
acl.setPublicReadAccess(true);
acl.setWriteAccess(user, true);
user.setACL(acl);
await user.save();
});

/* ========= 使用者列顯示 ========= */
const userAvatar = document.getElementById('userAvatar');
const userName   = document.getElementById('userName');
const userHint   = document.getElementById('userHint');
const logoutBtn  = document.getElementById('logoutBtn');
const DEFAULT_AVATAR = 'https://i.imgur.com/7h9vW7N.png';

function showUserInfo(u){
  if(!u){
    userAvatar.style.display='none';
    userName.style.display='none';
    userHint.style.display='';
    userHint.textContent='尚未登入';
    refreshUserBarButtons(null);
    return;
  }
  const nick = u.get('nickname') || u.getUsername();
  const ava  = u.get('avatar')   || DEFAULT_AVATAR;

  userAvatar.src = ava;
  userAvatar.style.display='';
  userName.textContent = nick;
  userName.style.display='';
  userHint.style.display='none';
  refreshUserBarButtons(u);
}

/* 登出 */
logoutBtn.addEventListener('click', async ()=>{
  await AV.User.logOut();
  clearSession();              // ★ 清 token
  showUserInfo(null);
});

/* 頁面載入時同步使用者列 */
showUserInfo(AV.User.current());

/* ========= 個人設定：修改暱稱／頭貼 ========= */
const openProf   = document.getElementById('openProf');
const profModal  = document.getElementById('profModal');
const profClose  = document.getElementById('profClose');
const profNick   = document.getElementById('profNick');
const profSave   = document.getElementById('profSave');
const profMsg    = document.getElementById('profMsg');

// 第二組頭貼選檔／預覽（不影響登入彈窗那一組）
const avatarInput2   = document.getElementById('avatarInput2');
const avatarPreview2 = document.getElementById('avatarPreview2');
let pickedAvatarFile2 = null;

function refreshUserBarButtons(u){
  const logged = !!u;
  document.getElementById('openLogin').style.display  = logged ? 'none' : '';
  document.getElementById('openSignup').style.display = logged ? 'none' : '';
  document.getElementById('openProf').style.display   = logged ? '' : 'none';
  document.getElementById('logoutBtn').style.display  = logged ? '' : 'none';
}
const _origShowUserInfo = showUserInfo;
showUserInfo = function(u){ _origShowUserInfo(u); refreshUserBarButtons(u); };
refreshUserBarButtons(AV.User.current());

// 開啟設定面板：帶入目前暱稱與頭貼
function openProfModal(){
  const u = AV.User.current();
  if(!u){ alert('請先登入'); return; }

  profMsg.textContent = '';
  profNick.value = u.get('nickname') || u.getUsername() || '';

  const ava = u.get('avatar') || '';
  avatarPreview2.src = ava || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cg fill='%23b78ad3'%3E%3Ccircle cx='60' cy='46' r='22'/%3E%3Cpath d='M16 108a44 44 0 0 1 88 0z'/%3E%3C/g%3E%3C/svg%3E";
  pickedAvatarFile2 = null;
  avatarInput2.value = '';

  profModal.classList.add('show');
  profModal.setAttribute('aria-hidden','false');
}
function closeProf(){ profModal.classList.remove('show'); profModal.setAttribute('aria-hidden','true'); }

openProf.addEventListener('click', openProfModal);
profClose.addEventListener('click', closeProf);
profModal.addEventListener('click', e=>{ if(e.target===profModal) closeProf(); });

// 選檔即時預覽
avatarInput2.addEventListener('change', ()=>{
  const f = avatarInput2.files?.[0];
  if(!f) return;
  const MAX = 2 * 1024 * 1024;
  if(f.size > MAX){ alert('圖片太大，請小於 2MB'); avatarInput2.value=''; return; }
  pickedAvatarFile2 = f;

  const reader = new FileReader();
  reader.onload = e => { avatarPreview2.src = e.target.result; };
  reader.readAsDataURL(f);
});

// 小工具：把 File 上傳到 LeanCloud，回傳公開 URL
async function uploadAvatarFile(file){
  const af = new AV.File(file.name, file);
  await af.save();
  return af.url();
}

// 儲存變更
profSave.addEventListener('click', async ()=>{
  const u = AV.User.current();
  if(!u){ profMsg.textContent = '尚未登入'; return; }

  let nick = profNick.value.trim();
  if(nick.length === 0 || nick.length > 30){
    profMsg.textContent = '暱稱長度需 1–30 字';
    return;
  }

  profSave.disabled = true; profMsg.textContent = '儲存中…';

  try{
    // 如果挑了新頭貼就先上傳
    let newAvatarUrl = null;
    if(pickedAvatarFile2){
      newAvatarUrl = await uploadAvatarFile(pickedAvatarFile2);
    }

    // 寫回使用者
    u.set('nickname', nick);
    if(newAvatarUrl) u.set('avatar', newAvatarUrl);
    await u.save();

    // 更新頁面上的頭貼與暱稱（沿用你的原函式）
    showUserInfo(u);
    profMsg.textContent = '已更新。';
    setTimeout(closeProf, 600);
  }catch(err){
    console.error(err);
    profMsg.textContent = `失敗：${err.message || err.code || '未知錯誤'}`;
  }finally{
    profSave.disabled = false;
  }
});
document.getElementById('deleteAccount').addEventListener('click', async () => {
  const u = AV.User.current();
  if (!u) return alert('尚未登入');

  if (!confirm('⚠️ 這會刪除你的帳號與所有貼文，且無法復原。確定嗎？')) return;
  if (!confirm('最後確認：真的要永久刪除？')) return;

  const sessionToken = u.getSessionToken();

  // 1) 先刪自己的貼文（類別：Cloud；用 authorId 比對）
  try {
    while (true) {
      const q = new AV.Query('Cloud');
      q.equalTo('authorId', u.id);
      q.limit(100);               // 分批刪
      const rows = await q.find();
      if (!rows.length) break;
      await AV.Object.destroyAll(rows);  // 需擁有者可寫 ACL
    }
  } catch (e) {
    console.warn('刪貼文時有失敗的項目（略過）:', e);
  }

  // 2) 嘗試直接刪除帳戶本身（前端）
  try {
    await u.destroy();            // 需要 _User 類：delete=「登入用戶」，且此 user ACL 允許本人寫入
  } catch (e) {
    alert('刪除帳戶失敗：' + (e.message || e.code || '未知錯誤') +
          '\n\n請到控制台把「_User 類的 delete 權限」設為「登入用戶」，且使用者物件 ACL 要允許本人寫入。');
    return;
  }

  // 3) 驗證舊 session 失效（能 become 就代表沒刪掉）
  try {
    await AV.User.become(sessionToken);
    alert('刪除失敗：舊登入仍有效，請稍後再試。');
    return;
  } catch (_) {
    // 失效代表真的刪掉了
  }

  // 4) 收尾：清本地、登出、刷新
  try { localStorage.removeItem('LC_SESSION_TOKEN'); } catch {}
  await AV.User.logOut();
  alert('✅ 帳號與貼文已註銷。');
  location.reload();
});
// 初始：依目前登入狀態調整按鈕可見性
refreshUserBarButtons(AV.User.current());
  /* ========= 載入列表（分頁） ========= */
const listEl = document.getElementById('cloudList');
const emptyEl = document.getElementById('empty');
const loadMoreBtn = document.getElementById('loadMore');
let PAGE = 0, SIZE = 20, BUSY = false, DONE = false;

let SEARCH = ''; // ← 目前搜尋關鍵字（空字串表示不過濾）
const searchInput = document.getElementById('searchKey');
const searchBtn   = document.getElementById('searchBtn');
const clearBtn    = document.getElementById('clearBtn');

/* 小工具：HTML 逃脫（只保留一個定義即可） */
function esc(s=''){
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function resetAndLoad(){
  // 清空畫面 & 狀態
  listEl.innerHTML = '';
  PAGE = 0; DONE = false;
  groupMap.clear(); // ★ 清作者群組快取
  loadPage();
}
function doSearch(){
  SEARCH = (searchInput.value || '').trim();
  resetAndLoad();
}
searchBtn.addEventListener('click', doSearch);
searchInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') doSearch(); });
clearBtn.addEventListener('click', ()=>{
  searchInput.value = '';
  if (SEARCH !== ''){ SEARCH = ''; resetAndLoad(); }
});

/* ====== 作者分群：結構與排序 ====== */
const groupMap = new Map(); // key: groupKey → {wrap, timeline, author}

function authorFromRow(o){
  return {
    id    : o.get('authorId') || '',
    name  : o.get('authorName') || '匿名',
    avatar: o.get('authorAvatar') || 'https://i.imgur.com/7h9vW7N.png'
  };
}
// 群組鍵：優先用 authorId，沒有就退回暱稱
function groupKeyOf(a){ return a.id ? `id:${a.id}` : `anon:${a.name}`; }

function ensureGroup(a){
  const key = groupKeyOf(a);
  if (groupMap.has(key)) return groupMap.get(key);

  const wrap = document.createElement('section');
  wrap.className = 'group';
  wrap.dataset.group = key;
  wrap.innerHTML = `
    <div class="group-head">
      <img src="${a.avatar}" alt="">
      <div>
        <div class="name">${esc(a.name)}</div>
        <div class="sub">此人的貼文</div>
      </div>
    </div>
    <div class="timeline">
      <div class="trow"></div>
    </div>
  `;
  listEl.appendChild(wrap);

  const pack = { wrap, timeline: wrap.querySelector('.trow'), author: a };

  // ★★★ 只在這裡（pack 建好後）綁一次 scroll 監聽 ★★★
  const row = pack.timeline;
  if (!row._linkBound){
    row._linkBound = true;
    let ticking = false;
    row.addEventListener('scroll', ()=>{
      if(!ticking){
        requestAnimationFrame(()=>{ linkDots(); ticking = false; });
        ticking = true;
      }
    });
  }
  // ★★★ 結束 ★★★

  groupMap.set(key, pack);
  return pack;
}

// 插入到該作者的水平列，依時間新→舊
function insertNodeSorted(rowEl, nodeEl, tms){
  nodeEl.dataset.tms = String(tms);
  const nodes = Array.from(rowEl.children);
  const idx = nodes.findIndex(n => Number(n.dataset.tms) < tms);
  if (idx === -1) rowEl.appendChild(nodeEl);
  else rowEl.insertBefore(nodeEl, nodes[idx]);
}

/* ====== UI小工具（改：輸出整個畫廊，而不是只有第一張） ====== */
/* ====== 列表用縮略圖（只顯示第一張，右下 +N） ====== */
function galleryHTML(imgs){
  if (!imgs || !imgs.length) return '';
  const cover = imgs[0];
  const extra = Math.max(0, imgs.length - 1);
  return (
    '<div class="thumb-bar">' +
      '<span class="twrap">' +
        '<img class="thumb-mini" src="' + esc(cover) + '" alt="" loading="lazy">' +
        (extra ? '<span class="thumb-more">+' + extra + '</span>' : '') +
      '</span>' +
    '</div>'
  );
}
/* ====== 依作者分群 + 水平紫外線時間線 渲染 ====== */
async function loadPage(){
  if (BUSY || DONE) return;
  BUSY = true; loadMoreBtn.textContent = '載入中…';

  try{
    // 查詢（支援標題 / 暱稱關鍵字）
    let q;
    if (SEARCH){
      const qTitle  = new AV.Query('Cloud').contains('title', SEARCH);
      const qAuthor = new AV.Query('Cloud').contains('authorName', SEARCH);
      q = AV.Query.or(qTitle, qAuthor);
    }else{
      q = new AV.Query('Cloud');
    }
    q.descending('createdAt').skip(PAGE*SIZE).limit(SIZE);

    const rows = await q.find();

    if (PAGE === 0){
      listEl.innerHTML = '';
      emptyEl.style.display = rows.length ? 'none' : 'block';
      loadMoreBtn.style.display = rows.length ? '' : 'none';
    }

    rows.forEach(o=>{
      const a = authorFromRow(o);
      const { timeline } = ensureGroup(a);  // timeline = 該作者的 .trow

      const title   = o.get('title')   || '（無標題）';
      const content = o.get('content') || '';
      const imgs    = o.get('images')  || [];

      // 發佈時間（你的現有工具）
      const pubStr = buildPubDisplay(o);

      // 創作時間＋干支（上傳時就已存）
      const createDate  = o.get('dateStr')  || '';
      const createSolar = o.get('solarStr') || '';
      const approx      = !!o.get('approx');
      const gzDay       = o.get('gzDay')    || '';
      const gzHour      = o.get('gzHour')   || '';

      // 節點卡片（橫向 item）
      const item = document.createElement('div');
      item.className = 'titem';
      item.dataset.id = o.id;
     const me      = AV.User.current();
     const isOwner = !!(me && a.id && me.id === a.id);

    item.innerHTML = `
  <div class="ts">
    <span class="ts-dot head" aria-hidden="true"></span>
    ${esc(pubStr)}
    <span class="ts-dot tail" aria-hidden="true"></span>
  </div>
  <div class="tcard">
    <div class="title">🧃 ${esc(title)}</div>
    <div class="meta" style="display:flex; gap:6px; flex-wrap:wrap; margin:4px 0 6px">
      <span class="badge dim">創作：${esc(createDate)}｜${esc(createSolar)}${approx?' ≈':''}</span>
      <span class="badge">日：${esc(gzDay)}</span>
      <span class="badge">時：${esc(gzHour)}</span>
    </div>
    <div class="excerpt">${esc(content)}</div>
    ${ galleryHTML(imgs) }
    ${ isOwner ? `<div class="actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                    <button class="btn" data-act="del">刪除</button>
                  </div>` : '' }
  </div>
`;
// 停用 actions 的冒泡 & 綁定刪除
const actions = item.querySelector('.actions');
if (actions){
  actions.addEventListener('click', e => e.stopPropagation());
  const delBtn = actions.querySelector('[data-act="del"]');
  delBtn.addEventListener('click', async ()=>{
  if(!confirm('確定刪除此貼文？')) return;

  try{
    await o.destroy();          // 刪後 server 成功
    // 先拿到這個作者群組（刪之前先抓 pack 才不會找不到）
    const groupKey = groupKeyOf(a);
    const pack     = groupMap.get(groupKey);

    // 從畫面移除這張卡
    item.remove();

    // 如果該作者這一列一張不剩，整個群組區塊也移掉
    if (pack && pack.timeline.querySelectorAll('.titem').length === 0){
      pack.wrap.remove();
      groupMap.delete(groupKey);
    }

    // 判斷「是否刪到自己最後一篇」→ 只剩 0 篇就整頁重整一次
    const me = AV.User.current();
    if (me && a.id && me.id === a.id){
      const q = new AV.Query('Cloud');
      q.equalTo('authorId', me.id);
      const left = await q.count();      // 我在雲端剩幾篇
      if (left === 0){
        location.reload();               // ✅ 最後一篇 → 刷新
        return;
      }
    }

    // 不是最後一篇 → 輕量重算連線與載入更多鈕
    if (document.querySelectorAll('.titem').length === 0){
      // 全站都沒內容了（極少見）→ 顯示空狀態
      emptyEl.style.display = 'block';
      loadMoreBtn.style.display = 'none';
    }else{
      requestAnimationFrame(linkDots);
    }
  }catch(err){
    alert('刪除失敗：' + (err.message || err.code || '未知錯誤'));
  }
});

}

      // 點卡片 → 詳情
      item.addEventListener('click', ()=>{ location.hash = `#/post/${o.id}`; });

      // 用 createdAt 排序（新→舊）
      const created = o.createdAt || o.get('createdAt') || new Date();
      const tms = (created instanceof Date ? created : new Date(created)).getTime();
      insertNodeSorted(timeline, item, tms);
    });
    requestAnimationFrame(linkDots);
    // 分頁控制
    if (rows.length < SIZE){
      DONE = true; loadMoreBtn.textContent = '沒有更多了'; loadMoreBtn.disabled = true;
    }else{
      PAGE++; loadMoreBtn.textContent = '載入更多';
    }
  }catch(err){
    console.error('[Cloud.load] 錯誤：', err);
    emptyEl.style.display='block';
    emptyEl.textContent = '載入失敗：' + (err.message || err.code || '未知錯誤');
  }finally{
    BUSY = false;
  }
}
loadMoreBtn.addEventListener('click', loadPage);
loadPage(); // 首次載入
window.addEventListener('resize', linkDots);
// 綁一次就好
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.trow').forEach(row=>{
    let ticking = false;
    row.addEventListener('scroll', ()=>{
      if(!ticking){
        requestAnimationFrame(()=>{ linkDots(); ticking = false; });
        ticking = true;
      }
    });
  });
});
linkDots();
// 量每列上「本卡尾點 → 下一卡頭點」的水平距離，寫到 --linkw
function linkDots(){
  document.querySelectorAll('.trow').forEach(row=>{
    const items = Array.from(row.children);
    for(let i=0; i<items.length; i++){
      const curTail  = items[i]?.querySelector('.ts .ts-dot.tail');
      if(!curTail) continue;

      if(i === items.length - 1){
        curTail.style.removeProperty('--linkw');   // 最後一張不要線
        continue;
      }

      const nextHead = items[i+1]?.querySelector('.ts .ts-dot.head');
      if(!nextHead) continue;

      const a = curTail.getBoundingClientRect();
      const b = nextHead.getBoundingClientRect();
      const w = Math.max(0, b.left - a.right);     // 尾點右緣 → 下一張頭點左緣
      curTail.style.setProperty('--linkw', w + 'px');
    }
  });
}
// 逃脫工具
function esc(s=''){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

const listView = document.querySelector('.wrap').parentElement;  // 你的列表 main
const detailView = document.getElementById('detailView');
const backList = document.getElementById('backList');
const dAuthor = document.getElementById('dAuthor');
const dTitle  = document.getElementById('dTitle');
const dMeta   = document.getElementById('dMeta');
const dContent= document.getElementById('dContent');
const dGallery= document.getElementById('dGallery');
const detailOwnerTools = document.getElementById('detailOwnerTools');
const delPost = document.getElementById('delPost');

let currentDetailId = null;

function openDetail(rec){
  currentDetailId = rec.objectId;

  // 作者
  dAuthor.innerHTML = `
    ${rec.authorAvatar ? `<img src="${rec.authorAvatar}" alt="">` : ''}
    <span>${esc(rec.authorName||'')}</span>
  `;

  // 標題 & 兩組時間
  dTitle.textContent = rec.title || '（無標題）';
  dMeta.innerHTML = `
    <span>創作：${esc(rec.dateStr)}｜${esc(rec.solarStr)}${rec.approx?' ≈':''}</span>
    <span>日：${esc(rec.gzDay)}</span>
    <span>時：${esc(rec.gzHour)}</span>
    <span style="margin-left:6px">｜</span>
    <span>發佈：${esc(buildPubDisplay(rec))}${rec.pubApprox?' ≈':''}</span>
    <span>日：${esc(rec.pubGZDay)}</span>
    <span>時：${esc(rec.pubGZHr)}</span>
  `;
  dContent.textContent = rec.content || '';
  dGallery.innerHTML = '';
  (rec.images||[]).forEach(src=>{
    const img = document.createElement('img');
    img.src = src; img.loading = 'lazy'; img.alt = '';
    img.addEventListener('click', ()=>window.open(src,'_blank'));
    dGallery.appendChild(img);
  });

  // 只有作者顯示刪除鈕
  const me = AV.User.current();
  const isOwner = !!(me && rec.authorId && me.id === rec.authorId);
  detailOwnerTools.style.display = isOwner ? 'flex' : 'none';

  listView.style.display = 'none';
  detailView.style.display = 'block';

  // 刪除
delPost.onclick = async () => {
  if (!confirm('確定刪除此貼文？')) return;
  try {
    const obj = AV.Object.createWithoutData('Cloud', currentDetailId);
    await obj.destroy();                               // 真正刪掉

    // ★ 設定返回後要刷新
    sessionStorage.setItem('CLOUD_SHOULD_RELOAD', '1');

    // ★ 回到列表（不強制整頁重載，交給列表邏輯刷新）
    location.hash = '';
  } catch (e) {
    alert('刪除失敗：' + (e.message || e.code || '未知錯誤'));
  }
};
}
backList.addEventListener('click', ()=>{
  detailView.style.display='none';
  listView.style.display='block';
});
/* ========= 頭貼挑選 / 上傳 ========= */
/* ========= 詳情容器（單頁） ========= */
const _listWrap = document.querySelector('.wrap'); // 既有列表外框
const _detailWrap = document.createElement('div');
_detailWrap.style.display = 'none';
_detailWrap.innerHTML = `
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin:10px 0 12px">
      <button id="postBack" class="btn">← 返回</button>
      <div id="postOwnerBtns" style="display:flex;gap:8px"></div>
    </div>
    <article id="postCard" class="card"></article>
  </div>
`;
document.body.appendChild(_detailWrap);

function showListView(){
  _detailWrap.style.display = 'none';
  _listWrap.style.display = 'block';
}
    // 詳情圖片：與 record.html 相同的結構（picwrap + 可點開）
    const g = document.getElementById('postGallery');
    if (g){
      g.innerHTML = '';
      imgs.forEach(src=>{
        const wrap = document.createElement('span');
        wrap.className = 'picwrap';
        const img = document.createElement('img');
        img.loading = 'lazy';
        img.src = src;
        img.alt = '';
        img.addEventListener('click', ()=>window.open(src, '_blank'));
        wrap.appendChild(img);
        g.appendChild(wrap);
      });
    }
function showDetailView(){
  _listWrap.style.display = 'none';
  _detailWrap.style.display = 'block';
}
document.getElementById('postBack').addEventListener('click', ()=>{ location.hash = ''; });

/* ========= 詳情渲染 ========= */
async function renderPost(objectId){
  try{
    const obj = await new AV.Query('Cloud').get(objectId);
    const me  = AV.User.current();

    const ownerId   = obj.get('authorId') || '';
    const iAmOwner  = !!me && me.id === ownerId;

    const author = {
      name  : obj.get('authorName')   || '匿名',
      avatar: obj.get('authorAvatar') || 'https://i.imgur.com/7h9vW7N.png'
    };

    const title   = obj.get('title')   || '（無標題）';
    const content = obj.get('content') || '';
    const imgs    = obj.get('images')  || [];

    // 發佈時間（真太陽時）
   const pubStr = buildPubDisplay(obj);

    // 創作時間＋干支（上傳時就存好的）
    const createDate  = obj.get('dateStr')  || '';
    const createSolar = obj.get('solarStr') || '';
    const approx      = !!obj.get('approx');
    const gzDay       = obj.get('gzDay')    || '';
    const gzHour      = obj.get('gzHour')   || '';

    const postCard = document.getElementById('postCard');
    postCard.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <img src="${author.avatar}" alt="" style="width:32px;height:32px;border-radius:50%;object-fit:cover;border:1px solid var(--edge)">
        <div style="font-weight:700">${esc(author.name)}</div>
        <div class="badge dim" style="margin-left:auto">${esc(pubStr)}</div>
      </div>

      <div class="title" style="font-weight:800;font-size:1.2rem">🧃${esc(title)}</div>

      <div class="meta">
        <span class="badge dim">創作：${esc(createDate)}｜${esc(createSolar)}${approx?' ≈':''}</span>
        <span class="badge">日：${esc(gzDay)}</span>
        <span class="badge">時：${esc(gzHour)}</span>
      </div>

     <div class="content">${esc(content)}</div>

                  ${
        imgs.length
          ? `<div class="detail-gallery">
     ${imgs.map(u=>`<img src="${u}" alt="" loading="lazy">`).join('')}
   </div>`
          : ''
      }
    `;

       // 擁有者工具列：建立「刪除」按鈕
    const ownerBar = document.getElementById('postOwnerBtns');
    ownerBar.innerHTML = '';
    if (iAmOwner) {
      const delBtn = document.createElement('button');
      delBtn.className = 'btn';
      delBtn.textContent = '刪除';
      delBtn.addEventListener('click', async () => {
        if (!confirm('確定刪除這則貼文？')) return;
        try {
          await obj.destroy();
          // 告訴列表：返回時要刷新
          sessionStorage.setItem('CLOUD_SHOULD_RELOAD', '1');
          // 回到列表；route() 會偵測旗標並 resetAndLoad()
          location.hash = '';
        } catch (err) {
          alert('刪除失敗：' + (err.message || err.code || '未知錯誤'));
        }
      });
      ownerBar.appendChild(delBtn);
    }

    showDetailView();
  }catch(err){
    console.error(err);
    alert('讀取貼文失敗'); showListView();
  }
}

/* ========= Hash 路由 =========
   LeanCloud 的 objectId 是英數混合，這裡放寬比對 */
/* ========= Hash 路由 =========
   LeanCloud 的 objectId 是英數混合，這裡放寬比對 */
function route(){
  const m = location.hash.match(/^#\/post\/([A-Za-z0-9_-]+)$/);
  if (m) {
    // 進入詳情
    renderPost(m[1]);
  } else {
    // 回到列表
    showListView(); // ← 這行會關掉 _detailWrap、顯示列表

    // 若詳情頁剛刪過，回來就刷新列表
    if (sessionStorage.getItem('CLOUD_SHOULD_RELOAD') === '1') {
      sessionStorage.removeItem('CLOUD_SHOULD_RELOAD');
      resetAndLoad();
    }
  }
}
window.addEventListener('hashchange', route);
route(); // 初始
// 保險：有些瀏覽器返回會用快取畫面，用 pageshow 再檢一次
window.addEventListener('pageshow', () => {
  if (sessionStorage.getItem('CLOUD_SHOULD_RELOAD') === '1') {
    sessionStorage.removeItem('CLOUD_SHOULD_RELOAD');
    resetAndLoad();
  }
});
  </script>
    <button id="backToTop" title="回到頂端">🧃🔝</button>
  <script>
    // 當頁面滾動超過 200px，顯示按鈕
window.onscroll = function() {
  let btn = document.getElementById("backToTop");
  if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
    btn.style.display = "block";
  } else {
    btn.style.display = "none";
  }
};

// 點擊按鈕平滑滾動到頂端
document.getElementById("backToTop").addEventListener("click", function() {
  window.scrollTo({
    top: 0,
    behavior: "smooth"
  });
});
  </script>
  <button id="refreshBtn" title="重新整理">🫧</button>
<script>
  const refreshBtn = document.getElementById("refreshBtn");

  // 捲到一定距離才顯示
  window.addEventListener("scroll", () => {
    if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
      refreshBtn.style.display = "block";
    } else {
      refreshBtn.style.display = "none";
    }
  });

  // 點擊 → 刷新列表（等於 resetAndLoad）
  refreshBtn.addEventListener("click", () => {
    // 如果你只想刷新縮略圖而不是整個頁面：
    resetAndLoad();

    // 如果你要強制整頁重整，就改成：
    // location.reload();
  });
</script>
<!--=================-->
<p style="text-align: center; font-size: 13px; color: #999; margin-top: 40px;">
  🐾 © 2024 yinnlim的小宇宙｜內容與設計皆由糖糖本人用愛製作 💞<br>
  未經授權請勿隨意使用、盜轉喔 🙅‍♀️ 謝謝你的尊重與溫柔 💌
</p>
</body>
</html>