<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>貼文詳情 - 曦花林YinnTown</title>
      <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9eaff;
      color: #333;
      padding: 30px;
    }
    #postContent {
  white-space: pre-wrap;
  word-break: break-word;
  line-height: 1.8;
}
    .card {
      max-width: 600px;
      margin: auto;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    h1 {
      color: #bb55cc;
    }
    .meta {
      font-size: 0.9em;
      color: #888;
      margin-bottom: 10px;
    }
i.back-bunny {
  position: fixed;
  bottom: 20px;
  left: 20px;
  width: 50px;
  z-index: 9999;
  cursor: pointer;
  display: none; /* ✅ 一開始不顯示 */
  transition: transform 0.3s ease;
}

.back-bunny:hover {
  transform: scale(1.2);
}

.text-pw{
  color: rgb(176, 79, 255);
  transform: translateY(-20px);
}
  </style>
</head>
<body>
      
     <div class="card">
    <h1 id="postTitle">載入中...</h1>
    <div class="meta">
      👤 <span id="postName"></span> | 🕒 <span id="postTime"></span>
    </div>
    <div id="postContent"></div>
    <img id="postImage" style="max-width:100%; border-radius: 8px; margin-top: 15px; display:none">
  </div>
<img src="/favicon.ico" id="backBunny" class="back-bunny" onclick="goBack()" alt="返回" title="點我返回">
  <div>⇧<p class="text-pw">點擊兔兔返回</p></div>

  <div class="card" style="margin-top: 30px;">
  <h3>💬 留言評論</h3>
  <textarea id="commentInput" placeholder="輸入你的評論..." rows="3" style="width: 100%; padding: 10px; border-radius: 8px;"></textarea>
  <button onclick="submitComment()" style="margin-top: 10px; padding: 10px 20px; background-color: #bb55cc; color: white; border: none; border-radius: 8px;">送出</button>
</div>


<div class="card" style="margin-top: 20px;">
  <h3>📝 所有評論</h3>
  <ul id="commentList" style="padding-left: 20px;"></ul>
</div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBkLJKrOdTgk4uf58jpciJIHm9hEYQUFCw",
      authDomain: "yinnlim-mgsg-wall.firebaseapp.com",
      projectId: "yinnlim-mgsg-wall",
      storageBucket: "yinnlim-mgsg-wall.firebasestorage.app",
      messagingSenderId: "811614776183",
      appId: "1:811614776183:web:d0b11607a54b5a4d8a0f72"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const postId = localStorage.getItem("selectedPostId");

    if (postId) {
      db.ref("posts/" + postId).once("value", snapshot => {
        const data = snapshot.val();
        if (data) {
          document.getElementById("postTitle").textContent = data.title;
          document.getElementById("postName").textContent = data.name;
          document.getElementById("postTime").textContent = new Date(data.time).toLocaleString();
          document.getElementById("postContent").textContent = data.content;

          // 如果有圖片
          if (data.imageUrl) {
            const img = document.getElementById("postImage");
            img.src = data.imageUrl;
            img.style.display = "block";
          }
        } else {
          document.getElementById("postTitle").textContent = "找不到這篇貼文。";
        }
      });
    } else {
      document.getElementById("postTitle").textContent = "未指定貼文。";
    }
    //=================
    function goBack() {
  const scrollY = localStorage.getItem("scrollY");
  localStorage.removeItem("selectedPostId");

  if (scrollY !== null) {
    localStorage.setItem("restoreScrollY", scrollY); // 再次暫存讓回去後讀取
  }

  if (document.referrer) {
    window.location.href = document.referrer;
  } else {
    window.history.back();
  }
}
//評論
// 儲存評論
// 留言送出（需登入）
function submitComment() {
  const user = firebase.auth().currentUser;
  const input = document.getElementById("commentInput");
  const text = input.value.trim();

  if (!user) {
    alert("⚠️ 請先登入才能留言！");
    return;
  }

  if (!text) return alert("請輸入評論內容");

  const comment = {
    text: text,
    uid: user.uid,
    name: user.displayName || "匿名用戶",
    time: Date.now()
  };

  db.ref("comments/" + postId).push(comment).then(() => {
    input.value = "";
    loadComments();
  });
}

// 載入留言
function loadComments() {
  const list = document.getElementById("commentList");
  list.innerHTML = "";

  const user = firebase.auth().currentUser;

  db.ref("comments/" + postId).once("value", snapshot => {
    snapshot.forEach(child => {
      const data = child.val();
      const key = child.key;

      const li = document.createElement("li");
      li.style.marginBottom = "8px";
      li.innerHTML = `🗨️ <strong>${data.name}</strong>：${data.text}<br><small>${new Date(data.time).toLocaleString()}</small>`;

      if (user && user.uid === data.uid) {
        const btn = document.createElement("button");
        btn.textContent = "刪除";
        btn.style.marginLeft = "10px";
        btn.style.color = "crimson";
        btn.style.background = "none";
        btn.style.border = "none";
        btn.style.cursor = "pointer";
        btn.onclick = () => {
          db.ref("comments/" + postId + "/" + key).remove().then(() => {
            loadComments();
          });
        };
        li.appendChild(btn);
      }

      list.appendChild(li);
    });
  });
}

// 監聽登入狀態變化，自動載入留言
firebase.auth().onAuthStateChanged(user => {
  if (postId) {
    loadComments();
  }
});

// 載入完成時自動撈取
if (postId) {
  loadComments();
}
</script>
</body>
</html>