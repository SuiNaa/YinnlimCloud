<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>è™•ç†è²·æ–¹ç”³è¨´</title>
<style>
  :root{ --brand:#6c4ef7; --muted:#777; --accent:#e91e63; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Noto Sans TC",Arial,sans-serif;background:#fafafa;color:#222;}
  .topbar{position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #eee; padding:10px 14px; display:flex; align-items:center; gap:10px;}
  .topbar a{ color:var(--brand); text-decoration:none; font-weight:800; }
  .wrap{ max-width:980px; margin:0 auto; padding:18px 14px 48px; }
  .list{ display:grid; gap:12px; }
  .card{ background:#fff; border:1px solid #eee; border-radius:14px; padding:12px; box-shadow:0 6px 16px rgba(0,0,0,.06); display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
  .thumb{ width:64px; height:64px; border-radius:10px; object-fit:cover; background:#f3f3f3; border:1px solid #eee; }
  .meta{ flex:1 1 360px; min-width:260px; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .muted{ color:var(--muted); }
  .price{ color:#e91e63; font-weight:900; }
  .actions{ display:flex; gap:8px; margin-left:auto; }
  .btn{ padding:8px 12px; border-radius:10px; border:1px solid #ddd; background:#fff; font-weight:800; cursor:pointer; }
  .btn.primary{ background:var(--brand); color:#fff; border-color:transparent; }
  .btn.ghost{ background:#fff; }
  .btn.disabled{ background:#e9e9ee; color:#999; border-color:#ddd; cursor:not-allowed; }
  .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px; z-index:1000; }
  .dlg{ width:min(560px, 94vw); background:#fff; border:1px solid #eee; border-radius:16px; overflow:hidden; box-shadow:0 16px 40px rgba(0,0,0,.18); }
  .dlg header{ position:sticky; top:0; background:#fff; padding:12px 14px; font-weight:900; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;}
  .dlg .body{ padding:14px; max-height:70vh; overflow:auto; -webkit-overflow-scrolling:touch; white-space:pre-wrap; line-height:1.6; }
  .dlg .actions{ position:sticky; bottom:0; background:#fff; display:flex; gap:10px; justify-content:flex-end; padding:10px 14px; border-top:1px solid #eee; }
  .label{ font-size:12px; color:#777; margin:8px 0 4px; }
  .input, .file, textarea{ width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px; outline:none; }
  textarea{ min-height:110px; resize:vertical; }
  .err{ color:#b00020; font-size:13px; margin-top:6px; }
  .proof{ max-width:280px; border:1px solid #eee; border-radius:10px; background:#fff; }
  .hint{ color:#777; font-size:12px; }
  /* ========== å¤œé–“æ¨¡å¼è®Šæ•¸ ========== */
html[data-theme="dark"]{
  --text:#cfc3ff;
  --muted:#9a8fd1;
  --brand:#a48cff;
  --accent:#bf66ff;

  --card-bg:#161222;
  --card-border:#2b2440;
  --page-bg:#0f0b1a;

  --btn-bg:#1b1629;
  --btn-border:#2b2440;
  --btn-text:#cfc3ff;

  --shadow:0 10px 28px rgba(0,0,0,.45);
}

/* ========== å…¨å±€è‰²ç³»ï¼ˆå¤œé–“ï¼‰ ========== */
html[data-theme="dark"] body{ background:var(--page-bg); color:var(--text); }
html[data-theme="dark"] .muted{ color:var(--muted); }
html[data-theme="dark"] .topbar,
html[data-theme="dark"] .card,
html[data-theme="dark"] .dlg,
html[data-theme="dark"] .wrap{
  background:var(--card-bg);
  border-color:var(--card-border);
  color:var(--text);
}
html[data-theme="dark"] .label{ color:var(--muted); }
html[data-theme="dark"] .btn{ background:var(--btn-bg); border:1px solid var(--btn-border); color:var(--btn-text); }
html[data-theme="dark"] .btn.primary{ background:var(--brand); color:#161222; border-color:transparent; }
html[data-theme="dark"] .btn.disabled{ background:#201a31; color:#7f76ad; border-color:var(--card-border); }
html[data-theme="dark"] .input,
html[data-theme="dark"] .file,
html[data-theme="dark"] textarea{
  background:transparent;
  color:var(--text);
  border:1px solid var(--card-border);
}
html[data-theme="dark"] .proof{ background:transparent; border:1px solid var(--card-border); }
html[data-theme="dark"] .backdrop{ background:rgba(0,0,0,.55); }

/* ========== åœ“çƒæŒ‰éˆ• + ä¸‹æ‹‰é¸å–® ========== */
.menu-wrap{ position:relative; display:inline-flex; gap:8px; align-items:center; }

/* åœ“çƒæŒ‰éˆ•ï¼ˆç™½å¤©æ˜¯å“ç‰Œè‰²ã€å¤œé–“èµ°æš—è‰²ç³»ï¼‰ */
.menu-btn{
  width:34px; height:34px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:16px; font-weight:700; line-height:1;
  background:var(--brand); color:#fff; border:none;
  cursor:pointer; transition:transform .2s ease, background .2s ease, box-shadow .2s ease;
  box-shadow:0 4px 12px rgba(108,78,247,.22);
}
.menu-btn:hover{ transform:scale(1.08); }
.menu-btn:active{ transform:scale(.95); }
html[data-theme="dark"] .menu-btn{
  background:var(--btn-bg);
  border:1px solid var(--btn-border);
  color:var(--btn-text);
  box-shadow:none;
}

/* ä¸‹æ‹‰ï¼ˆç™½å¤©æ·¡ç²‰ã€å¤œé–“æš—è‰²ï¼‰ï¼‹è‡ªé©æ‡‰ä¸è¢«æ“‹ä½ */
.dropdown{
  position:absolute; top:calc(100% + 8px);
  right:0; left:auto;                 /* âœ… é å³å°é½Šé¿å…è¢«è¢å¹•å³é‚Šæ“‹ä½ */
  max-width:90vw;                     /* âœ… æœ€å¤šä½” 90% è¢å¹•å¯¬ */
  transform:translateY(-6px) scale(.98);
  opacity:0; visibility:hidden; pointer-events:none;
  min-width:220px; border-radius:14px; padding:8px; z-index:999;
  transition:opacity .16s ease, transform .18s cubic-bezier(.2,.8,.2,1);
  background:#fdeaff; color:#4a3a6a;             /* æ·¡ç²‰èƒŒæ™¯ï¼ˆç™½å¤©ï¼‰ */
  border:1px solid #f5ccff;
  box-shadow:0 16px 32px rgba(0,0,0,.18);
  overflow-wrap:break-word;
}
.dropdown.show{
  transform:translateY(0) scale(1);
  opacity:1; visibility:visible; pointer-events:auto;
}
.dropdown::after{ content:none; }                 /* å»æ‰é‚£å€‹çªèµ·ç®­é ­ */
.dropdown .item{
  width:100%; text-align:left; padding:10px 12px;
  border:0; background:transparent; color:inherit;
  border-radius:8px; cursor:pointer; transition:.12s;
}
.dropdown .item:hover{ background:rgba(108,78,247,.10); transform:translateY(-1px); }
html[data-theme="dark"] .dropdown{
  background:var(--card-bg); color:var(--text); border:1px solid var(--card-border); box-shadow:var(--shadow);
}

/* å°è¢å¹•é‹ªæ»¿é¿å…å·¦å³è¢«æ“‹ */
@media (max-width:560px){
  .dropdown, .dropdown.show{ left:0 !important; right:auto !important; width:92vw; }
}
</style>
</head>
<body>
  <div class="topbar">
    <a href="user.html">â† è¿”å›å€‹äººä¸»é </a>
    <a href="ipuser.html" style="margin-left:auto">æˆ‘çš„ç™¼è²¨</a>
    <div class="menu-wrap">
  <button id="menuBtn" class="menu-btn" aria-expanded="false" onclick="toggleMenu()">%</button>
  <div id="menuDrop" class="dropdown" role="menu">
    <!-- ç¬¬ä¸€å€‹é¸é …ï¼šåˆ‡æ›æ¨¡å¼ -->
    <button class="item" onclick="toggleTheme()" id="modeItem">åˆ‡æ›æ¨¡å¼ï¼šå¤œé–“</button>
     <button class="item" onclick="location.href='../index.html'">ä¸»é </button>
    <button class="item" onclick="location.href='Grove.Examination-Yuan.html'">åƒåŠ ç®¡ç†å“¡</button>
    <button class="item" onclick="location.href='Grove. Control-Yuan.html'">Control</button>
    <button class="item" onclick="location.href='Grove.Executive-Yuan.html'">Executive</button>
    <button class="item" onclick="location.href='Grove.Judicial-Yuan.html'">ç”³è¨´</button>
    <button class="item" onclick="location.href='Grove.Legislative-Yuan.html'">Legislative</button>
    <button class="item" onclick="location.href='vote.html'">æŠ•ç¥¨å°ˆå€</button>
    <button class="item" onclick="location.href='constitution.html'">ç¶²ç«™ç”³æ˜</button>
  </div>
</div>
  </div>

  <div class="wrap">
    <h2 style="margin:0 0 12px">è²·æ–¹ç”³è¨´ç®¡ç†</h2>
    <div id="orderList" class="list"></div>
  </div>

  <!-- æŸ¥çœ‹ç”³è¨´ç†ç”± -->
  <div id="appealViewDlg" class="backdrop">
    <div class="dlg">
      <header>
        <div>ç”³è¨´ç†ç”±</div>
        <button class="btn" onclick="closeAppealView()">é—œé–‰</button>
      </header>
      <div class="body">
        <div id="avReason">â€”</div>
        <div class="label">ç”³è¨´åœ–ç‰‡</div>
        <img id="avProof" class="proof" style="display:none" alt="ç”³è¨´åœ–ç‰‡">
      </div>
    </div>
  </div>

  <!-- æŸ¥çœ‹åŸé§å›ç†ç”± -->
  <div id="rejectViewDlg" class="backdrop">
    <div class="dlg">
      <header>
        <div>åŸé§å›ç†ç”±</div>
        <button class="btn" onclick="closeRejectView()">é—œé–‰</button>
      </header>
      <div class="body">
        <div id="rvReason">â€”</div>
        <div class="label">é§å›åœ–ç‰‡</div>
        <img id="rvProof" class="proof" style="display:none" alt="é§å›åœ–ç‰‡">
      </div>
    </div>
  </div>

  <!-- é§å›ç”³è¨´ -->
  <div id="appealRejectDlg" class="backdrop">
    <div class="dlg">
      <header>
        <div>é§å›ç”³è¨´</div>
        <button class="btn" onclick="closeAppealReject()">é—œé–‰</button>
      </header>
      <div class="body">
        <div class="label">é§å›ç”³è¨´ç†ç”±</div>
        <textarea id="arReason" class="input" placeholder="è«‹è¼¸å…¥é§å›ç”³è¨´ç†ç”±"></textarea>
        <div class="label">åœ–ç‰‡ï¼ˆå¯é¸ï¼‰</div>
        <input id="arProof" class="file" type="file" accept="image/*">
        <div class="hint">é€å‡ºå¾Œæœƒä»¥è¨Šæ¯é€šçŸ¥è²·å®¶ï¼Œè¨‚å–®ä»ç¶­æŒã€Œé§å›ã€ã€‚</div>
        <div id="arErr" class="err"></div>
      </div>
      <div class="actions">
        <button class="btn" onclick="closeAppealReject()">å–æ¶ˆ</button>
        <button class="btn primary" onclick="submitAppealReject()">ç¢ºèªé€å‡º</button>
      </div>
    </div>
  </div>

<script>
const API     = "https://zdqo2eqb.lc-cn-n1-shared.com/1.1";
const APP_ID  = "ZDqo2eQBcSChCfRgwix9jUeI-gzGzoHsz";
const APP_KEY = "U66ybZWAD99LrT9zJnQlW52H";

(function guard(){
  const t = localStorage.getItem('sg_token');
  const u = JSON.parse(localStorage.getItem('sg_user')||'null');
  if(!t || !u){ location.replace('index.html?redirect=dellt'); }
})();
const me    = JSON.parse(localStorage.getItem('sg_user')||'null');
const token = localStorage.getItem('sg_token');
const AUTH  = { 'X-LC-Id': APP_ID, 'X-LC-Key': APP_KEY, 'X-LC-Session': token };

const DEFAULT_AVATAR = 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect width="100%" height="100%" rx="40" ry="40" fill="#f3f3f3"/><text x="50%" y="55%" text-anchor="middle" font-size="28">ğŸ™‚</text></svg>`);
const money = n => Number(n||0).toLocaleString('zh-TW');
const GID = me?.gid || me?.objectId || '';

let ORDERS = [];
let CURRENT = null;

/* ---------- æ ¸å¿ƒï¼šæŠ“è³‡æ–™ + åµæ¸¬ã€Œå†æ¬¡ç”³è¨´ã€ ---------- */
async function fetchAppeals(){
  // å…ˆæ‹¿åˆ°è³£å®¶çš„æ‰€æœ‰è¨‚å–®ï¼ˆä¿åº•ç”¨ updatedAt åšåˆ¤æ–·ï¼‰
  const where = encodeURIComponent(JSON.stringify({
    seller:{ "__type":"Pointer","className":"_User","objectId": me.objectId }
  }));
  const url = `${API}/classes/Order?where=${where}&order=-updatedAt&limit=200&include=buyer,product`;
  const res = await fetch(url,{ headers: AUTH });
  const data = await res.json();
  if(!res.ok){ console.warn('fetchAppeals error:', data); return []; }

  const list = (data.results||[]).filter(o=>{
  // âœ… åªçœ‹è²·å®¶æ˜¯å¦ã€Œæœ‰ç”³è¨´è·¡è±¡ã€
  const buyerAppealed =
    !!(o.appealedAt || o.appealReason || o.appealProofUrl);

  if (!buyerAppealed) return false;     // â† æ²’ç”³è¨´å°±ä¸é€²æ¸…å–®

  // æ™‚é–“åŸºæº–
  const appealTs   = o.appealedAt ? new Date(o.appealedAt.iso || o.appealedAt).getTime()
                                  : new Date(o.updatedAt).getTime();
  const decisionTs = o.appealDecisionAt ? new Date(o.appealDecisionAt.iso || o.appealDecisionAt).getTime() : 0;

  // æ˜¯å¦è¢«ä½ éš±è—é
  const archived     = o.appealArchivedBySeller === true;
  const archivedMark = o.appealArchivedAppealedAt ? new Date(o.appealArchivedAppealedAt).getTime() : 0;

  const approved  = o.appealDecision === 'approved';
  const reAppealed = appealTs > Math.max(decisionTs, archivedMark);

  // å†ç”³è¨´ â†’ è‡ªå‹•è§£é™¤éš±è—â€¦ï¼ˆåŸæœ¬é‚è¼¯ä¿ç•™ï¼‰
  if (reAppealed) {
    o.appealArchivedBySeller = false;
    delete o.appealDecision;
    delete o.appealDecisionAt;
    delete o.appealRejectReason;
    delete o.appealRejectProofUrl;
    delete o.appealArchivedAppealedAt;
    fetch(`${API}/classes/Order/${o.objectId}`,{
      method:'PUT',
      headers:{...AUTH,'Content-Type':'application/json'},
      body: JSON.stringify({
        appealArchivedBySeller:false,
        appealArchivedAppealedAt:{ "__op":"Delete" },
        appealDecision:{ "__op":"Delete" },
        appealDecisionAt:{ "__op":"Delete" },
        appealRejectReason:{ "__op":"Delete" },
        appealRejectProofUrl:{ "__op":"Delete" }
      })
    }).catch(()=>{});
  }

  // é¡¯ç¤ºæ¢ä»¶ï¼šæœ‰ç”³è¨´ï¼Œä¸”ï¼ˆå°šæœªè™•ç† or æœ‰å†ç”³è¨´ï¼‰ï¼Œä¸”ï¼ˆæœªè¢«éš±è— or æœ‰å†ç”³è¨´ï¼‰
  return buyerAppealed && (!approved || reAppealed) && (!archived || reAppealed);
});

  await hydrateBuyers(list);
  await fillBuyerByMessages(list);
  return list;
}

/* æ‰¹æ¬¡è£œè²·å®¶æš±ç¨±é ­è²¼ */
async function hydrateBuyers(list){
  const ids = Array.from(new Set((list||[]).map(o=>o?.buyer?.objectId).filter(Boolean)));
  if(!ids.length) return;
  const where = encodeURIComponent(JSON.stringify({ objectId:{ "$in": ids } }));
  try{
    const r = await fetch(`${API}/users?where=${where}&limit=${ids.length}`,{ headers:{...AUTH}});
    const d = await r.json(); if(!r.ok) return;
    const dict = new Map(); (d.results||[]).forEach(u=>dict.set(u.objectId,u));
    list.forEach(o=>{
      const u = dict.get(o?.buyer?.objectId);
      if(u){
        o.buyer.nickname = u.nickname || u.username || '';
        o.buyer.username = u.username || o.buyer.username || '';
        o.buyer.avatarUrl = (u.avatarUrl||'').replace(/^http:\/\//,'https://');
      }
    });
  }catch(e){}
}

/* è‹¥ buyer ç¼ºå¤±ï¼Œç”¨ Message(kind='order') å›å¡«ï¼ˆä¿åº•ï¼‰ */
async function fillBuyerByMessages(list){
  for(const o of (list||[])){
    if(o?.buyer?.objectId) continue;
    try{
      const where = encodeURIComponent(JSON.stringify({
        kind:'order',
        order:{ "__type":"Pointer","className":"Order","objectId": o.objectId }
      }));
      const url = `${API}/classes/Message?where=${where}&order=createdAt&limit=1&include=from`;
      const r = await fetch(url,{ headers:AUTH });
      const d = await r.json(); if(!r.ok) continue;
      const m = (d.results||[])[0]; const u = m && m.from;
      if(u && u.objectId){
        try{
          const ru = await fetch(`${API}/users/${u.objectId}`,{ headers:{...AUTH}});
          const fu = await ru.json();
          if(ru.ok && fu){
            u.nickname = fu.nickname || fu.username || u.nickname || '';
            u.username = fu.username || u.username || '';
            u.avatarUrl = fu.avatarUrl || u.avatarUrl || '';
          }
        }catch(e){}
        o.buyer = {
          "__type":"Pointer","className":"_User","objectId": u.objectId,
          nickname: u.nickname || u.username || '',
          username: u.username || '',
          avatarUrl: (u.avatarUrl||'').replace(/^http:\/\//,'https://')
        };
      }
    }catch(e){}
  }
}

/* ---------- UI ---------- */
function renderList(){
  const box = document.getElementById('orderList');
  box.innerHTML='';
  if(!ORDERS.length){
    box.innerHTML = `<div class="muted">ç›®å‰æ²’æœ‰å¾…è™•ç†çš„ç”³è¨´ã€‚</div>`;
    return;
  }
  ORDERS.forEach(o=>{
    const p = o.product||{};
    const io = o.io || '';
    const dt = new Date(o.appealedAt?.iso || o.appealedAt || o.updatedAt || o.createdAt);
    const thumb = p.imageUrl || (Array.isArray(p.images)&&p.images[0]) || DEFAULT_AVATAR;
    const unitPrice = (o.unitPrice ?? o.price) || 0;
    const qty = (o.quantity ?? 1);
    const total = (o.totalPrice ?? (unitPrice*qty)) || unitPrice;
    const buyerName =
      (o.buyer && (o.buyer.nickname || o.buyer.username)) ||
      (o.buyer && o.buyer.objectId ? ('#'+o.buyer.objectId.slice(-6)) : 'â€”');

    const approved   = o.appealDecision === 'approved';
    const rejected   = o.appealDecision === 'rejected';
    const actedDone  = approved || rejected;   // åªè¦è™•ç†éï¼Œå°±å…©é¡†éƒ½é–
    const disableAll = actedDone;

    const card = document.createElement('div');
card.className='card';
card.id = `order_${o.objectId}`;
card.innerHTML = `
  <img class="thumb" src="${thumb}" alt="">
  <div class="meta">
    <div class="row">
      <div style="font-weight:900">${escapeHTML(p.title || o.productTitle || 'æœªå‘½åå•†å“')}</div>
      <div class="muted">ï¼ˆè¦æ ¼ï¼š${escapeHTML(o.variantName || '')}ï¼‰</div>
    </div>

    ${io ? `<div class="row"><div class="muted">IOï¼š<code style="font-family:ui-monospace,monospace">${escapeHTML(io)}</code></div></div>` : ''}  <!-- â† é€™ä¸€è¡Œæ˜¯é—œéµ -->

    <div class="row">
      <div>è²·å®¶ï¼š<b>${escapeHTML(buyerName)}</b></div>
      <div class="muted">ï½œ ç”³è¨´æ™‚é–“ï¼š${dt.toLocaleString()}</div>
    </div>
    <div class="row" style="margin-top:4px">
      <div>å–®åƒ¹ï¼š<span class="price">Â¥${money(unitPrice)}</span></div>
      ${qty?`<div>ï½œ æ•¸é‡ï¼š${qty}</div>`:''}
      <div>ï½œ ç¸½é¡ï¼š<span class="price">Â¥${money(total)}</span></div>
      <div class="muted">ï½œ ç‹€æ…‹ï¼š${escapeHTML(o.status || 'submitted')}</div>
    </div>
  </div>
      <div class="actions">
        <button class="btn ghost" onclick="viewAppeal('${o.objectId}')">æŸ¥çœ‹ç”³è¨´ç†ç”±</button>
        <button class="btn ghost" onclick="viewReject('${o.objectId}')">æª¢æŸ¥é§å›ç†ç”±</button>

        ${disableAll
          ? `<button class="btn disabled" disabled>é§å›ç”³è¨´</button>`
          : `<button class="btn ghost" onclick="openAppealReject('${o.objectId}')">é§å›ç”³è¨´</button>`}

        ${disableAll
          ? `<button class="btn disabled" disabled>ç”³è¨´é€šé</button>`
          : `<button class="btn primary" onclick="approveAppeal('${o.objectId}')">ç”³è¨´é€šé</button>`}

        ${actedDone ? `<button class="btn ghost" onclick="archiveAppeal('${o.objectId}')">åˆªé™¤æ­¤æ¢åˆ—</button>` : ``}
      </div>
    `;
    box.appendChild(card);
  });
}

function findOrder(id){ return ORDERS.find(o=>o.objectId===id); }
function removeCard(id){ const el=document.getElementById(`order_${id}`); if(el) el.remove(); }

/* å¯¦éš›éš±è—ï¼ˆè¨˜ä¸‹ç•¶æ™‚çš„ appealedAt/updatedAtï¼Œæ–¹ä¾¿å†æ¬¡ç”³è¨´æ¯”å°ï¼‰ */
async function archiveAppeal(id){
  const o = findOrder(id); if(!o) return;
  if(!confirm('ç¢ºå®šè¦æŠŠé€™æ¢ç”³è¨´å¾æ¸…å–®éš±è—å—ï¼Ÿ')) return;

  const appealedTime = o.appealedAt ? new Date(o.appealedAt.iso || o.appealedAt).toISOString()
                                     : new Date(o.updatedAt).toISOString();

  try{
    const r = await fetch(`${API}/classes/Order/${id}`,{
      method:'PUT',
      headers:{ ...AUTH, 'Content-Type':'application/json' },
      body: JSON.stringify({
        appealArchivedBySeller: true,
        appealArchivedAppealedAt: appealedTime,
        appealArchivedAt: { "__type":"Date", "iso": new Date().toISOString() }
      })
    });
    const d = await r.json();
    if(!r.ok) throw new Error(d.error || 'æ“ä½œå¤±æ•—');

    const idx = ORDERS.findIndex(x=>x.objectId===id);
    if(idx>=0) ORDERS.splice(idx,1);
    removeCard(id);
  }catch(e){
    alert(e.message||'åˆªé™¤å¤±æ•—');
  }
}

/* æŸ¥çœ‹ç”³è¨´ / é§å›ç†ç”± */
function viewAppeal(id){
  const o = findOrder(id); if(!o) return;
  document.getElementById('avReason').textContent = o.appealReason || 'â€”';
  const img = document.getElementById('avProof');
  const u = (o.appealProofUrl||'').replace(/^http:\/\//,'https://');
  if(u){ img.src=u; img.style.display='block'; } else { img.removeAttribute('src'); img.style.display='none'; }
  document.getElementById('appealViewDlg').style.display='flex';
  // åœ¨ setContent ä¹‹å¾Œè‡ªè¨‚ä¸€å€‹é¡¯ç¤ºä½ï¼ˆç”¨ç¾æœ‰ body ç›´æ¥å¡å­—ï¼‰
const io = (o.io || '').trim();
if (io) {
  const body = document.querySelector('#appealViewDlg .body');
  const el = document.createElement('div');
  el.className = 'label';
  el.innerHTML = `IOï¼š<code style="font-family:ui-monospace,monospace">${escapeHTML(io)}</code>`;
  body.appendChild(el);
}
}
function closeAppealView(){ document.getElementById('appealViewDlg').style.display='none'; }

function viewReject(id){
  const o = findOrder(id); if(!o) return;
  document.getElementById('rvReason').textContent = o.rejectReason || 'â€”';
  const img = document.getElementById('rvProof');
  const u = (o.rejectProofUrl||'').replace(/^http:\/\//,'https://');
  if(u){ img.src=u; img.style.display='block'; } else { img.removeAttribute('src'); img.style.display='none'; }
  document.getElementById('rejectViewDlg').style.display='flex';
}
function closeRejectView(){ document.getElementById('rejectViewDlg').style.display='none'; }

/* æª”æ¡ˆä¸Šå‚³ */
function fileToBase64(file){ return new Promise((resolve,reject)=>{ const fr=new FileReader(); fr.onload=()=>resolve(fr.result.split(',')[1]); fr.onerror=reject; fr.readAsDataURL(file); }); }
async function uploadOne(file){
  const base64 = await fileToBase64(file);
  const r = await fetch(`${API}/files/${encodeURIComponent(file.name)}`,{
    method:'POST', headers:{...AUTH,'Content-Type':'application/json'}, body: JSON.stringify({ base64 })
  });
  const data = await r.json();
  if(!r.ok) throw new Error(data.error || 'æª”æ¡ˆä¸Šå‚³å¤±æ•—');
  return data.url;
}

/* ç”³è¨´é€šéï¼šç‹€æ…‹æ”¹å› submittedã€æ¸…ç©ºæ¬„ä½ã€é€šçŸ¥è²·å®¶ï¼ˆå…©é¡†ä¸€èµ·é–ï¼‰ */
function delOp(){ return {"__op":"Delete"}; }

async function approveAppeal(id){
  const o = findOrder(id); if(!o) return;
  if(!confirm('ç¢ºèªé€šéæœ¬æ¬¡ç”³è¨´ï¼Ÿ\nè¨‚å–®å°‡å›åˆ°ã€Œæœªç™¼è²¨ã€ç‹€æ…‹ã€‚')) return;
  try{
    const nowIso = new Date().toISOString();
    const clear = {
      status: 'submitted',
      appealedAt: delOp(),
      appealReason: delOp(),
      appealProofUrl: delOp(),
      appealDecision: 'approved',
      appealDecisionAt: { "__type":"Date", "iso": nowIso },
      rejectReason: delOp(),
      rejectProofUrl: delOp()
    };
    const put = await fetch(`${API}/classes/Order/${id}`,{
      method:'PUT', headers:{...AUTH,'Content-Type':'application/json'}, body: JSON.stringify(clear)
    });
    const pd = await put.json();
    if(!put.ok) throw new Error(pd.error || 'æ›´æ–°è¨‚å–®å¤±æ•—');

    const idx = ORDERS.findIndex(x=>x.objectId===id);
    if(idx>=0){
      ORDERS[idx].appealDecision   = 'approved';
      ORDERS[idx].appealDecisionAt = nowIso;
      delete ORDERS[idx].appealedAt;
      delete ORDERS[idx].appealReason;
      delete ORDERS[idx].appealProofUrl;
      delete ORDERS[idx].rejectReason;
      delete ORDERS[idx].rejectProofUrl;
    }
    renderList();

    if(o?.buyer?.objectId){
  const io = o.io || ''; // â† æ–°å¢
  const msgText = `${GID} ç”³è¨´é€šé${io ? `ï½œIOï¼š${io}` : ''}`;  // â† æ”¹
  await fetch(`${API}/classes/Message`,{
    method:'POST',
    headers:{...AUTH,'Content-Type':'application/json'},
    body: JSON.stringify({
      kind:'appeal_ok',
      text: msgText,
      body: msgText,
      from:{ "__type":"Pointer","className":"_User","objectId": me.objectId },
      to:  { "__type":"Pointer","className":"_User","objectId": o.buyer.objectId },
      order:{ "__type":"Pointer","className":"Order","objectId": o.objectId },
      product: o.product ? { "__type":"Pointer","className":"Product","objectId": o.product.objectId } : undefined,
      data:{ io }  // â† æ–°å¢
    })
  });
}

    alert('âœ… å·²é€šéç”³è¨´ï¼Œè¨‚å–®å›åˆ°æœªç™¼è²¨ã€‚');
  }catch(e){
    alert(e.message || 'æ“ä½œå¤±æ•—');
  }
}

/* é§å›ç”³è¨´ï¼ˆå…©é¡†ä¸€èµ·é–ï¼Œå¯« appealDecisionAtï¼‰ */
function openAppealReject(id){
  CURRENT = findOrder(id) || null; if(!CURRENT) return;
  document.getElementById('arReason').value = '';
  document.getElementById('arProof').value = '';
  document.getElementById('arErr').textContent = '';
  document.getElementById('appealRejectDlg').style.display='flex';
}
function closeAppealReject(){ document.getElementById('appealRejectDlg').style.display='none'; }

async function submitAppealReject(){
  if(!CURRENT) return;
  const reason = document.getElementById('arReason').value.trim();
  const pf = document.getElementById('arProof').files[0];
  if(!reason){ document.getElementById('arErr').textContent='è«‹å¡«å¯«é§å›ç”³è¨´ç†ç”±'; return; }

  try{
    let proofUrl = '';
    if(pf) proofUrl = await uploadOne(pf);

    const nowIso = new Date().toISOString();
    const put = await fetch(`${API}/classes/Order/${CURRENT.objectId}`,{
      method:'PUT',
      headers:{...AUTH,'Content-Type':'application/json'},
      body: JSON.stringify({
        status: 'rejected',
        appealDecision: 'rejected',
        appealDecisionAt: { "__type":"Date", "iso": nowIso },
        appealRejectReason: reason,
        appealRejectProofUrl: proofUrl
      })
    });
    const pd = await put.json();
    if(!put.ok) throw new Error(pd.error || 'æ›´æ–°è¨‚å–®å¤±æ•—');

    const idx = ORDERS.findIndex(x=>x.objectId===CURRENT.objectId);
    if(idx>=0){
      ORDERS[idx].appealDecision   = 'rejected';
      ORDERS[idx].appealDecisionAt = nowIso;
      ORDERS[idx].appealRejectReason   = reason;
      ORDERS[idx].appealRejectProofUrl = proofUrl;
    }
    closeAppealReject();
    renderList();

    if(CURRENT?.buyer?.objectId){
  const io = CURRENT.io || ''; // â† æ–°å¢
  const msgText = `å•†å®¶é§å›ç”³è¨´ï¼š${reason}${io ? `ï½œIOï¼š${io}` : ''}`; // â† æ”¹
  await fetch(`${API}/classes/Message`,{
    method:'POST',
    headers:{...AUTH,'Content-Type':'application/json'},
    body: JSON.stringify({
      kind:'appeal_reject',
      text: msgText,
      body: msgText,
      from:{ "__type":"Pointer","className":"_User","objectId": me.objectId },
      to:  { "__type":"Pointer","className":"_User","objectId": CURRENT.buyer.objectId },
      order:{ "__type":"Pointer","className":"Order","objectId": CURRENT.objectId },
      product: CURRENT.product ? { "__type":"Pointer","className":"Product","objectId": CURRENT.product.objectId } : undefined,
      data:{ reason, proofUrl, io }  // â† æ–°å¢
    })
  });
}

    alert('âœ… å·²é§å›ç”³è¨´ä¸¦é€šçŸ¥è²·å®¶');
  }catch(e){
    document.getElementById('arErr').textContent = e.message || 'é€å‡ºå¤±æ•—';
  }
}

/* å•Ÿå‹• & è¼ªè©¢ï¼ˆ6 ç§’ï¼‰ */
(async function start(){
  ORDERS = await fetchAppeals();
  renderList();
})();
setInterval(async ()=>{
  ORDERS = await fetchAppeals();
  renderList();
}, 3000);

/* utils */
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }
</script>
<script src="im.js"></script>
<!--=================-->
<p style="text-align: center; font-size: 13px; color: #999; margin-top: 40px;">
  ğŸ¾ Â© 2024 yinnlimçš„å°å®‡å®™ï½œå…§å®¹èˆ‡è¨­è¨ˆçš†ç”±ç³–ç³–æœ¬äººç”¨æ„›è£½ä½œ ğŸ’<br>
  æœªç¶“æˆæ¬Šè«‹å‹¿éš¨æ„ä½¿ç”¨ã€ç›œè½‰å–” ğŸ™…â€â™€ï¸ è¬è¬ä½ çš„å°Šé‡èˆ‡æº«æŸ” ğŸ’Œ
</p>
</body>
</html>