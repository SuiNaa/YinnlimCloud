<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Groveç›£å¯Ÿé™¢</title>
<style>
  :root{ --brand:#6c4ef7; --muted:#777; --danger:#e91e63; }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:system-ui,-apple-system,"Noto Sans TC",Arial,sans-serif; background:#fafafa; color:#222; }
  .wrap{ max-width:960px; margin:0 auto; padding:24px 14px 48px; }

  /* æœå°‹åˆ—ï¼ˆGoogle é¢¨ï¼‰ */
  .search{ display:flex; gap:10px; align-items:center; justify-content:center; margin:24px auto 20px; max-width:720px; }
  .input{
    flex:1; padding:14px 16px; border-radius:999px; border:1px solid #ddd; background:#fff; outline:none;
    box-shadow:0 4px 16px rgba(0,0,0,.06);
    font-size:16px;
  }
  .btn{ padding:12px 16px; border-radius:10px; border:1px solid #ddd; background:#fff; font-weight:800; cursor:pointer; }
  .btn.primary{ background:var(--brand); color:#fff; border-color:transparent; }
  .btn.danger{ background:var(--danger); color:#fff; border-color:transparent; }
  .hint{ text-align:center; color:#777; font-size:13px; margin-top:6px; }

  /* çµæœå¡ç‰‡ */
  .card{ background:#fff; border:1px solid #eee; border-radius:16px; padding:16px; box-shadow:0 8px 20px rgba(0,0,0,.06); }
  .row{ display:flex; align-items:center; gap:14px; }
  .avatar{ width:80px; height:80px; border-radius:50%; object-fit:cover; background:#f3f3f3; border:1px solid #eee; }
  .name{ font-weight:900; font-size:18px; }
  .muted{ color:var(--muted); font-size:13px; }
  .meta{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:8px; margin-top:8px; }
  .actions{ margin-top:12px; display:flex; gap:10px; }

  /* å¤œé–“ï¼ˆå¯é¸ï¼Œèˆ‡ä½ å…¨ç«™è‰²ç³»ä¸€è‡´ï¼‰ */
  html[data-theme="dark"] body{ background:#0f0b1a; color:#cfc3ff; }
  html[data-theme="dark"] .card{ background:#161222; border:1px solid #2b2440; box-shadow:0 10px 28px rgba(0,0,0,.45);}
  html[data-theme="dark"] .input{ background:#1b1629; border:1px solid #2b2440; color:#cfc3ff; }
  html[data-theme="dark"] .btn{ background:#1b1629; border:1px solid #2b2440; color:#cfc3ff; }
  html[data-theme="dark"] .btn.primary{ background:#a48cff; color:#161222; border-color:transparent; }
  html[data-theme="dark"] .btn.danger{ background:#bf66ff; color:#161222; border-color:transparent; }
/* ===== è­¦å‘Šå½ˆæ¡† ===== */
.backdrop{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:5000; padding:16px; }
.modal{
  width:min(560px,92vw); max-height:92vh; overflow:auto;
  background:#fff; border:1px solid #eee; border-radius:14px; box-shadow:0 16px 40px rgba(0,0,0,.18);
}
.modal header{ position:sticky; top:0; background:#fff; padding:12px 14px; border-bottom:1px solid #eee; font-weight:900; display:flex; justify-content:space-between; align-items:center; }
.modal .body{ padding:14px; }
.modal .actions{ padding:10px 14px; border-top:1px solid #eee; display:flex; gap:10px; justify-content:flex-end; }
.modal .input, .modal .textarea{ width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px; outline:none; background:#fff; }
.modal .textarea{ min-height:120px; resize:vertical; }
html[data-theme="dark"] .modal{ background:#161222; color:#cfc3ff; border:1px solid #2b2440; box-shadow:0 10px 28px rgba(0,0,0,.45); }
html[data-theme="dark"] .modal header{ background:#161222; border-bottom:1px solid #2b2440; }
html[data-theme="dark"] .modal .actions{ border-top:1px solid #2b2440; }
html[data-theme="dark"] .modal .input, html[data-theme="dark"] .modal .textarea{ background:transparent; color:#cfc3ff; border:1px solid #2b2440; }
/* ===== ä¸‹æ‹‰é¸å–®ï¼ˆå½ˆåŒ¡ï¼‰æ¨£å¼ï¼‹å‹•ç•« ===== */
/* ========== å³ä¸Šè§’åœ“çƒæŒ‰éˆ• + ä¸‹æ‹‰é¸å–® ========== */
.menu-wrap{ position:relative; display:inline-flex; gap:8px; align-items:center; }

/* åœ“çƒæŒ‰éˆ• */
.menu-btn{
  width:34px; height:34px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:16px; font-weight:700; line-height:1;
  background:var(--brand); color:#fff; border:none;
  cursor:pointer; transition:transform .2s ease, background .2s ease, box-shadow .2s ease;
  box-shadow:0 4px 12px rgba(108,78,247,.22);
}
.menu-btn:hover{ transform:scale(1.08); }
.menu-btn:active{ transform:scale(.95); }
html[data-theme="dark"] .menu-btn{
  background:var(--btn-bg);
  border:1px solid var(--btn-border);
  color:var(--btn-text);
  box-shadow:none;
}

/* ä¸‹æ‹‰é¸å–® */
.dropdown{
  position:absolute; top:calc(100% + 8px); left:0;
  transform:translateX(8px) translateY(-6px) scale(.98);
  opacity:0; visibility:hidden; pointer-events:none;
  min-width:220px; max-width:min(320px,80vw);
  border-radius:14px; padding:8px; z-index:999;
  transition:opacity .16s ease, transform .18s cubic-bezier(.2,.8,.2,1);
  background:var(--dropdown-bg); color:var(--dropdown-text);
  border:1px solid var(--dropdown-border);
  box-shadow:0 16px 32px rgba(0,0,0,.18);
}
.dropdown.show{
  transform:translateX(8px) translateY(0) scale(1);
  opacity:1; visibility:visible; pointer-events:auto;
}
/* å»æ‰çªèµ·ç®­é ­ */
.dropdown::after{ content:none; }
.dropdown .item{ width:100%; text-align:left; padding:10px 12px; border:0; background:transparent; color:inherit; border-radius:8px; cursor:pointer; transition:.12s; }
.dropdown .item:hover{ background:rgba(108,78,247,.10); transform:translateY(-1px); }
html[data-theme="dark"] .dropdown{ background:var(--card-bg); color:var(--text); border:1px solid var(--card-border); box-shadow:var(--shadow); }

/* å°è¢å¹•è‡ªå‹•é å·¦ */
@media(max-width:560px){
  .dropdown, .dropdown.show{ left:0 !important; transform:translateX(0) translateY(0) scale(1); }
}
.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
</style>
</head>
<body>
      <div class="menu-wrap">
        <!-- è¿”å›æŒ‰éˆ• -->
  <button class="btn primary" onclick="goBack()" style="margin-bottom:1px">â† è¿”å›</button>
  <button class="btn primary" onclick="location.href='shopping.html'">Esc Store</button>
  <button id="menuBtn" class="menu-btn" aria-expanded="false" onclick="toggleMenu()">%</button>
  <div id="menuDrop" class="dropdown" role="menu">
    <!-- ç¬¬ä¸€å€‹é¸é …ï¼šåˆ‡æ›æ¨¡å¼ -->
    <button class="item" onclick="toggleTheme()" id="modeItem">åˆ‡æ›æ¨¡å¼ï¼šå¤œé–“</button>
    <button class="item" onclick="location.href='shopping.html'">Esc Store</button>
  </div>
</div>
  <div class="wrap">
    <h2 style="margin:0;text-align:center">Grove Control Yuan</h2>
    <div class="hint">è¼¸å…¥ç”¨æˆ¶ GIDï¼ˆ= _User.objectIdï¼‰ï¼ŒæŒ‰ Enter æˆ–é»æœå°‹</div>

    <div class="search">
      <input id="kw" class="input" type="search" placeholder="ä¾‹å¦‚ï¼š5sX8YZaBâ€¦" autofocus>
      <button class="btn primary" onclick="doSearch()">æœå°‹</button>
    </div>
    
    <div id="result"></div>

    <div id="toast" style="position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#000;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:opacity .18s">â€”</div>
    <h3 style="margin-top:24px">å¾…è™•ç†æª¢èˆ‰</h3>
<div id="reportList" class="report-list muted">è®€å–ä¸­â€¦</div>
  </div>

<div id="warnDlg" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="warnTitle">
  <div class="modal">
    <header>
      <div id="warnTitle">ç™¼é€è­¦å‘Š âš ï¸</div>
      <button class="btn" onclick="closeWarn()" aria-label="é—œé–‰">Ã—</button>
    </header>
    <div class="body">
      <div class="muted" style="margin-bottom:8px">å°‡æŠŠé€™å‰‡è­¦å‘Šå‚³é€åˆ°è©²ç”¨æˆ¶çš„ç«™å…§è¨Šæ¯ï¼ˆä»¥è¡¨æ ¼å½¢å¼å±•ç¤ºï¼‰ã€‚</div>

      <!-- å›ºå®šæ¨™é¡Œ -->
      <label class="muted" style="display:block; margin:8px 0 6px">æ¨™é¡Œ</label>
      <input id="warnTitleFixed" class="input" type="text" value="è­¦å‘Šâš ï¸ æ­¤å‰‡æ˜¯é‡è¦è¨Šæ¯" readonly>

      <!-- ç®¡ç†å“¡ GIDï¼ˆè‡ªå‹•å¸¶å…¥ç›®å‰ç™»å…¥çš„ç®¡ç†å“¡ï¼‰ -->
      <label class="muted" style="display:block; margin:12px 0 6px">ç®¡ç†å“¡ GID</label>
      <input id="warnAdmin" class="input" type="text" readonly>

      <!-- è¢«æª¢èˆ‰ GIDï¼ˆç›®æ¨™ï¼‰ -->
      <label class="muted" style="display:block; margin:12px 0 6px">è¢«æª¢èˆ‰ GID</label>
      <input id="warnUid" class="input" type="text" readonly>

      <!-- è­¦å‘Šå…§å®¹ -->
      <label class="muted" style="display:block; margin:12px 0 6px">è­¦å‘Šå…§å®¹</label>
      <textarea id="warnText" class="textarea" placeholder="è«‹è¼¸å…¥è¦æé†’/è­¦å‘Šçš„å…§å®¹â€¦"></textarea>

      <div id="warnErr" style="color:#b00020; font-size:13px; margin-top:6px"></div>
    </div>
    <div class="actions">
      <button class="btn" onclick="closeWarn()">å–æ¶ˆ</button>
      <button class="btn danger" onclick="sendWarning()">é€å‡ºè­¦å‘Š</button>
    </div>
  </div>
</div>
<!-- æª¢èˆ‰å…§å®¹å½ˆæ¡† -->
<div id="reportsDlg" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="reportsTitle">
  <div class="modal">
    <header>
      <div id="reportsTitle">è¢«æª¢èˆ‰å…§å®¹</div>
      <button class="btn" onclick="closeReports()" aria-label="é—œé–‰">Ã—</button>
    </header>
    <div class="body" id="reportsBody">
      <!-- å‹•æ…‹å¡å…§å®¹ -->
    </div>
    <div class="actions">
      <button class="btn" onclick="closeReports()">é—œé–‰</button>
    </div>
  </div>
</div>
<script>
/* ====== ä½ çš„ LeanCloud è¨­å®š ====== */
const API     = "https://zdqo2eqb.lc-cn-n1-shared.com/1.1";
const APP_ID  = "ZDqo2eQBcSChCfRgwix9jUeI-gzGzoHsz";
const APP_KEY = "68b19eeb90ed2201c4839219";

/* â† å›ºå®šä¸€å€‹å¯é€²å…¥ç›£å¯Ÿé™¢çš„è¶…ç´š GIDï¼ˆå°±ç®—ä¸åœ¨ Admin è¡¨ä¹Ÿæ”¾è¡Œï¼‰ */
const SUPER_CONTROL_UID = "68b19eeb90ed2201c4839219";  // ä½ å¯æ”¹æˆæƒ³è¦çš„

/* ä¾›ä¹‹å¾Œè¡Œé™¢é é¢å…±ç”¨çš„é¡åˆ¥/æ¬„ä½ç´„å®š */
const RECALL_CLASS = "RecallVote";

/* ========== åŸºæœ¬å·¥å…· ========== */
const DEFAULT_AVATAR = 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect width="100%" height="100%" rx="40" ry="40" fill="#f3f3f3"/><text x="50%" y="55%" text-anchor="middle" font-size="28">ğŸ™‚</text></svg>`);

function toast(s){
  const t = document.getElementById('toast'); t.textContent = s;
  t.style.opacity = '1'; setTimeout(()=>{ t.style.opacity='0'; }, 1600);
}

let __ADMIN_AUTH = null;

async function requireAdmin(){
  if(__ADMIN_AUTH) return __ADMIN_AUTH;

  const token = localStorage.getItem('sg_token');
  const me    = JSON.parse(localStorage.getItem('sg_user')||'null');
  if(!token || !me){
    alert('è«‹å…ˆç™»å…¥'); location.replace('index.html'); return null;
  }

  // â˜… è¶…ç´š GID ç›´æ¥æ”¾è¡Œ
  if (me.objectId === SUPER_CONTROL_UID){
    __ADMIN_AUTH = { me, token };
    return __ADMIN_AUTH;
  }

  // ä¸€èˆ¬æƒ…æ³ï¼šå¿…é ˆæ˜¯ Admin è¡¨ä¸” active:true
  const headers = { 'X-LC-Id': APP_ID, 'X-LC-Key': APP_KEY, 'X-LC-Session': token };
  const where = encodeURIComponent(JSON.stringify({
    user: { "__type":"Pointer","className":"_User","objectId": me.objectId },
    active: true
  }));
  const r = await fetch(`${API}/classes/Admin?where=${where}&limit=1`, { headers });
  const d = await r.json();
  if(!r.ok || !d.results || !d.results.length){
    alert('ä½ æ²’æœ‰å­˜å–æ­¤é çš„æ¬Šé™');
    location.replace('shopping.html');
    return null;
  }

  __ADMIN_AUTH = { me, token };
  return __ADMIN_AUTH;
}
//èº«ä»½ç¢ºèª

//ç½·é¸
async function hasOpenRecall(uid){
  const nowIso = new Date().toISOString();
  const where = encodeURIComponent(JSON.stringify({
    target:   { "__type":"Pointer","className":"_User","objectId": uid },
    status:   "open",
    endsAt: { "$gt": { "__type":"Date","iso": nowIso } }
  }));
  const r = await fetch(`${API}/classes/${RECALL_CLASS}?where=${where}&limit=1`, { headers: lcAuth() });
  const d = await r.json();
  return r.ok && d.results && d.results.length > 0;
}
async function createRecallVote(uid, reasons){
  const { me, token } = await requireAdmin(); if(!me) throw new Error('æœªç™»å…¥');
  const endsAt = new Date(Date.now() + 3*24*60*60*1000); // ä¸‰å¤©å¾Œ

  const payload = {
    target:    { "__type":"Pointer","className":"_User","objectId": uid },
    targetGid: uid,
    question:  "æ˜¯å¦ç½·å…æ­¤äººï¼Ÿ",
    options:   ["æ˜¯","å¦"],       // ä¹‹å¾Œè¡Œæ”¿é™¢é é¢æœƒä»¥é€™å…©å€‹é¸é …çµ±è¨ˆ
    reasons,                       // Array<string>ï¼Œä¾›æ°‘çœ¾æª¢è¦–
    status:    "open",
    startsAt:  { "__type":"Date","iso": new Date().toISOString() },
    endsAt:    { "__type":"Date","iso": endsAt.toISOString() },
    createdBy: { "__type":"Pointer","className":"_User","objectId": me.objectId },
    ACL: {
      "*":              { "read": true,  "write": false },      // â˜… å…¬é–‹å¯è®€
      [me.objectId]:    { "read": true,  "write": true  },
      [SUPER_CONTROL_UID]: { "read": true, "write": true }      // è¶…ç´šå¯å¯«
    }
  };

  const r = await fetch(`${API}/classes/${RECALL_CLASS}`,{
    method:'POST',
    headers:{ 'Content-Type':'application/json', ...lcAuth() },
    body: JSON.stringify(payload)
  });
  const d = await r.json();
  if(!r.ok) throw new Error(d.error || 'å»ºç«‹æŠ•ç¥¨å¤±æ•—');
  return d.objectId;
}
/* ç”¨ where æŸ¥ _Userï¼ˆæ¯” /users/{id} å¯¬é¬†ï¼‰ */
async function fetchUserById(uid){
  const headers = { 'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY };
  const token = localStorage.getItem('sg_token'); if(token) headers['X-LC-Session'] = token;

  const where = encodeURIComponent(JSON.stringify({ objectId: uid }));
  const r = await fetch(`${API}/users?where=${where}&limit=1`, { headers });
  const d = await r.json();
  if(!r.ok) throw new Error(d.error || 'è®€å–ç”¨æˆ¶å¤±æ•—');
  return (d.results && d.results[0]) || null;
}

/* æŸ¥æ˜¯å¦å·²å°é–ï¼ˆBlockedUser è¡¨ï¼‰ */
async function findBlockId(uid){
  const headers = { 'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY, 'X-LC-Session': localStorage.getItem('sg_token')||'' };
  const where = encodeURIComponent(JSON.stringify({
    target:{ "__type":"Pointer","className":"_User","objectId": uid },
    status:"active"
  }));
  const r = await fetch(`${API}/classes/BlockedUser?where=${where}&limit=1`, { headers });
  const d = await r.json();
  if(!r.ok) return null;
  return (d.results && d.results[0] && d.results[0].objectId) || null;
}

/* å»ºç«‹å°é– */
async function blockUser(uid){
 const { me, token } = await requireAdmin();
const headers = {
    'Content-Type':'application/json',
    'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY, 'X-LC-Session': token||''
  };
  const payload = {
    target: { "__type":"Pointer","className":"_User","objectId": uid },
    by:     { "__type":"Pointer","className":"_User","objectId": me.objectId },
    status: "active",
    ACL:{
      "*":{ "read": false },
      [me.objectId]:{ "read": true, "write": true }
      // ä½ ä¹Ÿå¯ä»¥æ”¹æˆ [REPORT_ADMIN_UID]:{...} åªçµ¦æŒ‡å®šå¸³è™Ÿ
    }
  };
  const r = await fetch(`${API}/classes/BlockedUser`,{ method:'POST', headers, body:JSON.stringify(payload) });
  const d = await r.json();
  if(!r.ok) throw new Error(d.error || 'å°é–å¤±æ•—ï¼ˆè«‹æª¢æŸ¥ BlockedUser é¡åˆ¥æ¬Šé™ï¼‰');
  return d.objectId;
}

/* è§£é™¤å°é–ï¼ˆæŠŠ status æ”¹ç‚º releasedï¼‰ */
async function unblock(blockId){
  const token = localStorage.getItem('sg_token');
  const headers = { 'Content-Type':'application/json', 'X-LC-Id':APP_ID,'X-LC-Key':APP_KEY,'X-LC-Session': token||'' };
  const r = await fetch(`${API}/classes/BlockedUser/${blockId}`, {
    method:'PUT', headers, body: JSON.stringify({ status:"released" })
  });
  const d = await r.json();
  if(!r.ok) throw new Error(d.error || 'è§£é™¤å°é–å¤±æ•—');
}

// ç™¼é€å°é–é€šçŸ¥è¨Šæ¯ï¼ˆæœƒå‡ºç¾åœ¨å°æ–¹è¨Šæ¯ç›’ï¼‰
async function sendSystemMessage(toId, text){
const { token, me } = await requireAdmin() || {};
  if(!token || !me) throw new Error('æœªç™»å…¥');
  const payload = {
    kind: 'system',     // ä½ ç¾æœ‰ messages é ä¹Ÿæœƒç•¶ä¸€èˆ¬è¨Šæ¯é¡¯ç¤º
    subtype: 'ban',     // æ–¹ä¾¿ä¹‹å¾Œå‰ç«¯ç‰¹åˆ¥æ¨£å¼
    text, body: text,
    read: "false",      // ä¾ä½ ç›®å‰ Message.read çš„ã€Œå­—ä¸²ã€å‹åˆ¥
    from: { "__type":"Pointer","className":"_User","objectId": me.objectId },
    to:   { "__type":"Pointer","className":"_User","objectId": toId },
    ACL: {
      "*": { "read": false },
      [me.objectId]: { "read": true, "write": true },
      [toId]:        { "read": true, "write": false }
    }
  };
  const r = await fetch(`${API}/classes/Message`,{
    method:'POST',
    headers:{ 'Content-Type':'application/json','X-LC-Id':APP_ID,'X-LC-Key':APP_KEY,'X-LC-Session': token },
    body: JSON.stringify(payload)
  });
  const d = await r.json();
  if(!r.ok) throw new Error(d.error || 'é€šçŸ¥è¨Šæ¯ç™¼é€å¤±æ•—');
  return d.objectId;
}

// å…±ç”¨ï¼šé˜»æ“‹å°è‡ªå·±æ“ä½œï¼ˆå› true è¡¨ç¤ºå·²é˜»æ“‹ä¸¦å·²æç¤ºï¼‰
async function forbidSelf(targetId, actionName){
  const auth = await requireAdmin(); 
  if(!auth) return true;
  const { me } = auth;
  if(me && me.objectId === targetId){
    alert(`ä½ ä¸èƒ½å°è‡ªå·±çš„å¸³è™ŸåŸ·è¡Œã€Œ${actionName}ã€ã€‚`);
    return true;
  }
  return false;
}
/* ç¹ªå‡ºçµæœå¡ç‰‡ */
async function renderUser(u, blockId){
  const box = document.getElementById('result');
  const avatar = (u.avatarUrl ? u.avatarUrl.replace(/^http:\/\//,'https://') : '') || DEFAULT_AVATAR;

  const roles  = await getUserRoles(u.objectId);  // â† æ”¹é€™è£¡
  const hasRpt = await hasAnyReport(u.objectId);
  const { me } = await requireAdmin();
  const isSelf = !!(me && me.objectId === u.objectId);

  box.innerHTML = `
    <div class="card">
      <div class="row">
        <img class="avatar" src="${avatar}" alt="">
        <div>
          <div class="name">${escapeHTML(u.nickname || u.username || '(æœªå‘½å)')}</div>
          <div class="muted">GIDï¼š${u.objectId}</div>
          <div class="muted" style="margin-top:4px">èº«åˆ†ï¼š${roles.label}</div>   <!-- â† é¡¯ç¤ºäº”é™¢å½™ç¸½ -->
        </div>
      </div>

      <div class="meta">
        <div>æš±ç¨± / åç¨±ï¼š${escapeHTML(u.nickname || u.username || '')}</div>
        <div>Emailï¼š${escapeHTML(u.email || '(æœªç¶å®š)')}</div>
        <div>å»ºç«‹æ™‚é–“ï¼š${new Date(u.createdAt).toLocaleString()}</div>
        <div>ç‹€æ…‹ï¼š${blockId ? 'å·²å°é–' : 'æ­£å¸¸'}</div>
      </div>

      <div class="actions">
        ${blockId
          ? `<button class="btn" ${isSelf?'disabled title="ä¸å¯å°è‡ªå·±æ“ä½œ"':''}
                onclick="${isSelf?'void(0)':`onUnblock('${blockId}','${u.objectId}')`}">è§£é™¤å°é–</button>`
          : `<button class="btn danger" ${isSelf?'disabled title="ä¸å¯å°è‡ªå·±æ“ä½œ"':''}
                onclick="${isSelf?'void(0)':`onBlock('${u.objectId}')`}">å°é–</button>`}

        <button class="btn" onclick="viewReports('${u.objectId}')">æŸ¥è©¢è¢«æª¢èˆ‰å…§å®¹</button>

        ${ roles.anyOfficial
            ? `<button class="btn primary"
                ${(!hasRpt || isSelf)?'disabled':''}
                title="${isSelf ? 'ä¸å¯å°è‡ªå·±æ“ä½œ' : (hasRpt ? '' : 'ç„¡æª¢èˆ‰ï¼Œä¸å¯ç™¼èµ·')}"
                onclick="${(!hasRpt || isSelf)?'void(0)':`openRecall('${u.objectId}')`}">ç½·å…</button>`
            : '' }

        <button class="btn" ${isSelf?'disabled title="ä¸å¯å°è‡ªå·±æ“ä½œ"':''}
                onclick="${isSelf?'void(0)':`openWarn('${u.objectId}')`}">è­¦å‘Š âš ï¸</button>
      </div>
    </div>
  `;
}
async function openWarn(uid){
  if(await forbidSelf(uid, 'ç™¼é€è­¦å‘Š')) return;
  const auth = await requireAdmin(); if(!auth) return;
  const { me } = auth;

  // å¸¶å…¥å››å€‹æ¬„ä½ï¼šå›ºå®šæ¨™é¡Œã€ç®¡ç†å“¡ GIDã€è¢«æª¢èˆ‰ GIDã€æ¸…ç©ºå…§å®¹
  document.getElementById('warnTitleFixed').value = 'è­¦å‘Šâš ï¸ æ­¤å‰‡æ˜¯é‡è¦è¨Šæ¯';
  document.getElementById('warnAdmin').value = me.objectId || '';
  document.getElementById('warnUid').value   = uid || '';
  document.getElementById('warnText').value  = '';
  document.getElementById('warnErr').textContent = '';

  document.getElementById('warnDlg').style.display = 'flex';
}
function closeWarn(){
  document.getElementById('warnDlg').style.display = 'none';
}
// å–ç”¨æˆ¶åœ¨äº”é™¢çš„èº«ä»½ï¼ˆåŒæ™‚æŸ¥ user / Userã€ä¸” active !== falseï¼‰
async function getUserRoles(uid){
  const hdr = lcAuth();
  const p   = { "__type":"Pointer","className":"_User","objectId": uid };
  const w   = encodeURIComponent(JSON.stringify({ "$or":[ {user:p},{User:p} ], active:true }));

  const [cR, eR, xR, jR] = await Promise.all([
    fetch(`${API}/classes/Admin?where=${w}&limit=1`,            { headers: hdr }), // ç›£å¯Ÿé™¢ C
    fetch(`${API}/classes/ExecutiveStaff?where=${w}&limit=1`,   { headers: hdr }), // è¡Œæ”¿é™¢ I
    fetch(`${API}/classes/ExamStaff?where=${w}&limit=1`,        { headers: hdr }), // è€ƒè©¦é™¢ E
    fetch(`${API}/classes/JudicialStaff?where=${w}&limit=1`,    { headers: hdr }), // å¸æ³•é™¢ A
  ]);
  const [c, e, x, j] = await Promise.all([cR.json(), eR.json(), xR.json(), jR.json()]);
  const hasC = cR.ok && c?.results?.length > 0;
  const hasI = eR.ok && e?.results?.length > 0;
  const hasE = xR.ok && x?.results?.length > 0;
  const hasA = jR.ok && j?.results?.length > 0;

  // ç«‹æ³•é™¢ï¼šå„ªå…ˆæŸ¥ LegislativeStaffï¼ˆå¦‚æœä½ æœªå»ºç«‹æ­¤è¡¨ï¼Œé€€è€Œæ±‚å…¶æ¬¡ç”¨ ExamSubmission çš„ã€Œå·²é€šéç«‹æ³•é™¢ã€ç´€éŒ„ï¼‰
  let hasL = false;
  try{
    const lR = await fetch(`${API}/classes/LegislativeStaff?where=${w}&limit=1`, { headers: hdr });
    const l  = await lR.json();
    hasL = lR.ok && l?.results?.length > 0;
  }catch(_){ hasL = false; }
  if(!hasL){
    const whereLeg = encodeURIComponent(JSON.stringify({
      applicant: p,
      status: 'approved',
      type: { "$in": ['apply-legislative-public','apply-legislative-internal'] }
    }));
    const l2R = await fetch(`${API}/classes/ExamSubmission?where=${whereLeg}&limit=1`, { headers: hdr });
    const l2  = await l2R.json();
    hasL = l2R.ok && l2?.results?.length > 0;
  }

  const tags = [];
  if (hasC) tags.push('ç›£å¯Ÿé™¢(C)');
  if (hasI) tags.push('è¡Œæ”¿é™¢(I)');
  if (hasE) tags.push('è€ƒè©¦é™¢(E)');
  if (hasA) tags.push('å¸æ³•é™¢(A)');
  if (hasL) tags.push('ç«‹æ³•é™¢(L)');

  return {
    hasC, hasI, hasE, hasA, hasL,
    anyOfficial: (hasC || hasI || hasE || hasA || hasL),
    label: tags.length ? tags.join(' / ') : 'ä¸€èˆ¬ç”¨æˆ¶'
  };
}
/* ===== æª¢èˆ‰æŸ¥è©¢ ===== */
const AUTH = {
  'X-LC-Id': APP_ID,
  'X-LC-Key': APP_KEY,
};
function lcAuth(){
  const t = localStorage.getItem('sg_token');
  return t ? { ...AUTH, 'X-LC-Session': t } : AUTH;
}

// ä¾ GID æŸ¥ Reportï¼ˆæ”¯æ´ target Pointer èˆ‡ targetGid å­—ä¸²å…©ç¨®æ¬„ä½ï¼‰
async function fetchReports(targetUid){
  const where = encodeURIComponent(JSON.stringify({
    "$or":[
      { target: { "__type":"Pointer","className":"_User","objectId": targetUid } },
      { targetGid: targetUid }
    ]
  }));
  const url = `${API}/classes/Report?where=${where}&order=-createdAt&limit=50&include=reporter`;
  const r = await fetch(url, { headers: lcAuth() });
  const d = await r.json();
  if(!r.ok) throw new Error(d.error || 'è®€å–æª¢èˆ‰å¤±æ•—');
  return d.results || [];
}

function closeReports(){ document.getElementById('reportsDlg').style.display='none'; }

 async function viewReports(uid){
 const auth = await requireAdmin(); if(!auth) return;
  const box = document.getElementById('reportsBody');
  box.innerHTML = '<div class="muted">è®€å–ä¸­â€¦</div>';
  document.getElementById('reportsDlg').style.display='flex';

  try{
    const rows = await fetchReports(uid);
    if(!rows.length){
      box.innerHTML = '<div class="muted">ç›®å‰ç„¡æª¢èˆ‰</div>';
      return;
    }
    // åˆ—å‡ºæ¯ä¸€ç­†ï¼ˆç†ç”±ã€æª¢èˆ‰äººã€æ™‚é–“ã€åœ–ç‰‡é€£çµï¼‰
    const html = rows.map((r,i)=>{
      const who = r.reporter ? (r.reporter.nickname || r.reporter.username || r.reporter.objectId) : 'ï¼ˆæœªçŸ¥ï¼‰';
      const when = r.createdAt ? new Date(r.createdAt).toLocaleString() : '';
      const imgs = Array.isArray(r.images) && r.images.length
        ? `<div style="margin-top:6px">åœ–ç‰‡è­‰æ“šï¼š${r.images.map(u=>`<a href="${u}" target="_blank">é€£çµ</a>`).join('ã€')}</div>`
        : '';
      return `
        <div class="card" style="margin-bottom:10px">
          <div style="font-weight:800">#${i+1}</div>
          <div style="margin-top:6px;white-space:pre-wrap">${escapeHTML(r.reason || r.reasonText || '')}</div>
          ${imgs}
          <div class="muted" style="margin-top:8px">æª¢èˆ‰äººï¼š${escapeHTML(who)}ã€€æ™‚é–“ï¼š${when}</div>
        </div>`;
    }).join('');
    box.innerHTML = html;
  }catch(e){
    box.innerHTML = `<div style="color:#b00020">${escapeHTML(e.message||'è®€å–å¤±æ•—')}</div>`;
  }
}
async function openRecall(uid){
  if(await forbidSelf(uid, 'ç™¼èµ·ç½·å…æŠ•ç¥¨')) return;

  const roles = await getUserRoles(uid);
  if(!roles.anyOfficial){
    alert('æ­¤äººä¸æ˜¯äº”é™¢å®˜å“¡ï¼Œç„¡æ³•ç™¼èµ·ç½·å…ã€‚');
    return;
  }

  // çµ„ç†ç”±ï¼ˆå­—ä¸²é™£åˆ—ï¼‰
  const reasons = rows.map(r => (r.reason || r.reasonText || '').trim()).filter(Boolean);

  // å¡åˆ°åŸæœ¬çš„ reports å½ˆæ¡†è£¡ä¸¦åŠ ä¸Šå‹•ä½œæŒ‰éˆ•
  const box = document.getElementById('reportsBody');
  const html = reasons.map((t,i)=>`
    <div style="white-space:pre-wrap">${escapeHTML(t)}</div>
    ${i<reasons.length-1?'<hr style="margin:12px 0;border:none;border-top:1px solid #eee">':''}
  `).join('');

  document.getElementById('reportsTitle').textContent = 'è¢«æª¢èˆ‰å…§å®¹ï¼ˆä¾›ç½·å…ç”¨ï¼‰';
  box.innerHTML = `
    <div class="muted" style="margin-bottom:8px">ä»¥ä¸‹ç‚ºæ­¤äººè¢«æª¢èˆ‰çš„ç†ç”±ï¼ˆå¤šäººä»¥åˆ†éš”ç·šå€éš”ï¼‰</div>
    <div class="card">${html}</div>
  `;
  // æ›æˆã€Œé—œé–‰ + é–‹å•ŸæŠ•ç¥¨ã€å…©é¡†æŒ‰éˆ•
  const actions = document.querySelector('#reportsDlg .actions');
  actions.innerHTML = `
    <button class="btn" onclick="closeReports()">é—œé–‰</button>
    <button class="btn primary" onclick="startRecall('${uid}')">é–‹å•Ÿç½·å…æŠ•ç¥¨ğŸ—³ï¸</button>
  `;
  document.getElementById('reportsDlg').style.display='flex';
}

async function startRecall(uid){
  try{
    // ç¦æ­¢å°è‡ªå·±æ“ä½œ
    if (await forbidSelf(uid, 'ç™¼èµ·ç½·å…æŠ•ç¥¨')) return;

    // å·²æœ‰é€²è¡Œä¸­çš„ç½·å… â†’ æç¤ºå¾Œé›¢é–‹
    if (await hasOpenRecall(uid)) {
      alert('å·²å­˜åœ¨é€²è¡Œä¸­çš„ç½·å…æŠ•ç¥¨ï¼Œç„¡æ³•é‡è¤‡å»ºç«‹ã€‚');
      return;
    }

    // è®€æª¢èˆ‰ â†’ çµ„ç†ç”±
    const rows = await fetchReports(uid);
    const reasons = rows.map(r => (r.reason || r.reasonText || '').trim()).filter(Boolean);

    // æ²’æœ‰æª¢èˆ‰ â†’ ä¸å¾—é–‹æŠ•ç¥¨
    if (!reasons.length){
      alert('ä½ ç„¡æ³•å¯¦è¡Œç½·å…æŠ•ç¥¨ï¼Œå› ç‚ºæ­¤äººç„¡ä¸è‰¯æª¢èˆ‰ã€‚');
      return;
    }

    // å»ºç«‹æŠ•ç¥¨
    const id = await createRecallVote(uid, reasons);
    closeReports();
    toast('å·²å»ºç«‹ç½·å…æŠ•ç¥¨ï¼ˆ3 å¤©ï¼‰');
  }catch(e){
    alert(e.message || 'å»ºç«‹æŠ•ç¥¨å¤±æ•—');
  }
}
// ä¾›ç™¼é€å‰å¿«é€Ÿç¢ºèªæ­¤äººæ˜¯å¦æœ‰æª¢èˆ‰
async function hasAnyReport(uid){
  try{
    const rows = await fetchReports(uid);
    return rows.length > 0;
  }catch(e){
    // æŸ¥è©¢å¤±æ•—æ™‚ï¼Œç‚ºäº†ä¸é˜»å¡æµç¨‹ï¼Œè¦–ç‚ºã€ŒæœªçŸ¥ã€ï¼Œæ­¤æ™‚ä»çµ¦ç™¼é€ä½†ä¸å½ˆæç¤º
    return true;
  }
}

/* ===== ä¿®æ”¹ sendWarningï¼šè‹¥ç„¡æª¢èˆ‰å…ˆäºŒæ¬¡ç¢ºèª ===== */
async function sendWarning(){
  const auth = await requireAdmin(); if(!auth) return;
  const { me, token } = auth;

  const title = (document.getElementById('warnTitleFixed').value || 'è­¦å‘Šâš ï¸ æ­¤å‰‡æ˜¯é‡è¦è¨Šæ¯').trim();
  const admin = (document.getElementById('warnAdmin').value || '').trim();
  const toId  = (document.getElementById('warnUid').value   || '').trim();
  const text  = (document.getElementById('warnText').value  || '').trim();

  if(!toId){ document.getElementById('warnErr').textContent = 'ç¼ºå°‘å°è±¡ GID'; return; }
  if(!text){ document.getElementById('warnErr').textContent = 'è«‹è¼¸å…¥è­¦å‘Šå…§å®¹'; return; }
  document.getElementById('warnErr').textContent = '';

  // â˜… é€™è£¡æ–°å¢ï¼šè‹¥æ²’æœ‰ä»»ä½•æª¢èˆ‰ï¼Œå…ˆç¢ºèª
  const any = await hasAnyReport(toId);
  if(!any){
    const ok = window.confirm('æ­¤äººç›®å‰ç„¡æª¢èˆ‰ï¼Œç¢ºå®šè¦ç™¼é€è­¦å‘Šå—ï¼Ÿ');
    if(!ok) return;
  }

  const table =
`
â”‚               ${title}                       â”‚
           
â”‚ ç®¡ç†å“¡ GID : ${admin}                         â”‚

â”‚ è¢«æª¢èˆ‰ GID : ${toId}                          â”‚

â”‚ è­¦å‘Šå…§å®¹   |.  ${text.replace(/\n/g, '\nâ”‚ ')} â”‚
`;

  const finalText = `${title}\n\n${table}`;

  const payload = {
    kind:'warning',
    text: finalText,
    body: finalText,
    read: "false",                 // ä¾ä½ ç›®å‰ Message.read çš„å­—ä¸²å‹åˆ¥
    from:{ "__type":"Pointer","className":"_User","objectId": me.objectId },
    to:{   "__type":"Pointer","className":"_User","objectId": toId },
    ACL:{
      "*": { "read": false },
      [me.objectId]: { "read": true, "write": true },
      [toId]:        { "read": true, "write": false }
    },
    data:{ title, adminGid:admin, targetGid:toId, content:text }
  };

  try{
    const r = await fetch(`${API}/classes/Message`,{
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY, 'X-LC-Session':token },
      body: JSON.stringify(payload)
    });
    const d = await r.json();
    if(!r.ok) throw new Error(d.error || 'ç™¼é€å¤±æ•—');
    closeWarn();
    toast('å·²ç™¼é€è­¦å‘Šçµ¦è©²ç”¨æˆ¶');
  }catch(e){
    document.getElementById('warnErr').textContent = e.message || 'ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦';
  }
}

function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }

/* äº‹ä»¶ */
async function doSearch(){
const auth = await requireAdmin(); if(!auth) return;
  const kw = (document.getElementById('kw').value||'').trim();
  if(!kw){ toast('è«‹è¼¸å…¥ GID'); return; }
  document.getElementById('result').innerHTML = '';
  try{
    const user = await fetchUserById(kw);
    if(!user){ toast('æ‰¾ä¸åˆ°æ­¤ GID'); return; }
    const blockId = await findBlockId(user.objectId);
    renderUser(user, blockId);
  }catch(e){
    toast(e.message||'æœå°‹å¤±æ•—');
  }
}
async function onBlock(uid){
  if(await forbidSelf(uid, 'å°é–')) return;
  try{
    const any = await hasAnyReport(uid);
    if(!any){ alert('ä½ ç„¡æ³•å¯¦è¡Œå°é–ï¼Œå› ç‚ºæ­¤äººç„¡ä¸è‰¯æª¢èˆ‰ã€‚'); return; 
  }

    // äºŒæ¬¡ç¢ºèª
    if(!confirm('ç¢ºå®šè¦å°é–æ­¤å¸³è™Ÿï¼Ÿå°é–å¾Œå°‡ç„¡æ³•è³¼è²·èˆ‡ç™¼è¨Šæ¯ã€‚')) return;

    // å»ºç«‹å°é–
    const blockId = await blockUser(uid);

    // ç™¼å°é–é€šçŸ¥è¨Šæ¯
    const notice =
`ã€å°é–é€šçŸ¥ã€‘
ä½ çš„å¸³è™Ÿå› é­æª¢èˆ‰ä¸¦ç¶“å¯©æ ¸ç¢ºèªï¼Œå·²è¢«å°é–ã€‚
è‡ªå³æ—¥èµ·ç¦æ­¢è³¼è²·ã€ç™¼è¨Šæ¯ç­‰æ“ä½œã€‚å¦‚æœ‰ç–‘ç¾©ï¼Œè«‹å›è¦†æ­¤è¨Šæ¯æˆ–è¯ç¹«å®¢æœã€‚`;
    await sendSystemMessage(uid, notice);

    toast('å·²å°é–ä¸¦å·²é€šçŸ¥è©²ç”¨æˆ¶');
    const u = await fetchUserById(uid);
    renderUser(u, blockId);
  }catch(e){
    toast(e.message || 'å°é–å¤±æ•—');
  }
}
async function onUnblock(blockId, uid){
  if(await forbidSelf(uid, 'è§£é™¤å°é–')) return;
  try{
    await unblock(blockId);
    await sendSystemMessage(uid, 'ã€è§£å°é€šçŸ¥ã€‘ä½ çš„å¸³è™Ÿå·²è§£é™¤å°é–ï¼Œå¯æ¢å¾©æ­£å¸¸ä½¿ç”¨ã€‚');
    toast('å·²è§£é™¤å°é–ä¸¦é€šçŸ¥');
    const u = await fetchUserById(uid);
    renderUser(u, null);
  }catch(e){
    toast(e.message||'è§£é™¤å¤±æ•—');
  }
}

/* Enter æœå°‹ */
document.getElementById('kw').addEventListener('keydown', e=>{
  if(e.key === 'Enter') doSearch();
});

/* åˆå§‹ï¼šæª¢æŸ¥ç®¡ç†å“¡ç™»å…¥ */
/* åˆå§‹ï¼šæª¢æŸ¥ç®¡ç†å“¡ç™»å…¥ä¸¦è¼‰å…¥æª¢èˆ‰ */
(async()=>{
  await requireAdmin();
  await loadNewReports();   // â† æ–°å¢é€™è¡Œ
})();
// è¼‰å…¥å¾…è™•ç†æª¢èˆ‰ï¼ˆstatus = newï¼‰
async function loadNewReports(){
  const where = encodeURIComponent(JSON.stringify({ status:"new" }));
  const url = `${API}/classes/Report?where=${where}&order=-createdAt&include=reporter,target&limit=20`;
  const r = await fetch(url, { headers: lcAuth() });
  const d = await r.json();
  const box = document.getElementById('reportList');

  if(!r.ok){ 
    box.innerHTML = `<div style="color:#b00020">${escapeHTML(d.error||'è®€å–å¤±æ•—')}</div>`;
    return;
  }
  if(!d.results.length){
    box.innerHTML = '<div class="muted">ç›®å‰æ²’æœ‰æ–°çš„æª¢èˆ‰æ¡ˆä»¶</div>';
    return;
  }

  // æ¸²æŸ“æ¯ä¸€ç­†
box.innerHTML = d.results.map(r=>{
  const who = r.reporter ? (r.reporter.nickname||r.reporter.username||r.reporter.objectId) : 'ï¼ˆæœªçŸ¥ï¼‰';
  const tgtGid  = r.target ? r.target.objectId : r.targetGid;          // â† ç›®æ¨™ GID
  const tgtName = r.target ? (r.target.nickname||r.target.username||'') : ''; // é¡¯ç¤ºåç¨±
  const when = new Date(r.createdAt).toLocaleString();
  const img = r.images && r.images.length ? 
    `<div>åœ–ç‰‡ï¼š<a href="${r.images[0]}" target="_blank">æŸ¥çœ‹</a></div>` : '';

  return `
    <div class="card" style="margin:10px 0;padding:12px">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <b>è¢«æª¢èˆ‰è€…ï¼š</b>
        <span class="mono">${escapeHTML(tgtGid||'æœªçŸ¥')}</span>
        ${tgtName ? `<span class="muted">ï¼ˆ${escapeHTML(tgtName)}ï¼‰</span>` : ''}
        <button class="btn" data-gid="${tgtGid||''}" onclick="copyAndSearch(this.dataset.gid)">
          è¤‡è£½ä¸¦æœå°‹
        </button>
      </div>
      <div style="margin-top:6px"><b>ç†ç”±ï¼š</b>${escapeHTML(r.reason||'')}</div>
      ${img}
      <div class="muted" style="margin-top:6px">æª¢èˆ‰äººï¼š${escapeHTML(who)}ï½œæ™‚é–“ï¼š${when}</div>
    </div>
  `;
}).join('');
}
// è¤‡è£½ GIDï¼Œä¸¦æŠŠå®ƒå¸¶åˆ°ä¸Šæ–¹æœå°‹æ¡†å¾Œç«‹å³æœå°‹
function copyAndSearch(gid){
  if(!gid) return;
  // å˜—è©¦è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼ˆå¤±æ•—å°±å¿½ç•¥ï¼‰
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(gid).then(
      ()=> toast('å·²è¤‡è£½ GID'),
      ()=> {} // éœé»˜å¤±æ•—
    );
  }
  const kw = document.getElementById('kw');
  if (kw) kw.value = gid;
  doSearch();
}
// ===== è¿”å›ä¸Šä¸€é  =====
function goBack(){
  try{
    const ref = document.referrer || '';
    const sameOrigin = ref && new URL(ref).origin === location.origin;
    if (sameOrigin) { location.href = ref; return; }
  }catch(e){}
  if (history.length > 1) { history.back(); return; }
  location.href = 'shopping.html';
}
</script>
<script src="im.js"></script>
<!--=================-->
<p style="text-align: center; font-size: 13px; color: #999; margin-top: 40px;">
  ğŸ¾ Â© 2024 yinnlimçš„å°å®‡å®™ï½œå…§å®¹èˆ‡è¨­è¨ˆçš†ç”±ç³–ç³–æœ¬äººç”¨æ„›è£½ä½œ ğŸ’<br>
  æœªç¶“æˆæ¬Šè«‹å‹¿éš¨æ„ä½¿ç”¨ã€ç›œè½‰å–” ğŸ™…â€â™€ï¸ è¬è¬ä½ çš„å°Šé‡èˆ‡æº«æŸ” ğŸ’Œ
</p>
</body>
</html>