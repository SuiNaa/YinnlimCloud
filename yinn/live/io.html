<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>我的購買</title>
<style>
  :root{ --brand:#6c4ef7; --muted:#777; --accent:#e91e63; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Noto Sans TC",Arial,sans-serif;background:#fafafa;color:#222;}
  .topbar{position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #eee; padding:10px 14px; display:flex; align-items:center; gap:10px;}
  .topbar a{ color:var(--brand); text-decoration:none; font-weight:800; }
  .wrap{ max-width:980px; margin:0 auto; padding:18px 14px 48px; }

  .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
  .tab{ padding:8px 12px; border:1px solid #ddd; border-radius:999px; background:#fff; cursor:pointer; font-weight:800; }
  .tab.active{ background:var(--brand); color:#fff; border-color:transparent; }

  .list{ display:grid; gap:12px; }
  .card{
    background:#fff; border:1px solid #eee; border-radius:14px; padding:12px;
    box-shadow:0 6px 16px rgba(0,0,0,.06); display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;
  }
  .thumb{ width:64px; height:64px; border-radius:10px; object-fit:cover; background:#f3f3f3; border:1px solid #eee; }
  .meta{ flex:1 1 360px; min-width:260px; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .muted{ color:var(--muted); }
  .price{ color:#e91e63; font-weight:900; }
  .actions{ display:flex; gap:8px; margin-left:auto; }

  .btn{ padding:8px 12px; border-radius:10px; border:1px solid #ddd; background:#fff; font-weight:800; cursor:pointer; }
  .btn.primary{ background:var(--brand); color:#fff; border-color:transparent; }
  .btn.ghost{ background:#fff; }
  .btn.done{ background:#6c4ef7; color:#fff; border-color:transparent; box-shadow:0 0 0 3px rgba(108,78,247,.15), 0 8px 18px rgba(108,78,247,.25); }

  /* 共用彈窗 */
  .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px; z-index:1000; }
  .dlg{ width:min(560px, 94vw); background:#fff; border:1px solid #eee; border-radius:16px; overflow:hidden; box-shadow:0 16px 40px rgba(0,0,0,.18); }
  .dlg header{ position:sticky; top:0; background:#fff; padding:12px 14px; font-weight:900; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;}
  .dlg .body{ padding:14px; max-height:70vh; overflow:auto; -webkit-overflow-scrolling:touch; }
  .field{ margin:10px 0; }
  .label{ font-size:12px; color:#777; margin-bottom:6px; }
  .input, .file, textarea{ width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px; outline:none; }
  textarea{ min-height:110px; resize:vertical; }
  .dlg .actions{ position:sticky; bottom:0; background:#fff; display:flex; gap:10px; justify-content:flex-end; padding:10px 14px; border-top:1px solid #eee; }
  .hint{ color:#777; font-size:12px; }
  .err{ color:#b00020; font-size:13px; margin-top:6px; }
  .closex{ cursor:pointer; font-size:22px; color:#888; line-height:1; }

  .proof{ max-width:260px; border:1px solid #eee; border-radius:10px; background:#fff; }
  .btn.disabled{ opacity:.45; pointer-events:none; filter:grayscale(1); }
  /* ========== 夜間模式變數 ========== */
html[data-theme="dark"]{
  --text:#cfc3ff;
  --muted:#9a8fd1;
  --brand:#a48cff;
  --accent:#bf66ff;

  --card-bg:#161222;
  --card-border:#2b2440;
  --page-bg:#0f0b1a;

  --btn-bg:#1b1629;
  --btn-border:#2b2440;
  --btn-text:#cfc3ff;

  --shadow:0 10px 28px rgba(0,0,0,.45);
}

/* ========== 全局色系 ========== */
html[data-theme="dark"] body{ background:var(--page-bg); color:var(--text); }
html[data-theme="dark"] .muted{ color:var(--muted); }
html[data-theme="dark"] .topbar,
html[data-theme="dark"] .card,
html[data-theme="dark"] .dlg,
html[data-theme="dark"] .wrap{
  background:var(--card-bg);
  border-color:var(--card-border);
  color:var(--text);
}
html[data-theme="dark"] .tab{ background:var(--btn-bg); border:1px solid var(--btn-border); color:var(--btn-text); }
html[data-theme="dark"] .tab.active{ background:var(--brand); color:#161222; border-color:transparent; }
html[data-theme="dark"] .btn{ background:var(--btn-bg); border:1px solid var(--btn-border); color:var(--btn-text); }
html[data-theme="dark"] .btn.primary{ background:var(--brand); color:#161222; border-color:transparent; }

/* ========== 右上角圓球按鈕 + 下拉選單 ========== */
.menu-wrap{ position:relative; display:inline-flex; gap:8px; align-items:center; }

/* 圓球按鈕 */
.menu-btn{
  width:34px; height:34px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:16px; font-weight:700; line-height:1;
  background:var(--brand); color:#fff; border:none;
  cursor:pointer; transition:transform .2s ease, background .2s ease, box-shadow .2s ease;
  box-shadow:0 4px 12px rgba(108,78,247,.22);
}
.menu-btn:hover{ transform:scale(1.08); }
.menu-btn:active{ transform:scale(.95); }
html[data-theme="dark"] .menu-btn{
  background:var(--btn-bg);
  border:1px solid var(--btn-border);
  color:var(--btn-text);
  box-shadow:none;
}

/* 下拉選單 */
.dropdown{
  position:absolute; top:calc(100% + 8px);
  right:0; left:auto;                /* ✅ 靠右對齊避免被螢幕擋住 */
  max-width:90vw;                    /* ✅ 最多佔螢幕 90% */
  overflow-wrap:break-word;
  transform:translateY(-6px) scale(.98);
  opacity:0; visibility:hidden; pointer-events:none;
  min-width:220px;
  border-radius:14px; padding:8px; z-index:999;
  transition:opacity .16s ease, transform .18s cubic-bezier(.2,.8,.2,1);
  background:#fdeaff; color:#4a3a6a;
  border:1px solid #f5ccff;
  box-shadow:0 16px 32px rgba(0,0,0,.18);
}
.dropdown.show{
  transform:translateY(0) scale(1);
  opacity:1; visibility:visible; pointer-events:auto;
}
.dropdown::after{ content:none; }
.dropdown .item{ width:100%; text-align:left; padding:10px 12px; border:0; background:transparent; color:inherit; border-radius:8px; cursor:pointer; transition:.12s; }
.dropdown .item:hover{ background:rgba(108,78,247,.10); transform:translateY(-1px); }
html[data-theme="dark"] .dropdown{ background:var(--card-bg); color:var(--text); border:1px solid var(--card-border); box-shadow:var(--shadow); }

/* 小螢幕自動鋪滿 */
@media(max-width:560px){
  .dropdown, .dropdown.show{ left:0 !important; right:auto !important; width:92vw; }
}
</style>
</head>
<body>
  <div class="topbar">
    <a href="user.html">← 返回個人主頁</a>
    <a href="messages.html" style="margin-left:auto">我的訊息</a>
    <div class="menu-wrap">
  <button id="menuBtn" class="menu-btn" aria-expanded="false" onclick="toggleMenu()">%</button>
  <div id="menuDrop" class="dropdown" role="menu">
    <!-- 第一個選項：切換模式 -->
    <button class="item" onclick="toggleTheme()" id="modeItem">切換模式：夜間</button>
     <button class="item" onclick="location.href='../index.html'">主頁</button>
    <button class="item" onclick="location.href='Grove.Examination-Yuan.html'">參加管理員</button>
    <button class="item" onclick="location.href='Grove. Control-Yuan.html'">Control</button>
    <button class="item" onclick="location.href='Grove.Executive-Yuan.html'">Executive</button>
    <button class="item" onclick="location.href='Grove.Judicial-Yuan.html'">申訴</button>
    <button class="item" onclick="location.href='Grove.Legislative-Yuan.html'">Legislative</button>
    <button class="item" onclick="location.href='vote.html'">投票專區</button>
    <button class="item" onclick="location.href='constitution.html'">網站申明</button>
  </div>
</div>
  </div>

  <div class="wrap">
    <h2 style="margin:0 0 10px">我的購買</h2>

    <div class="tabs">
      <button class="tab active" data-tab="shipped" onclick="switchTab('shipped')">已發貨</button>
      <button class="tab" data-tab="pending" onclick="switchTab('pending')">未發貨</button>
      <button class="tab" data-tab="rejected" onclick="switchTab('rejected')">駁回</button>
      <button class="tab" data-tab="history" onclick="switchTab('history')">歷史購物</button>
    </div>

    <div id="orderList" class="list"></div>
  </div>

  <!-- 申訴 Modal -->
  <div id="appealDlg" class="backdrop">
    <div class="dlg">
      <header>
        <div>訂單申訴</div>
        <div class="closex" onclick="closeAppeal()">×</div>
      </header>
      <div class="body">
        <div class="field">
          <div class="label">申訴理由</div>
          <textarea id="apReason" class="input" placeholder="請簡述原因…"></textarea>
        </div>
        <div class="field">
          <div class="label">證據圖片（可選）</div>
          <input id="apProof" class="file" type="file" accept="image/*">
        </div>
        <div class="hint">送出後會以訊息通知商家。</div>
        <div id="apErr" class="err"></div>
      </div>
      <div class="actions">
        <button class="btn" onclick="closeAppeal()">取消</button>
        <button class="btn primary" onclick="submitAppeal()">確認</button>
      </div>
    </div>
  </div>

  <!-- 查看駁回 Modal -->
  <div id="rejViewDlg" class="backdrop">
    <div class="dlg">
      <header>
        <div>駁回訊息</div>
        <div class="closex" onclick="closeRejView()">×</div>
      </header>
      <div class="body">
        <div class="label">駁回理由</div>
        <div id="rvReason" style="white-space:pre-wrap; line-height:1.6">—</div>
        <div class="label" style="margin-top:10px">圖片</div>
        <img id="rvProofImg" class="proof" style="display:none" alt="駁回圖片">
      </div>
      <div class="actions">
        <button class="btn" onclick="closeRejView()">關閉</button>
      </div>
    </div>
  </div>

<script>
const API     = "https://zdqo2eqb.lc-cn-n1-shared.com/1.1";
const APP_ID  = "ZDqo2eQBcSChCfRgwix9jUeI-gzGzoHsz";
const APP_KEY = "U66ybZWAD99LrT9zJnQlW52H";
const CURRENCY_SIGN = '¥';

(function guard(){
  const t = localStorage.getItem('sg_token');
  const u = JSON.parse(localStorage.getItem('sg_user')||'null');
  if(!t || !u){ location.replace('index.html?redirect=io'); }
})();
const me    = JSON.parse(localStorage.getItem('sg_user')||'null');
const token = localStorage.getItem('sg_token');
const AUTH  = { 'X-LC-Id': APP_ID, 'X-LC-Key': APP_KEY, 'X-LC-Session': token };

const DEFAULT_AVATAR = 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect width="100%" height="100%" rx="40" ry="40" fill="#f3f3f3"/><text x="50%" y="55%" text-anchor="middle" font-size="28">🙂</text></svg>`);
const money = n => Number(n||0).toLocaleString('zh-TW');
const GID = me?.gid || me?.objectId || '';

let TAB = 'shipped';
let ORDERS = [];      // 全部（buyer=我）
let CURRENT = null;   // 目前操作中的訂單（for 申訴視窗）

/* === 讀我的訂單 === */
async function fetchMyOrders(){
  const where = encodeURIComponent(JSON.stringify({
    buyer: { "__type":"Pointer","className":"_User","objectId": me.objectId }
  }));
  const url = `${API}/classes/Order?where=${where}&order=-createdAt&limit=200&include=seller,product`;
  const res = await fetch(url, { headers: AUTH });
  const data = await res.json();
  if(!res.ok){ console.warn('fetchMyOrders error', data); return []; }
  const list = data.results || [];
  await hydrateSellers(list);
  return list;
}

// 讓 seller 顯示暱稱
async function hydrateSellers(list){
  const ids = Array.from(new Set((list||[]).map(o=>o?.seller?.objectId).filter(Boolean)));
  if(!ids.length) return;
  const where = encodeURIComponent(JSON.stringify({ objectId: { "$in": ids } }));
  try{
    const res = await fetch(`${API}/users?where=${where}&limit=${ids.length}`, { headers: { ...AUTH } });
    const data = await res.json();
    if(!res.ok) return;
    const dict = new Map();
    (data.results||[]).forEach(u=>dict.set(u.objectId, u));
    list.forEach(o=>{
      const u = dict.get(o?.seller?.objectId);
      if(u){
        o.seller.nickname = u.nickname || u.username || '';
        o.seller.username = u.username || o.seller.username || '';
        o.seller.avatarUrl = (u.avatarUrl || '').replace(/^http:\/\//,'https://');
      }
    });
  }catch(e){}
}

/* === UI === */
function switchTab(tab){
  TAB = tab;
  document.querySelectorAll('.tab').forEach(t=>{
    t.classList.toggle('active', t.dataset.tab===TAB);
  });
  renderList();
}

function listByTab(){
  if(TAB==='history') return ORDERS;
  if(TAB==='shipped') return ORDERS.filter(o=>o.status==='shipped');
  if(TAB==='pending') return ORDERS.filter(o=>!o.status || o.status==='submitted');
  if(TAB==='rejected') return ORDERS.filter(o=>o.status==='rejected');
  return [];
}

function renderList(){
  const box = document.getElementById('orderList');
  const list = listByTab();
  box.innerHTML = '';

  if(!list.length){
    box.innerHTML = `<div class="muted">這個分類目前沒有資料。</div>`;
    return;
  }

  list.forEach(o=>{
    const io = o.io || '';
    const p = o.product || {};
    const dt = new Date(o.createdAt);
    const thumb = p.imageUrl || (Array.isArray(p.images)&&p.images[0]) || DEFAULT_AVATAR;
    const unitPrice = (o.unitPrice ?? o.price) || 0;
    const qty = (o.quantity ?? 1);
    const total = (o.totalPrice ?? (unitPrice*qty)) || unitPrice;
    const sellerName = (o.seller?.nickname || o.seller?.username || '商家');

    const card = document.createElement('div');
    card.className='card';
    card.id = `order_${o.objectId}`;

    let actionHtml = '';
    if(TAB==='shipped'){
      actionHtml = `<button class="btn primary" onclick="confirmReceive('${o.objectId}')">確認簽收</button>`;
    }else if(TAB==='pending'){
      actionHtml = `<button class="btn ghost" onclick="urgeShip('${o.objectId}')">催發貨</button>`;
    }else if(TAB==='rejected'){
      const appealed = !!o.appealedAt;
      actionHtml = `
        <button class="btn ghost" onclick="openAppeal('${o.objectId}')">申訴</button>
        <button class="btn ghost" onclick="viewReject('${o.objectId}')">查看駁回訊息</button>
        ${appealed ? `<button class="btn ghost" onclick="urgeAppeal('${o.objectId}')">催處理</button>` : ''}
      `;
    } // history 分頁不放按鈕

    card.innerHTML = `
  <img class="thumb" src="${thumb}" alt="">
  <div class="meta">
    <div class="row">
      <div style="font-weight:900">${escapeHTML(p.title || o.productTitle || '未命名商品')}</div>
      <div class="muted">（規格：${escapeHTML(o.variantName || '')}）</div>
    </div>
    ${io ? `<div class="row"><div class="muted">IO：<code style="font-family:ui-monospace,monospace">${escapeHTML(io)}</code></div></div>` : ''}
    <div class="row">
      <div>商家：<b>${escapeHTML(sellerName)}</b></div>
      <div class="muted">｜ 購買日期：${dt.toLocaleString()}</div>
    </div>
    <div class="row" style="margin-top:4px">
      <div>單價：<span class="price">${CURRENCY_SIGN}${money(unitPrice)}</span></div>
      ${qty ? `<div>｜ 數量：${qty}</div>` : ''}
      <div>｜ 總額：<span class="price">${CURRENCY_SIGN}${money(total)}</span></div>
      <div class="muted">｜ 狀態：${escapeHTML(o.status || 'submitted')}</div>
    </div>
  </div>
  <div class="actions">${actionHtml}</div>
`;
    box.appendChild(card);
  });
}

function removeCard(id){
  const el = document.getElementById(`order_${id}`);
  if(el) el.remove();
}

/* === 操作：確認簽收 === */
async function confirmReceive(oid){
  const o = ORDERS.find(x=>x.objectId===oid);
  if(!o) return;
  if(!confirm('確認已收到商品？')) return;

  try{
    const r = await fetch(`${API}/classes/Order/${oid}`,{
      method:'PUT',
      headers:{...AUTH,'Content-Type':'application/json'},
      body: JSON.stringify({ status:'received', receivedAt:{ "__type":"Date","iso": new Date().toISOString() } })
    });
    const d = await r.json();
    if(!r.ok) throw new Error(d.error || '更新訂單失敗');

    const io = o.io || '';
const unitPrice = (o.unitPrice ?? o.price) || 0;
const qty = (o.quantity ?? 1);
const total = (o.totalPrice ?? (unitPrice * qty)) || unitPrice;
const msgText = `買家已確認簽收：${o.productTitle || o.product?.title || ''}｜金額：${CURRENCY_SIGN}${money(total)}${io ? `｜IO：${io}` : ''}`;
const payload = {
  kind:'receive',
  text: msgText,
  body: msgText,
  from:{ "__type":"Pointer","className":"_User","objectId": me.objectId },
  to:  { "__type":"Pointer","className":"_User","objectId": o.seller.objectId },
  order:{ "__type":"Pointer","className":"Order","objectId": o.objectId },
  product: o.product ? { "__type":"Pointer","className":"Product","objectId": o.product.objectId } : undefined,
  data:{ io }
};
    const m = await fetch(`${API}/classes/Message`,{
      method:'POST',
      headers:{...AUTH,'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const md = await m.json();
    if(!m.ok) throw new Error(md.error || '通知商家失敗');

    removeCard(oid);
    alert('✅ 訂單已簽收');
  }catch(e){
    alert(e.message || '操作失敗');
  }
}

/* === 操作：催發貨 === */
async function urgeShip(oid){
  const o = ORDERS.find(x=>x.objectId===oid);
  if(!o) return;
  const io = o.io || '';
const text = `${GID} 催發貨${io ? `｜IO：${io}` : ''}`;
const payload = {
  kind: 'urge_ship',
  text,
  body: text,
  from:{ "__type":"Pointer","className":"_User","objectId": me.objectId },
  to:  { "__type":"Pointer","className":"_User","objectId": o.seller.objectId },
  order:{ "__type":"Pointer","className":"Order","objectId": o.objectId },
  product: o.product ? { "__type":"Pointer","className":"Product","objectId": o.product.objectId } : undefined,
  data:{ io }
};

  try{
    const res = await fetch(`${API}/classes/Message`,{
      method:'POST',
      headers:{...AUTH,'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || '催發貨失敗');
    alert('✅ 已送出催發貨訊息');
  }catch(e){
    alert(e.message || '操作失敗');
  }
}

async function urgeAppeal(oid){
  const o = ORDERS.find(x=>x.objectId===oid);
  if(!o) return;
  const io = o.io || '';
const text = `${GID} 催處理申訴${io ? `｜IO：${io}` : ''}`;
const payload = {
  kind:'urge_appeal',
  text,
  body: text,
  from:{ "__type":"Pointer","className":"_User","objectId": me.objectId },
  to:  { "__type":"Pointer","className":"_User","objectId": o.seller.objectId },
  order:{ "__type":"Pointer","className":"Order","objectId": o.objectId },
  product: o.product ? { "__type":"Pointer","className":"Product","objectId": o.product.objectId } : undefined,
  data:{ io }
};

  try{
    const res = await fetch(`${API}/classes/Message`,{
      method:'POST',
      headers:{...AUTH,'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || '催處理失敗');
    alert('✅ 已送出催處理訊息');
  }catch(e){
    alert(e.message || '操作失敗');
  }
}

/* === 操作：查看駁回 === */
function viewReject(oid){
  const o = ORDERS.find(x=>x.objectId===oid);
  if(!o) return;
  document.getElementById('rvReason').textContent = o.rejectReason || '—';
  const img = document.getElementById('rvProofImg');
  const u = (o.rejectProofUrl||'').replace(/^http:\/\//,'https://');
  if(u){ img.src=u; img.style.display='block'; } else { img.removeAttribute('src'); img.style.display='none'; }
  document.getElementById('rejViewDlg').style.display='flex';
}
function closeRejView(){ document.getElementById('rejViewDlg').style.display='none'; }

/* === 操作：申訴 === */
function openAppeal(oid){
  CURRENT = ORDERS.find(x=>x.objectId===oid) || null;
  if(!CURRENT) return;
  document.getElementById('apReason').value = '';
  document.getElementById('apProof').value = '';
  document.getElementById('apErr').textContent = '';
  document.getElementById('appealDlg').style.display='flex';
}
function closeAppeal(){ document.getElementById('appealDlg').style.display='none'; }

function fileToBase64(file){ return new Promise((resolve,reject)=>{ const fr=new FileReader(); fr.onload=()=>resolve(fr.result.split(',')[1]); fr.onerror=reject; fr.readAsDataURL(file); }); }
async function uploadOne(file){
  const base64 = await fileToBase64(file);
  const r = await fetch(`${API}/files/${encodeURIComponent(file.name)}`,{
    method:'POST',
    headers:{...AUTH,'Content-Type':'application/json'},
    body: JSON.stringify({ base64 })
  });
  const data = await r.json();
  if(!r.ok) throw new Error(data.error || '檔案上傳失敗');
  return data.url;
}

async function submitAppeal(){
  if(!CURRENT) return;
  const reason = document.getElementById('apReason').value.trim();
  const pf = document.getElementById('apProof').files[0];
  if(!reason){ document.getElementById('apErr').textContent='請填寫申訴理由'; return; }

  try{
    let proofUrl = '';
    if(pf) proofUrl = await uploadOne(pf);

    const put = await fetch(`${API}/classes/Order/${CURRENT.objectId}`,{
      method:'PUT',
      headers:{...AUTH,'Content-Type':'application/json'},
      body: JSON.stringify({ appealedAt:{ "__type":"Date","iso": new Date().toISOString() }, appealReason: reason, appealProofUrl: proofUrl })
    });
    const pd = await put.json();
    if(!put.ok) throw new Error(pd.error || '更新訂單失敗');

    const io = CURRENT.io || '';
const unitPrice = (CURRENT.unitPrice ?? CURRENT.price) || 0;
const qty = (CURRENT.quantity ?? 1);
const total = (CURRENT.totalPrice ?? (unitPrice * qty)) || unitPrice;

const msgText = `買家提交申訴：${reason}｜金額：${CURRENCY_SIGN}${money(total)}${io ? `｜IO：${io}` : ''}`;
const payload = {
  kind:'appeal',
  text: msgText,
  body: msgText,
  from:{ "__type":"Pointer","className":"_User","objectId": me.objectId },
  to:  { "__type":"Pointer","className":"_User","objectId": CURRENT.seller.objectId },
  order:{ "__type":"Pointer","className":"Order","objectId": CURRENT.objectId },
  product: CURRENT.product ? { "__type":"Pointer","className":"Product","objectId": CURRENT.product.objectId } : undefined,
  data:{ reason, proofUrl, io }
};
    const res = await fetch(`${API}/classes/Message`,{
      method:'POST',
      headers:{...AUTH,'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || '申訴送出失敗');

    closeAppeal();
    alert('✅ 已送出申訴');
    const idx = ORDERS.findIndex(x=>x.objectId===CURRENT.objectId);
    if(idx>=0){ ORDERS[idx].appealedAt = { "__type":"Date","iso": new Date().toISOString() }; }
    renderList();
  }catch(e){
    document.getElementById('apErr').textContent = e.message || '送出失敗';
  }
}

/* === 操作：催處理申訴 === */
async function urgeAppeal(oid){
  const o = ORDERS.find(x=>x.objectId===oid);
  if(!o) return;
  const io = o.io || '';
const text = `${GID} 催處理申訴${io ? `｜IO：${io}` : ''}`;
const payload = {
  kind:'urge_appeal',
  text,
  body: text,
  from:{ "__type":"Pointer","className":"_User","objectId": me.objectId },
  to:  { "__type":"Pointer","className":"_User","objectId": o.seller.objectId },
  order:{ "__type":"Pointer","className":"Order","objectId": o.objectId },
  product: o.product ? { "__type":"Pointer","className":"Product","objectId": o.product.objectId } : undefined,
  data:{ io }
};
try{
    const res = await fetch(`${API}/classes/Message`,{
      method:'POST',
      headers:{...AUTH,'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || '催處理失敗');
    alert('✅ 已送出催處理訊息');
  }catch(e){
    alert(e.message || '操作失敗');
  }
}

/* === 啟動 === */
(async function start(){
  ORDERS = await fetchMyOrders();
  renderList();
})();
setInterval(async ()=>{
  ORDERS = await fetchMyOrders();
  renderList();
}, 12000);

/* utils */
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }
</script>
<script src="im.js"></script>
<!--=================-->
<p style="text-align: center; font-size: 13px; color: #999; margin-top: 40px;">
  🐾 © 2024 yinnlim的小宇宙｜內容與設計皆由糖糖本人用愛製作 💞<br>
  未經授權請勿隨意使用、盜轉喔 🙅‍♀️ 謝謝你的尊重與溫柔 💌
</p>
</body>
</html>