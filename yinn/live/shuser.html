<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>商品詳情</title>
<style>
  :root{ --brand:#6c4ef7; --muted:#777; --accent:#e91e63; }
  *{box-sizing:border-box}
  body{
  margin:0;
  font-family:"DFKai-SB","KaiTi","標楷體","BiauKai",serif;
  background:#fafafa;
  color:#222;
}
  .wrap{max-width:980px;margin:0 auto;padding:18px 14px 48px;}
  .top{display:flex;gap:18px;flex-wrap:wrap;}
  .gallery{flex:1 1 360px;background:#fff;border:1px solid #eee;border-radius:14px;overflow:hidden}
  .g-main{width:100%;aspect-ratio:1/1;object-fit:cover;background:#f3f3f3;display:block}
  .g-strip{display:flex;gap:8px;padding:8px;overflow:auto;border-top:1px solid #eee;background:#fff}
  .g-thumb{width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid #eee;cursor:pointer}
  .meta{flex:1 1 420px;background:#fff;border:1px solid #eee;border-radius:14px;padding:14px}
  .seller-bar{display:flex;align-items:center;gap:10px;padding:8px 0;cursor:pointer}
  .seller-bar img{width:40px;height:40px;border-radius:50%;object-fit:cover;border:1px solid #eee}
  .title{font-size:22px;font-weight:800;margin-bottom:6px}
  .muted{color:var(--muted)}
  .price{color:var(--accent);font-size:20px;font-weight:900}
  .specs{margin:12px 0;display:flex;flex-direction:column;gap:10px}
  .spec-row{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid #ddd;border-radius:999px;padding:8px 12px;cursor:pointer;background:#fff}
  .chip.active{border-color:var(--brand);box-shadow:0 0 0 3px rgba(108,78,247,.15)}
  .pay{margin-top:10px}
  .pay img{max-width:220px;border:1px solid #eee;border-radius:10px;background:#fff}
  .desc{margin-top:16px;
    background:#fff;
    border:1px solid #eee;
    border-radius:14px;
    padding:14px;
    line-height:1.7;
    white-space: pre-wrap;   /* 保留空格 & 換行 */
    word-wrap: break-word;   /* 長字也能換行 */
    line-height: 1.7;
  }
  .btn{padding:12px 16px;border-radius:12px;border:1px solid #ddd;background:#fff;font-weight:800;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
  .actions{margin-top:14px;display:flex;gap:10px}
  .back{display:inline-block;margin-bottom:12px;color:var(--brand);text-decoration:none;font-weight:700}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px}
  .card{display:block;border:1px solid #eee;border-radius:10px;overflow:hidden;text-decoration:none;color:inherit;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  .card img{width:100%;height:120px;object-fit:cover;background:#f3f3f3}
  .card .cbody{padding:8px}
  /* 讓彈窗本體可直向捲動，限制在視窗高度內 */
.order{
  width:min(640px, 92vw);
  background:#fff;
  border-radius:16px;
  border:1px solid #eee;
  box-shadow:0 16px 40px rgba(0,0,0,.18);
  max-height:92vh;          /* ← 最高不超過視窗高度 */
  overflow:auto;            /* ← 內容可捲動 */
}

/* 讓標題列固定在頂端 */
.order header{
  position: sticky;
  top: 0;
  background:#fff;
  z-index: 2;
  padding:14px 16px;
  font-weight:800;
  border-bottom:1px solid #eee;
  display:flex; justify-content:space-between; align-items:center;
}

/* 讓底部按鈕固定在底部 */
.order .actions{
  position: sticky;
  bottom: 0;
  background:#fff;
  z-index: 2;
  border-top:1px solid #eee;
  padding:10px 16px;
  display:flex; gap:10px; justify-content:flex-end;
}
.order .body{
  -webkit-overflow-scrolling: touch;
}

/* （可選）讓背景不跟著捲 */
.backdrop{
  position:fixed; inset:0;
  background:rgba(0,0,0,.35);
  display:none; align-items:center; justify-content:center;
  padding:16px;
}
  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .field{ flex:1 1 180px; }
  .field label{ display:block; font-size:12px; color:#777; margin-bottom:6px; }
  .input, .select, .file{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #ddd; outline:none; }
  .order .muted{ color:#777; font-size:12px; }
  .closex{ cursor:pointer; font-size:22px; line-height:1; color:#888;}
  .hr{ border:none; border-top:1px solid #eee; margin:12px 0; }
  .fix{ background:#fafafa; border:1px dashed #e7e7e7; border-radius:12px; padding:10px 12px; }
  .paybox{ display:none; padding:10px 12px; border:1px solid #eee; border-radius:12px; }
  .err{ color:#b00020; font-size:13px; margin-top:6px; }
  #favBtn.faved {
  color: #ff2ef5;   /* 螢光粉 */
  text-shadow: 0 0 6px #ff9df7;
}

/* === 與首頁一致的夜間主題變數 === */
:root[data-theme="dark"]{
  --glass-bg: rgba(20,16,34,.65);
  --glass-border: rgba(163,143,255,.14);

  --text:#cfc3ff;          /* 全站文字（紫外線感） */
  --muted:#9a8fd1;         /* 次要文字 */
  --brand:#a48cff;         /* 品牌紫 */
  --accent:#bf66ff;        /* 價格/重點色 */

  --card-bg:#161222;       /* 卡片/下拉/輸入底色 */
  --card-border:#2b2440;   /* 卡片邊框 */
  --page-bg:#0f0b1a;       /* 頁面底色 */

  --btn-bg:#1b1629;
  --btn-border:#2b2440;
  --btn-text:#cfc3ff;

  --chip-bg:#1b1629;
  --chip-border:#2b2440;

  --shadow: 0 10px 28px rgba(0,0,0,.45);
}

/* 全頁底色 & 文字 */
:root[data-theme="dark"] body{
  background:var(--page-bg);
  color:var(--text);
  font-family:"DFKai-SB","KaiTi","標楷體","BiauKai",serif;
}

/* 返回連結（← 返回） */
:root[data-theme="dark"] .back{ color:var(--brand); }
.back{ text-decoration:none; }

/* 區塊/卡片底色與邊框 */
:root[data-theme="dark"] .gallery,
:root[data-theme="dark"] .meta,
:root[data-theme="dark"] .desc,
:root[data-theme="dark"] .card{
  background:var(--card-bg);
  border:1px solid var(--card-border);
  box-shadow:var(--shadow);
  color:var(--text);
}

/* 縮圖/主圖預留底色 */
:root[data-theme="dark"] .g-main,
:root[data-theme="dark"] .card img{
  background:#1e1930;
}

/* 次要字、價格、標題 */
:root[data-theme="dark"] .muted{ color:var(--muted); }
:root[data-theme="dark"] .price{ color:var(--accent); }
:root[data-theme="dark"] .title{ color:var(--text); }

/* 規格 chip */
:root[data-theme="dark"] .chip{
  background:var(--chip-bg);
  border:1px solid var(--chip-border);
  color:var(--text);
}
:root[data-theme="dark"] .chip.active{
  border-color:var(--brand);
  box-shadow:0 0 0 3px rgba(164,140,255,.18);
}

/* 賣家列 */
:root[data-theme="dark"] .seller-bar img{ border-color:var(--card-border); }

/* 動作按鈕 */
:root[data-theme="dark"] .btn{
  background:var(--btn-bg);
  border:1px solid var(--btn-border);
  color:var(--btn-text);
}
:root[data-theme="dark"] .btn.primary{
  background:var(--brand);
  color:#161222;
  border-color:transparent;
}

/* 收藏 ♥ 狀態已在原碼，這裡只確保在暗色可見 */
:root[data-theme="dark"] #favBtn{ color:var(--text); }

/* 付款碼區 */
:root[data-theme="dark"] .pay img{
  background:var(--card-bg);
  border:1px solid var(--card-border);
}

/* 下方「此賣家的其他商品」卡片內價格色系對齊 */
:root[data-theme="dark"] .card .cbody{ color:var(--text); }
:root[data-theme="dark"] .card .cbody div:nth-child(2){ color:var(--accent); }

/* —— 訂單彈窗（與首頁 Modal 對齊） —— */
:root[data-theme="dark"] .order{
  background:var(--card-bg);
  color:var(--text);
  border:1px solid var(--card-border);
  box-shadow:var(--shadow);
}
:root[data-theme="dark"] .order header{
  background:var(--card-bg);
  border-bottom:1px solid var(--card-border);
}
:root[data-theme="dark"] .order .actions{
  background:var(--card-bg);
  border-top:1px solid var(--card-border);
}
:root[data-theme="dark"] .input,
:root[data-theme="dark"] .select,
:root[data-theme="dark"] .file{
  background:transparent;
  color:var(--text);
  border:1px solid var(--card-border);
}
:root[data-theme="dark"] .fix{
  background:#151127;
  border-color:#2e2750;
}
:root[data-theme="dark"] .paybox{
  border:1px solid var(--card-border);
  background:var(--card-bg);
}
:root[data-theme="dark"] .hr{ border-top:1px solid var(--card-border); }
:root[data-theme="dark"] .closex{ color:#a79be0; }

/* —— 右上角選單（與首頁一致） —— */
/* 容器維持相對定位即可 */
.menu-wrap{ position:relative; display:inline-flex; gap:8px; align-items:center; }

/* 先給 dropdown 基本樣式（關閉狀態） */
.dropdown{
  position:fixed;           /* ← 用 fixed 才能鎖在視窗，不會被父層 overflow 擋住 */
  left:-9999px; top:-9999px;/* 初始移到畫面外，開啟時用 JS 設確切座標 */
  min-width:220px;
  background:#fff; color:#222;
  border:1px solid #eee; border-radius:12px;
  box-shadow:0 16px 40px rgba(0,0,0,.22);
  padding:8px; z-index:5000;
  opacity:0; transform:translateY(-6px) scale(.98);
  transform-origin: top left;
  pointer-events:none; visibility:hidden;
  transition:opacity .16s ease, transform .18s cubic-bezier(.2,.8,.2,1), box-shadow .18s ease;
}
.dropdown.show{
  opacity:1; transform:translateY(0) scale(1);
  pointer-events:auto; visibility:visible;
}


/* hover 微動效 */
.dropdown .item{ width:100%; text-align:left; padding:10px 12px; border-radius:8px; border:0; background:transparent; cursor:pointer; }
.dropdown .item:hover{ background:rgba(108,78,247,.10); transform:translateY(-1px); transition:transform .12s ease, background .12s ease; }

/* 夜間配色與首頁一致 */
:root[data-theme="dark"] .dropdown{ background:var(--card-bg); color:var(--text); border:1px solid var(--card-border); box-shadow:var(--shadow); }
:root[data-theme="dark"] .dropdown::after{ background:var(--card-bg); border-color:var(--card-border); }
/* ===== 覆寫：夜間主題配色（提高權重 & 一致性） ===== */
html[data-theme="dark"] body{ background:var(--page-bg); color:var(--text); }
html[data-theme="dark"] .title{ color:var(--text); }
html[data-theme="dark"] .muted{ color:var(--muted); }
html[data-theme="dark"] .price{ color:var(--accent); }

/* 卡片/區塊（含商品描述、右欄 meta、圖片下方縮圖條） */
html[data-theme="dark"] .gallery,
html[data-theme="dark"] .meta,
html[data-theme="dark"] .desc,
html[data-theme="dark"] .card,
html[data-theme="dark"] .g-strip{
  background:var(--card-bg) !important;
  border:1px solid var(--card-border) !important;
  color:var(--text);
  box-shadow:var(--shadow);
}

/* 主圖與卡片中的圖片底色 */
html[data-theme="dark"] .g-main,
html[data-theme="dark"] .card img{ background:#1e1930; }

/* 規格 chip */
html[data-theme="dark"] .chip{
  background:var(--chip-bg); border:1px solid var(--chip-border); color:var(--text);
}
html[data-theme="dark"] .chip.active{
  border-color:var(--brand);
  box-shadow:0 0 0 3px rgba(164,140,255,.18);
}

/* 按鈕（包含右上角的 % 選單按鈕） */
html[data-theme="dark"] .btn,
html[data-theme="dark"] .menu-btn{
  background:var(--btn-bg) !important;
  border:1px solid var(--btn-border) !important;
  color:var(--btn-text) !important;
  box-shadow:none;
}
html[data-theme="dark"] .btn.primary{ background:var(--brand) !important; color:#161222 !important; }

/* 返回上方那條水平線（hr）在夜間的顏色 */
html[data-theme="dark"] hr{ border-top:1px solid var(--card-border) !important; }

/* ===== 覆寫：右上角「下拉選單」位置 + 動效（純 CSS） ===== */
/* 讓容器成為定位參考點 */
.menu-wrap{ position:relative !important; display:inline-flex; gap:8px; align-items:center; }

/* 關閉狀態 */
.dropdown{
  position:absolute !important;
  left:0; top:calc(100% + 8px);         /* 先讓它在按鈕正下 */
  transform:translateX(8px) translateY(-6px) scale(.98);
  opacity:0; visibility:hidden; pointer-events:none;
  min-width:220px; max-width:min(320px, 80vw);
  background:#fff; color:#222;
  border:1px solid #eee; border-radius:12px;
  box-shadow:0 16px 40px rgba(0,0,0,.22);
  z-index:1200;
  transition:opacity .16s ease, transform .18s cubic-bezier(.2,.8,.2,1), box-shadow .18s ease;
}

/* 開啟：顯示在「按鈕正下方並略向右」 */
.dropdown.show{
  transform:translateX(8px) translateY(0) scale(1);
  opacity:1; visibility:visible; pointer-events:auto;
}
/* 移除下拉選單的小箭頭 */
.dropdown::after{ content:none !important; }
/* 項目 hover 的「靈動感」 */
.dropdown .item{
  width:100%; text-align:left; padding:10px 12px;
  border:0; border-radius:8px; background:transparent; color:inherit; cursor:pointer;
  transition: transform .12s ease, background .12s ease;
}
.dropdown .item:hover{ background:rgba(108,78,247,.10); transform:translateY(-1px); }

/* 夜間版的選單與箭頭顏色 */
html[data-theme="dark"] .dropdown{
  background:var(--card-bg) !important;
  color:var(--text) !important;
  border:1px solid var(--card-border) !important;
  box-shadow:var(--shadow);
}
html[data-theme="dark"] .dropdown::after{
  background:var(--card-bg); border-color:var(--card-border);
}
/* 晝間模式的 dropdown 淡粉色背景 */
html[data-theme="light"] .dropdown {
  background: #ffe6f2 !important;   /* 淡粉色 */
  color: #222;                      /* 文字仍然深色 */
  border: 1px solid #f5cce0;        /* 淡粉邊框 */
  box-shadow: 0 10px 28px rgba(0,0,0,.15);
}
/* 小螢幕時，當右側空間不足，自動改為「貼齊左邊」 */
@media (max-width:560px){
  .dropdown, .dropdown.show{
    left:0 !important; right:auto !important;
    transform:translateX(0) translateY(0);
  }
  .dropdown::after{ left:14px; }
}

/* ===== 其它細節：收藏按鈕 & 縮圖條邊框 ===== */
#favBtn.faved{ color:#ff2ef5; text-shadow:0 0 6px #ff9df7; }
.g-strip{ border-top:1px solid #eee; }
html[data-theme="dark"] .g-strip{ border-top:1px solid var(--card-border) !important; }
/* 讓圖框能放置絕對定位的箭頭 */
.gallery{ position:relative; }

/* 箭頭容器（覆蓋整個主圖區，方便點擊） */
.g-nav{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:space-between;
  pointer-events:none;              /* 只有箭頭能點 */
}

/* 左右箭頭 */
.g-arrow{
  pointer-events:auto;
  width:42px; height:42px; border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  font-size:24px; font-weight:900; line-height:1;
  background:rgba(255,255,255,.86);
  border:1px solid #e7e7e7;
  box-shadow:0 6px 18px rgba(0,0,0,.15);
  cursor:pointer; user-select:none;
  transition:transform .12s ease, background .12s ease, box-shadow .12s ease;
  margin:0 10px;
}
.g-arrow:hover{ transform:scale(1.04); box-shadow:0 10px 26px rgba(0,0,0,.18); }
.g-arrow:active{ transform:scale(.96); }

/* 置中對齊主圖高度 */
.g-arrow-left{  margin-left:10px; }
.g-arrow-right{ margin-right:10px; }

/* 夜間配色 */
:root[data-theme="dark"] .g-arrow{
  background:rgba(22,18,34,.92);
  color:var(--text);
  border:1px solid var(--card-border);
  box-shadow:0 10px 24px rgba(0,0,0,.45);
}

/* 只有一張圖時隱藏箭頭 */
.gallery[data-count="1"] .g-nav{ display:none; }
/* 預設隱藏箭頭 */
.g-arrow{ opacity:0; pointer-events:none; }

/* 滑鼠進入 .gallery 才顯示 */
.gallery:hover .g-arrow{
  opacity:1; pointer-events:auto;
}
/* % 按鈕圓球化 */
.menu-btn {
  width: 30px;              /* 按鈕大小 */
  height: 30px;
  border-radius: 50%;       /* 圓形 */
  font-size: 20px;          /* 文字大小 */
  font-weight: 700;
  background: var(--brand); /* 白天模式預設紫色背景 */
  color: #fff;              /* 白字 */
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform .2s ease, background .2s ease;
}

/* hover 動效 */
.menu-btn:hover {
  transform: scale(1.1);        /* 微微放大 */
  background: #875cff;          /* hover 時亮一點的紫 */
}

/* 夜間模式：保持和你的深色系一致 */
html[data-theme="dark"] .menu-btn {
  background: var(--btn-bg);
  border: 1px solid var(--btn-border);
  color: var(--btn-text);
}
.t{
  text-decoration: none;
  color: rgb(158, 88, 255);
}
/*==============*/
/* ===== 評論區 ===== */
.comments {
  margin-top: 16px;
  background:#fff;
  border:1px solid #eee;
  border-radius:14px;
  overflow:hidden;
}
.c-head{
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px; border-bottom:1px solid #eee; font-weight:800;
}
.c-list{ padding:10px; display:flex; flex-direction:column; gap:10px; }
.c-item{ display:flex; gap:10px; }
.c-avatar{
  width:36px; height:36px; border-radius:50%; object-fit:cover;
  border:1px solid #eee; background:#f3f3f3;
}
.c-body{ flex:1; }
.c-meta{ font-size:12px; color:#777; display:flex; gap:8px; flex-wrap:wrap; }
.c-name{ font-weight:800; color:#333; }
.c-time{ color:#999; }
.c-text{ margin-top:4px; line-height:1.6; word-break:break-word; }
.c-photos{ margin-top:6px; display:flex; gap:6px; flex-wrap:wrap; }
.c-photo{
  width:84px; height:84px; object-fit:cover; border-radius:8px;
  border:1px solid #eee; background:#fafafa;
}
.c-foot{ padding:10px; border-top:1px solid #eee; display:flex; justify-content:center; }
.c-toggle{ border:1px solid #ddd; background:#fff; border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:700; }

/* 發佈評論 Modal（沿用你現有的樣式語言） */
#cModal.backdrop{ z-index:3000; }
.cbox{
  width:min(560px, 92vw);
  background:#fff; border:1px solid #eee; border-radius:14px;
  box-shadow:0 16px 40px rgba(0,0,0,.18); overflow:hidden; max-height:92vh;
  display:flex; flex-direction:column;
}
.cbox header{
  padding:12px 14px; font-weight:800; border-bottom:1px solid #eee;
  display:flex; justify-content:space-between; align-items:center;
}
.cbox .body{ padding:14px; overflow:auto; }
.cbox .field{ margin:10px 0; }
.cbox label{ display:block; font-size:12px; color:#777; margin-bottom:6px; }
.cbox .input, .cbox .file, .cbox textarea{
  width:100%; padding:10px 12px; border-radius:10px; border:1px solid #ddd; outline:none;
}
.cbox textarea{ min-height:120px; resize:vertical; }
.cbox .actions{
  border-top:1px solid #eee; display:flex; gap:10px; justify-content:flex-end; padding:10px 14px;
}
.c-err{ color:#b00020; font-size:13px; margin-top:6px; }

/* 夜間配色對齊 */
:root[data-theme="dark"] .comments,
:root[data-theme="dark"] .cbox{
  background:var(--card-bg); color:var(--text); border:1px solid var(--card-border); box-shadow:var(--shadow);
}
:root[data-theme="dark"] .c-head,
:root[data-theme="dark"] .cbox header{ border-bottom:1px solid var(--card-border); }
:root[data-theme="dark"] .c-foot,
:root[data-theme="dark"] .cbox .actions{ border-top:1px solid var(--card-border); }
:root[data-theme="dark"] .c-toggle{ background:var(--btn-bg); border:1px solid var(--btn-border); color:var(--btn-text); }
:root[data-theme="dark"] .cbox .input,
:root[data-theme="dark"] .cbox .file,
:root[data-theme="dark"] .cbox textarea{ background:transparent; color:var(--text); border:1px solid var(--card-border); }
/* === 評論展開面板（大匡） === */
#cPanelBackdrop{
  position: fixed; inset: 0;
  background: rgba(0,0,0,.35);
  display: none;
  align-items: center; justify-content: center;
  z-index: 3000;
  opacity: 0; transition: opacity .18s ease;
}
#cPanelBackdrop.show{ display:flex; }
#cPanelBackdrop.visible{ opacity:1; }

.c-panel{
  width: min(760px, 94vw);
  height: 70vh;                     /* 固定高度 → 內容可捲 */
  background: #fff;
  border: 1px solid #eee; border-radius: 14px;
  box-shadow: 0 18px 48px rgba(0,0,0,.22);
  display: flex; flex-direction: column; overflow: hidden;
  transform: translateY(8px) scale(.98);
  opacity: 0;
  transition: transform .22s cubic-bezier(.2,.8,.2,1), opacity .18s ease;
}
.c-panel.enter{ transform: translateY(0) scale(1); opacity: 1; }

.cp-head{
  padding: 12px 14px; font-weight: 800; border-bottom:1px solid #eee;
  display:flex; align-items:center; justify-content:space-between;
}
.cp-body{
  padding: 12px; overflow:auto;    /* 內容可上下滑 */
  -webkit-overflow-scrolling: touch;
}
.cp-foot{
  border-top:1px solid #eee; padding:10px 12px; display:flex; justify-content:center;
}
.cp-close{ cursor:pointer; font-size:22px; color:#888; }

.c-item{ position: relative; }      /* 放刪除鈕 */
.c-del{
  position:absolute; right:0; top:0;
  border:1px solid #f5c5d0; background:#ffe9ee; color:#d23;
  border-radius:10px; padding:4px 8px; font-size:12px; cursor:pointer;
  display:none;
}
.c-item.own .c-del{ display:inline-block; }

/* 小匡預覽區也加點開合動畫感 */
#comments{
  transition: transform .18s cubic-bezier(.2,.8,.2,1), opacity .16s ease;
}
#comments.anim-hide{ transform: scale(.98); opacity:.0; }
#comments.anim-show{ transform: scale(1);   opacity:1; }

/* 夜間對齊 */
:root[data-theme="dark"] #cPanelBackdrop{ background: rgba(0,0,0,.5); }
:root[data-theme="dark"] .c-panel{
  background: var(--card-bg); color: var(--text);
  border:1px solid var(--card-border); box-shadow: var(--shadow);
}
:root[data-theme="dark"] .cp-head, :root[data-theme="dark"] .cp-foot{
  border-color: var(--card-border);
}
:root[data-theme="dark"] .c-del{
  background:#3b1f28; color:#ff9fb1; border-color:#5a2e3d;
}
:root[data-theme="dark"] .btny{
  background:#3b1f28; color:#ff9fb1; border-color:#5a2e3d;
}
.btny{
  padding:5px 9px;
  border-radius:12px;
  border:1px solid #ff35b2;
  background:#ff75c8;
  font-weight:800;
  cursor:pointer
}
.i{
  text-decoration: none;
  color: rgb(255, 255, 255);
}
</style>
<style>
  /*游標*/
/* 透明 1x1 游標（資料URI），比單純 none 更不會被瀏覽器臨時覆蓋 */
:root{
  --cursor-none: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAEklEQVQImWNgYGBgYAAAAAQAARV7J8EAAAAASUVORK5CYII=') 0 0, none;
}

/* 徹底套用到所有盒與偽元素 */
html, body, *, *::before, *::after{
  cursor: var(--cursor-none) !important;
}

/* 任何原本會把游標改成 pointer / text 的元素，強制繼承就不會跳回原生樣式 */
a, button, [role="button"], label, summary,
input, textarea, select, option, details, svg, canvas{
  cursor: inherit !important;
}

/* 你的自訂游標外層（不變） */
#cursor{
  position: fixed; left:0; top:0; width:0; height:0;
  pointer-events: none; will-change: transform; z-index: 9999;
}
/* 內層圖片（不變） */
#cursor .cursor-img{
  width:32px; height:32px;
  background: url('../shoing.png') center/contain no-repeat;
  transform: translate(-8px,-12px) scale(1);
  transition: transform .12s ease; 
  will-change: transform;
}
#cursor.down .cursor-img{ 
  transform: translate(-8px,-12px) scale(.9); 
}
/* 透明遮罩：預設不擋互動，但在捲動瞬間短暫接手 hit-test 以保證 cursor:none 生效 */
#cursor-shield{
  position: fixed;
  inset: 0;
  cursor: var(--cursor-none) !important;  /* 一律隱藏系統游標 */
  pointer-events: none;                   /* 平常不擋點擊/滑動 */
  z-index: 9998;                          /* 低於自訂游標 #cursor */
}

/* 「捲動中」短暫啟用命中（只影響游標命中，不會影響滾動） */
#cursor-shield.cover{
  pointer-events: auto;                   /* 讓它成為命中元素，游標就不會被下面原生控件奪回 */
}

</style>
<style>
  /* ========== Gallery 響應式 ========== */

/* 主圖：預設以「完整顯示」為主，不裁切；高度不超過視窗 70vh */
.g-main{
  width: 100%;
  height: auto;
  max-height: 70vh;
  object-fit: contain;
  aspect-ratio: auto;           /* 取消固定 1:1，讓圖片自己決定比例 */
  display: block;
}

/* 寬螢幕（平板/桌機）才回到方形框，視覺更整齊 */
@media (min-width: 768px){
  .g-main{
    aspect-ratio: 1 / 1;
    max-height: none;
    object-fit: cover;          /* 這時候方框內裁切一些比較好看 */
  }
}

/* 縮圖列：在小螢幕縮小尺寸，避免擠壓 */
.g-strip{ gap: 6px; }
.g-thumb{ width: 64px; height: 64px; }
@media (max-width: 480px){
  .g-thumb{ width: 52px; height: 52px; }
}

/* 兩欄版面：手機一欄直排，避免左右擠壓 */
@media (max-width: 768px){
  .top{ flex-direction: column; }
  .gallery, .meta{ flex: 1 1 100%; }
}

/* 箭頭：行動裝置沒有 hover，直接常駐顯示、稍微縮小 */
@media (hover: none){
  .gallery .g-arrow{
    opacity: 1;
    pointer-events: auto;
  }
}
@media (max-width: 480px){
  .gallery .g-arrow{ width: 34px; height: 34px; font-size: 20px; }
}

/* 內文區的圖片：一律自適應容器寬，不要固定 500px */
.desc img{
  display: block;
  max-width: 100% !important;
  width: 100% !important;
  height: auto !important;
  border: 1px solid #eee;
  border-radius: 10px;
  margin: 8px 0;
}

/* 如果你有放其他賣家商品的卡片圖，也保底一下 */
.card img{ width: 100%; height: auto; object-fit: cover; }
</style>
</head>
<body>
  <div id="cursor-shield"></div>
<div id="cursor"><div class="cursor-img"></div></div>


  <div class="wrap">
    <div class="menu-wrap">
      <a class="back" href="javascript:void(0)" onclick="goBack()">← 返回</a>
  <button id="menuBtn" class="menu-btn" aria-expanded="false" onclick="toggleMenu()">%</button>
  <button class="btny">
    <a href="shopping.html" class="i">Esc Store</a></button>
  <div id="menuDrop" class="dropdown" role="menu">
    <!-- 第一個選項：切換模式 -->
    <button class="item" onclick="toggleTheme()" id="modeItem">切換模式：夜間</button>
     <button class="item" onclick="location.href='../index.html'">主頁</button>
    <button class="item" onclick="location.href='Grove.Examination-Yuan.html'">參加管理員</button>
    <button class="item" onclick="location.href='Grove. Control-Yuan.html'">Control</button>
    <button class="item" onclick="location.href='Grove.Executive-Yuan.html'">Executive</button>
    <button class="item" onclick="location.href='Grove.Judicial-Yuan.html'">申訴</button>
    <button class="item" onclick="location.href='Grove.Legislative-Yuan.html'">Legislative</button>
    <button class="item" onclick="location.href='vote.html'">投票專區</button>
    <button class="item" onclick="location.href='constitution.html'">網站申明</button>
    
  </div>
</div>
 <hr style="border:none;border-top:1px solid #eee;margin:8px 0 16px">
    <!-- 只顯示「頭貼＋暱稱」 -->
    <div id="sellerBar" class="seller-bar" style="display:none">
      <img id="sellerAvatar" alt="賣家頭貼">
      <div id="sellerName" style="font-weight:800;font-size:15px"></div>
    </div>
   

    <div class="top">
      <div class="gallery">
        <img id="gMain" class="g-main" src="" alt="商品圖片">
        <div id="gStrip" class="g-strip"></div>
      </div>

      <div class="meta">
        <div id="mTitle" class="title">—</div>
        <div id="mSummary" class="muted">—</div>

        <div class="specs">
          <div class="muted">規格</div>
          <div id="specBox" class="spec-row"></div>
          <div class="muted">總價</div>
          <div id="mPrice" class="price">¥0</div>
          <div id="ioLine" class="muted" style="font-weight:700;color:#6c4ef7">io$: 0.00000</div>

          <div id="payBox" class="pay" style="display:none">
            <div class="muted" style="margin-bottom:6px">收款碼</div>
            <img id="payImg" src="" alt="收款碼">
          </div>

          <div class="actions">
          <button class="btn" onclick="history.back()" style="color: #b066ff;">Esc Store</button>
          <button class="btn primary" onclick="openOrder()">確認購買</button>
          <button id="favBtn" class="btn" style="background:transparent;font-size:20px;line-height:1">♡</button>
          <button class="btn" onclick="openCModal()">發佈評論</button>
          </div>
        </div>
      </div>
    </div>

    <div id="mDesc" class="desc"></div>
<div id="comments" class="comments" style="display:none">
  <div class="c-head">
    <div>評論</div>
    <div class="muted" id="cCount">0 則</div>
  </div>
  <div id="cList" class="c-list"></div>
  <div class="c-foot">
    <button id="cToggleBtn" class="c-toggle" onclick="openCPanel()">展開全部</button>
  </div>
</div>
    <div style="margin-top:20px">
      <div style="font-weight:800;margin-bottom:8px">此賣家的其他商品</div>
      <div id="sellerProducts" class="grid"></div>
    </div>
  </div>
<!-- 評論展開面板（大匡） -->
<div id="cPanelBackdrop">
  <div id="cPanel" class="c-panel" role="dialog" aria-modal="true" aria-label="全部評論">
    <div class="cp-head">
      <div>全部評論 <span id="cpCount" class="muted" style="font-weight:400"></span></div>
      <div class="cp-close" onclick="closeCPanel()">×</div>
    </div>
    <div id="cpBody" class="cp-body"><!-- 動態塞 full list --></div>
    <div class="cp-foot">
      <button class="c-toggle" onclick="closeCPanel()">收起</button>
    </div>
  </div>
</div>
  <!-- 購買：訂單表單 Modal -->
  <div id="orderDlg" class="backdrop">
    <div class="order">
      <header>
        <div>填寫訂單資料</div>
        <div class="closex" onclick="closeOrder()">×</div>
      </header>
      <div class="body">
        <!-- 固定資訊 -->
        <div class="fix">
          <div class="row">
            <div class="field"><label>商品</label><input id="odTitle" class="input" type="text" disabled></div>
            <div class="field"><label>規格</label><input id="odSpec"  class="input" type="text" disabled></div>
            <div class="field"><label>價格</label><input id="odPrice" class="input" type="text" disabled></div>
            <!-- 新增：IO 號碼 -->
            <div class="field"><label>IO:</label><input id="odIo" class="input" type="text" disabled></div>
          </div>
        </div>

        <hr class="hr">

        <!-- 地址 -->
        <div style="font-weight:800;margin-bottom:6px">收件地址</div>
        <div class="row">
          <div class="field"><label>國家/加地區碼電話（+886、+86…）</label><input id="odCcode" class="input" type="text" placeholder="+886"></div>
          <div class="field"><label>省/州</label><input id="odProv" class="input" type="text" placeholder="省/州"></div>
        </div>
        <div class="row">
          <div class="field"><label>市</label><input id="odCity" class="input" type="text" placeholder="城市"></div>
          <div class="field"><label>縣</label><input id="odDist" class="input" type="text" placeholder="區/縣"></div>
        </div>
        <div class="row">
          <div class="field" style="flex:1 1 100%"><label>詳細地址</label><input id="odAddr" class="input" type="text" placeholder="道路、門牌、樓層…"></div>
        </div>

        <!-- 付款碼 -->
        <div id="odPayWrap" class="paybox" style="margin-top:10px">
          <div class="muted" style="margin-bottom:6px">對應規格的收款碼</div>
          <img id="odPayImg" src="" alt="收款碼" style="max-width:220px;border:1px solid #eee;border-radius:10px;background:#fff">
        </div>

        <!-- 上傳付款截圖 -->
        <div id="odProofWrap" style="display:none; margin-top:12px">
          <label style="display:block; font-size:12px; color:#777; margin-bottom:6px">付款頁面截圖</label>
          <input id="odProof" class="file" type="file" accept="image/*">
          <div class="muted">完成付款後，請上傳截圖做為依據。</div>
        </div>

        <div id="odErr" class="err"></div>
      </div>
      <div class="actions">
        <button class="btn" onclick="closeOrder()">取消</button>
        <button id="btnShowPay" class="btn" onclick="showPayCode()">顯示付款碼</button>
        <button id="btnSubmitOrder" class="btn primary" style="display:none" onclick="submitOrder()">上傳購買</button>
      </div>
    </div>
  </div>
<div id="cModal" class="backdrop" style="display:none">
  <div class="cbox">
    <header>
      <div>發佈評論</div>
      <div class="closex" onclick="closeCModal()">×</div>
    </header>
    <div class="body">
      <div class="field">
        <label>評論內容</label>
        <textarea id="cText" placeholder="說點什麼吧…"></textarea>
      </div>
      <div class="field">
        <label>附加圖片（最多 3 張）</label>
        <input id="cFiles" class="file" type="file" accept="image/*" multiple>
        <div class="muted">上傳後在評論區會顯示為固定小縮圖。</div>
      </div>
      <div id="cErr" class="c-err"></div>
    </div>
    <div class="actions">
      <button class="btn" onclick="closeCModal()">取消</button>
      <button class="btn primary" onclick="submitComment()">送出</button>
    </div>
  </div>
</div>
<script>
const API     = "https://zdqo2eqb.lc-cn-n1-shared.com/1.1";
const APP_ID  = "ZDqo2eQBcSChCfRgwix9jUeI-gzGzoHsz";
const APP_KEY = "U66ybZWAD99LrT9zJnQlW52H";
const CURRENCY_SIGN = '¥';
const IO_TO_CNY = 60;                   // 匯率：1 io$ = ¥60
const fmtIo = n => (Math.round(n*1e5)/1e5).toFixed(5);  // io$ 顯示 5 位小數
// 讀 URL 參數
const pid = new URLSearchParams(location.search).get('id');

// 內嵌預設頭貼（不走外部 URL，避免 SSL 錯誤）
const DEFAULT_AVATAR = 'data:image/svg+xml;utf8,' + encodeURIComponent(
  `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80">
     <rect width="100%" height="100%" rx="40" ry="40" fill="#f3f3f3"/>
     <text x="50%" y="55%" text-anchor="middle" font-size="28">🙂</text>
   </svg>`
);

// 讀商品（帶 include=seller）
async function fetchProduct(id){
  const res = await fetch(`${API}/classes/Product/${id}?include=seller`, {
    headers:{ 'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY }
  });
  if(!res.ok) throw new Error('載入商品失敗');
  return res.json();
}

let PRODUCT=null, chosenIndex=0;
const money = n => Number(n||0).toLocaleString('zh-TW');

function getFileUrl(maybeFile){
  let u = '';
  if(!maybeFile) return '';
  if (typeof maybeFile === 'string') u = maybeFile;
  else if (typeof maybeFile === 'object' && maybeFile.url) u = maybeFile.url;
  if (u && /^http:\/\//i.test(u)) u = u.replace(/^http:\/\//i, 'https://');
  return u;
}
// 可能後端欄位叫不同名字或混有 File 物件/字串
function pickDetailImages(p){
  const cand = [p.detailImages, p.detailImgs, p.detailPics, p.detailPhotos, p.desImages];
  const arr = cand.find(a => Array.isArray(a) && a.length) || [];
  return arr.map(getFileUrl).filter(Boolean);
}

// 只允許 top / bottom；其它值一律當 top
function normalizePos(pos){
  const s = String(pos||'top').toLowerCase();
  if (s.includes('bot') || s.includes('下')) return 'bottom';
  return 'top';
}
// 取得該規格的付款碼網址（同時相容新舊欄位）
function getPayUrl(p, cur){
  // 新欄位（字串）優先
  let url = p.samePrice ? p.commonPayUrl : cur.payCodeUrl;
  // 舊欄位（File 物件 或 字串）後備
  if (!url) url = p.samePrice ? getFileUrl(p.commonPayCode) : getFileUrl(cur.payCode);
  return url || '';
}

function renderGallery(p){

 const imgs = [
   getFileUrl(p.imageUrl),
   ...(Array.isArray(p.images) ? p.images.map(getFileUrl) : [])
 ].filter(Boolean);
  const gMain  = document.getElementById('gMain');
  const gStrip = document.getElementById('gStrip');
  gMain.src = imgs[0] || DEFAULT_AVATAR;
  gStrip.innerHTML = '';
  imgs.forEach(url=>{
    const im = document.createElement('img');
    im.className='g-thumb'; im.src=url; im.alt='縮圖';
    im.onclick=()=>{ gMain.src=url; };
    gStrip.appendChild(im);
  });
}

function renderMeta(p){
  document.getElementById('mTitle').textContent = p.title || '—';
  document.getElementById('mSummary').textContent = p.summary || '';

  const box = document.getElementById('specBox');
  box.innerHTML = '';
  const variants = Array.isArray(p.variants)? p.variants : [];
  variants.forEach((v,idx)=>{
    const chip=document.createElement('button');
    chip.type='button';
    chip.className='chip'+(idx===0?' active':'');
    chip.textContent = p.samePrice ? `${v.name}` : `${v.name}（${CURRENCY_SIGN}${money(v.price)}）`;
    chip.onclick=()=>{
      [...box.querySelectorAll('.chip')].forEach(c=>c.classList.remove('active'));
      chip.classList.add('active'); chosenIndex=idx; updatePriceAndPay();
    };
    box.appendChild(chip);
  });

  // === 詳情：依擺位插圖 ===
function buildDetailHTML(p){
  const desc  = (p.description || '');
  const lines = desc.split(/\r?\n/);
  const imgs  = (p.detailImages || []).map(String);

  const imgsHTML = imgs.map(u => `
    <img src="${u}" alt="">
  `).join('');   // 交給上面的 .desc img CSS 控制寬高

  const lineHTML = lines.map(s => `<p>${s || '&nbsp;'}</p>`).join('');
  const pos = String(p.detailImagePos || 'top').toLowerCase();

  if (pos.includes('bottom')) return lineHTML + imgsHTML;
  return imgsHTML + lineHTML; // 預設 top
}

// 取代你原本的三行
document.getElementById('mDesc').innerHTML = buildDetailHTML(p);
console.log({
  detailImagePos:p.detailImagePos,
  detailImageAfterLine:p.detailImageAfterLine,
  pickedImages: pickDetailImages(p)
});
  updatePriceAndPay();
}

/* === 付款碼偵錯面板 === */
function updatePayDebug(){
  let box = document.getElementById('payDebug');
  if(!box){
    box = document.createElement('pre');
    box.id = 'payDebug';
    box.style.cssText = 'margin-top:10px;font:12px ui-monospace,monospace;background:#fff;border:1px dashed #ddd;border-radius:8px;padding:8px;white-space:pre-wrap;color:#444';
    document.querySelector('.meta').appendChild(box);
  }
  const p   = PRODUCT || {};
  const cur = (p.variants||[])[chosenIndex] || {};
  const payUrl = getPayUrl(p, cur);

  box.textContent =
    '[samePrice] ' + JSON.stringify(p.samePrice) + '\n' +
    '[commonPayUrl] ' + JSON.stringify(p.commonPayUrl) + '\n' +
    '[commonPayCode raw] ' + JSON.stringify(p.commonPayCode) + '\n' +
    '[variant.payCodeUrl] ' + JSON.stringify(cur.payCodeUrl) + '\n' +
    '[variant.payCode raw] ' + JSON.stringify(cur.payCode) + '\n' +
    '[computed payUrl] ' + payUrl;
}

/* === 計價 & 顯示付款碼 === */
function updatePriceAndPay(){
  const p = PRODUCT, cur = (p.variants||[])[chosenIndex] || {};
  const price = p.samePrice ? p.price : cur.price;

  // 顯示人民幣
  document.getElementById('mPrice').textContent = CURRENCY_SIGN + money(price);

  // **顯示 io$（依規格變動）**
  const ioAmount = price / IO_TO_CNY;
  const ioEl = document.getElementById('ioLine');
  if (ioEl) ioEl.textContent = 'io$: ' + fmtIo(ioAmount);

  // 不在詳情頁顯示收款碼
  const payBox = document.getElementById('payBox');
  if (payBox) payBox.style.display = 'none';

  // **如果不需要那個字母偵錯區，註解掉下一行**
  // updatePayDebug && updatePayDebug();
}

// 只顯示頭貼＋暱稱（修正：強制 https）
function renderSellerBar(seller){
  const bar  = document.getElementById('sellerBar');
  const img  = document.getElementById('sellerAvatar');
  const name = document.getElementById('sellerName');
  const avatarRaw = seller.avatarUrl || '';
  const avatar = avatarRaw ? avatarRaw.replace(/^http:\/\//, 'https://') : '';
  img.src = avatar || ('data:image/svg+xml;utf8,' + encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80">
      <rect width="100%" height="100%" rx="40" ry="40" fill="#f3f3f3"/>
      <text x="50%" y="55%" text-anchor="middle" font-size="28">🙂</text>
    </svg>`
  ));
  name.textContent = seller.nickname || seller.username || '賣家';

  bar.onclick = ()=>{
    const me = JSON.parse(localStorage.getItem('sg_user')||'null');
    if(me && seller.objectId && me.objectId===seller.objectId){
      location.href='user.html';
    }else if(seller.objectId){
      location.href=`seller.html?uid=${seller.objectId}`;
    }
  };
  bar.style.display='flex';
}

// 其他商品
async function fetchSellerProducts(uid, currentId){
  const where = encodeURIComponent(JSON.stringify({
    seller:{ "__type":"Pointer","className":"_User","objectId":uid },
    objectId:{ "$ne": currentId }
  }));
  const res = await fetch(`${API}/classes/Product?where=${where}&limit=12&order=-createdAt`, {
    headers:{ 'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY }
  });
  const data = await res.json();
  if(res.ok) renderSellerProducts(data.results||[]);
}
function renderSellerProducts(list){
  const box=document.getElementById('sellerProducts');
  if(!list.length){ box.innerHTML=`<div class="muted">暫無其他商品</div>`; return; }
  box.innerHTML='';
  list.forEach(p=>{
    const a=document.createElement('a');
    a.className='card'; a.href=`shuser.html?id=${p.objectId}`;
    const cover = getFileUrl(p.imageUrl) || (Array.isArray(p.images) ? getFileUrl(p.images[0]) : '');
    const img = cover || DEFAULT_AVATAR;
    const price=p.samePrice ? p.price : ((p.variants&&p.variants[0])?p.variants[0].price:0);
    a.innerHTML=`<img src="${img}" alt="">
      <div class="cbody">
        <div style="font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.title||'未命名'}</div>
        <div style="color:#e91e63;font-weight:800">${CURRENCY_SIGN}${money(price)}</div>
      </div>`;
    box.appendChild(a);
  });
}

/* ===== 購買流程 ===== */
function openOrder(){
  const me = JSON.parse(localStorage.getItem('sg_user')||'null');
  if(!me){ alert('請先登入再購買'); return; }

  const p=PRODUCT, cur=(p.variants||[])[chosenIndex]||{};
  const price = p.samePrice ? p.price : cur.price;

  document.getElementById('odTitle').value = p.title || '';
  document.getElementById('odSpec').value  = cur.name || (p.samePrice ? '(同價)' : '');
  document.getElementById('odPrice').value = CURRENCY_SIGN + money(price);

  // 重置區塊
  document.getElementById('odCcode').value = '';
  document.getElementById('odProv').value  = '';
  document.getElementById('odCity').value  = '';
  document.getElementById('odDist').value  = '';
  document.getElementById('odAddr').value  = '';
  document.getElementById('odProof').value = '';
  document.getElementById('odErr').textContent = '';
  document.getElementById('odPayWrap').style.display   = 'none';
  document.getElementById('odProofWrap').style.display = 'none';
  document.getElementById('btnSubmitOrder').style.display = 'none';
  document.getElementById('btnShowPay').style.display    = 'inline-block';

  document.getElementById('orderDlg').style.display='flex';
  ORDER_IO = generateIo();
  document.getElementById('odIo').value = ORDER_IO;
}
function closeOrder(){ document.getElementById('orderDlg').style.display='none'; }

// 第一步：顯示對應規格的付款碼，並開啟上傳區
function showPayCode(){
  const p=PRODUCT, cur=(p.variants||[])[chosenIndex]||{};
  const payUrl = getPayUrl(p, cur);  // ✅ 只在彈窗取出對應收款碼

  if(!payUrl){
    document.getElementById('odErr').textContent='此規格暫無付款碼，請聯絡賣家';
    return;
  }

  document.getElementById('odPayImg').src = payUrl;
  document.getElementById('odPayWrap').style.display='block';
  document.getElementById('odProofWrap').style.display='block';
  document.getElementById('btnSubmitOrder').style.display='inline-block';
  document.getElementById('btnShowPay').style.display='none';
}

// 工具：檔案轉 base64 & 上傳到 /files → 回 URL
function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result.split(',')[1]);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}
async function uploadOne(file){
  const base64 = await fileToBase64(file);
  const r = await fetch(`${API}/files/${encodeURIComponent(file.name)}`,{
    method:'POST',
    headers:{'Content-Type':'application/json','X-LC-Id':APP_ID,'X-LC-Key':APP_KEY},
    body: JSON.stringify({ base64 })
  });
  const data = await r.json();
  if(!r.ok) throw new Error(data.error || '檔案上傳失敗');
  return data.url;
}

// 第二步：送出「購買」訊息到 Message 類別
async function createOrder({ p, cur, me, price, address, proofUrl }){
  const token = localStorage.getItem('sg_token');

  for(let attempt=0; attempt<3; attempt++){
    const orderPayload = {
      product: { "__type":"Pointer", "className":"Product", "objectId": p.objectId },
      seller:  { "__type":"Pointer", "className":"_User",   "objectId": p.seller.objectId },
      buyer:   { "__type":"Pointer", "className":"_User",   "objectId": me.objectId },
      productTitle: p.title || '',
      variantName:  cur.name || '',
      price:      Number(price) || 0,
      unitPrice:  Number(price) || 0,
      quantity:   1,
      totalPrice: Number(price) || 0,
      currency:   p.currency || 'CN¥',
      address,
      payProofUrl: proofUrl,
      status: 'submitted',
      // ★ 新增：io 號碼（每筆唯一）
      io: ORDER_IO || generateIo()
    };

    const res = await fetch(`${API}/classes/Order`,{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-LC-Id': APP_ID,
        'X-LC-Key': APP_KEY,
        'X-LC-Session': token
      },
      body: JSON.stringify(orderPayload)
    });
    const data = await res.json();

    // 成功
    if(res.ok) return data.objectId;

    // 若是 io 重複，換一個 io 重試（最多 3 次）
    if(data && typeof data.error === 'string' && /duplicate value/i.test(data.error)){
      ORDER_IO = generateIo();
      continue;
    }
    // 其他錯誤直接丟出
    throw new Error(data.error || '建立訂單失敗（請檢查 Order 類別的 Create 權限）');
  }

  throw new Error('建立訂單失敗（io 產生重試次數耗盡）');
}

// 取代你原本的 submitOrder()
async function submitOrder(){
  const me   = JSON.parse(localStorage.getItem('sg_user')||'null');
  const token= localStorage.getItem('sg_token');
  if(!me || !token){ alert('請先登入'); return; }

  const p=PRODUCT, cur=(p.variants||[])[chosenIndex]||{};
  const price = p.samePrice ? p.price : cur.price;

  // 地址檢查
  const ccode = document.getElementById('odCcode').value.trim();
  const prov  = document.getElementById('odProv').value.trim();
  const city  = document.getElementById('odCity').value.trim();
  const dist  = document.getElementById('odDist').value.trim();
  const addr  = document.getElementById('odAddr').value.trim();
  if(!ccode || !prov || !city || !dist || !addr){
    document.getElementById('odErr').textContent = '請填寫完整地址欄位';
    return;
  }
  const address = { countryCode: ccode, province: prov, city, district: dist, detail: addr };

  // 必須有付款截圖
  const proofFile = document.getElementById('odProof').files[0];
  if(!proofFile){
    document.getElementById('odErr').textContent = '請上傳付款頁面截圖';
    return;
  }

  try{
    // 1) 上傳付款截圖
    const proofUrl = await uploadOne(proofFile);

    // 2) 先建立 Order 物件
    const orderId = await createOrder({
      p, cur, me, price, address, proofUrl
    });

    // 3) 再建立 Message，order 欄位放 Pointer
    const payload = {
      kind: 'order',
      text: `訂單提交：${p.title} / ${cur.name||'(同價)'} / ${CURRENCY_SIGN}${money(price)}`,
body: `訂單提交：${p.title} / ${cur.name||'(同價)'} / ${CURRENCY_SIGN}${money(price)}`,
      from: { "__type":"Pointer", "className":"_User", "objectId": me.objectId },
      to:   { "__type":"Pointer", "className":"_User", "objectId": p.seller.objectId },
      product: { "__type":"Pointer", "className":"Product", "objectId": p.objectId },

      // <<< 關鍵：Pointer 到剛剛建立的 Order >>>
      order: { "__type":"Pointer", "className":"Order", "objectId": orderId },

      // 若你還想保留 data 舊欄位也可以（非必須）
      data: {
        productId: p.objectId,
        productTitle: p.title,
        variantName: cur.name || '',
        price: price,
        address,
        payProofUrl: proofUrl,
        io: ORDER_IO
      },

      ACL: {
        "*": { "read": false },
        [me.objectId]: { "read": true, "write": true },
        [p.seller.objectId]: { "read": true, "write": false }
      }
    };

    const res = await fetch(`${API}/classes/Message`,{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-LC-Id': APP_ID,
        'X-LC-Key': APP_KEY,
        'X-LC-Session': token
      },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || '送出失敗，請稍後重試');

    closeOrder();
    alert('✅ 已送出購買資訊，商家將在訊息中與你聯絡。');
  }catch(e){
    document.getElementById('odErr').textContent = e.message || '送出失敗';
  }
}

function confirmBuy(){ openOrder(); }
let ORDER_IO = ''; // 這筆下單暫存的 io

function pad2(n){ return String(n).padStart(2,'0'); }
function generateIo(){
  const d = new Date();
  const stamp = `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}-${pad2(d.getHours())}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`;
  const rand  = Math.random().toString().slice(2,8); // 6 位隨機數字
  return `${stamp}-${rand}`;
}
// 啟動
(async ()=>{
  if(!pid){ alert('缺少商品 id'); history.back(); return; }
  try{
    const p = await fetchProduct(pid);
    PRODUCT = p;

    renderGallery(p);
    renderMeta(p);

    if(p.seller && p.seller.objectId){
      renderSellerBar(p.seller);
      if(!p.seller.nickname && !p.seller.avatarUrl){
        try{
          const r = await fetch(`${API}/users/${p.seller.objectId}`, {
            headers:{ 'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY }
          });
          if(r.ok){ renderSellerBar(await r.json()); }
        }catch(e){}
      }
      fetchSellerProducts(p.seller.objectId, p.objectId);
    }else{
      renderSellerBar({ nickname: '（本商品缺少賣家指標）', avatarUrl: '' });
    }
  }catch(e){
    console.error(e);
    alert(e.message || '載入失敗');
  }
})();
function goBack(){
  if (document.referrer && document.referrer.indexOf(location.origin) === 0) {
    // 有上一頁，並且同一個網站
    history.back();
  } else {
    // 沒有 referrer，或從外部連進來 → 預設回首頁
    location.href = 'shopping.html';
  }
}
// ====== 收藏 Favorite（LeanCloud 後端版）======
// 需要：sg_user（含 objectId）、sg_token（Session）已存在 localStorage；pid 為當前商品 id
const favBtn = document.getElementById('favBtn');

function getMe(){
  return JSON.parse(localStorage.getItem('sg_user')||'null');
}

// 查詢是否已收藏（回傳 Favorite 的 objectId，沒有則 null）
async function findFavoriteId(pid){
  const me = getMe(); if(!me) return null;
  const where = encodeURIComponent(JSON.stringify({
    user:    { "__type":"Pointer","className":"_User","objectId": me.objectId },
    product: { "__type":"Pointer","className":"Product","objectId": pid }
  }));
  const res = await fetch(`${API}/classes/Favorite?where=${where}&limit=1`, {
    headers:{
      'X-LC-Id': APP_ID,
      'X-LC-Key': APP_KEY,
      'X-LC-Session': localStorage.getItem('sg_token')||''
    }
  });
  const data = await res.json();
  if(!res.ok) return null;
  return (data.results && data.results[0] && data.results[0].objectId) || null;
}

// 建立收藏
async function createFavorite(pid){
  const me = getMe(); if(!me){ alert('請先登入再收藏'); return null; }
  const payload = {
    user:    { "__type":"Pointer","className":"_User","objectId": me.objectId },
    product: { "__type":"Pointer","className":"Product","objectId": pid },
    // 建議：每筆物件設 ACL，只允許本人讀寫
    ACL: {
      "*": { "read": false },
      [me.objectId]: { "read": true, "write": true }
    }
  };
  const res = await fetch(`${API}/classes/Favorite`,{
    method:'POST',
    headers:{
      'Content-Type': 'application/json',
      'X-LC-Id': APP_ID,
      'X-LC-Key': APP_KEY,
      'X-LC-Session': localStorage.getItem('sg_token')||''
    },
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if(!res.ok){ alert(data.error || '收藏失敗'); return null; }
  return data.objectId;
}

// 取消收藏
async function deleteFavorite(favId){
  const res = await fetch(`${API}/classes/Favorite/${favId}`,{
    method:'DELETE',
    headers:{
      'X-LC-Id': APP_ID,
      'X-LC-Key': APP_KEY,
      'X-LC-Session': localStorage.getItem('sg_token')||''
    }
  });
  if(!res.ok){
    const d = await res.json().catch(()=>({}));
    alert(d.error || '取消收藏失敗');
    return false;
  }
  return true;
}

// 刷新按鈕外觀
async function refreshFavBtn(){
  const id = await findFavoriteId(pid);
  favBtn.dataset.favId = id || '';
  if(id){
    favBtn.classList.add('faved');
    favBtn.textContent = '♥';        // 已收藏
  }else{
    favBtn.classList.remove('faved');
    favBtn.textContent = '♡';        // 未收藏
  }
}

// 點擊切換收藏
favBtn.addEventListener('click', async ()=>{
  const me = getMe(); if(!me){ alert('請先登入再收藏'); return; }
  const currentId = favBtn.dataset.favId || '';
  if(currentId){
    const ok = await deleteFavorite(currentId);
    if(ok) await refreshFavBtn();
  }else{
    const id = await createFavorite(pid);
    if(id) await refreshFavBtn();
  }
});

// 進頁初始化（放在 DOM 準備好後呼叫即可）
refreshFavBtn();
/* === 圖片左右切換（不改 HTML） === */
let G_IMAGES = [], gIndex = 0;

function setMain(i){
  if(!G_IMAGES.length) return;
  gIndex = (i + G_IMAGES.length) % G_IMAGES.length;      // 環狀
  document.getElementById('gMain').src = G_IMAGES[gIndex];
  // 縮圖 active 狀態
  const thumbs = document.querySelectorAll('#gStrip .g-thumb');
  thumbs.forEach((t,idx)=> t.style.outline = (idx===gIndex)?'2px solid var(--brand)':'none');
}
function stepGallery(delta){ setMain(gIndex + delta); }

/* 改寫 renderGallery：建立箭頭、縮圖點擊同步索引 */
const _renderGallery_orig = renderGallery;
renderGallery = function(p){
  // 1) 蒐集所有圖片
  const imgs = [
    getFileUrl(p.imageUrl),
    ...(Array.isArray(p.images) ? p.images.map(getFileUrl) : [])
  ].filter(Boolean);
   G_IMAGES = imgs.slice(); gIndex = 0;

  // 2) 原本行為
  const gMain  = document.getElementById('gMain');
  const gStrip = document.getElementById('gStrip');
  gStrip.innerHTML = '';
  imgs.forEach((url,idx)=>{
    const im = document.createElement('img');
    im.className='g-thumb'; im.src=url; im.alt='縮圖';
    im.onclick=()=> setMain(idx);
    gStrip.appendChild(im);
  });

  // 3) 放上左右箭頭（只建立一次）
  const wrap = document.querySelector('.gallery');
  wrap.setAttribute('data-count', String(imgs.length || 0));
  if(!wrap.querySelector('.g-nav')){
    const nav = document.createElement('div');
    nav.className = 'g-nav';
    nav.innerHTML = `
      <div class="g-arrow g-arrow-left"  aria-label="上一張">‹</div>
      <div class="g-arrow g-arrow-right" aria-label="下一張">›</div>`;
    wrap.appendChild(nav);
    nav.querySelector('.g-arrow-left').addEventListener('click',  e=>{ e.stopPropagation(); stepGallery(-1); });
    nav.querySelector('.g-arrow-right').addEventListener('click', e=>{ e.stopPropagation(); stepGallery(+1); });
  }

  // 4) 設定第一張
  setMain(0);
};
/* ===== 評論：設定 ===== */
const C_PAGE_LIMIT = 100;            // 一次抓幾則（展開時）
const C_COLLAPSED_SHOW = 1;//展示
let C_ALL = [];
function renderCommentsPreview(){                 // ← 小匡只畫前 2 則
  const box = document.getElementById('comments');
  const list = document.getElementById('cList');
  list.innerHTML = '';
  (C_ALL.slice(0, C_COLLAPSED_SHOW)).forEach(c => list.appendChild(renderOneComment(c, /*ownCheck*/true)));
  document.getElementById('cCount').textContent = `${C_ALL.length} 則`;
  box.style.display = 'block';
  requestAnimationFrame(()=>{ box.classList.remove('anim-hide'); box.classList.add('anim-show'); });
}          // 摺疊預覽幾則
let C_FULL_OPEN = false;             // 當前是否展開

// 你可在控制台先建空類（也可程式第一次寫入自動建）
// === 小匡：只顯示前 C_COLLAPSED_SHOW 則（你已經有 renderCommentsPreview，可保留你那版）

// === 共用：渲染單一評論（ownCheck=true 時，自己的會出現刪除鈕）
function renderOneComment(c, ownCheck){
  const u = c.user || {};
  const me = JSON.parse(localStorage.getItem('sg_user')||'null');
  const isOwn = !!(ownCheck && me && u && (u.objectId === me.objectId));

  const avatar = (u.avatarUrl||'').replace(/^http:\/\//,'https://') || 'https://via.placeholder.com/60?text=%F0%9F%98%8A';
  const name = u.nickname || u.username || '用戶';
  const time = fmtTime(c.createdAt);
  const text = escapeHTML(c.text || '');
  const photos = Array.isArray(c.photos) ? c.photos : [];

  const wrap = document.createElement('div');
  wrap.className = 'c-item' + (isOwn ? ' own' : '');
  wrap.innerHTML = `
    <img class="c-avatar" src="${avatar}" alt="">
    <div class="c-body">
      <div class="c-meta">
        <span class="c-name">${escapeHTML(name)}</span>
        <span class="c-time">${time}</span>
      </div>
      <div class="c-text">${text}</div>
      ${photos.length ? `<div class="c-photos">${photos.map(u=>`<img class="c-photo" src="${u}" alt="">`).join('')}</div>` : ''}
    </div>
    ${isOwn ? `<button class="c-del" onclick="deleteComment('${c.objectId}', this)">刪除</button>` : '' }
  `;
  return wrap;
}

// === 大匡控制 ===
function isPanelOpen(){
  return document.getElementById('cPanelBackdrop').classList.contains('show');
}

function rebuildFullList(){
  const body = document.getElementById('cpBody');
  body.innerHTML = '';
  C_ALL.forEach(c => body.appendChild(renderOneComment(c, true)));
  document.getElementById('cpCount').textContent = `（${C_ALL.length} 則）`;
}

function openCPanel(){
  rebuildFullList();
  const bd = document.getElementById('cPanelBackdrop');
  const panel = document.getElementById('cPanel');
  bd.classList.add('show');
  // 用 rAF 觸發過渡
  requestAnimationFrame(()=>{
    bd.classList.add('visible');
    panel.classList.add('enter');
  });
  // 點灰色背景就關
  bd.addEventListener('click', onBackdropClick);
  // ESC 關閉
  document.addEventListener('keydown', onEscClose);
}

function closeCPanel(){
  const bd = document.getElementById('cPanelBackdrop');
  const panel = document.getElementById('cPanel');
  bd.classList.remove('visible');
  panel.classList.remove('enter');
  // 等動畫結束再把 display:none 拿掉
  setTimeout(()=>{ bd.classList.remove('show'); }, 220);
  bd.removeEventListener('click', onBackdropClick);
  document.removeEventListener('keydown', onEscClose);
}

function onBackdropClick(e){
  // 只在點到「灰底」時關閉；點到面板本體不關
  if(e.target && e.target.id === 'cPanelBackdrop') closeCPanel();
}

function onEscClose(e){
  if(e.key === 'Escape') closeCPanel();
}

// === 刪除（後端真刪，LeanCloud 依 ACL 限制只有作者能刪）
async function deleteComment(id, btn){
  const token = localStorage.getItem('sg_token')||'';
  if(!token){ alert('請先登入'); return; }
  if(!confirm('確定要刪除這則評論？')) return;

  const item = btn.closest('.c-item');
  // 先做一個「靈動」退場
  item.style.transition = 'opacity .16s ease, transform .18s ease';
  item.style.opacity = '.0';
  item.style.transform = 'scale(.98)';

  try{
    const r = await fetch(`${API}/classes/Comment/${id}`,{
      method:'DELETE',
      headers:{ 'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY, 'X-LC-Session': token }
    });
    if(!r.ok){
      const d = await r.json().catch(()=>({}));
      throw new Error(d.error || '刪除失敗');
    }
    // 從快取移除並刷新
    C_ALL = C_ALL.filter(x => x.objectId !== id);
    renderCommentsPreview();
    if (isPanelOpen()) rebuildFullList();
  }catch(e){
    // 還原動效
    item.style.opacity = '1';
    item.style.transform = 'none';
    alert(e.message || '刪除失敗');
  }
}
/* ===== 小工具 ===== */
function fmtTime(iso){
  const d = new Date(iso);
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  const hh=String(d.getHours()).padStart(2,'0'), mi=String(d.getMinutes()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
}
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

async function uploadManyC(fileList, limit=3){
  const files = Array.from(fileList||[]).slice(0, limit);
  const urls=[];
  for(const f of files){
    // 圖片可適度壓小（省流）→ 如需客端壓縮可再加，這裡先直接上傳
    const base64 = await fileToBase64(f);
    const r = await fetch(`${API}/files/${encodeURIComponent(f.name)}`,{
      method:'POST',
      headers:{ 'Content-Type':'application/json','X-LC-Id':APP_ID,'X-LC-Key':APP_KEY },
      body: JSON.stringify({ base64 })
    });
    const d = await r.json();
    if(!r.ok) throw new Error(d.error||'圖片上傳失敗');
    urls.push(d.url);
  }
  return urls;
}

/* ===== 讀取 & 渲染 ===== */
async function loadComments(){
  try{
    const where = encodeURIComponent(JSON.stringify({
      product: { "__type":"Pointer","className":"Product","objectId": pid }
    }));
    // include=user 取頭貼/暱稱
    const res = await fetch(`${API}/classes/Comment?where=${where}&order=-createdAt&limit=${C_PAGE_LIMIT}&include=user`,{
      headers:{ 'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY }
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error||'讀取評論失敗');

    C_ALL = data.results || [];
document.getElementById('cCount').textContent = `${C_ALL.length} 則`;
renderCommentsPreview();          // ← 換這行
document.getElementById('comments').style.display = 'block';
  }catch(e){
    console.warn(e);
    document.getElementById('comments').style.display = 'block';
  }
}

function renderComments(){
  const list = document.getElementById('cList');
  list.innerHTML = '';
  const showing = C_FULL_OPEN ? C_ALL : C_ALL.slice(0, C_COLLAPSED_SHOW);

  showing.forEach(c=>{
    const u = c.user || {};
    const avatar = (u.avatarUrl||'').replace(/^http:\/\//,'https://') || 'https://via.placeholder.com/60?text=%F0%9F%98%8A';
    const name = u.nickname || u.username || '用戶';
    const time = fmtTime(c.createdAt);
    const text = escapeHTML(c.text || '');
    const photos = Array.isArray(c.photos) ? c.photos : [];

    const item = document.createElement('div');
    item.className = 'c-item';
    item.innerHTML = `
      <img class="c-avatar" src="${avatar}" alt="">
      <div class="c-body">
        <div class="c-meta">
          <span class="c-name">${escapeHTML(name)}</span>
          <span class="c-time">${time}</span>
        </div>
        <div class="c-text">${text}</div>
        ${photos.length ? `<div class="c-photos">${photos.map(u=>`<img class="c-photo" src="${u}" alt="">`).join('')}</div>` : ''}
      </div>`;
    list.appendChild(item);
  });

  const btn = document.getElementById('cToggleBtn');
  if (C_ALL.length <= C_COLLAPSED_SHOW){
    btn.style.display = 'none';
  }else{
    btn.style.display = 'inline-block';
    btn.textContent = C_FULL_OPEN ? '收起' : '展開全部';
  }
}

function toggleComments(){
  C_FULL_OPEN = !C_FULL_OPEN;
  renderComments();
}

/* ===== 發佈評論：開關 Modal ===== */
function openCModal(){
  const me = JSON.parse(localStorage.getItem('sg_user')||'null');
  if(!me){ alert('請先登入再發佈評論'); return; }
  document.getElementById('cErr').textContent='';
  document.getElementById('cText').value='';
  document.getElementById('cFiles').value='';
  document.getElementById('cModal').style.display='flex';
}
function closeCModal(){ document.getElementById('cModal').style.display='none'; }

/* ===== 發佈評論：送出 ===== */
async function submitComment(){
  const me = JSON.parse(localStorage.getItem('sg_user')||'null');
  const token = localStorage.getItem('sg_token')||'';
  if(!me || !token){ alert('請先登入'); return; }

  const text = (document.getElementById('cText').value||'').trim();
  const files = document.getElementById('cFiles').files;
  const errEl = document.getElementById('cErr');

  if(!text && (!files || !files.length)){
    errEl.textContent = '請輸入評論內容或上傳圖片（擇一即可）';
    return;
  }
  errEl.textContent = '';

  try{
    // 1) 上傳圖片（最多 3）
    const photos = await uploadManyC(files, 3);

    // 2) 建立 Comment
    const payload = {
      product: { "__type":"Pointer","className":"Product","objectId": pid },
      user:    { "__type":"Pointer","className":"_User","objectId": me.objectId },
      text,
      photos,
      ACL: { "*": { "read": true }, [me.objectId]: { "read": true, "write": true } }
    };
    const res = await fetch(`${API}/classes/Comment`,{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY,
        'X-LC-Session': token
      },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error||'發佈失敗');

    // 3) 關閉、刷新
    closeCModal();
    await loadComments();
    // 預設顯示最新在最上方
    C_FULL_OPEN = false;
renderCommentsPreview();
if (isPanelOpen()) rebuildFullList();
  }catch(e){
    errEl.textContent = e.message || '發佈失敗';
  }
}

/* 啟動時順便載入評論 */
loadComments();
</script>
<script src="im.js"></script>
<script src="lioc.js?v=0.1.1"></script>
<!--=================-->
<p style="text-align: center; font-size: 13px; color: #999; margin-top: 40px;">
  🐾 © 2024 yinnlim的小宇宙｜內容與設計皆由糖糖本人用愛製作 💞<br>
  未經授權請勿隨意使用、盜轉喔 🙅‍♀️ 謝謝你的尊重與溫柔 💌
</p>
</body>
</html>