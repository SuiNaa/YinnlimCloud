<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>å•†å“è©³æƒ…</title>
<style>
  :root{ --brand:#6c4ef7; --muted:#777; --accent:#e91e63; }
  *{box-sizing:border-box}
  body{
  margin:0;
  font-family:"DFKai-SB","KaiTi","æ¨™æ¥·é«”","BiauKai",serif;
  background:#fafafa;
  color:#222;
}
  .wrap{max-width:980px;margin:0 auto;padding:18px 14px 48px;}
  .top{display:flex;gap:18px;flex-wrap:wrap;}
  .gallery{flex:1 1 360px;background:#fff;border:1px solid #eee;border-radius:14px;overflow:hidden}
  .g-main{width:100%;aspect-ratio:1/1;object-fit:cover;background:#f3f3f3;display:block}
  .g-strip{display:flex;gap:8px;padding:8px;overflow:auto;border-top:1px solid #eee;background:#fff}
  .g-thumb{width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid #eee;cursor:pointer}
  .meta{flex:1 1 420px;background:#fff;border:1px solid #eee;border-radius:14px;padding:14px}
  .seller-bar{display:flex;align-items:center;gap:10px;padding:8px 0;cursor:pointer}
  .seller-bar img{width:40px;height:40px;border-radius:50%;object-fit:cover;border:1px solid #eee}
  .title{font-size:22px;font-weight:800;margin-bottom:6px}
  .muted{color:var(--muted)}
  .price{color:var(--accent);font-size:20px;font-weight:900}
  .specs{margin:12px 0;display:flex;flex-direction:column;gap:10px}
  .spec-row{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid #ddd;border-radius:999px;padding:8px 12px;cursor:pointer;background:#fff}
  .chip.active{border-color:var(--brand);box-shadow:0 0 0 3px rgba(108,78,247,.15)}
  .pay{margin-top:10px}
  .pay img{max-width:220px;border:1px solid #eee;border-radius:10px;background:#fff}
  .desc{margin-top:16px;
    background:#fff;
    border:1px solid #eee;
    border-radius:14px;
    padding:14px;
    line-height:1.7;
    white-space: pre-wrap;   /* ä¿ç•™ç©ºæ ¼ & æ›è¡Œ */
    word-wrap: break-word;   /* é•·å­—ä¹Ÿèƒ½æ›è¡Œ */
    line-height: 1.7;
  }
  .btn{padding:12px 16px;border-radius:12px;border:1px solid #ddd;background:#fff;font-weight:800;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
  .actions{margin-top:14px;display:flex;gap:10px}
  .back{display:inline-block;margin-bottom:12px;color:var(--brand);text-decoration:none;font-weight:700}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px}
  .card{display:block;border:1px solid #eee;border-radius:10px;overflow:hidden;text-decoration:none;color:inherit;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  .card img{width:100%;height:120px;object-fit:cover;background:#f3f3f3}
  .card .cbody{padding:8px}
  /* è®“å½ˆçª—æœ¬é«”å¯ç›´å‘æ²å‹•ï¼Œé™åˆ¶åœ¨è¦–çª—é«˜åº¦å…§ */
.order{
  width:min(640px, 92vw);
  background:#fff;
  border-radius:16px;
  border:1px solid #eee;
  box-shadow:0 16px 40px rgba(0,0,0,.18);
  max-height:92vh;          /* â† æœ€é«˜ä¸è¶…éè¦–çª—é«˜åº¦ */
  overflow:auto;            /* â† å…§å®¹å¯æ²å‹• */
}

/* è®“æ¨™é¡Œåˆ—å›ºå®šåœ¨é ‚ç«¯ */
.order header{
  position: sticky;
  top: 0;
  background:#fff;
  z-index: 2;
  padding:14px 16px;
  font-weight:800;
  border-bottom:1px solid #eee;
  display:flex; justify-content:space-between; align-items:center;
}

/* è®“åº•éƒ¨æŒ‰éˆ•å›ºå®šåœ¨åº•éƒ¨ */
.order .actions{
  position: sticky;
  bottom: 0;
  background:#fff;
  z-index: 2;
  border-top:1px solid #eee;
  padding:10px 16px;
  display:flex; gap:10px; justify-content:flex-end;
}
.order .body{
  -webkit-overflow-scrolling: touch;
}

/* ï¼ˆå¯é¸ï¼‰è®“èƒŒæ™¯ä¸è·Ÿè‘—æ² */
.backdrop{
  position:fixed; inset:0;
  background:rgba(0,0,0,.35);
  display:none; align-items:center; justify-content:center;
  padding:16px;
}
  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .field{ flex:1 1 180px; }
  .field label{ display:block; font-size:12px; color:#777; margin-bottom:6px; }
  .input, .select, .file{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #ddd; outline:none; }
  .order .muted{ color:#777; font-size:12px; }
  .closex{ cursor:pointer; font-size:22px; line-height:1; color:#888;}
  .hr{ border:none; border-top:1px solid #eee; margin:12px 0; }
  .fix{ background:#fafafa; border:1px dashed #e7e7e7; border-radius:12px; padding:10px 12px; }
  .paybox{ display:none; padding:10px 12px; border:1px solid #eee; border-radius:12px; }
  .err{ color:#b00020; font-size:13px; margin-top:6px; }
  #favBtn.faved {
  color: #ff2ef5;   /* è¢å…‰ç²‰ */
  text-shadow: 0 0 6px #ff9df7;
}

/* === èˆ‡é¦–é ä¸€è‡´çš„å¤œé–“ä¸»é¡Œè®Šæ•¸ === */
:root[data-theme="dark"]{
  --glass-bg: rgba(20,16,34,.65);
  --glass-border: rgba(163,143,255,.14);

  --text:#cfc3ff;          /* å…¨ç«™æ–‡å­—ï¼ˆç´«å¤–ç·šæ„Ÿï¼‰ */
  --muted:#9a8fd1;         /* æ¬¡è¦æ–‡å­— */
  --brand:#a48cff;         /* å“ç‰Œç´« */
  --accent:#bf66ff;        /* åƒ¹æ ¼/é‡é»è‰² */

  --card-bg:#161222;       /* å¡ç‰‡/ä¸‹æ‹‰/è¼¸å…¥åº•è‰² */
  --card-border:#2b2440;   /* å¡ç‰‡é‚Šæ¡† */
  --page-bg:#0f0b1a;       /* é é¢åº•è‰² */

  --btn-bg:#1b1629;
  --btn-border:#2b2440;
  --btn-text:#cfc3ff;

  --chip-bg:#1b1629;
  --chip-border:#2b2440;

  --shadow: 0 10px 28px rgba(0,0,0,.45);
}

/* å…¨é åº•è‰² & æ–‡å­— */
:root[data-theme="dark"] body{
  background:var(--page-bg);
  color:var(--text);
  font-family:"DFKai-SB","KaiTi","æ¨™æ¥·é«”","BiauKai",serif;
}

/* è¿”å›é€£çµï¼ˆâ† è¿”å›ï¼‰ */
:root[data-theme="dark"] .back{ color:var(--brand); }
.back{ text-decoration:none; }

/* å€å¡Š/å¡ç‰‡åº•è‰²èˆ‡é‚Šæ¡† */
:root[data-theme="dark"] .gallery,
:root[data-theme="dark"] .meta,
:root[data-theme="dark"] .desc,
:root[data-theme="dark"] .card{
  background:var(--card-bg);
  border:1px solid var(--card-border);
  box-shadow:var(--shadow);
  color:var(--text);
}

/* ç¸®åœ–/ä¸»åœ–é ç•™åº•è‰² */
:root[data-theme="dark"] .g-main,
:root[data-theme="dark"] .card img{
  background:#1e1930;
}

/* æ¬¡è¦å­—ã€åƒ¹æ ¼ã€æ¨™é¡Œ */
:root[data-theme="dark"] .muted{ color:var(--muted); }
:root[data-theme="dark"] .price{ color:var(--accent); }
:root[data-theme="dark"] .title{ color:var(--text); }

/* è¦æ ¼ chip */
:root[data-theme="dark"] .chip{
  background:var(--chip-bg);
  border:1px solid var(--chip-border);
  color:var(--text);
}
:root[data-theme="dark"] .chip.active{
  border-color:var(--brand);
  box-shadow:0 0 0 3px rgba(164,140,255,.18);
}

/* è³£å®¶åˆ— */
:root[data-theme="dark"] .seller-bar img{ border-color:var(--card-border); }

/* å‹•ä½œæŒ‰éˆ• */
:root[data-theme="dark"] .btn{
  background:var(--btn-bg);
  border:1px solid var(--btn-border);
  color:var(--btn-text);
}
:root[data-theme="dark"] .btn.primary{
  background:var(--brand);
  color:#161222;
  border-color:transparent;
}

/* æ”¶è— â™¥ ç‹€æ…‹å·²åœ¨åŸç¢¼ï¼Œé€™è£¡åªç¢ºä¿åœ¨æš—è‰²å¯è¦‹ */
:root[data-theme="dark"] #favBtn{ color:var(--text); }

/* ä»˜æ¬¾ç¢¼å€ */
:root[data-theme="dark"] .pay img{
  background:var(--card-bg);
  border:1px solid var(--card-border);
}

/* ä¸‹æ–¹ã€Œæ­¤è³£å®¶çš„å…¶ä»–å•†å“ã€å¡ç‰‡å…§åƒ¹æ ¼è‰²ç³»å°é½Š */
:root[data-theme="dark"] .card .cbody{ color:var(--text); }
:root[data-theme="dark"] .card .cbody div:nth-child(2){ color:var(--accent); }

/* â€”â€” è¨‚å–®å½ˆçª—ï¼ˆèˆ‡é¦–é  Modal å°é½Šï¼‰ â€”â€” */
:root[data-theme="dark"] .order{
  background:var(--card-bg);
  color:var(--text);
  border:1px solid var(--card-border);
  box-shadow:var(--shadow);
}
:root[data-theme="dark"] .order header{
  background:var(--card-bg);
  border-bottom:1px solid var(--card-border);
}
:root[data-theme="dark"] .order .actions{
  background:var(--card-bg);
  border-top:1px solid var(--card-border);
}
:root[data-theme="dark"] .input,
:root[data-theme="dark"] .select,
:root[data-theme="dark"] .file{
  background:transparent;
  color:var(--text);
  border:1px solid var(--card-border);
}
:root[data-theme="dark"] .fix{
  background:#151127;
  border-color:#2e2750;
}
:root[data-theme="dark"] .paybox{
  border:1px solid var(--card-border);
  background:var(--card-bg);
}
:root[data-theme="dark"] .hr{ border-top:1px solid var(--card-border); }
:root[data-theme="dark"] .closex{ color:#a79be0; }

/* â€”â€” å³ä¸Šè§’é¸å–®ï¼ˆèˆ‡é¦–é ä¸€è‡´ï¼‰ â€”â€” */
/* å®¹å™¨ç¶­æŒç›¸å°å®šä½å³å¯ */
.menu-wrap{ position:relative; display:inline-flex; gap:8px; align-items:center; }

/* å…ˆçµ¦ dropdown åŸºæœ¬æ¨£å¼ï¼ˆé—œé–‰ç‹€æ…‹ï¼‰ */
.dropdown{
  position:fixed;           /* â† ç”¨ fixed æ‰èƒ½é–åœ¨è¦–çª—ï¼Œä¸æœƒè¢«çˆ¶å±¤ overflow æ“‹ä½ */
  left:-9999px; top:-9999px;/* åˆå§‹ç§»åˆ°ç•«é¢å¤–ï¼Œé–‹å•Ÿæ™‚ç”¨ JS è¨­ç¢ºåˆ‡åº§æ¨™ */
  min-width:220px;
  background:#fff; color:#222;
  border:1px solid #eee; border-radius:12px;
  box-shadow:0 16px 40px rgba(0,0,0,.22);
  padding:8px; z-index:5000;
  opacity:0; transform:translateY(-6px) scale(.98);
  transform-origin: top left;
  pointer-events:none; visibility:hidden;
  transition:opacity .16s ease, transform .18s cubic-bezier(.2,.8,.2,1), box-shadow .18s ease;
}
.dropdown.show{
  opacity:1; transform:translateY(0) scale(1);
  pointer-events:auto; visibility:visible;
}


/* hover å¾®å‹•æ•ˆ */
.dropdown .item{ width:100%; text-align:left; padding:10px 12px; border-radius:8px; border:0; background:transparent; cursor:pointer; }
.dropdown .item:hover{ background:rgba(108,78,247,.10); transform:translateY(-1px); transition:transform .12s ease, background .12s ease; }

/* å¤œé–“é…è‰²èˆ‡é¦–é ä¸€è‡´ */
:root[data-theme="dark"] .dropdown{ background:var(--card-bg); color:var(--text); border:1px solid var(--card-border); box-shadow:var(--shadow); }
:root[data-theme="dark"] .dropdown::after{ background:var(--card-bg); border-color:var(--card-border); }
/* ===== è¦†å¯«ï¼šå¤œé–“ä¸»é¡Œé…è‰²ï¼ˆæé«˜æ¬Šé‡ & ä¸€è‡´æ€§ï¼‰ ===== */
html[data-theme="dark"] body{ background:var(--page-bg); color:var(--text); }
html[data-theme="dark"] .title{ color:var(--text); }
html[data-theme="dark"] .muted{ color:var(--muted); }
html[data-theme="dark"] .price{ color:var(--accent); }

/* å¡ç‰‡/å€å¡Šï¼ˆå«å•†å“æè¿°ã€å³æ¬„ metaã€åœ–ç‰‡ä¸‹æ–¹ç¸®åœ–æ¢ï¼‰ */
html[data-theme="dark"] .gallery,
html[data-theme="dark"] .meta,
html[data-theme="dark"] .desc,
html[data-theme="dark"] .card,
html[data-theme="dark"] .g-strip{
  background:var(--card-bg) !important;
  border:1px solid var(--card-border) !important;
  color:var(--text);
  box-shadow:var(--shadow);
}

/* ä¸»åœ–èˆ‡å¡ç‰‡ä¸­çš„åœ–ç‰‡åº•è‰² */
html[data-theme="dark"] .g-main,
html[data-theme="dark"] .card img{ background:#1e1930; }

/* è¦æ ¼ chip */
html[data-theme="dark"] .chip{
  background:var(--chip-bg); border:1px solid var(--chip-border); color:var(--text);
}
html[data-theme="dark"] .chip.active{
  border-color:var(--brand);
  box-shadow:0 0 0 3px rgba(164,140,255,.18);
}

/* æŒ‰éˆ•ï¼ˆåŒ…å«å³ä¸Šè§’çš„ % é¸å–®æŒ‰éˆ•ï¼‰ */
html[data-theme="dark"] .btn,
html[data-theme="dark"] .menu-btn{
  background:var(--btn-bg) !important;
  border:1px solid var(--btn-border) !important;
  color:var(--btn-text) !important;
  box-shadow:none;
}
html[data-theme="dark"] .btn.primary{ background:var(--brand) !important; color:#161222 !important; }

/* è¿”å›ä¸Šæ–¹é‚£æ¢æ°´å¹³ç·šï¼ˆhrï¼‰åœ¨å¤œé–“çš„é¡è‰² */
html[data-theme="dark"] hr{ border-top:1px solid var(--card-border) !important; }

/* ===== è¦†å¯«ï¼šå³ä¸Šè§’ã€Œä¸‹æ‹‰é¸å–®ã€ä½ç½® + å‹•æ•ˆï¼ˆç´” CSSï¼‰ ===== */
/* è®“å®¹å™¨æˆç‚ºå®šä½åƒè€ƒé» */
.menu-wrap{ position:relative !important; display:inline-flex; gap:8px; align-items:center; }

/* é—œé–‰ç‹€æ…‹ */
.dropdown{
  position:absolute !important;
  left:0; top:calc(100% + 8px);         /* å…ˆè®“å®ƒåœ¨æŒ‰éˆ•æ­£ä¸‹ */
  transform:translateX(8px) translateY(-6px) scale(.98);
  opacity:0; visibility:hidden; pointer-events:none;
  min-width:220px; max-width:min(320px, 80vw);
  background:#fff; color:#222;
  border:1px solid #eee; border-radius:12px;
  box-shadow:0 16px 40px rgba(0,0,0,.22);
  z-index:1200;
  transition:opacity .16s ease, transform .18s cubic-bezier(.2,.8,.2,1), box-shadow .18s ease;
}

/* é–‹å•Ÿï¼šé¡¯ç¤ºåœ¨ã€ŒæŒ‰éˆ•æ­£ä¸‹æ–¹ä¸¦ç•¥å‘å³ã€ */
.dropdown.show{
  transform:translateX(8px) translateY(0) scale(1);
  opacity:1; visibility:visible; pointer-events:auto;
}
/* ç§»é™¤ä¸‹æ‹‰é¸å–®çš„å°ç®­é ­ */
.dropdown::after{ content:none !important; }
/* é …ç›® hover çš„ã€Œéˆå‹•æ„Ÿã€ */
.dropdown .item{
  width:100%; text-align:left; padding:10px 12px;
  border:0; border-radius:8px; background:transparent; color:inherit; cursor:pointer;
  transition: transform .12s ease, background .12s ease;
}
.dropdown .item:hover{ background:rgba(108,78,247,.10); transform:translateY(-1px); }

/* å¤œé–“ç‰ˆçš„é¸å–®èˆ‡ç®­é ­é¡è‰² */
html[data-theme="dark"] .dropdown{
  background:var(--card-bg) !important;
  color:var(--text) !important;
  border:1px solid var(--card-border) !important;
  box-shadow:var(--shadow);
}
html[data-theme="dark"] .dropdown::after{
  background:var(--card-bg); border-color:var(--card-border);
}
/* æ™é–“æ¨¡å¼çš„ dropdown æ·¡ç²‰è‰²èƒŒæ™¯ */
html[data-theme="light"] .dropdown {
  background: #ffe6f2 !important;   /* æ·¡ç²‰è‰² */
  color: #222;                      /* æ–‡å­—ä»ç„¶æ·±è‰² */
  border: 1px solid #f5cce0;        /* æ·¡ç²‰é‚Šæ¡† */
  box-shadow: 0 10px 28px rgba(0,0,0,.15);
}
/* å°è¢å¹•æ™‚ï¼Œç•¶å³å´ç©ºé–“ä¸è¶³ï¼Œè‡ªå‹•æ”¹ç‚ºã€Œè²¼é½Šå·¦é‚Šã€ */
@media (max-width:560px){
  .dropdown, .dropdown.show{
    left:0 !important; right:auto !important;
    transform:translateX(0) translateY(0);
  }
  .dropdown::after{ left:14px; }
}

/* ===== å…¶å®ƒç´°ç¯€ï¼šæ”¶è—æŒ‰éˆ• & ç¸®åœ–æ¢é‚Šæ¡† ===== */
#favBtn.faved{ color:#ff2ef5; text-shadow:0 0 6px #ff9df7; }
.g-strip{ border-top:1px solid #eee; }
html[data-theme="dark"] .g-strip{ border-top:1px solid var(--card-border) !important; }
/* è®“åœ–æ¡†èƒ½æ”¾ç½®çµ•å°å®šä½çš„ç®­é ­ */
.gallery{ position:relative; }

/* ç®­é ­å®¹å™¨ï¼ˆè¦†è“‹æ•´å€‹ä¸»åœ–å€ï¼Œæ–¹ä¾¿é»æ“Šï¼‰ */
.g-nav{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:space-between;
  pointer-events:none;              /* åªæœ‰ç®­é ­èƒ½é» */
}

/* å·¦å³ç®­é ­ */
.g-arrow{
  pointer-events:auto;
  width:42px; height:42px; border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  font-size:24px; font-weight:900; line-height:1;
  background:rgba(255,255,255,.86);
  border:1px solid #e7e7e7;
  box-shadow:0 6px 18px rgba(0,0,0,.15);
  cursor:pointer; user-select:none;
  transition:transform .12s ease, background .12s ease, box-shadow .12s ease;
  margin:0 10px;
}
.g-arrow:hover{ transform:scale(1.04); box-shadow:0 10px 26px rgba(0,0,0,.18); }
.g-arrow:active{ transform:scale(.96); }

/* ç½®ä¸­å°é½Šä¸»åœ–é«˜åº¦ */
.g-arrow-left{  margin-left:10px; }
.g-arrow-right{ margin-right:10px; }

/* å¤œé–“é…è‰² */
:root[data-theme="dark"] .g-arrow{
  background:rgba(22,18,34,.92);
  color:var(--text);
  border:1px solid var(--card-border);
  box-shadow:0 10px 24px rgba(0,0,0,.45);
}

/* åªæœ‰ä¸€å¼µåœ–æ™‚éš±è—ç®­é ­ */
.gallery[data-count="1"] .g-nav{ display:none; }
/* é è¨­éš±è—ç®­é ­ */
.g-arrow{ opacity:0; pointer-events:none; }

/* æ»‘é¼ é€²å…¥ .gallery æ‰é¡¯ç¤º */
.gallery:hover .g-arrow{
  opacity:1; pointer-events:auto;
}
/* % æŒ‰éˆ•åœ“çƒåŒ– */
.menu-btn {
  width: 30px;              /* æŒ‰éˆ•å¤§å° */
  height: 30px;
  border-radius: 50%;       /* åœ“å½¢ */
  font-size: 20px;          /* æ–‡å­—å¤§å° */
  font-weight: 700;
  background: var(--brand); /* ç™½å¤©æ¨¡å¼é è¨­ç´«è‰²èƒŒæ™¯ */
  color: #fff;              /* ç™½å­— */
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform .2s ease, background .2s ease;
}

/* hover å‹•æ•ˆ */
.menu-btn:hover {
  transform: scale(1.1);        /* å¾®å¾®æ”¾å¤§ */
  background: #875cff;          /* hover æ™‚äº®ä¸€é»çš„ç´« */
}

/* å¤œé–“æ¨¡å¼ï¼šä¿æŒå’Œä½ çš„æ·±è‰²ç³»ä¸€è‡´ */
html[data-theme="dark"] .menu-btn {
  background: var(--btn-bg);
  border: 1px solid var(--btn-border);
  color: var(--btn-text);
}
.t{
  text-decoration: none;
  color: rgb(158, 88, 255);
}
/*==============*/
/* ===== è©•è«–å€ ===== */
.comments {
  margin-top: 16px;
  background:#fff;
  border:1px solid #eee;
  border-radius:14px;
  overflow:hidden;
}
.c-head{
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px; border-bottom:1px solid #eee; font-weight:800;
}
.c-list{ padding:10px; display:flex; flex-direction:column; gap:10px; }
.c-item{ display:flex; gap:10px; }
.c-avatar{
  width:36px; height:36px; border-radius:50%; object-fit:cover;
  border:1px solid #eee; background:#f3f3f3;
}
.c-body{ flex:1; }
.c-meta{ font-size:12px; color:#777; display:flex; gap:8px; flex-wrap:wrap; }
.c-name{ font-weight:800; color:#333; }
.c-time{ color:#999; }
.c-text{ margin-top:4px; line-height:1.6; word-break:break-word; }
.c-photos{ margin-top:6px; display:flex; gap:6px; flex-wrap:wrap; }
.c-photo{
  width:84px; height:84px; object-fit:cover; border-radius:8px;
  border:1px solid #eee; background:#fafafa;
}
.c-foot{ padding:10px; border-top:1px solid #eee; display:flex; justify-content:center; }
.c-toggle{ border:1px solid #ddd; background:#fff; border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:700; }

/* ç™¼ä½ˆè©•è«– Modalï¼ˆæ²¿ç”¨ä½ ç¾æœ‰çš„æ¨£å¼èªè¨€ï¼‰ */
#cModal.backdrop{ z-index:3000; }
.cbox{
  width:min(560px, 92vw);
  background:#fff; border:1px solid #eee; border-radius:14px;
  box-shadow:0 16px 40px rgba(0,0,0,.18); overflow:hidden; max-height:92vh;
  display:flex; flex-direction:column;
}
.cbox header{
  padding:12px 14px; font-weight:800; border-bottom:1px solid #eee;
  display:flex; justify-content:space-between; align-items:center;
}
.cbox .body{ padding:14px; overflow:auto; }
.cbox .field{ margin:10px 0; }
.cbox label{ display:block; font-size:12px; color:#777; margin-bottom:6px; }
.cbox .input, .cbox .file, .cbox textarea{
  width:100%; padding:10px 12px; border-radius:10px; border:1px solid #ddd; outline:none;
}
.cbox textarea{ min-height:120px; resize:vertical; }
.cbox .actions{
  border-top:1px solid #eee; display:flex; gap:10px; justify-content:flex-end; padding:10px 14px;
}
.c-err{ color:#b00020; font-size:13px; margin-top:6px; }

/* å¤œé–“é…è‰²å°é½Š */
:root[data-theme="dark"] .comments,
:root[data-theme="dark"] .cbox{
  background:var(--card-bg); color:var(--text); border:1px solid var(--card-border); box-shadow:var(--shadow);
}
:root[data-theme="dark"] .c-head,
:root[data-theme="dark"] .cbox header{ border-bottom:1px solid var(--card-border); }
:root[data-theme="dark"] .c-foot,
:root[data-theme="dark"] .cbox .actions{ border-top:1px solid var(--card-border); }
:root[data-theme="dark"] .c-toggle{ background:var(--btn-bg); border:1px solid var(--btn-border); color:var(--btn-text); }
:root[data-theme="dark"] .cbox .input,
:root[data-theme="dark"] .cbox .file,
:root[data-theme="dark"] .cbox textarea{ background:transparent; color:var(--text); border:1px solid var(--card-border); }
/* === è©•è«–å±•é–‹é¢æ¿ï¼ˆå¤§åŒ¡ï¼‰ === */
#cPanelBackdrop{
  position: fixed; inset: 0;
  background: rgba(0,0,0,.35);
  display: none;
  align-items: center; justify-content: center;
  z-index: 3000;
  opacity: 0; transition: opacity .18s ease;
}
#cPanelBackdrop.show{ display:flex; }
#cPanelBackdrop.visible{ opacity:1; }

.c-panel{
  width: min(760px, 94vw);
  height: 70vh;                     /* å›ºå®šé«˜åº¦ â†’ å…§å®¹å¯æ² */
  background: #fff;
  border: 1px solid #eee; border-radius: 14px;
  box-shadow: 0 18px 48px rgba(0,0,0,.22);
  display: flex; flex-direction: column; overflow: hidden;
  transform: translateY(8px) scale(.98);
  opacity: 0;
  transition: transform .22s cubic-bezier(.2,.8,.2,1), opacity .18s ease;
}
.c-panel.enter{ transform: translateY(0) scale(1); opacity: 1; }

.cp-head{
  padding: 12px 14px; font-weight: 800; border-bottom:1px solid #eee;
  display:flex; align-items:center; justify-content:space-between;
}
.cp-body{
  padding: 12px; overflow:auto;    /* å…§å®¹å¯ä¸Šä¸‹æ»‘ */
  -webkit-overflow-scrolling: touch;
}
.cp-foot{
  border-top:1px solid #eee; padding:10px 12px; display:flex; justify-content:center;
}
.cp-close{ cursor:pointer; font-size:22px; color:#888; }

.c-item{ position: relative; }      /* æ”¾åˆªé™¤éˆ• */
.c-del{
  position:absolute; right:0; top:0;
  border:1px solid #f5c5d0; background:#ffe9ee; color:#d23;
  border-radius:10px; padding:4px 8px; font-size:12px; cursor:pointer;
  display:none;
}
.c-item.own .c-del{ display:inline-block; }

/* å°åŒ¡é è¦½å€ä¹ŸåŠ é»é–‹åˆå‹•ç•«æ„Ÿ */
#comments{
  transition: transform .18s cubic-bezier(.2,.8,.2,1), opacity .16s ease;
}
#comments.anim-hide{ transform: scale(.98); opacity:.0; }
#comments.anim-show{ transform: scale(1);   opacity:1; }

/* å¤œé–“å°é½Š */
:root[data-theme="dark"] #cPanelBackdrop{ background: rgba(0,0,0,.5); }
:root[data-theme="dark"] .c-panel{
  background: var(--card-bg); color: var(--text);
  border:1px solid var(--card-border); box-shadow: var(--shadow);
}
:root[data-theme="dark"] .cp-head, :root[data-theme="dark"] .cp-foot{
  border-color: var(--card-border);
}
:root[data-theme="dark"] .c-del{
  background:#3b1f28; color:#ff9fb1; border-color:#5a2e3d;
}
:root[data-theme="dark"] .btny{
  background:#3b1f28; color:#ff9fb1; border-color:#5a2e3d;
}
.btny{
  padding:5px 9px;
  border-radius:12px;
  border:1px solid #ff35b2;
  background:#ff75c8;
  font-weight:800;
  cursor:pointer
}
.i{
  text-decoration: none;
  color: rgb(255, 255, 255);
}
</style>
<style>
  /*æ¸¸æ¨™*/
/* é€æ˜ 1x1 æ¸¸æ¨™ï¼ˆè³‡æ–™URIï¼‰ï¼Œæ¯”å–®ç´” none æ›´ä¸æœƒè¢«ç€è¦½å™¨è‡¨æ™‚è¦†è“‹ */
:root{
  --cursor-none: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAEklEQVQImWNgYGBgYAAAAAQAARV7J8EAAAAASUVORK5CYII=') 0 0, none;
}

/* å¾¹åº•å¥—ç”¨åˆ°æ‰€æœ‰ç›’èˆ‡å½å…ƒç´  */
html, body, *, *::before, *::after{
  cursor: var(--cursor-none) !important;
}

/* ä»»ä½•åŸæœ¬æœƒæŠŠæ¸¸æ¨™æ”¹æˆ pointer / text çš„å…ƒç´ ï¼Œå¼·åˆ¶ç¹¼æ‰¿å°±ä¸æœƒè·³å›åŸç”Ÿæ¨£å¼ */
a, button, [role="button"], label, summary,
input, textarea, select, option, details, svg, canvas{
  cursor: inherit !important;
}

/* ä½ çš„è‡ªè¨‚æ¸¸æ¨™å¤–å±¤ï¼ˆä¸è®Šï¼‰ */
#cursor{
  position: fixed; left:0; top:0; width:0; height:0;
  pointer-events: none; will-change: transform; z-index: 9999;
}
/* å…§å±¤åœ–ç‰‡ï¼ˆä¸è®Šï¼‰ */
#cursor .cursor-img{
  width:32px; height:32px;
  background: url('../shoing.png') center/contain no-repeat;
  transform: translate(-8px,-12px) scale(1);
  transition: transform .12s ease; 
  will-change: transform;
}
#cursor.down .cursor-img{ 
  transform: translate(-8px,-12px) scale(.9); 
}
/* é€æ˜é®ç½©ï¼šé è¨­ä¸æ“‹äº’å‹•ï¼Œä½†åœ¨æ²å‹•ç¬é–“çŸ­æš«æ¥æ‰‹ hit-test ä»¥ä¿è­‰ cursor:none ç”Ÿæ•ˆ */
#cursor-shield{
  position: fixed;
  inset: 0;
  cursor: var(--cursor-none) !important;  /* ä¸€å¾‹éš±è—ç³»çµ±æ¸¸æ¨™ */
  pointer-events: none;                   /* å¹³å¸¸ä¸æ“‹é»æ“Š/æ»‘å‹• */
  z-index: 9998;                          /* ä½æ–¼è‡ªè¨‚æ¸¸æ¨™ #cursor */
}

/* ã€Œæ²å‹•ä¸­ã€çŸ­æš«å•Ÿç”¨å‘½ä¸­ï¼ˆåªå½±éŸ¿æ¸¸æ¨™å‘½ä¸­ï¼Œä¸æœƒå½±éŸ¿æ»¾å‹•ï¼‰ */
#cursor-shield.cover{
  pointer-events: auto;                   /* è®“å®ƒæˆç‚ºå‘½ä¸­å…ƒç´ ï¼Œæ¸¸æ¨™å°±ä¸æœƒè¢«ä¸‹é¢åŸç”Ÿæ§ä»¶å¥ªå› */
}

</style>
<style>
  /* ========== Gallery éŸ¿æ‡‰å¼ ========== */

/* ä¸»åœ–ï¼šé è¨­ä»¥ã€Œå®Œæ•´é¡¯ç¤ºã€ç‚ºä¸»ï¼Œä¸è£åˆ‡ï¼›é«˜åº¦ä¸è¶…éè¦–çª— 70vh */
.g-main{
  width: 100%;
  height: auto;
  max-height: 70vh;
  object-fit: contain;
  aspect-ratio: auto;           /* å–æ¶ˆå›ºå®š 1:1ï¼Œè®“åœ–ç‰‡è‡ªå·±æ±ºå®šæ¯”ä¾‹ */
  display: block;
}

/* å¯¬è¢å¹•ï¼ˆå¹³æ¿/æ¡Œæ©Ÿï¼‰æ‰å›åˆ°æ–¹å½¢æ¡†ï¼Œè¦–è¦ºæ›´æ•´é½Š */
@media (min-width: 768px){
  .g-main{
    aspect-ratio: 1 / 1;
    max-height: none;
    object-fit: cover;          /* é€™æ™‚å€™æ–¹æ¡†å…§è£åˆ‡ä¸€äº›æ¯”è¼ƒå¥½çœ‹ */
  }
}

/* ç¸®åœ–åˆ—ï¼šåœ¨å°è¢å¹•ç¸®å°å°ºå¯¸ï¼Œé¿å…æ“ å£“ */
.g-strip{ gap: 6px; }
.g-thumb{ width: 64px; height: 64px; }
@media (max-width: 480px){
  .g-thumb{ width: 52px; height: 52px; }
}

/* å…©æ¬„ç‰ˆé¢ï¼šæ‰‹æ©Ÿä¸€æ¬„ç›´æ’ï¼Œé¿å…å·¦å³æ“ å£“ */
@media (max-width: 768px){
  .top{ flex-direction: column; }
  .gallery, .meta{ flex: 1 1 100%; }
}

/* ç®­é ­ï¼šè¡Œå‹•è£ç½®æ²’æœ‰ hoverï¼Œç›´æ¥å¸¸é§é¡¯ç¤ºã€ç¨å¾®ç¸®å° */
@media (hover: none){
  .gallery .g-arrow{
    opacity: 1;
    pointer-events: auto;
  }
}
@media (max-width: 480px){
  .gallery .g-arrow{ width: 34px; height: 34px; font-size: 20px; }
}

/* å…§æ–‡å€çš„åœ–ç‰‡ï¼šä¸€å¾‹è‡ªé©æ‡‰å®¹å™¨å¯¬ï¼Œä¸è¦å›ºå®š 500px */
.desc img{
  display: block;
  max-width: 100% !important;
  width: 100% !important;
  height: auto !important;
  border: 1px solid #eee;
  border-radius: 10px;
  margin: 8px 0;
}

/* å¦‚æœä½ æœ‰æ”¾å…¶ä»–è³£å®¶å•†å“çš„å¡ç‰‡åœ–ï¼Œä¹Ÿä¿åº•ä¸€ä¸‹ */
.card img{ width: 100%; height: auto; object-fit: cover; }
</style>
</head>
<body>
  <div id="cursor-shield"></div>
<div id="cursor"><div class="cursor-img"></div></div>


  <div class="wrap">
    <div class="menu-wrap">
      <a class="back" href="javascript:void(0)" onclick="goBack()">â† è¿”å›</a>
  <button id="menuBtn" class="menu-btn" aria-expanded="false" onclick="toggleMenu()">%</button>
  <button class="btny">
    <a href="shopping.html" class="i">Esc Store</a></button>
  <div id="menuDrop" class="dropdown" role="menu">
    <!-- ç¬¬ä¸€å€‹é¸é …ï¼šåˆ‡æ›æ¨¡å¼ -->
    <button class="item" onclick="toggleTheme()" id="modeItem">åˆ‡æ›æ¨¡å¼ï¼šå¤œé–“</button>
     <button class="item" onclick="location.href='../index.html'">ä¸»é </button>
    <button class="item" onclick="location.href='Grove.Examination-Yuan.html'">åƒåŠ ç®¡ç†å“¡</button>
    <button class="item" onclick="location.href='Grove. Control-Yuan.html'">Control</button>
    <button class="item" onclick="location.href='Grove.Executive-Yuan.html'">Executive</button>
    <button class="item" onclick="location.href='Grove.Judicial-Yuan.html'">ç”³è¨´</button>
    <button class="item" onclick="location.href='Grove.Legislative-Yuan.html'">Legislative</button>
    <button class="item" onclick="location.href='vote.html'">æŠ•ç¥¨å°ˆå€</button>
    <button class="item" onclick="location.href='constitution.html'">ç¶²ç«™ç”³æ˜</button>
    
  </div>
</div>
 <hr style="border:none;border-top:1px solid #eee;margin:8px 0 16px">
    <!-- åªé¡¯ç¤ºã€Œé ­è²¼ï¼‹æš±ç¨±ã€ -->
    <div id="sellerBar" class="seller-bar" style="display:none">
      <img id="sellerAvatar" alt="è³£å®¶é ­è²¼">
      <div id="sellerName" style="font-weight:800;font-size:15px"></div>
    </div>
   

    <div class="top">
      <div class="gallery">
        <img id="gMain" class="g-main" src="" alt="å•†å“åœ–ç‰‡">
        <div id="gStrip" class="g-strip"></div>
      </div>

      <div class="meta">
        <div id="mTitle" class="title">â€”</div>
        <div id="mSummary" class="muted">â€”</div>

        <div class="specs">
          <div class="muted">è¦æ ¼</div>
          <div id="specBox" class="spec-row"></div>
          <div class="muted">ç¸½åƒ¹</div>
          <div id="mPrice" class="price">Â¥0</div>
          <div id="ioLine" class="muted" style="font-weight:700;color:#6c4ef7">io$: 0.00000</div>

          <div id="payBox" class="pay" style="display:none">
            <div class="muted" style="margin-bottom:6px">æ”¶æ¬¾ç¢¼</div>
            <img id="payImg" src="" alt="æ”¶æ¬¾ç¢¼">
          </div>

          <div class="actions">
          <button class="btn" onclick="history.back()" style="color: #b066ff;">Esc Store</button>
          <button class="btn primary" onclick="openOrder()">ç¢ºèªè³¼è²·</button>
          <button id="favBtn" class="btn" style="background:transparent;font-size:20px;line-height:1">â™¡</button>
          <button class="btn" onclick="openCModal()">ç™¼ä½ˆè©•è«–</button>
          </div>
        </div>
      </div>
    </div>

    <div id="mDesc" class="desc"></div>
<div id="comments" class="comments" style="display:none">
  <div class="c-head">
    <div>è©•è«–</div>
    <div class="muted" id="cCount">0 å‰‡</div>
  </div>
  <div id="cList" class="c-list"></div>
  <div class="c-foot">
    <button id="cToggleBtn" class="c-toggle" onclick="openCPanel()">å±•é–‹å…¨éƒ¨</button>
  </div>
</div>
    <div style="margin-top:20px">
      <div style="font-weight:800;margin-bottom:8px">æ­¤è³£å®¶çš„å…¶ä»–å•†å“</div>
      <div id="sellerProducts" class="grid"></div>
    </div>
  </div>
<!-- è©•è«–å±•é–‹é¢æ¿ï¼ˆå¤§åŒ¡ï¼‰ -->
<div id="cPanelBackdrop">
  <div id="cPanel" class="c-panel" role="dialog" aria-modal="true" aria-label="å…¨éƒ¨è©•è«–">
    <div class="cp-head">
      <div>å…¨éƒ¨è©•è«– <span id="cpCount" class="muted" style="font-weight:400"></span></div>
      <div class="cp-close" onclick="closeCPanel()">Ã—</div>
    </div>
    <div id="cpBody" class="cp-body"><!-- å‹•æ…‹å¡ full list --></div>
    <div class="cp-foot">
      <button class="c-toggle" onclick="closeCPanel()">æ”¶èµ·</button>
    </div>
  </div>
</div>
  <!-- è³¼è²·ï¼šè¨‚å–®è¡¨å–® Modal -->
  <div id="orderDlg" class="backdrop">
    <div class="order">
      <header>
        <div>å¡«å¯«è¨‚å–®è³‡æ–™</div>
        <div class="closex" onclick="closeOrder()">Ã—</div>
      </header>
      <div class="body">
        <!-- å›ºå®šè³‡è¨Š -->
        <div class="fix">
          <div class="row">
            <div class="field"><label>å•†å“</label><input id="odTitle" class="input" type="text" disabled></div>
            <div class="field"><label>è¦æ ¼</label><input id="odSpec"  class="input" type="text" disabled></div>
            <div class="field"><label>åƒ¹æ ¼</label><input id="odPrice" class="input" type="text" disabled></div>
            <!-- æ–°å¢ï¼šIO è™Ÿç¢¼ -->
            <div class="field"><label>IO:</label><input id="odIo" class="input" type="text" disabled></div>
          </div>
        </div>

        <hr class="hr">

        <!-- åœ°å€ -->
        <div style="font-weight:800;margin-bottom:6px">æ”¶ä»¶åœ°å€</div>
        <div class="row">
          <div class="field"><label>åœ‹å®¶/åŠ åœ°å€ç¢¼é›»è©±ï¼ˆ+886ã€+86â€¦ï¼‰</label><input id="odCcode" class="input" type="text" placeholder="+886"></div>
          <div class="field"><label>çœ/å·</label><input id="odProv" class="input" type="text" placeholder="çœ/å·"></div>
        </div>
        <div class="row">
          <div class="field"><label>å¸‚</label><input id="odCity" class="input" type="text" placeholder="åŸå¸‚"></div>
          <div class="field"><label>ç¸£</label><input id="odDist" class="input" type="text" placeholder="å€/ç¸£"></div>
        </div>
        <div class="row">
          <div class="field" style="flex:1 1 100%"><label>è©³ç´°åœ°å€</label><input id="odAddr" class="input" type="text" placeholder="é“è·¯ã€é–€ç‰Œã€æ¨“å±¤â€¦"></div>
        </div>

        <!-- ä»˜æ¬¾ç¢¼ -->
        <div id="odPayWrap" class="paybox" style="margin-top:10px">
          <div class="muted" style="margin-bottom:6px">å°æ‡‰è¦æ ¼çš„æ”¶æ¬¾ç¢¼</div>
          <img id="odPayImg" src="" alt="æ”¶æ¬¾ç¢¼" style="max-width:220px;border:1px solid #eee;border-radius:10px;background:#fff">
        </div>

        <!-- ä¸Šå‚³ä»˜æ¬¾æˆªåœ– -->
        <div id="odProofWrap" style="display:none; margin-top:12px">
          <label style="display:block; font-size:12px; color:#777; margin-bottom:6px">ä»˜æ¬¾é é¢æˆªåœ–</label>
          <input id="odProof" class="file" type="file" accept="image/*">
          <div class="muted">å®Œæˆä»˜æ¬¾å¾Œï¼Œè«‹ä¸Šå‚³æˆªåœ–åšç‚ºä¾æ“šã€‚</div>
        </div>

        <div id="odErr" class="err"></div>
      </div>
      <div class="actions">
        <button class="btn" onclick="closeOrder()">å–æ¶ˆ</button>
        <button id="btnShowPay" class="btn" onclick="showPayCode()">é¡¯ç¤ºä»˜æ¬¾ç¢¼</button>
        <button id="btnSubmitOrder" class="btn primary" style="display:none" onclick="submitOrder()">ä¸Šå‚³è³¼è²·</button>
      </div>
    </div>
  </div>
<div id="cModal" class="backdrop" style="display:none">
  <div class="cbox">
    <header>
      <div>ç™¼ä½ˆè©•è«–</div>
      <div class="closex" onclick="closeCModal()">Ã—</div>
    </header>
    <div class="body">
      <div class="field">
        <label>è©•è«–å…§å®¹</label>
        <textarea id="cText" placeholder="èªªé»ä»€éº¼å§â€¦"></textarea>
      </div>
      <div class="field">
        <label>é™„åŠ åœ–ç‰‡ï¼ˆæœ€å¤š 3 å¼µï¼‰</label>
        <input id="cFiles" class="file" type="file" accept="image/*" multiple>
        <div class="muted">ä¸Šå‚³å¾Œåœ¨è©•è«–å€æœƒé¡¯ç¤ºç‚ºå›ºå®šå°ç¸®åœ–ã€‚</div>
      </div>
      <div id="cErr" class="c-err"></div>
    </div>
    <div class="actions">
      <button class="btn" onclick="closeCModal()">å–æ¶ˆ</button>
      <button class="btn primary" onclick="submitComment()">é€å‡º</button>
    </div>
  </div>
</div>
<script>
const API     = "https://zdqo2eqb.lc-cn-n1-shared.com/1.1";
const APP_ID  = "ZDqo2eQBcSChCfRgwix9jUeI-gzGzoHsz";
const APP_KEY = "U66ybZWAD99LrT9zJnQlW52H";
const CURRENCY_SIGN = 'Â¥';
const IO_TO_CNY = 60;                   // åŒ¯ç‡ï¼š1 io$ = Â¥60
const fmtIo = n => (Math.round(n*1e5)/1e5).toFixed(5);  // io$ é¡¯ç¤º 5 ä½å°æ•¸
// è®€ URL åƒæ•¸
const pid = new URLSearchParams(location.search).get('id');

// å…§åµŒé è¨­é ­è²¼ï¼ˆä¸èµ°å¤–éƒ¨ URLï¼Œé¿å… SSL éŒ¯èª¤ï¼‰
const DEFAULT_AVATAR = 'data:image/svg+xml;utf8,' + encodeURIComponent(
  `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80">
     <rect width="100%" height="100%" rx="40" ry="40" fill="#f3f3f3"/>
     <text x="50%" y="55%" text-anchor="middle" font-size="28">ğŸ™‚</text>
   </svg>`
);

// è®€å•†å“ï¼ˆå¸¶ include=sellerï¼‰
async function fetchProduct(id){
  const res = await fetch(`${API}/classes/Product/${id}?include=seller`, {
    headers:{ 'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY }
  });
  if(!res.ok) throw new Error('è¼‰å…¥å•†å“å¤±æ•—');
  return res.json();
}

let PRODUCT=null, chosenIndex=0;
const money = n => Number(n||0).toLocaleString('zh-TW');

function getFileUrl(maybeFile){
  let u = '';
  if(!maybeFile) return '';
  if (typeof maybeFile === 'string') u = maybeFile;
  else if (typeof maybeFile === 'object' && maybeFile.url) u = maybeFile.url;
  if (u && /^http:\/\//i.test(u)) u = u.replace(/^http:\/\//i, 'https://');
  return u;
}
// å¯èƒ½å¾Œç«¯æ¬„ä½å«ä¸åŒåå­—æˆ–æ··æœ‰ File ç‰©ä»¶/å­—ä¸²
function pickDetailImages(p){
  const cand = [p.detailImages, p.detailImgs, p.detailPics, p.detailPhotos, p.desImages];
  const arr = cand.find(a => Array.isArray(a) && a.length) || [];
  return arr.map(getFileUrl).filter(Boolean);
}

// åªå…è¨± top / bottomï¼›å…¶å®ƒå€¼ä¸€å¾‹ç•¶ top
function normalizePos(pos){
  const s = String(pos||'top').toLowerCase();
  if (s.includes('bot') || s.includes('ä¸‹')) return 'bottom';
  return 'top';
}
// å–å¾—è©²è¦æ ¼çš„ä»˜æ¬¾ç¢¼ç¶²å€ï¼ˆåŒæ™‚ç›¸å®¹æ–°èˆŠæ¬„ä½ï¼‰
function getPayUrl(p, cur){
  // æ–°æ¬„ä½ï¼ˆå­—ä¸²ï¼‰å„ªå…ˆ
  let url = p.samePrice ? p.commonPayUrl : cur.payCodeUrl;
  // èˆŠæ¬„ä½ï¼ˆFile ç‰©ä»¶ æˆ– å­—ä¸²ï¼‰å¾Œå‚™
  if (!url) url = p.samePrice ? getFileUrl(p.commonPayCode) : getFileUrl(cur.payCode);
  return url || '';
}

function renderGallery(p){

 const imgs = [
   getFileUrl(p.imageUrl),
   ...(Array.isArray(p.images) ? p.images.map(getFileUrl) : [])
 ].filter(Boolean);
  const gMain  = document.getElementById('gMain');
  const gStrip = document.getElementById('gStrip');
  gMain.src = imgs[0] || DEFAULT_AVATAR;
  gStrip.innerHTML = '';
  imgs.forEach(url=>{
    const im = document.createElement('img');
    im.className='g-thumb'; im.src=url; im.alt='ç¸®åœ–';
    im.onclick=()=>{ gMain.src=url; };
    gStrip.appendChild(im);
  });
}

function renderMeta(p){
  document.getElementById('mTitle').textContent = p.title || 'â€”';
  document.getElementById('mSummary').textContent = p.summary || '';

  const box = document.getElementById('specBox');
  box.innerHTML = '';
  const variants = Array.isArray(p.variants)? p.variants : [];
  variants.forEach((v,idx)=>{
    const chip=document.createElement('button');
    chip.type='button';
    chip.className='chip'+(idx===0?' active':'');
    chip.textContent = p.samePrice ? `${v.name}` : `${v.name}ï¼ˆ${CURRENCY_SIGN}${money(v.price)}ï¼‰`;
    chip.onclick=()=>{
      [...box.querySelectorAll('.chip')].forEach(c=>c.classList.remove('active'));
      chip.classList.add('active'); chosenIndex=idx; updatePriceAndPay();
    };
    box.appendChild(chip);
  });

  // === è©³æƒ…ï¼šä¾æ“ºä½æ’åœ– ===
function buildDetailHTML(p){
  const desc  = (p.description || '');
  const lines = desc.split(/\r?\n/);
  const imgs  = (p.detailImages || []).map(String);

  const imgsHTML = imgs.map(u => `
    <img src="${u}" alt="">
  `).join('');   // äº¤çµ¦ä¸Šé¢çš„ .desc img CSS æ§åˆ¶å¯¬é«˜

  const lineHTML = lines.map(s => `<p>${s || '&nbsp;'}</p>`).join('');
  const pos = String(p.detailImagePos || 'top').toLowerCase();

  if (pos.includes('bottom')) return lineHTML + imgsHTML;
  return imgsHTML + lineHTML; // é è¨­ top
}

// å–ä»£ä½ åŸæœ¬çš„ä¸‰è¡Œ
document.getElementById('mDesc').innerHTML = buildDetailHTML(p);
console.log({
  detailImagePos:p.detailImagePos,
  detailImageAfterLine:p.detailImageAfterLine,
  pickedImages: pickDetailImages(p)
});
  updatePriceAndPay();
}

/* === ä»˜æ¬¾ç¢¼åµéŒ¯é¢æ¿ === */
function updatePayDebug(){
  let box = document.getElementById('payDebug');
  if(!box){
    box = document.createElement('pre');
    box.id = 'payDebug';
    box.style.cssText = 'margin-top:10px;font:12px ui-monospace,monospace;background:#fff;border:1px dashed #ddd;border-radius:8px;padding:8px;white-space:pre-wrap;color:#444';
    document.querySelector('.meta').appendChild(box);
  }
  const p   = PRODUCT || {};
  const cur = (p.variants||[])[chosenIndex] || {};
  const payUrl = getPayUrl(p, cur);

  box.textContent =
    '[samePrice] ' + JSON.stringify(p.samePrice) + '\n' +
    '[commonPayUrl] ' + JSON.stringify(p.commonPayUrl) + '\n' +
    '[commonPayCode raw] ' + JSON.stringify(p.commonPayCode) + '\n' +
    '[variant.payCodeUrl] ' + JSON.stringify(cur.payCodeUrl) + '\n' +
    '[variant.payCode raw] ' + JSON.stringify(cur.payCode) + '\n' +
    '[computed payUrl] ' + payUrl;
}

/* === è¨ˆåƒ¹ & é¡¯ç¤ºä»˜æ¬¾ç¢¼ === */
function updatePriceAndPay(){
  const p = PRODUCT, cur = (p.variants||[])[chosenIndex] || {};
  const price = p.samePrice ? p.price : cur.price;

  // é¡¯ç¤ºäººæ°‘å¹£
  document.getElementById('mPrice').textContent = CURRENCY_SIGN + money(price);

  // **é¡¯ç¤º io$ï¼ˆä¾è¦æ ¼è®Šå‹•ï¼‰**
  const ioAmount = price / IO_TO_CNY;
  const ioEl = document.getElementById('ioLine');
  if (ioEl) ioEl.textContent = 'io$: ' + fmtIo(ioAmount);

  // ä¸åœ¨è©³æƒ…é é¡¯ç¤ºæ”¶æ¬¾ç¢¼
  const payBox = document.getElementById('payBox');
  if (payBox) payBox.style.display = 'none';

  // **å¦‚æœä¸éœ€è¦é‚£å€‹å­—æ¯åµéŒ¯å€ï¼Œè¨»è§£æ‰ä¸‹ä¸€è¡Œ**
  // updatePayDebug && updatePayDebug();
}

// åªé¡¯ç¤ºé ­è²¼ï¼‹æš±ç¨±ï¼ˆä¿®æ­£ï¼šå¼·åˆ¶ httpsï¼‰
function renderSellerBar(seller){
  const bar  = document.getElementById('sellerBar');
  const img  = document.getElementById('sellerAvatar');
  const name = document.getElementById('sellerName');
  const avatarRaw = seller.avatarUrl || '';
  const avatar = avatarRaw ? avatarRaw.replace(/^http:\/\//, 'https://') : '';
  img.src = avatar || ('data:image/svg+xml;utf8,' + encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80">
      <rect width="100%" height="100%" rx="40" ry="40" fill="#f3f3f3"/>
      <text x="50%" y="55%" text-anchor="middle" font-size="28">ğŸ™‚</text>
    </svg>`
  ));
  name.textContent = seller.nickname || seller.username || 'è³£å®¶';

  bar.onclick = ()=>{
    const me = JSON.parse(localStorage.getItem('sg_user')||'null');
    if(me && seller.objectId && me.objectId===seller.objectId){
      location.href='user.html';
    }else if(seller.objectId){
      location.href=`seller.html?uid=${seller.objectId}`;
    }
  };
  bar.style.display='flex';
}

// å…¶ä»–å•†å“
async function fetchSellerProducts(uid, currentId){
  const where = encodeURIComponent(JSON.stringify({
    seller:{ "__type":"Pointer","className":"_User","objectId":uid },
    objectId:{ "$ne": currentId }
  }));
  const res = await fetch(`${API}/classes/Product?where=${where}&limit=12&order=-createdAt`, {
    headers:{ 'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY }
  });
  const data = await res.json();
  if(res.ok) renderSellerProducts(data.results||[]);
}
function renderSellerProducts(list){
  const box=document.getElementById('sellerProducts');
  if(!list.length){ box.innerHTML=`<div class="muted">æš«ç„¡å…¶ä»–å•†å“</div>`; return; }
  box.innerHTML='';
  list.forEach(p=>{
    const a=document.createElement('a');
    a.className='card'; a.href=`shuser.html?id=${p.objectId}`;
    const cover = getFileUrl(p.imageUrl) || (Array.isArray(p.images) ? getFileUrl(p.images[0]) : '');
    const img = cover || DEFAULT_AVATAR;
    const price=p.samePrice ? p.price : ((p.variants&&p.variants[0])?p.variants[0].price:0);
    a.innerHTML=`<img src="${img}" alt="">
      <div class="cbody">
        <div style="font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.title||'æœªå‘½å'}</div>
        <div style="color:#e91e63;font-weight:800">${CURRENCY_SIGN}${money(price)}</div>
      </div>`;
    box.appendChild(a);
  });
}

/* ===== è³¼è²·æµç¨‹ ===== */
function openOrder(){
  const me = JSON.parse(localStorage.getItem('sg_user')||'null');
  if(!me){ alert('è«‹å…ˆç™»å…¥å†è³¼è²·'); return; }

  const p=PRODUCT, cur=(p.variants||[])[chosenIndex]||{};
  const price = p.samePrice ? p.price : cur.price;

  document.getElementById('odTitle').value = p.title || '';
  document.getElementById('odSpec').value  = cur.name || (p.samePrice ? '(åŒåƒ¹)' : '');
  document.getElementById('odPrice').value = CURRENCY_SIGN + money(price);

  // é‡ç½®å€å¡Š
  document.getElementById('odCcode').value = '';
  document.getElementById('odProv').value  = '';
  document.getElementById('odCity').value  = '';
  document.getElementById('odDist').value  = '';
  document.getElementById('odAddr').value  = '';
  document.getElementById('odProof').value = '';
  document.getElementById('odErr').textContent = '';
  document.getElementById('odPayWrap').style.display   = 'none';
  document.getElementById('odProofWrap').style.display = 'none';
  document.getElementById('btnSubmitOrder').style.display = 'none';
  document.getElementById('btnShowPay').style.display    = 'inline-block';

  document.getElementById('orderDlg').style.display='flex';
  ORDER_IO = generateIo();
  document.getElementById('odIo').value = ORDER_IO;
}
function closeOrder(){ document.getElementById('orderDlg').style.display='none'; }

// ç¬¬ä¸€æ­¥ï¼šé¡¯ç¤ºå°æ‡‰è¦æ ¼çš„ä»˜æ¬¾ç¢¼ï¼Œä¸¦é–‹å•Ÿä¸Šå‚³å€
function showPayCode(){
  const p=PRODUCT, cur=(p.variants||[])[chosenIndex]||{};
  const payUrl = getPayUrl(p, cur);  // âœ… åªåœ¨å½ˆçª—å–å‡ºå°æ‡‰æ”¶æ¬¾ç¢¼

  if(!payUrl){
    document.getElementById('odErr').textContent='æ­¤è¦æ ¼æš«ç„¡ä»˜æ¬¾ç¢¼ï¼Œè«‹è¯çµ¡è³£å®¶';
    return;
  }

  document.getElementById('odPayImg').src = payUrl;
  document.getElementById('odPayWrap').style.display='block';
  document.getElementById('odProofWrap').style.display='block';
  document.getElementById('btnSubmitOrder').style.display='inline-block';
  document.getElementById('btnShowPay').style.display='none';
}

// å·¥å…·ï¼šæª”æ¡ˆè½‰ base64 & ä¸Šå‚³åˆ° /files â†’ å› URL
function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result.split(',')[1]);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}
async function uploadOne(file){
  const base64 = await fileToBase64(file);
  const r = await fetch(`${API}/files/${encodeURIComponent(file.name)}`,{
    method:'POST',
    headers:{'Content-Type':'application/json','X-LC-Id':APP_ID,'X-LC-Key':APP_KEY},
    body: JSON.stringify({ base64 })
  });
  const data = await r.json();
  if(!r.ok) throw new Error(data.error || 'æª”æ¡ˆä¸Šå‚³å¤±æ•—');
  return data.url;
}

// ç¬¬äºŒæ­¥ï¼šé€å‡ºã€Œè³¼è²·ã€è¨Šæ¯åˆ° Message é¡åˆ¥
async function createOrder({ p, cur, me, price, address, proofUrl }){
  const token = localStorage.getItem('sg_token');

  for(let attempt=0; attempt<3; attempt++){
    const orderPayload = {
      product: { "__type":"Pointer", "className":"Product", "objectId": p.objectId },
      seller:  { "__type":"Pointer", "className":"_User",   "objectId": p.seller.objectId },
      buyer:   { "__type":"Pointer", "className":"_User",   "objectId": me.objectId },
      productTitle: p.title || '',
      variantName:  cur.name || '',
      price:      Number(price) || 0,
      unitPrice:  Number(price) || 0,
      quantity:   1,
      totalPrice: Number(price) || 0,
      currency:   p.currency || 'CNÂ¥',
      address,
      payProofUrl: proofUrl,
      status: 'submitted',
      // â˜… æ–°å¢ï¼šio è™Ÿç¢¼ï¼ˆæ¯ç­†å”¯ä¸€ï¼‰
      io: ORDER_IO || generateIo()
    };

    const res = await fetch(`${API}/classes/Order`,{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-LC-Id': APP_ID,
        'X-LC-Key': APP_KEY,
        'X-LC-Session': token
      },
      body: JSON.stringify(orderPayload)
    });
    const data = await res.json();

    // æˆåŠŸ
    if(res.ok) return data.objectId;

    // è‹¥æ˜¯ io é‡è¤‡ï¼Œæ›ä¸€å€‹ io é‡è©¦ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
    if(data && typeof data.error === 'string' && /duplicate value/i.test(data.error)){
      ORDER_IO = generateIo();
      continue;
    }
    // å…¶ä»–éŒ¯èª¤ç›´æ¥ä¸Ÿå‡º
    throw new Error(data.error || 'å»ºç«‹è¨‚å–®å¤±æ•—ï¼ˆè«‹æª¢æŸ¥ Order é¡åˆ¥çš„ Create æ¬Šé™ï¼‰');
  }

  throw new Error('å»ºç«‹è¨‚å–®å¤±æ•—ï¼ˆio ç”¢ç”Ÿé‡è©¦æ¬¡æ•¸è€—ç›¡ï¼‰');
}

// å–ä»£ä½ åŸæœ¬çš„ submitOrder()
async function submitOrder(){
  const me   = JSON.parse(localStorage.getItem('sg_user')||'null');
  const token= localStorage.getItem('sg_token');
  if(!me || !token){ alert('è«‹å…ˆç™»å…¥'); return; }

  const p=PRODUCT, cur=(p.variants||[])[chosenIndex]||{};
  const price = p.samePrice ? p.price : cur.price;

  // åœ°å€æª¢æŸ¥
  const ccode = document.getElementById('odCcode').value.trim();
  const prov  = document.getElementById('odProv').value.trim();
  const city  = document.getElementById('odCity').value.trim();
  const dist  = document.getElementById('odDist').value.trim();
  const addr  = document.getElementById('odAddr').value.trim();
  if(!ccode || !prov || !city || !dist || !addr){
    document.getElementById('odErr').textContent = 'è«‹å¡«å¯«å®Œæ•´åœ°å€æ¬„ä½';
    return;
  }
  const address = { countryCode: ccode, province: prov, city, district: dist, detail: addr };

  // å¿…é ˆæœ‰ä»˜æ¬¾æˆªåœ–
  const proofFile = document.getElementById('odProof').files[0];
  if(!proofFile){
    document.getElementById('odErr').textContent = 'è«‹ä¸Šå‚³ä»˜æ¬¾é é¢æˆªåœ–';
    return;
  }

  try{
    // 1) ä¸Šå‚³ä»˜æ¬¾æˆªåœ–
    const proofUrl = await uploadOne(proofFile);

    // 2) å…ˆå»ºç«‹ Order ç‰©ä»¶
    const orderId = await createOrder({
      p, cur, me, price, address, proofUrl
    });

    // 3) å†å»ºç«‹ Messageï¼Œorder æ¬„ä½æ”¾ Pointer
    const payload = {
      kind: 'order',
      text: `è¨‚å–®æäº¤ï¼š${p.title} / ${cur.name||'(åŒåƒ¹)'} / ${CURRENCY_SIGN}${money(price)}`,
body: `è¨‚å–®æäº¤ï¼š${p.title} / ${cur.name||'(åŒåƒ¹)'} / ${CURRENCY_SIGN}${money(price)}`,
      from: { "__type":"Pointer", "className":"_User", "objectId": me.objectId },
      to:   { "__type":"Pointer", "className":"_User", "objectId": p.seller.objectId },
      product: { "__type":"Pointer", "className":"Product", "objectId": p.objectId },

      // <<< é—œéµï¼šPointer åˆ°å‰›å‰›å»ºç«‹çš„ Order >>>
      order: { "__type":"Pointer", "className":"Order", "objectId": orderId },

      // è‹¥ä½ é‚„æƒ³ä¿ç•™ data èˆŠæ¬„ä½ä¹Ÿå¯ä»¥ï¼ˆéå¿…é ˆï¼‰
      data: {
        productId: p.objectId,
        productTitle: p.title,
        variantName: cur.name || '',
        price: price,
        address,
        payProofUrl: proofUrl,
        io: ORDER_IO
      },

      ACL: {
        "*": { "read": false },
        [me.objectId]: { "read": true, "write": true },
        [p.seller.objectId]: { "read": true, "write": false }
      }
    };

    const res = await fetch(`${API}/classes/Message`,{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-LC-Id': APP_ID,
        'X-LC-Key': APP_KEY,
        'X-LC-Session': token
      },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || 'é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');

    closeOrder();
    alert('âœ… å·²é€å‡ºè³¼è²·è³‡è¨Šï¼Œå•†å®¶å°‡åœ¨è¨Šæ¯ä¸­èˆ‡ä½ è¯çµ¡ã€‚');
  }catch(e){
    document.getElementById('odErr').textContent = e.message || 'é€å‡ºå¤±æ•—';
  }
}

function confirmBuy(){ openOrder(); }
let ORDER_IO = ''; // é€™ç­†ä¸‹å–®æš«å­˜çš„ io

function pad2(n){ return String(n).padStart(2,'0'); }
function generateIo(){
  const d = new Date();
  const stamp = `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}-${pad2(d.getHours())}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`;
  const rand  = Math.random().toString().slice(2,8); // 6 ä½éš¨æ©Ÿæ•¸å­—
  return `${stamp}-${rand}`;
}
// å•Ÿå‹•
(async ()=>{
  if(!pid){ alert('ç¼ºå°‘å•†å“ id'); history.back(); return; }
  try{
    const p = await fetchProduct(pid);
    PRODUCT = p;

    renderGallery(p);
    renderMeta(p);

    if(p.seller && p.seller.objectId){
      renderSellerBar(p.seller);
      if(!p.seller.nickname && !p.seller.avatarUrl){
        try{
          const r = await fetch(`${API}/users/${p.seller.objectId}`, {
            headers:{ 'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY }
          });
          if(r.ok){ renderSellerBar(await r.json()); }
        }catch(e){}
      }
      fetchSellerProducts(p.seller.objectId, p.objectId);
    }else{
      renderSellerBar({ nickname: 'ï¼ˆæœ¬å•†å“ç¼ºå°‘è³£å®¶æŒ‡æ¨™ï¼‰', avatarUrl: '' });
    }
  }catch(e){
    console.error(e);
    alert(e.message || 'è¼‰å…¥å¤±æ•—');
  }
})();
function goBack(){
  if (document.referrer && document.referrer.indexOf(location.origin) === 0) {
    // æœ‰ä¸Šä¸€é ï¼Œä¸¦ä¸”åŒä¸€å€‹ç¶²ç«™
    history.back();
  } else {
    // æ²’æœ‰ referrerï¼Œæˆ–å¾å¤–éƒ¨é€£é€²ä¾† â†’ é è¨­å›é¦–é 
    location.href = 'shopping.html';
  }
}
// ====== æ”¶è— Favoriteï¼ˆLeanCloud å¾Œç«¯ç‰ˆï¼‰======
// éœ€è¦ï¼šsg_userï¼ˆå« objectIdï¼‰ã€sg_tokenï¼ˆSessionï¼‰å·²å­˜åœ¨ localStorageï¼›pid ç‚ºç•¶å‰å•†å“ id
const favBtn = document.getElementById('favBtn');

function getMe(){
  return JSON.parse(localStorage.getItem('sg_user')||'null');
}

// æŸ¥è©¢æ˜¯å¦å·²æ”¶è—ï¼ˆå›å‚³ Favorite çš„ objectIdï¼Œæ²’æœ‰å‰‡ nullï¼‰
async function findFavoriteId(pid){
  const me = getMe(); if(!me) return null;
  const where = encodeURIComponent(JSON.stringify({
    user:    { "__type":"Pointer","className":"_User","objectId": me.objectId },
    product: { "__type":"Pointer","className":"Product","objectId": pid }
  }));
  const res = await fetch(`${API}/classes/Favorite?where=${where}&limit=1`, {
    headers:{
      'X-LC-Id': APP_ID,
      'X-LC-Key': APP_KEY,
      'X-LC-Session': localStorage.getItem('sg_token')||''
    }
  });
  const data = await res.json();
  if(!res.ok) return null;
  return (data.results && data.results[0] && data.results[0].objectId) || null;
}

// å»ºç«‹æ”¶è—
async function createFavorite(pid){
  const me = getMe(); if(!me){ alert('è«‹å…ˆç™»å…¥å†æ”¶è—'); return null; }
  const payload = {
    user:    { "__type":"Pointer","className":"_User","objectId": me.objectId },
    product: { "__type":"Pointer","className":"Product","objectId": pid },
    // å»ºè­°ï¼šæ¯ç­†ç‰©ä»¶è¨­ ACLï¼Œåªå…è¨±æœ¬äººè®€å¯«
    ACL: {
      "*": { "read": false },
      [me.objectId]: { "read": true, "write": true }
    }
  };
  const res = await fetch(`${API}/classes/Favorite`,{
    method:'POST',
    headers:{
      'Content-Type': 'application/json',
      'X-LC-Id': APP_ID,
      'X-LC-Key': APP_KEY,
      'X-LC-Session': localStorage.getItem('sg_token')||''
    },
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if(!res.ok){ alert(data.error || 'æ”¶è—å¤±æ•—'); return null; }
  return data.objectId;
}

// å–æ¶ˆæ”¶è—
async function deleteFavorite(favId){
  const res = await fetch(`${API}/classes/Favorite/${favId}`,{
    method:'DELETE',
    headers:{
      'X-LC-Id': APP_ID,
      'X-LC-Key': APP_KEY,
      'X-LC-Session': localStorage.getItem('sg_token')||''
    }
  });
  if(!res.ok){
    const d = await res.json().catch(()=>({}));
    alert(d.error || 'å–æ¶ˆæ”¶è—å¤±æ•—');
    return false;
  }
  return true;
}

// åˆ·æ–°æŒ‰éˆ•å¤–è§€
async function refreshFavBtn(){
  const id = await findFavoriteId(pid);
  favBtn.dataset.favId = id || '';
  if(id){
    favBtn.classList.add('faved');
    favBtn.textContent = 'â™¥';        // å·²æ”¶è—
  }else{
    favBtn.classList.remove('faved');
    favBtn.textContent = 'â™¡';        // æœªæ”¶è—
  }
}

// é»æ“Šåˆ‡æ›æ”¶è—
favBtn.addEventListener('click', async ()=>{
  const me = getMe(); if(!me){ alert('è«‹å…ˆç™»å…¥å†æ”¶è—'); return; }
  const currentId = favBtn.dataset.favId || '';
  if(currentId){
    const ok = await deleteFavorite(currentId);
    if(ok) await refreshFavBtn();
  }else{
    const id = await createFavorite(pid);
    if(id) await refreshFavBtn();
  }
});

// é€²é åˆå§‹åŒ–ï¼ˆæ”¾åœ¨ DOM æº–å‚™å¥½å¾Œå‘¼å«å³å¯ï¼‰
refreshFavBtn();
/* === åœ–ç‰‡å·¦å³åˆ‡æ›ï¼ˆä¸æ”¹ HTMLï¼‰ === */
let G_IMAGES = [], gIndex = 0;

function setMain(i){
  if(!G_IMAGES.length) return;
  gIndex = (i + G_IMAGES.length) % G_IMAGES.length;      // ç’°ç‹€
  document.getElementById('gMain').src = G_IMAGES[gIndex];
  // ç¸®åœ– active ç‹€æ…‹
  const thumbs = document.querySelectorAll('#gStrip .g-thumb');
  thumbs.forEach((t,idx)=> t.style.outline = (idx===gIndex)?'2px solid var(--brand)':'none');
}
function stepGallery(delta){ setMain(gIndex + delta); }

/* æ”¹å¯« renderGalleryï¼šå»ºç«‹ç®­é ­ã€ç¸®åœ–é»æ“ŠåŒæ­¥ç´¢å¼• */
const _renderGallery_orig = renderGallery;
renderGallery = function(p){
  // 1) è’é›†æ‰€æœ‰åœ–ç‰‡
  const imgs = [
    getFileUrl(p.imageUrl),
    ...(Array.isArray(p.images) ? p.images.map(getFileUrl) : [])
  ].filter(Boolean);
   G_IMAGES = imgs.slice(); gIndex = 0;

  // 2) åŸæœ¬è¡Œç‚º
  const gMain  = document.getElementById('gMain');
  const gStrip = document.getElementById('gStrip');
  gStrip.innerHTML = '';
  imgs.forEach((url,idx)=>{
    const im = document.createElement('img');
    im.className='g-thumb'; im.src=url; im.alt='ç¸®åœ–';
    im.onclick=()=> setMain(idx);
    gStrip.appendChild(im);
  });

  // 3) æ”¾ä¸Šå·¦å³ç®­é ­ï¼ˆåªå»ºç«‹ä¸€æ¬¡ï¼‰
  const wrap = document.querySelector('.gallery');
  wrap.setAttribute('data-count', String(imgs.length || 0));
  if(!wrap.querySelector('.g-nav')){
    const nav = document.createElement('div');
    nav.className = 'g-nav';
    nav.innerHTML = `
      <div class="g-arrow g-arrow-left"  aria-label="ä¸Šä¸€å¼µ">â€¹</div>
      <div class="g-arrow g-arrow-right" aria-label="ä¸‹ä¸€å¼µ">â€º</div>`;
    wrap.appendChild(nav);
    nav.querySelector('.g-arrow-left').addEventListener('click',  e=>{ e.stopPropagation(); stepGallery(-1); });
    nav.querySelector('.g-arrow-right').addEventListener('click', e=>{ e.stopPropagation(); stepGallery(+1); });
  }

  // 4) è¨­å®šç¬¬ä¸€å¼µ
  setMain(0);
};
/* ===== è©•è«–ï¼šè¨­å®š ===== */
const C_PAGE_LIMIT = 100;            // ä¸€æ¬¡æŠ“å¹¾å‰‡ï¼ˆå±•é–‹æ™‚ï¼‰
const C_COLLAPSED_SHOW = 1;//å±•ç¤º
let C_ALL = [];
function renderCommentsPreview(){                 // â† å°åŒ¡åªç•«å‰ 2 å‰‡
  const box = document.getElementById('comments');
  const list = document.getElementById('cList');
  list.innerHTML = '';
  (C_ALL.slice(0, C_COLLAPSED_SHOW)).forEach(c => list.appendChild(renderOneComment(c, /*ownCheck*/true)));
  document.getElementById('cCount').textContent = `${C_ALL.length} å‰‡`;
  box.style.display = 'block';
  requestAnimationFrame(()=>{ box.classList.remove('anim-hide'); box.classList.add('anim-show'); });
}          // æ‘ºç–Šé è¦½å¹¾å‰‡
let C_FULL_OPEN = false;             // ç•¶å‰æ˜¯å¦å±•é–‹

// ä½ å¯åœ¨æ§åˆ¶å°å…ˆå»ºç©ºé¡ï¼ˆä¹Ÿå¯ç¨‹å¼ç¬¬ä¸€æ¬¡å¯«å…¥è‡ªå‹•å»ºï¼‰
// === å°åŒ¡ï¼šåªé¡¯ç¤ºå‰ C_COLLAPSED_SHOW å‰‡ï¼ˆä½ å·²ç¶“æœ‰ renderCommentsPreviewï¼Œå¯ä¿ç•™ä½ é‚£ç‰ˆï¼‰

// === å…±ç”¨ï¼šæ¸²æŸ“å–®ä¸€è©•è«–ï¼ˆownCheck=true æ™‚ï¼Œè‡ªå·±çš„æœƒå‡ºç¾åˆªé™¤éˆ•ï¼‰
function renderOneComment(c, ownCheck){
  const u = c.user || {};
  const me = JSON.parse(localStorage.getItem('sg_user')||'null');
  const isOwn = !!(ownCheck && me && u && (u.objectId === me.objectId));

  const avatar = (u.avatarUrl||'').replace(/^http:\/\//,'https://') || 'https://via.placeholder.com/60?text=%F0%9F%98%8A';
  const name = u.nickname || u.username || 'ç”¨æˆ¶';
  const time = fmtTime(c.createdAt);
  const text = escapeHTML(c.text || '');
  const photos = Array.isArray(c.photos) ? c.photos : [];

  const wrap = document.createElement('div');
  wrap.className = 'c-item' + (isOwn ? ' own' : '');
  wrap.innerHTML = `
    <img class="c-avatar" src="${avatar}" alt="">
    <div class="c-body">
      <div class="c-meta">
        <span class="c-name">${escapeHTML(name)}</span>
        <span class="c-time">${time}</span>
      </div>
      <div class="c-text">${text}</div>
      ${photos.length ? `<div class="c-photos">${photos.map(u=>`<img class="c-photo" src="${u}" alt="">`).join('')}</div>` : ''}
    </div>
    ${isOwn ? `<button class="c-del" onclick="deleteComment('${c.objectId}', this)">åˆªé™¤</button>` : '' }
  `;
  return wrap;
}

// === å¤§åŒ¡æ§åˆ¶ ===
function isPanelOpen(){
  return document.getElementById('cPanelBackdrop').classList.contains('show');
}

function rebuildFullList(){
  const body = document.getElementById('cpBody');
  body.innerHTML = '';
  C_ALL.forEach(c => body.appendChild(renderOneComment(c, true)));
  document.getElementById('cpCount').textContent = `ï¼ˆ${C_ALL.length} å‰‡ï¼‰`;
}

function openCPanel(){
  rebuildFullList();
  const bd = document.getElementById('cPanelBackdrop');
  const panel = document.getElementById('cPanel');
  bd.classList.add('show');
  // ç”¨ rAF è§¸ç™¼éæ¸¡
  requestAnimationFrame(()=>{
    bd.classList.add('visible');
    panel.classList.add('enter');
  });
  // é»ç°è‰²èƒŒæ™¯å°±é—œ
  bd.addEventListener('click', onBackdropClick);
  // ESC é—œé–‰
  document.addEventListener('keydown', onEscClose);
}

function closeCPanel(){
  const bd = document.getElementById('cPanelBackdrop');
  const panel = document.getElementById('cPanel');
  bd.classList.remove('visible');
  panel.classList.remove('enter');
  // ç­‰å‹•ç•«çµæŸå†æŠŠ display:none æ‹¿æ‰
  setTimeout(()=>{ bd.classList.remove('show'); }, 220);
  bd.removeEventListener('click', onBackdropClick);
  document.removeEventListener('keydown', onEscClose);
}

function onBackdropClick(e){
  // åªåœ¨é»åˆ°ã€Œç°åº•ã€æ™‚é—œé–‰ï¼›é»åˆ°é¢æ¿æœ¬é«”ä¸é—œ
  if(e.target && e.target.id === 'cPanelBackdrop') closeCPanel();
}

function onEscClose(e){
  if(e.key === 'Escape') closeCPanel();
}

// === åˆªé™¤ï¼ˆå¾Œç«¯çœŸåˆªï¼ŒLeanCloud ä¾ ACL é™åˆ¶åªæœ‰ä½œè€…èƒ½åˆªï¼‰
async function deleteComment(id, btn){
  const token = localStorage.getItem('sg_token')||'';
  if(!token){ alert('è«‹å…ˆç™»å…¥'); return; }
  if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡è©•è«–ï¼Ÿ')) return;

  const item = btn.closest('.c-item');
  // å…ˆåšä¸€å€‹ã€Œéˆå‹•ã€é€€å ´
  item.style.transition = 'opacity .16s ease, transform .18s ease';
  item.style.opacity = '.0';
  item.style.transform = 'scale(.98)';

  try{
    const r = await fetch(`${API}/classes/Comment/${id}`,{
      method:'DELETE',
      headers:{ 'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY, 'X-LC-Session': token }
    });
    if(!r.ok){
      const d = await r.json().catch(()=>({}));
      throw new Error(d.error || 'åˆªé™¤å¤±æ•—');
    }
    // å¾å¿«å–ç§»é™¤ä¸¦åˆ·æ–°
    C_ALL = C_ALL.filter(x => x.objectId !== id);
    renderCommentsPreview();
    if (isPanelOpen()) rebuildFullList();
  }catch(e){
    // é‚„åŸå‹•æ•ˆ
    item.style.opacity = '1';
    item.style.transform = 'none';
    alert(e.message || 'åˆªé™¤å¤±æ•—');
  }
}
/* ===== å°å·¥å…· ===== */
function fmtTime(iso){
  const d = new Date(iso);
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  const hh=String(d.getHours()).padStart(2,'0'), mi=String(d.getMinutes()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
}
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

async function uploadManyC(fileList, limit=3){
  const files = Array.from(fileList||[]).slice(0, limit);
  const urls=[];
  for(const f of files){
    // åœ–ç‰‡å¯é©åº¦å£“å°ï¼ˆçœæµï¼‰â†’ å¦‚éœ€å®¢ç«¯å£“ç¸®å¯å†åŠ ï¼Œé€™è£¡å…ˆç›´æ¥ä¸Šå‚³
    const base64 = await fileToBase64(f);
    const r = await fetch(`${API}/files/${encodeURIComponent(f.name)}`,{
      method:'POST',
      headers:{ 'Content-Type':'application/json','X-LC-Id':APP_ID,'X-LC-Key':APP_KEY },
      body: JSON.stringify({ base64 })
    });
    const d = await r.json();
    if(!r.ok) throw new Error(d.error||'åœ–ç‰‡ä¸Šå‚³å¤±æ•—');
    urls.push(d.url);
  }
  return urls;
}

/* ===== è®€å– & æ¸²æŸ“ ===== */
async function loadComments(){
  try{
    const where = encodeURIComponent(JSON.stringify({
      product: { "__type":"Pointer","className":"Product","objectId": pid }
    }));
    // include=user å–é ­è²¼/æš±ç¨±
    const res = await fetch(`${API}/classes/Comment?where=${where}&order=-createdAt&limit=${C_PAGE_LIMIT}&include=user`,{
      headers:{ 'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY }
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error||'è®€å–è©•è«–å¤±æ•—');

    C_ALL = data.results || [];
document.getElementById('cCount').textContent = `${C_ALL.length} å‰‡`;
renderCommentsPreview();          // â† æ›é€™è¡Œ
document.getElementById('comments').style.display = 'block';
  }catch(e){
    console.warn(e);
    document.getElementById('comments').style.display = 'block';
  }
}

function renderComments(){
  const list = document.getElementById('cList');
  list.innerHTML = '';
  const showing = C_FULL_OPEN ? C_ALL : C_ALL.slice(0, C_COLLAPSED_SHOW);

  showing.forEach(c=>{
    const u = c.user || {};
    const avatar = (u.avatarUrl||'').replace(/^http:\/\//,'https://') || 'https://via.placeholder.com/60?text=%F0%9F%98%8A';
    const name = u.nickname || u.username || 'ç”¨æˆ¶';
    const time = fmtTime(c.createdAt);
    const text = escapeHTML(c.text || '');
    const photos = Array.isArray(c.photos) ? c.photos : [];

    const item = document.createElement('div');
    item.className = 'c-item';
    item.innerHTML = `
      <img class="c-avatar" src="${avatar}" alt="">
      <div class="c-body">
        <div class="c-meta">
          <span class="c-name">${escapeHTML(name)}</span>
          <span class="c-time">${time}</span>
        </div>
        <div class="c-text">${text}</div>
        ${photos.length ? `<div class="c-photos">${photos.map(u=>`<img class="c-photo" src="${u}" alt="">`).join('')}</div>` : ''}
      </div>`;
    list.appendChild(item);
  });

  const btn = document.getElementById('cToggleBtn');
  if (C_ALL.length <= C_COLLAPSED_SHOW){
    btn.style.display = 'none';
  }else{
    btn.style.display = 'inline-block';
    btn.textContent = C_FULL_OPEN ? 'æ”¶èµ·' : 'å±•é–‹å…¨éƒ¨';
  }
}

function toggleComments(){
  C_FULL_OPEN = !C_FULL_OPEN;
  renderComments();
}

/* ===== ç™¼ä½ˆè©•è«–ï¼šé–‹é—œ Modal ===== */
function openCModal(){
  const me = JSON.parse(localStorage.getItem('sg_user')||'null');
  if(!me){ alert('è«‹å…ˆç™»å…¥å†ç™¼ä½ˆè©•è«–'); return; }
  document.getElementById('cErr').textContent='';
  document.getElementById('cText').value='';
  document.getElementById('cFiles').value='';
  document.getElementById('cModal').style.display='flex';
}
function closeCModal(){ document.getElementById('cModal').style.display='none'; }

/* ===== ç™¼ä½ˆè©•è«–ï¼šé€å‡º ===== */
async function submitComment(){
  const me = JSON.parse(localStorage.getItem('sg_user')||'null');
  const token = localStorage.getItem('sg_token')||'';
  if(!me || !token){ alert('è«‹å…ˆç™»å…¥'); return; }

  const text = (document.getElementById('cText').value||'').trim();
  const files = document.getElementById('cFiles').files;
  const errEl = document.getElementById('cErr');

  if(!text && (!files || !files.length)){
    errEl.textContent = 'è«‹è¼¸å…¥è©•è«–å…§å®¹æˆ–ä¸Šå‚³åœ–ç‰‡ï¼ˆæ“‡ä¸€å³å¯ï¼‰';
    return;
  }
  errEl.textContent = '';

  try{
    // 1) ä¸Šå‚³åœ–ç‰‡ï¼ˆæœ€å¤š 3ï¼‰
    const photos = await uploadManyC(files, 3);

    // 2) å»ºç«‹ Comment
    const payload = {
      product: { "__type":"Pointer","className":"Product","objectId": pid },
      user:    { "__type":"Pointer","className":"_User","objectId": me.objectId },
      text,
      photos,
      ACL: { "*": { "read": true }, [me.objectId]: { "read": true, "write": true } }
    };
    const res = await fetch(`${API}/classes/Comment`,{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY,
        'X-LC-Session': token
      },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error||'ç™¼ä½ˆå¤±æ•—');

    // 3) é—œé–‰ã€åˆ·æ–°
    closeCModal();
    await loadComments();
    // é è¨­é¡¯ç¤ºæœ€æ–°åœ¨æœ€ä¸Šæ–¹
    C_FULL_OPEN = false;
renderCommentsPreview();
if (isPanelOpen()) rebuildFullList();
  }catch(e){
    errEl.textContent = e.message || 'ç™¼ä½ˆå¤±æ•—';
  }
}

/* å•Ÿå‹•æ™‚é †ä¾¿è¼‰å…¥è©•è«– */
loadComments();
</script>
<script src="im.js"></script>
<script src="lioc.js?v=0.1.1"></script>
<!--=================-->
<p style="text-align: center; font-size: 13px; color: #999; margin-top: 40px;">
  ğŸ¾ Â© 2024 yinnlimçš„å°å®‡å®™ï½œå…§å®¹èˆ‡è¨­è¨ˆçš†ç”±ç³–ç³–æœ¬äººç”¨æ„›è£½ä½œ ğŸ’<br>
  æœªç¶“æˆæ¬Šè«‹å‹¿éš¨æ„ä½¿ç”¨ã€ç›œè½‰å–” ğŸ™…â€â™€ï¸ è¬è¬ä½ çš„å°Šé‡èˆ‡æº«æŸ” ğŸ’Œ
</p>
</body>
</html>