<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>è³¼ç‰©é¦–é </title>
<style>
  :root{
    --glass-bg: rgba(255,255,255,.55);
    --glass-border: rgba(255,255,255,.7);
    --brand:#6c4ef7; --text:#222; --muted:#777; --accent:#e91e63;
  }
  *{box-sizing:border-box}
  body{
  margin:0;
  font-family:"DFKai-SB","KaiTi","æ¨™æ¥·é«”","BiauKai",serif;
  background:#fafafa;
  color:var(--text);
  padding-top:72px;
}
  .navbar{ position:fixed; inset:0 0 auto 0; height:72px; display:flex; align-items:center; justify-content:space-between; padding:0 18px; background:var(--glass-bg); backdrop-filter: blur(12px) saturate(120%); -webkit-backdrop-filter: blur(12px) saturate(120%); border-bottom:1px solid var(--glass-border); z-index:1000; }
  /* è®“æœå°‹åˆ—å¯ä»¥ç›¸å° brand çµ•å°å®šä½ */
  .brand{ position:relative; display:flex; align-items:center; gap:0px; font-weight:700; color:var(--brand); }
  .brand img{ width:32px; height:32px; border-radius:8px; }
  .nav-right{ display:flex; align-items:center; gap:10px; }
  .btn{ padding:8px 12px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; font-weight:600; }
  .btn.primary{ background:var(--brand); color:#fff; border-color:transparent; }
  .user-chip{ display:flex; align-items:center; gap:10px; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #eaeaea; text-decoration:none; color:inherit; }
  .user-chip img{ width:28px; height:28px; border-radius:50%; object-fit:cover; }
  .container{ max-width:1120px; margin:20px auto; padding:0 16px; }
  .product-grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); gap:20px; }
  .card{ display:block; background:#fff; border:1px solid #eee; border-radius:14px; overflow:hidden; box-shadow:0 6px 18px rgba(0,0,0,.06); transition:.18s; color:inherit; text-decoration:none; }
  .card:hover{ transform:translateY(-3px); box-shadow:0 10px 24px rgba(0,0,0,.08); }
  .thumb{ width:100%; height:180px; object-fit:cover; background:#f3f3f3; }
  .card-body{ padding:12px; }
  .title{ font-weight:700; font-size:16px; line-height:1.4; margin:4px 0 8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .meta-line{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; }
  .price{ color:var(--accent); font-weight:800; }
  .seller{ color:var(--muted); font-size:13px; max-width:50%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  @media (max-width:520px){ .navbar{ height:64px; } body{ padding-top:64px; } .thumb{ height:160px; } }
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:2000; padding:16px; }
  .modal{ width:min(460px,92vw); background:#fff; border:1px solid #eee; border-radius:14px; box-shadow:0 16px 40px rgba(0,0,0,.18); overflow:hidden; }
  .modal header{ padding:12px 14px; font-weight:800; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
  .modal .body{ padding:14px; }
  .modal .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .modal .field{ margin:8px 0; width:100%; }
  .modal label{ display:block; font-size:12px; color:#777; margin-bottom:6px; }
  .modal .input,.modal .file{ width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px; outline:none; }
  .modal .actions{ padding:10px 14px; border-top:1px solid #eee; display:flex; gap:10px; justify-content:flex-end; }
  .modal .err{ color:#b00020; font-size:13px; margin-top:6px; }
  .closex{ cursor:pointer; font-size:22px; line-height:1; color:#888; }
  /* === Hero å»£å‘Šæ¿ === */
.hero {
  position: relative;
  max-width: 1120px;
  margin: 16px auto 0;
  padding: 0 16px;
}
.hero-frame {
  position: relative;
  border-radius: 14px;
  overflow: hidden;
  background: #eee;
  aspect-ratio: 16/6;  /* è‡ªå‹•ç­‰æ¯”é«˜åº¦ï¼Œæ‰‹æ©Ÿä¹Ÿå¥½çœ‹ */
}
.hero-track {
  display: flex;
  width: 100%;
  height: 100%;
  transform: translateX(0);
  transition: transform .45s ease;
}
.hero-slide {
  min-width: 100%;
  height: 100%;
  position: relative;
}
.hero-slide img {
  width: 100%;
  height: 100%;
  object-fit: contain;  /* æ”¹æˆ contain */
  background: #ddd;     /* ç•™åº•è‰²ï¼Œé¿å…ç©ºç™½ */
}
.hero-slide a { display:block; width:100%; height:100%; }
.hero-dots {
  position: absolute; left:50%; bottom:10px; transform:translateX(-50%);
  display:flex; gap:8px; z-index:5;
}
.hero-dot {
  width:8px; height:8px; border-radius:50%;
  background: rgba(255,255,255,.6); border:1px solid rgba(0,0,0,.15);
  cursor:pointer;
}
.hero-dot.active { background:#fff; }
.hero-nav {
  position:absolute; inset:0; display:flex; justify-content:space-between; align-items:center; pointer-events:none;
}
.hero-btn {
  pointer-events:auto; user-select:none;
  width:42px; height:42px; border-radius:50%; border:1px solid rgba(0,0,0,.1);
  background:rgba(255,255,255,.75); backdrop-filter:blur(6px);
  display:grid; place-items:center; margin:0 6px; cursor:pointer; font-weight:900;
}
@media (max-width:600px){
  .hero-frame{ aspect-ratio: 16/9; }
}
/* å»£å‘Šæ¿å³ä¸‹è§’æŠ•æ”¾å»£å‘ŠæŒ‰éˆ• */
.ad-fab {
  position: absolute;
  right: 16px;
  bottom: 16px;
  width: 44px;
  height: 44px;
  border-radius: 8px;
  background: var(--brand);
  color: #fff;
  font-size: 24px;
  font-weight: 700;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 3px 8px rgba(0,0,0,.25);
  z-index: 20;
  transition: background .2s ease;
}
.ad-fab:hover {
  background: #5339c9; /* æ·±ä¸€é»çš„å“ç‰Œè‰² */
}
.section-title{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;                 /* æ–‡å­—å’Œç·šçš„é–“è· */
  margin:20px auto 20px;    /* èˆ‡å»£å‘Šæ¿ã€å•†å“å€çš„è·é›¢ */
  font-size:18px;
  font-weight:700;
  color:#fd85ff;
  text-align:center;
}
.section-title::before,
.section-title::after{
  content:"";
  flex:1;                   /* å…©å´ç·šè‡ªå‹•å»¶ä¼¸ */
  border-top:2px dashed #fd85ff;  /* æƒ³è¦å¯¦ç·šå°±æ”¹æˆ solid */
  opacity:.9;
}

.section-title::before { left: 0; }
.section-title::after  { right: 0; }
.io-line{
  margin-top:4px;
  font-size:13px;
  color:#6c4ef7;   /* æƒ³è¦ä½èª¿ä¸€é»å¯æ”¹æˆ #777 */
  font-weight:700;
}
/*---------æœå°‹*/
/* ğŸ” æŒ‰éˆ•ï¼šä¿ç•™å¾®äº’å‹• */
.search-btn{
  margin-left:8px; width:36px; height:36px; border-radius:999px;
  border:1px solid #ddd; background:#fff; cursor:pointer; font-size:18px; line-height:1;
  display:flex; align-items:center; justify-content:center;
  transition: transform .12s ease, box-shadow .18s ease, border-color .18s ease;
}
.search-btn:hover{ transform: translateY(-1px); box-shadow:0 6px 14px rgba(0,0,0,.08); }

/* â–¶ è®“ .brand è£¡çš„å…§å®¹èƒ½æ°´å¹³æ’ã€ä¸¦é ç•™ç©ºé–“ */
.brand{ position:relative; display:flex; align-items:center; gap:0; font-weight:700; color:var(--brand); }

/* â–¶ æœå°‹åˆ—ã€Œå¾å·¦é‚Šï¼ˆğŸ”ï¼‰å¾€å³å±•é–‹ã€ï¼Œä¸æœƒè¦†è“‹ hero */
/* â–¶ æœå°‹åˆ—ã€Œå¾å·¦é‚Šï¼ˆğŸ”ï¼‰å¾€å³å±•é–‹ã€ï¼Œä¸æœƒè¦†è“‹ hero */
.search-bar{
  position: relative;        /* â† é€™è£¡å¾ static æ›æˆ relative */
  display:inline-flex; align-items:center; gap:8px;
  overflow:hidden;
  white-space:nowrap;

  width:0;
  opacity:0;
  transform:scaleX(.92);
  transform-origin:left center;
  pointer-events:none;
  visibility:hidden;

  margin-left:8px;
  background:#fff;
  border:1px solid #ddd; border-radius:999px; padding:6px 8px;
  box-shadow:0 8px 20px rgba(0,0,0,.10);

  transition:
    width .26s cubic-bezier(.2,.8,.2,1),
    opacity .2s ease,
    transform .26s cubic-bezier(.2,.8,.2,1),
    visibility 0s linear .26s;
}

.search-bar.show{
  overflow: visible;
  width: clamp(260px, 44vw, 520px);  /* å±•é–‹çš„ç›®æ¨™å¯¬åº¦ */
  opacity:1;
  transform:scaleX(1);
  pointer-events:auto;
  visibility:visible;
  transition:
    width .3s cubic-bezier(.2,.8,.2,1),
    opacity .2s ease,
    transform .3s cubic-bezier(.2,.8,.2,1),
    visibility 0s;
}

.search-input{
  border:none; outline:none; width:100%; font-size:14px;
}
.search-go, .search-close{
  border:1px solid #eee; background:#f9f9f9; border-radius:999px; padding:6px 10px; cursor:pointer;
  transition: transform .12s ease, box-shadow .18s ease;
}
.search-go:hover, .search-close:hover{ transform: translateY(-1px); box-shadow:0 6px 12px rgba(0,0,0,.08); }
.search-close{ border:none; background:transparent; font-size:18px; padding:0 6px; }

@media (max-width:600px){
  .search-bar.show{ width: clamp(220px, 72vw, 520px); }
}
/*------æœå°‹-------åŒ¡---*/
/* ===== æœå°‹ä¸‹æ‹‰å»ºè­° ===== */
.suggest-box{
  position:absolute; left:0; top:100%;
  margin-top:6px;
  width:100%;                /* â† ç”¨ 100% å°é½Š .search-bar çš„å¯¦éš›å¯¬åº¦ */
  min-width:260px;           /* å¯ä¿ç•™ä¸‹é™ */
  max-width:520px;           /* èˆ‡ search-bar çš„ä¸Šé™ä¸€è‡´ */
  background:#fff; border:1px solid #eee; border-radius:12px;
  box-shadow:0 10px 24px rgba(0,0,0,.10);
  overflow:hidden; z-index:1200; display:none;
}
.suggest-item{
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; cursor:pointer;
}
.suggest-item:hover{ background:#f7f7ff; }
.suggest-avatar{ width:30px; height:30px; border-radius:50%; object-fit:cover; }
.suggest-name{ font-weight:700; }
.suggest-gid{ font-size:12px; color:#888; margin-left:auto; }
.no-suggest{ padding:10px 12px; color:#777; font-size:14px; }
.btm{
 padding:5px 5px; 
 border-radius:10px; 
 border:1px solid #fff4d6; 
 background:#ffdbb9; 
 font-weight:600; 
 cursor:pointer;
 margin-left: 10px;
}

/* ===== å¤œé–“ä¸»é¡Œè®Šæ•¸ ===== */
:root[data-theme="dark"]{
  --glass-bg: rgba(20,16,34,.65);
  --glass-border: rgba(163,143,255,.14);

  --text:#cfc3ff;          /* å…¨ç«™æ–‡å­—ï¼ˆç´«å¤–ç·šæ„Ÿï¼‰ */
  --muted:#9a8fd1;         /* æ¬¡è¦æ–‡å­— */
  --brand:#a48cff;         /* å“ç‰Œç´« */
  --accent:#bf66ff;        /* åƒ¹æ ¼/é‡é»è‰²ï¼ˆæ·±ç´«ç²‰ï¼‰ */

  --card-bg:#161222;       /* å¡ç‰‡/ä¸‹æ‹‰/è¼¸å…¥åº•è‰² */
  --card-border:#2b2440;   /* å¡ç‰‡é‚Šæ¡† */
  --page-bg:#0f0b1a;       /* é é¢åº•è‰² */

  --btn-bg:#1b1629;        /* ä¸€èˆ¬æŒ‰éˆ•åº•è‰² */
  --btn-border:#2b2440;
  --btn-text:#cfc3ff;

  --chip-bg:#1b1629;       /* user-chip */
  --chip-border:#2b2440;

  --shadow: 0 10px 28px rgba(0,0,0,.45);
}
/* å¤œé–“ï¼šå»£å‘Šæ¿åº•è‰²è¦æš— */
:root[data-theme="dark"] .hero-frame {
  background: #612a84;   /* æ·±ç´«é»‘åº•ï¼Œé¿å…ç™½è‰²åˆºçœ¼ */
}

/* å¤œé–“ï¼šå»£å‘Šåœ–æ²’å¡«æ»¿ï¼ˆobject-fit: contain æ™‚ï¼‰éœ²å‡ºçš„èƒŒæ™¯ */
:root[data-theme="dark"] .hero-slide img {
  background: #74268c;
}

/* ===== å…¨ç«™è¦†å¯«ï¼šè®“é¡è‰²è·Ÿè‘—è®Šæ•¸èµ° ===== */
:root[data-theme="dark"] body{
  background:var(--page-bg);
  color:var(--text);
  font-family:"DFKai-SB","KaiTi","æ¨™æ¥·é«”","BiauKai",serif; /* æ°¸é ä¿ç•™å°æ¥· */
}

/* é ‚éƒ¨æ¬„ï¼ˆç»ç’ƒæ„Ÿï¼‰ */
:root[data-theme="dark"] .navbar{
  background:var(--glass-bg);
  border-bottom:1px solid var(--glass-border);
  backdrop-filter: blur(12px) saturate(120%);
  -webkit-backdrop-filter: blur(12px) saturate(120%);
}
:root[data-theme="dark"] .brand{ color:var(--brand); }

/* ä¸€èˆ¬æŒ‰éˆ• / ä¸»è¦æŒ‰éˆ• */
:root[data-theme="dark"] .btn{
  background:var(--btn-bg);
  border:1px solid var(--btn-border);
  color:var(--btn-text);
  box-shadow:none;
}
:root[data-theme="dark"] .btn.primary{
  background:var(--brand);
  color:#161222;
  border-color:transparent;
}
/* ã€Œæ‰¾å›/é‡ç½® å¯†ç¢¼ã€é‚£é¡† btm */
:root[data-theme="dark"] .btm{
  background:var(--btn-bg);
  border:1px solid var(--btn-border);
  color:var(--text);
}
:root[data-theme="dark"] .btm a{ color:var(--text); }

/* ä½¿ç”¨è€… chip */
:root[data-theme="dark"] .user-chip{
  background:var(--chip-bg);
  border:1px solid var(--chip-border);
  color:var(--text);
}

/* å¡ç‰‡/å•†å“/é™°å½± */
:root[data-theme="dark"] .card,
:root[data-theme="dark"] .modal,
:root[data-theme="dark"] .dropdown{
  background:var(--card-bg);
  color:var(--text);
  border:1px solid var(--card-border);
  box-shadow:var(--shadow);
}
:root[data-theme="dark"] .card:hover{
  transform:translateY(-3px);
  box-shadow:0 16px 40px rgba(0,0,0,.55);
}

/* å•†å“ç¸®åœ–åº•è‰²ã€hero åº•è‰² */
:root[data-theme="dark"] .thumb{ background:#1e1930; }
:root[data-theme="dark"] .hero-frame{ background:#1e1930; }

/* å•†å“è³‡è¨Š */
:root[data-theme="dark"] .price{ color:var(--accent); }
:root[data-theme="dark"] .seller{ color:var(--muted); }
:root[data-theme="dark"] .io-line{ color:var(--brand); }

/* Modal ç´°ç¯€ */
:root[data-theme="dark"] .modal header{
  border-bottom:1px solid var(--card-border);
}
:root[data-theme="dark"] .modal .input,
:root[data-theme="dark"] .modal .file{
  background:transparent;
  color:var(--text);
  border:1px solid var(--card-border);
}
:root[data-theme="dark"] .modal .actions{
  border-top:1px solid var(--card-border);
}
:root[data-theme="dark"] .closex{ color:#a79be0; }

/* æœå°‹ï¼ˆæŒ‰éˆ•ï¼‹å±•é–‹åˆ—ï¼‹å»ºè­°ï¼‰ */
:root[data-theme="dark"] .search-btn{
  background:var(--btn-bg);
  border:1px solid var(--btn-border);
  color:var(--text);
}
:root[data-theme="dark"] .search-bar{
  background:var(--card-bg);
  border:1px solid var(--card-border);
  color:var(--text);
  box-shadow:0 12px 28px rgba(0,0,0,.45);
}
:root[data-theme="dark"] .search-input{ color:var(--text); }
:root[data-theme="dark"] .search-go,
:root[data-theme="dark"] .search-close{
  background:#1e1930;
  border:1px solid var(--card-border);
  color:var(--text);
}
:root[data-theme="dark"] .suggest-box{
  background:var(--card-bg);
  border:1px solid var(--card-border);
  color:var(--text);
}
:root[data-theme="dark"] .suggest-item:hover{ background:rgba(164,140,255,.12); }
:root[data-theme="dark"] .no-suggest{ color:var(--muted); }

/* ä¸‹æ‹‰é¸å–®ï¼ˆå½ˆåŒ¡ï¼‰ï¼†éˆå‹•æ„Ÿ hover */
:root[data-theme="dark"] .menu-btn{
  background:var(--btn-bg);
  border:1px solid var(--btn-border);
  color:var(--btn-text);
}
:root[data-theme="dark"] .dropdown .item:hover{
  background:rgba(164,140,255,.12);
  transform:translateY(-1px);
  transition:transform .12s ease, background .18s ease;
}

/* Hero å°åœ“é»ï¼‹å·¦å³ç®­é ­ */
:root[data-theme="dark"] .hero-dot{
  background:rgba(255,255,255,.35);
  border:1px solid rgba(255,255,255,.18);
}
:root[data-theme="dark"] .hero-dot.active{ background:#fff; }
:root[data-theme="dark"] .hero-btn{
  background:rgba(36,30,56,.85);
  border:1px solid var(--card-border);
  color:#ddd;
}

/* æµ®å‹•ã€Œï¼‹ã€æŠ•æ”¾å»£å‘ŠæŒ‰éˆ• */
:root[data-theme="dark"] .ad-fab{
  background:var(--brand);
  color:#161222;
  box-shadow:0 6px 18px rgba(0,0,0,.55);
}

/* åˆ†æ®µæ¨™é¡Œç·šæ¢èˆ‡é¡è‰² */
:root[data-theme="dark"] .section-title{
  color:#d89bff;
}
:root[data-theme="dark"] .section-title::before,
:root[data-theme="dark"] .section-title::after{
  border-top:2px dashed #d89bff;
  opacity:.9;
}

/* é€£çµé¡è‰²ï¼ˆå¦‚éœ€è¦ï¼‰ */
:root[data-theme="dark"] a{ color:var(--brand); }
/* ===== ä¸‹æ‹‰é¸å–®ï¼ˆå½ˆåŒ¡ï¼‰æ¨£å¼ï¼‹å‹•ç•« ===== */
.menu-wrap{ position:relative; }
.menu-btn{
  padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:800; line-height:1;
  border:1px solid #ddd; background:#fff; color:#222;
}
:root[data-theme="dark"] .menu-btn{
  border-color:var(--btn-border); background:var(--btn-bg); color:var(--btn-text);
}

.dropdown{
  position:absolute; right:0; top:calc(100% + 8px);
  min-width:200px; background:#fff; color:#222;
  border:1px solid #eee; border-radius:12px;
  box-shadow:0 12px 28px rgba(0,0,0,.22); padding:8px; z-index:1200;
  opacity:0; transform:translateY(-6px) scale(.98);
  visibility:hidden; pointer-events:none;
  transition:opacity .16s ease, transform .18s ease, visibility 0s linear .16s;
}
.dropdown.show{
  opacity:1; transform:translateY(0) scale(1);
  visibility:visible; pointer-events:auto; transition:opacity .16s ease, transform .18s ease;
}
:root[data-theme="dark"] .dropdown{
  background:var(--card-bg); color:var(--text); border:1px solid var(--card-border);
}

.dropdown .item{
  width:100%; text-align:left; padding:10px 12px;
  background:transparent; border:none; border-radius:8px;
  color:inherit; cursor:pointer; font-size:14px;
}
.dropdown .item:hover{ background:rgba(108,78,247,.12); }

/* è®“æœå°‹ä¸‹æ‹‰/æœå°‹åˆ—åœ¨å¤œé–“ä¹Ÿæš—è‰²ï¼ˆå¯é¸ï¼‰ */
:root[data-theme="dark"] .search-bar{
  background:var(--card-bg); border:1px solid var(--card-border); color:var(--text);
}
:root[data-theme="dark"] .search-input{ color:var(--text); }
:root[data-theme="dark"] .suggest-box{
  background:var(--card-bg); border:1px solid var(--card-border); color:var(--text);
}
/* å¤œé–“æ¨¡å¼ï¼šæ‰¾å›/é‡ç½®å¯†ç¢¼ */
:root[data-theme="dark"] .btm a {
  color: #bb86fc !important;  /* ç´«å¤–ç·šè‰² */
}
.btm a {
  color: #222;  /* äº®è‰²æ¨¡å¼ä¸‹æ­£å¸¸æ·±ç° */
  text-decoration: none;
}
/* è®“æœå°‹è¼¸å…¥æœ¬èº«è·Ÿè‘—ä¸»é¡Œæ›è‰²ï¼ˆå« iOS/Safari ç‰¹æ€§ï¼‰ */
.search-input{
  background: transparent;
  color: var(--text);
  caret-color: var(--brand);
}

/* placeholder é¡è‰²ï¼šäº®/æš—éƒ½è·Ÿè®Šæ•¸èµ° */
.search-input::placeholder{ color: var(--muted); opacity: .95; }
:root[data-theme="dark"] .search-input::placeholder{ color: var(--muted); opacity: .85; }

/* å¤œé–“ï¼šæ•´å€‹æœå°‹åˆ—åº•è‰²ã€é‚Šæ¡†å·²è·Ÿè‘—è®Šæ•¸ï¼›å†ä¿éšªæŒ‡å®šä¸€æ¬¡ */
:root[data-theme="dark"] .search-bar{
  background: var(--card-bg) !important;
  border-color: var(--card-border) !important;
  color: var(--text) !important;
}

/* âœ… è‡ªå‹•å¡«å…¥(autofill) åœ¨ Safari/Chrome æœƒå¼·åˆ¶æ·ºåº•ï¼Œé€™è£¡è¦†è“‹å®ƒ */
.search-input:-webkit-autofill,
.search-input:-webkit-autofill:hover,
.search-input:-webkit-autofill:focus{
  -webkit-text-fill-color: var(--text) !important;
  transition: background-color 9999s ease-in-out 0s !important; /* å»é»ƒåº•é–ƒçˆ */
  box-shadow: 0 0 0px 1000px #fff inset;           /* äº®è‰²æ™‚ç¶­æŒç™½åº• */
}
:root[data-theme="dark"] .search-input:-webkit-autofill,
:root[data-theme="dark"] .search-input:-webkit-autofill:hover,
:root[data-theme="dark"] .search-input:-webkit-autofill:focus{
  -webkit-text-fill-color: var(--text) !important;
  box-shadow: 0 0 0px 1000px var(--card-bg) inset !important;  /* å¤œé–“ç”¨æš—åº• */
}

/* æœå°‹æŒ‰éˆ•ä¹ŸåŒæ­¥æš—è‰²ï¼ˆè‹¥ä½ å‰é¢å·²åŠ å¯å¿½ç•¥ï¼‰ */
:root[data-theme="dark"] .search-go,
:root[data-theme="dark"] .search-close{
  background:#1e1930; border-color: var(--card-border); color: var(--text);
}
</style>
<style>
  /*æ¸¸æ¨™*/
/* é€æ˜ 1x1 æ¸¸æ¨™ï¼ˆè³‡æ–™URIï¼‰ï¼Œæ¯”å–®ç´” none æ›´ä¸æœƒè¢«ç€è¦½å™¨è‡¨æ™‚è¦†è“‹ */
:root{
  --cursor-none: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAEklEQVQImWNgYGBgYAAAAAQAARV7J8EAAAAASUVORK5CYII=') 0 0, none;
}

/* å¾¹åº•å¥—ç”¨åˆ°æ‰€æœ‰ç›’èˆ‡å½å…ƒç´  */
html, body, *, *::before, *::after{
  cursor: var(--cursor-none) !important;
}

/* ä»»ä½•åŸæœ¬æœƒæŠŠæ¸¸æ¨™æ”¹æˆ pointer / text çš„å…ƒç´ ï¼Œå¼·åˆ¶ç¹¼æ‰¿å°±ä¸æœƒè·³å›åŸç”Ÿæ¨£å¼ */
a, button, [role="button"], label, summary,
input, textarea, select, option, details, svg, canvas{
  cursor: inherit !important;
}

/* ä½ çš„è‡ªè¨‚æ¸¸æ¨™å¤–å±¤ï¼ˆä¸è®Šï¼‰ */
#cursor{
  position: fixed; left:0; top:0; width:0; height:0;
  pointer-events: none; will-change: transform; z-index: 9999;
}
/* å…§å±¤åœ–ç‰‡ï¼ˆä¸è®Šï¼‰ */
#cursor .cursor-img{
  width:32px; height:32px;
  background: url('../shoing.png') center/contain no-repeat;
  transform: translate(-8px,-12px) scale(1);
  transition: transform .12s ease; 
  will-change: transform;
}
#cursor.down .cursor-img{ 
  transform: translate(-8px,-12px) scale(.9); 
}
/* é€æ˜é®ç½©ï¼šé è¨­ä¸æ“‹äº’å‹•ï¼Œä½†åœ¨æ²å‹•ç¬é–“çŸ­æš«æ¥æ‰‹ hit-test ä»¥ä¿è­‰ cursor:none ç”Ÿæ•ˆ */
#cursor-shield{
  position: fixed;
  inset: 0;
  cursor: var(--cursor-none) !important;  /* ä¸€å¾‹éš±è—ç³»çµ±æ¸¸æ¨™ */
  pointer-events: none;                   /* å¹³å¸¸ä¸æ“‹é»æ“Š/æ»‘å‹• */
  z-index: 9998;                          /* ä½æ–¼è‡ªè¨‚æ¸¸æ¨™ #cursor */
}

/* ã€Œæ²å‹•ä¸­ã€çŸ­æš«å•Ÿç”¨å‘½ä¸­ï¼ˆåªå½±éŸ¿æ¸¸æ¨™å‘½ä¸­ï¼Œä¸æœƒå½±éŸ¿æ»¾å‹•ï¼‰ */
#cursor-shield.cover{
  pointer-events: auto;                   /* è®“å®ƒæˆç‚ºå‘½ä¸­å…ƒç´ ï¼Œæ¸¸æ¨™å°±ä¸æœƒè¢«ä¸‹é¢åŸç”Ÿæ§ä»¶å¥ªå› */
}

</style>
</head>
<body>
  <div id="cursor-shield"></div>
<div id="cursor"><div class="cursor-img"></div></div>

  <nav class="navbar">
    <div class="brand">
      <img src="favicon.ico" alt="logo">
       <span>Sunlit Grove Store</span>
       <button class="btm"><a href="in0.html">æ‰¾å›/é‡ç½® å¯†ç¢¼</a></button>
    <!-- é€™é¡†è·³è½‰æŒ‰éˆ•ï¼šåªæœ‰ç™»å…¥æ‰é¡¯ç¤º -->
    <a id="adManageBtn" href="cd.html" title="ç®¡ç†æˆ‘çš„å»£å‘Š"
       style="display:none; margin-left:8px; padding:2px 8px; border-radius:8px; border:1px solid #ddd; text-decoration:none; font-weight:700; color:#6c4ef7; background:#fff;">
      ^ - ^
    </a>
    <div class="menu-wrap">
  <button id="menuBtn" class="menu-btn" aria-expanded="false" onclick="toggleMenu()">%</button>
  <div id="menuDrop" class="dropdown" role="menu">
    <!-- ç¬¬ä¸€å€‹é¸é …ï¼šåˆ‡æ›æ¨¡å¼ -->
    <button class="item" onclick="toggleTheme()" id="modeItem">åˆ‡æ›æ¨¡å¼ï¼šå¤œé–“</button>
    <button class="item" onclick="location.href='../index.html'">ä¸»é </button>
    <button class="item" onclick="location.href='Grove.Examination-Yuan.html'">åƒåŠ ç®¡ç†å“¡</button>
    <button class="item" onclick="location.href='Grove. Control-Yuan.html'">Control</button>
    <button class="item" onclick="location.href='Grove.Executive-Yuan.html'">Executive</button>
    <button class="item" onclick="location.href='Grove.Judicial-Yuan.html'">ç”³è¨´</button>
    <button class="item" onclick="location.href='Grove.Legislative-Yuan.html'">Legislative</button>
    <button class="item" onclick="location.href='vote.html'">æŠ•ç¥¨å°ˆå€</button>
    <button class="item" onclick="location.href='constitution.html'">ç¶²ç«™ç”³æ˜</button>
    <!-- ä½ è‡ªå·±çš„å…¶å®ƒé€£çµ/æŒ‰éˆ•å¾€ä¸‹åŠ  -->
    <!-- <button class="item">æˆ‘çš„å…¶å®ƒåŠŸèƒ½</button> -->
  </div>
</div>
    <!-- ğŸ” æœå°‹ï¼ˆæŒ‰éˆ• + å¯å±•é–‹çš„æœå°‹åˆ—ï¼‰ -->
<button id="searchBtn" class="search-btn" title="æœå°‹" aria-label="æœå°‹"
        onclick="toggleSearch()">
  ğŸ”
</button>


<div id="searchBar" class="search-bar" role="search" aria-hidden="true">
  <input id="searchInput" class="search-input" type="search"
         placeholder="æœå°‹ GIDï¼æš±ç¨±ï¼å•†å“åç¨±ï¼ˆ#åªæœå•†å“å~åªæœåƒ¹æ ¼ï¼‰"
         onkeydown="if(event.key==='Enter'){ runSearch(); }">
  <button class="search-go" onclick="runSearch()">æœå°‹</button>
  <button class="search-close" aria-label="é—œé–‰æœå°‹" onclick="toggleSearch(false)">â™¡</button>
  <div id="searchSuggest" class="suggest-box" role="listbox" aria-label="æœå°‹å»ºè­°"></div>
</div>
  </div>
  <div class="nav-right" id="navRight">â€¦</div>
</nav>
    <!-- é¦–é æ»‘å‹•å»£å‘Šæ¿ -->
<section class="hero">
  <div class="hero-frame" id="adHero">
    <div class="hero-track" id="adTrack"></div>
    <div class="hero-dots" id="adDots"></div>
    <div class="hero-nav">
      <div class="hero-btn" onclick="adPrev()">â€¹</div>
      <div class="hero-btn" onclick="adNext()">â€º</div>
    </div>
    <!-- âœ… æµ®å‹•æŠ•æ”¾å»£å‘ŠæŒ‰éˆ•ï¼ˆé è¨­éš±è—ï¼Œç™»å…¥æ‰é¡¯ç¤ºï¼‰ -->
    <button class="ad-fab" id="adCreateBtn" style="display:none" onclick="openAdModal()">ï¼‹</button>
  </div>
</section>
<h5 class="section-title">Sunlit Groveå•†å“</h5>
  <main class="container">
    <div class="product-grid" id="productGrid"></div>
  </main>
  <h5 class="section-title">â‰¤IO$1å•†å“</h5>
<main class="container">
  <div class="product-grid" id="cheapGrid"></div>
</main>

  <!-- ç™»å…¥ -->
  <div class="modal-backdrop" id="loginModal">
    <div class="modal">
      <header><div>ç™»å…¥</div><div class="closex" onclick="closeModal('loginModal')">Ã—</div></header>
      <div class="body">
        <div class="field"><label>é›»å­éƒµä»¶</label><input id="loginEmail" class="input" type="email" placeholder="name@example.com" autocomplete="username email"></div>
        <div class="field"><label>å¯†ç¢¼</label><input id="loginPass" class="input" type="password" placeholder="è¼¸å…¥å¯†ç¢¼" autocomplete="current-password" onkeydown="if(event.key==='Enter') doLogin()"></div>
        <div id="loginErr" class="err"></div>
        <div class="row" style="margin-top:8px"><button class="btn" onclick="switchToRegister()">æ²’æœ‰å¸³è™Ÿï¼Ÿå»è¨»å†Š</button></div>
      </div>
      <div class="actions"><button class="btn" onclick="closeModal('loginModal')">å–æ¶ˆ</button><button class="btn primary" onclick="doLogin()">ç™»å…¥</button></div>
    </div>
  </div>

  <!-- è¨»å†Š -->
  <div class="modal-backdrop" id="registerModal">
    <div class="modal">
      <header><div>è¨»å†Š</div><div class="closex" onclick="closeModal('registerModal')">Ã—</div></header>
      <div class="body">
        <div class="field"><label>é›»å­éƒµä»¶ï¼ˆå¿…å¡«ï¼‰</label><input id="regEmail" class="input" type="email" placeholder="name@example.com"></div>
        <div class="field"><label>å¯†ç¢¼ï¼ˆå¿…å¡«ï¼‰</label><input id="regPass" class="input" type="password" placeholder="è¨­å®šå¯†ç¢¼" onkeydown="if(event.key==='Enter') doRegister()"></div>
        <div class="field"><label>æš±ç¨±ï¼ˆå¿…å¡«ï¼‰</label><input id="regNickname" class="input" type="text" placeholder="é¡¯ç¤ºåç¨±"></div>
        <div class="field"><label>é ­è²¼ï¼ˆå¯é¸ï¼‰</label><input id="regAvatar" class="file" type="file" accept="image/*"></div>
        <div id="regErr" class="err"></div>
        <div class="row" style="margin-top:8px"><button class="btn" onclick="switchToLogin()">å·²æœ‰å¸³è™Ÿï¼Ÿå»ç™»å…¥</button></div>
      </div>
      <div class="actions"><button class="btn" onclick="closeModal('registerModal')">å–æ¶ˆ</button><button class="btn primary" onclick="doRegister()">å»ºç«‹å¸³è™Ÿ</button></div>
    </div>
  </div>
<!-- æŠ•æ”¾å»£å‘Š Modalï¼ˆç™»å…¥è€…é™å®šï¼‰ -->
<div class="modal-backdrop" id="adModal" style="display:none">
  <div class="modal">
    <header>
      <div>æŠ•æ”¾å»£å‘Š</div>
      <div class="closex" onclick="closeModal('adModal')">Ã—</div>
    </header>
    <div class="body">
      <div class="field">
        <label>å»£å‘Šæ¨™é¡Œï¼ˆé¡¯ç¤ºç”¨ï¼Œå¯é¸ï¼‰</label>
        <input id="adTitle" class="input" type="text" placeholder="ä¾‹å¦‚ï¼šå¤æ—¥ç‰¹è³£ 5 æŠ˜èµ·">
      </div>
      <div class="field">
        <label>è·³è½‰é€£çµï¼ˆå¿…å¡«ï¼Œéœ€ http(s)ï¼‰</label>
        <input id="adLink" class="input" type="url" placeholder="https://example.com/sale">
      </div>
      <div class="field">
        <label>å»£å‘Šåœ–ç‰‡ï¼ˆå¿…å¡«ï¼Œå»ºè­° 1120x420 æˆ– 16:6ï¼‰</label>
        <input id="adImage" class="file" type="file" accept="image/*">
      </div>
      <div class="field" style="display:flex; gap:10px">
        <div style="flex:1">
          <label>é–‹å§‹æ™‚é–“ï¼ˆå¯é¸ï¼‰</label>
          <input id="adStart" class="input" type="datetime-local">
        </div>
        <div style="flex:1">
          <label>çµæŸæ™‚é–“ï¼ˆå¯é¸ï¼‰</label>
          <input id="adEnd" class="input" type="datetime-local">
        </div>
      </div>
      <div id="adErr" class="err"></div>
      <div style="font-size:12px; color:#777;">ä¸Šå‚³å¾Œç«‹å³ç”Ÿæ•ˆï¼›è‹¥è¨­äº†æ™‚æ®µï¼Œæœƒè‡ªå‹•åœ¨æ™‚æ®µå…§é¡¯ç¤ºã€‚</div>
    </div>
    <div class="actions">
      <button class="btn" onclick="closeModal('adModal')">å–æ¶ˆ</button>
      <button class="btn primary" onclick="createAd()">é€å‡º</button>
    </div>
  </div>
</div>
<script>
/** ====== LeanCloud è¨­å®š ====== */
const APP_ID="ZDqo2eQBcSChCfRgwix9jUeI-gzGzoHsz";
const APP_KEY="U66ybZWAD99LrT9zJnQlW52H";
const API="https://zdqo2eqb.lc-cn-n1-shared.com/1.1";
const CURRENCY_SIGN='Â¥';
const money=n=>Number(n||0).toLocaleString('zh-TW');
// ====== io$ åŒ¯ç‡èˆ‡æ ¼å¼ ======
const IO_TO_CNY = 60;
const fmtIo = n => (Math.round(n * 1e5) / 1e5).toFixed(5);


/** ====== å°å·¥å…· ====== */
const $=s=>document.querySelector(s);
function openLogin(){ $('#loginModal').style.display='flex'; }
function openRegister(){ $('#registerModal').style.display='flex'; }
function closeModal(id){ document.getElementById(id).style.display='none'; }
function switchToRegister(){ closeModal('loginModal'); openRegister(); }
function switchToLogin(){ closeModal('registerModal'); openLogin(); }
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }
function fileToBase64(file){ return new Promise((resolve,reject)=>{ const fr=new FileReader(); fr.onload=()=>resolve(fr.result.split(',')[1]); fr.onerror=reject; fr.readAsDataURL(file); }); }

/** ====== å°è¦½åˆ— ====== */
function renderNav(){
  const navRight=$('#navRight');
  const user=JSON.parse(localStorage.getItem('sg_user')||'null');
  if(!user){
    navRight.innerHTML=`<button class="btn" onclick="openLogin()">ç™»å…¥</button><button class="btn primary" onclick="openRegister()">è¨»å†Š</button>`;
  }else{
    const avatar=user.avatarUrl||'https://via.placeholder.com/60?text=ğŸ™‚';
    const name=user.nickname||user.username||'ç”¨æˆ¶';
    navRight.innerHTML=`<a class="user-chip" href="user.html"><img src="${avatar}" alt=""><div style="font-weight:700; max-width:140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHTML(name)}</div></a><button class="btn" style="margin-left:6px" onclick="logout()">ç™»å‡º</button>`;
  }
  // è®“ ^-^ ç®¡ç†æŒ‰éˆ•åƒ…ç™»å…¥æ™‚é¡¯ç¤º
const manageBtn = document.getElementById('adManageBtn');
if (manageBtn) manageBtn.style.display = user ? 'inline-block' : 'none';
}

function logout(){ localStorage.removeItem('sg_token'); localStorage.removeItem('sg_user'); renderNav(); }

/** ====== å•†å“æ¸…å–® + å³æ™‚è¼ªè©¢ ====== */
function displayPrice(p){
  if(p.samePrice && typeof p.price==='number') return p.price;
  if(Array.isArray(p.variants)&&p.variants.length && typeof p.variants[0].price==='number') return p.variants[0].price;
  if(typeof p.price==='number') return p.price;
  return 0;
}
function makeProductCard(p, showIo=false){
  const cover=p.imageUrl||(Array.isArray(p.images)&&p.images[0])||'https://via.placeholder.com/400x300?text=%F0%9F%8C%9E';
  const price=displayPrice(p);
  const sellerName=(p.seller&&(p.seller.nickname||p.seller.username))?(p.seller.nickname||p.seller.username):'å•†å®¶';
  const ioLine = showIo ? `<div class="io-line">â‰ˆ io$ ${fmtIo(price/IO_TO_CNY)}</div>` : '';

  const a=document.createElement('a');
  a.className='card';
  a.href=`shuser.html?id=${p.objectId}`;
  a.setAttribute('aria-label',`æŸ¥çœ‹ ${p.title||'å•†å“'} è©³ç´°`);
  a.innerHTML=`
    <img class="thumb" src="${cover}" alt="">
    <div class="card-body">
      <div class="title" title="${escapeHTML(p.title||'')}">${escapeHTML(p.title||'æœªå‘½åå•†å“')}</div>
      <div class="meta-line">
        <div>
          <div class="price">${CURRENCY_SIGN}${money(price)}</div>
          ${ioLine}
        </div>
        <div class="seller">${escapeHTML(sellerName)}</div>
      </div>
    </div>`;
  return a;
}
const shownProductIds=new Set();
let latestCreatedAtIso=null;

async function loadProducts(){
  try{
    const res=await fetch(`${API}/classes/Product?order=-createdAt&limit=100&include=seller`,{
      headers:{'X-LC-Id':APP_ID,'X-LC-Key':APP_KEY}
    });
    const data=await res.json();
    if(!res.ok){ console.warn('loadProducts error:',data); return; }
    PRODUCTS = data.results || [];   // â† æ–°å¢

    const gridAll=document.getElementById('productGrid');
    const gridCheap=document.getElementById('cheapGrid');
    gridAll.innerHTML='';
    if(gridCheap) gridCheap.innerHTML='';

    (data.results||[]).forEach(p=>{
      shownProductIds.add(p.objectId);

      // æ‰€æœ‰å•†å“
      gridAll.appendChild(makeProductCard(p, false));

      // â‰¤ IO$1ï¼ˆ= â‰¤ 60 CNYï¼‰çš„å•†å“ï¼ŒåŠ åˆ°ç¬¬äºŒå€å¡Šï¼Œä¸¦é¡¯ç¤º io$
      const price=displayPrice(p);
      if(price <= 60 && gridCheap){
        gridCheap.appendChild(makeProductCard(p, true));
      }
    });

    const latest=(data.results||[]).reduce((max,it)=>{
      const t=new Date(it.createdAt).toISOString();
      return (!max||t>max)?t:max;
    },null);
    latestCreatedAtIso=latest||new Date().toISOString();
    PRODUCTS = data.results || [];
    rebuildSellers(PRODUCTS);
  }catch(e){ console.error(e); }
}
async function pollNewProducts(){
  if(!latestCreatedAtIso) return;
  const where={ createdAt:{ "$gt":{ "__type":"Date","iso":latestCreatedAtIso } } };
  const url=`${API}/classes/Product?where=${encodeURIComponent(JSON.stringify(where))}&order=createdAt&include=seller&limit=50`;
  try{
    const r=await fetch(url,{ headers:{'X-LC-Id':APP_ID,'X-LC-Key':APP_KEY} });
    const d=await r.json();
    if(!r.ok){ return; }
    const list=d.results||[];
    if(list.length){
      const gridAll = document.getElementById('productGrid');
      const gridCheap = document.getElementById('cheapGrid');
      for(let i=list.length-1;i>=0;i--){
        const p=list[i];
        if(shownProductIds.has(p.objectId)) continue;
        shownProductIds.add(p.objectId);

        // ä¸Šæ–¹ï¼šæ‰€æœ‰å•†å“
        if (gridAll) gridAll.prepend(makeProductCard(p, false));

        // ä¸‹æ–¹ï¼šâ‰¤ IO$1ï¼ˆâ‰¤ 60 CNYï¼‰ï¼Œé¡¯ç¤º io$ è¡Œ
        const price = displayPrice(p);
        if (gridCheap && price <= 60) {
          gridCheap.prepend(makeProductCard(p, true));
        }
        // æ›´æ–°
         PRODUCTS.unshift(p);
         rebuildSellers(PRODUCTS);
      }
      latestCreatedAtIso=new Date(list[list.length-1].createdAt).toISOString();
    }
  }catch(e){ console.warn('poll error',e); }
}
setInterval(pollNewProducts, 5000);

/** ====== ç™»å…¥ï¼šè‹¥å¸³è™Ÿä¸å­˜åœ¨â†’å¼•å°è¨»å†Š ====== */
function suggestRegister(email){
  alert('é€™å€‹ Email å°šæœªè¨»å†Šï¼Œè«‹å…ˆå»ºç«‹å¸³è™Ÿã€‚');
  closeModal('loginModal'); openRegister();
  if(email) document.getElementById('regEmail').value=email;
}
async function doLogin(){
  const email=($('#loginEmail').value||'').trim();
  const password=($('#loginPass').value||'').trim();
  if(!email||!password){ $('#loginErr').textContent='è«‹è¼¸å…¥é›»å­éƒµä»¶èˆ‡å¯†ç¢¼'; return; }
  $('#loginErr').textContent='';
  try{
    const res=await fetch(`${API}/login?username=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`,{
      headers:{'X-LC-Id':APP_ID,'X-LC-Key':APP_KEY}
    });
    const data=await res.json();
    if(!res.ok){
      if(Number(data.code)===211){ return suggestRegister(email); } // ä½¿ç”¨è€…ä¸å­˜åœ¨
      $('#loginErr').textContent=data.error||'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤'; return;
    }
    const meRes=await fetch(`${API}/users/me`,{
      headers:{'X-LC-Id':APP_ID,'X-LC-Key':APP_KEY,'X-LC-Session':data.sessionToken}
    });
    const me=await meRes.json();
    if(!meRes.ok){ $('#loginErr').textContent=me.error||'è®€å–ä½¿ç”¨è€…ç‹€æ…‹å¤±æ•—'; return; }
    localStorage.setItem('sg_token',data.sessionToken||'');
    localStorage.setItem('sg_user',JSON.stringify({
      objectId:me.objectId, username:me.username, email:me.email, nickname:me.nickname, avatarUrl:me.avatarUrl||''
    }));
    closeModal('loginModal'); 
    renderNav(); 
    // è‹¥ä½ æƒ³ç™»å…¥å¾Œè·³é ï¼šlocation.href='user.html';
  }catch(err){ $('#loginErr').textContent=err.message||'ç™»å…¥å¤±æ•—'; }
}

/** ====== Email MX æª¢æŸ¥ï¼ˆCloudflare DoHï¼‰ ====== */
async function hasMXRecord(email){
  const m=String(email).trim().match(/@([^@\s]+)$/);
  if(!m) return false;
  const domain=m[1].toLowerCase();
  const disposable=['mailinator.com','guerrillamail.com','10minutemail.com','tempmail.com'];
  if(disposable.includes(domain)) return false;
  try{
    const controller=new AbortController();
    const timer=setTimeout(()=>controller.abort(), 3000);
    const url=`https://cloudflare-dns.com/dns-query?name=${encodeURIComponent(domain)}&type=MX`;
    const res=await fetch(url,{ headers:{'Accept':'application/dns-json'}, signal:controller.signal });
    clearTimeout(timer);
    if(!res.ok) return false;
    const data=await res.json();
    return Array.isArray(data.Answer) && data.Answer.some(a=>a.type===15);
  }catch(e){
    return null; // è¢«ç‰†/è¶…æ™‚
  }
}

/** ====== è¨»å†Šï¼šæ ¼å¼+MX æª¢æŸ¥â†’å»ºç«‹â†’è‡ªå‹•ç™»å…¥ ====== */
async function doRegister(){
  const email=($('#regEmail').value||'').trim();
  const password=($('#regPass').value||'').trim();
  const nickname=($('#regNickname').value||'').trim();

  const emailRe=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if(!emailRe.test(email)){ $('#regErr').textContent='è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€'; return; }

  $('#regErr').textContent='æ­£åœ¨æª¢æŸ¥éƒµç®±å¯ç”¨æ€§ï¼ˆMXï¼‰â€¦';
  const mxOk=await hasMXRecord(email);
  if(mxOk===false){ $('#regErr').textContent='é€™å€‹éƒµç®±åŸŸåæ²’æœ‰ MX è¨˜éŒ„ï¼Œå¯èƒ½ä¸èƒ½æ”¶ä¿¡'; return; }
  if(mxOk===null){ $('#regErr').textContent='DNS æŸ¥è©¢è¢«é˜»æ“‹ï¼šç„¡æ³•ç¢ºèªéƒµç®±å¯ç”¨æ€§ï¼ˆå¯ç¨å¾Œå†è©¦ï¼‰'; return; }

  if(!password||!nickname){ $('#regErr').textContent='è«‹å®Œæ•´å¡«å¯«ï¼šé›»å­éƒµä»¶ã€å¯†ç¢¼ã€æš±ç¨±'; return; }
  $('#regErr').textContent='';

  let avatarUrl='';
  const f=document.getElementById('regAvatar').files[0];
  if(f){
    try{
      const base64=await fileToBase64(f);
      const rf=await fetch(`${API}/files/${encodeURIComponent(f.name)}`,{
        method:'POST',
        headers:{'Content-Type':'application/json','X-LC-Id':APP_ID,'X-LC-Key':APP_KEY},
        body:JSON.stringify({base64})
      });
      const rd=await rf.json();
      if(!rf.ok) throw new Error(rd.error||'é ­è²¼ä¸Šå‚³å¤±æ•—');
      avatarUrl=rd.url;
    }catch(err){
      $('#regErr').textContent=err.message||'é ­è²¼ä¸Šå‚³å¤±æ•—';
      return;
    }
  }

  const payload={ username:email, email, password, nickname, ...(avatarUrl?{avatarUrl}:{}) };

  try{
    const res=await fetch(`${API}/users`,{
      method:'POST',
      headers:{'Content-Type':'application/json','X-LC-Id':APP_ID,'X-LC-Key':APP_KEY},
      body:JSON.stringify(payload)
    });
    const created=await res.json();
    if(!res.ok) throw new Error(created.error||'è¨»å†Šå¤±æ•—');

    // ç›´æ¥è‡ªå‹•ç™»å…¥ï¼šå„ªå…ˆç”¨å›å‚³çš„ sessionTokenï¼›æ²’æœ‰å°±ç”¨å¸³å¯†å†ç™»ä¸€æ¬¡
    let sessionToken=created.sessionToken;
    if(!sessionToken){
      const loginRes=await fetch(`${API}/login?username=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`,{
        headers:{'X-LC-Id':APP_ID,'X-LC-Key':APP_KEY}
      });
      const loginData=await loginRes.json();
      if(!loginRes.ok) throw new Error(loginData.error||'è‡ªå‹•ç™»å…¥å¤±æ•—');
      sessionToken=loginData.sessionToken;
    }

    const meRes=await fetch(`${API}/users/me`,{
      headers:{'X-LC-Id':APP_ID,'X-LC-Key':APP_KEY,'X-LC-Session':sessionToken}
    });
    const me=await meRes.json();
    if(!meRes.ok) throw new Error(me.error||'è®€å–ä½¿ç”¨è€…ç‹€æ…‹å¤±æ•—');

    localStorage.setItem('sg_token',sessionToken||'');
    localStorage.setItem('sg_user',JSON.stringify({
      objectId:me.objectId, username:me.username, email:me.email, nickname:me.nickname, avatarUrl:me.avatarUrl||''
    }));

    closeModal('registerModal'); renderNav();
    alert('ğŸ‰ è¨»å†ŠæˆåŠŸï¼Œå·²è‡ªå‹•ç‚ºä½ ç™»å…¥ï¼');
    // è‹¥ä½ æƒ³è‡ªå‹•è·³é ï¼šlocation.href='user.html';
  }catch(err){
    $('#regErr').textContent=err.message||'è¨»å†Šå¤±æ•—';
  }
}
//æœå°‹====================
function parseQueryMode(raw=''){
  const s = raw.trim();
  if(!s) return { mode:'none', text:'' };
  if(/^#/.test(s)) return { mode:'title', text: s.replace(/^#\s*/,'') };
  if(/^(~|ï½)/.test(s)) return { mode:'price', text: s.replace(/^(~|ï½)\s*/,'') };
  return { mode:'free', text: s };  // æ²’å‰ç¶´
}
/* ====== ç”¢å“å¿«å– / è³£å®¶ç´¢å¼• ====== */
let PRODUCTS = [];                 // ä½ åŸæœ¬å°±æœ‰
const SELLERS_MAP = new Map();     // ä½ åŸæœ¬å°±æœ‰
const PRODUCT_COUNT = new Map();   // â† æ–°å¢ï¼šsellerId -> å•†å“æ•¸

function rebuildSellers(products){
  SELLERS_MAP.clear();
  PRODUCT_COUNT.clear();           // â† æ–°å¢
  (products||[]).forEach(p=>{
    const s = p.seller || {};
    if(!s || !s.objectId) return;
    // å»ºå•†å“æ•¸
    PRODUCT_COUNT.set(s.objectId, (PRODUCT_COUNT.get(s.objectId)||0) + 1);
    // å»ºè³£å®¶ç´¢å¼•
    if(!SELLERS_MAP.has(s.objectId)){
      SELLERS_MAP.set(s.objectId, {
        id: s.objectId,
        nickname: s.nickname || '',
        username: s.username || '',
        avatarUrl: s.avatarUrl || 'https://via.placeholder.com/60?text=ğŸ™‚'
      });
    }
  });
}
/* ====== debounce å°å·¥å…· ====== */
function debounce(fn, ms=150){
  let t=null; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}
//ä¼ºæœå™¨æœå°‹==============================
// ===== å”¯ä¸€ç‰ˆæœ¬ï¼šsearchUsersRemote =====
function regexEscape(s=''){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

let LAST_USER_Q = '';
let LAST_USER_LIST = [];

async function searchUsersRemote(keyword){
  const kw = (keyword || '').trim();
  if (!kw) return [];
  if (kw === LAST_USER_Q && LAST_USER_LIST.length) return LAST_USER_LIST;

  const re = regexEscape(kw);
  const where = {
    "$or": [
      { nickname: { "$regex": re, "$options": "i" } },
      { username: { "$regex": re, "$options": "i" } },
      { email:    { "$regex": re, "$options": "i" } },
      { objectId: { "$regex": re, "$options": "i" } }
    ]
  };

  const headers = { 'X-LC-Id': APP_ID, 'X-LC-Key': APP_KEY };
  const token = localStorage.getItem('sg_token');
  if (token) headers['X-LC-Session'] = token;   // â† å¾ˆé‡è¦ï¼šå¸¶ session

  const url = `${API}/users?where=${encodeURIComponent(JSON.stringify(where))}&limit=20&order=-updatedAt`;
  try{
    const r = await fetch(url, { headers });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || 'search users failed');
    const list = (d.results || []).map(u => ({
      id: u.objectId,
      nickname: u.nickname || '',
      username: u.username || '',
      avatarUrl: u.avatarUrl || 'https://via.placeholder.com/60?text=ğŸ™‚',
      productCount: PRODUCT_COUNT.get(u.objectId) || 0
    }));
    LAST_USER_Q = kw;
    LAST_USER_LIST = list;
    return list;
  }catch(e){
    console.warn('searchUsersRemote error:', e);
    LAST_USER_Q = kw;
    LAST_USER_LIST = [];
    return [];
  }
}
/* ç”¢ç”Ÿå»ºè­°æ¸…å–®ï¼ˆæš±ç¨±/ä½¿ç”¨è€…åç¨±/GID æ¨¡ç³Šï¼‰ */
const updateSuggest = debounce(async function(raw){
  const box = document.getElementById('searchSuggest');
  const bar = document.getElementById('searchBar');
  if(!box || !bar) return;

  const kw = (raw||'').trim();
  if(!kw){ box.style.display='none'; box.innerHTML=''; return; }

  // å…ˆæ‰“é ç«¯æ‰¾ã€Œæ‰€æœ‰ç”¨æˆ¶ã€
  let list = await searchUsersRemote(kw);

  // è‹¥é ç«¯å›å‚³å¾ˆå°‘ï¼Œå†æŠŠç›®å‰é é¢ä¸Šã€Œæ›¾å‡ºç¾éçš„è³£å®¶ã€è£œé€²ä¾†ï¼ˆé¿å…æ¼ï¼‰
  if(list.length < 8){
    const keys = expandHan(kw).map(normalizeText);
    SELLERS_MAP.forEach(s=>{
      const name = normalizeText(s.nickname || s.username || '');
      const hit = keys.some(k=> name.includes(k)) ||
                  String(s.id).toLowerCase().includes(normalizeText(kw));
      if(hit && !list.some(x=>x.id===s.id)){
        list.push({
          id: s.id,
          nickname: s.nickname||'',
          username: s.username||'',
          avatarUrl: s.avatarUrl||'https://via.placeholder.com/60?text=ğŸ™‚',
          productCount: PRODUCT_COUNT.get(s.id) || 0
        });
      }
    });
  }

  // åªç•™å‰ 8
  list = list.slice(0,8);

  // æ²’è³‡æ–™
  if(!list.length){
    box.innerHTML = `<div class="no-suggest">æ²’æœ‰æ‰¾åˆ°ä½¿ç”¨è€…</div>`;
    box.style.display = bar.classList.contains('show') ? 'block' : 'none';
    return;
  }

  // renderï¼ˆå¸¶ã€Œå•†å“æ•¸ã€ï¼‰
  box.innerHTML = list.map(s=>{
    const name = escapeHTML(s.nickname || s.username || 'ç”¨æˆ¶');
    const gid  = escapeHTML(s.id);
    const avatar = s.avatarUrl || 'https://via.placeholder.com/60?text=ğŸ™‚';
    const cnt = s.productCount|0;
    return `
      <div class="suggest-item" role="option" onclick="goProfile('${gid}')">
        <img class="suggest-avatar" src="${avatar}" alt="">
        <div class="suggest-name">${name}</div>
        <div class="suggest-gid">${gid}</div>
        <div style="font-size:12px;color:#999;margin-left:8px;">å•†å“æ•¸ ${cnt}</div>
      </div>`;
  }).join('');

  box.style.display = bar.classList.contains('show') ? 'block' : 'none';
}, 180);

/* ä¾é»æ“Šçš„äººï¼Œå°å‘ seller æˆ– user */
function goProfile(targetId){
  const me = JSON.parse(localStorage.getItem('sg_user')||'null');
  if(me && me.objectId === targetId){
    location.href='user.html';
  }else{
    location.href=`seller.html?id=${encodeURIComponent(targetId)}`;
  }
}

/* ç›£è½è¼¸å…¥æ¡†ï¼šå³æ™‚å»ºè­° */
(function(){
  const input = document.getElementById('searchInput');
  if(!input) return;
  input.addEventListener('input', e=> updateSuggest(e.target.value));
})();
/* ====== ç°¡ç¹å°ç…§ï¼ˆå°å­—åº«ï¼Œé›™å‘ï¼‰ ====== */
const ST_MAP = {
  'å›½':'åœ‹','ä½“':'é«”','å°':'è‡º','å':'å¾Œ','å‘':'ç™¼','å¹¿':'å»£','è½¦':'è»Š','ç”µ':'é›»','ç½‘':'ç¶²','è½¯':'è»Ÿ','ä¹¦':'æ›¸',
  'ä¹°':'è²·','å–':'è³£','ä¼˜':'å„ª','çˆ±':'æ„›','è“':'è—','ç»¿':'ç¶ ','çº¢':'ç´…','é»„':'é»ƒ','é“¶':'éŠ€','é—¨':'é–€','é—´':'é–“',
  'è¿™':'é€™','ä¸ª':'å€‹','ä¼š':'æœƒ','äº§':'ç”¢','åŒ»':'é†«','å­¦':'å­¸','å†':'æ­·','å¤':'è¤‡','æ‚':'é›œ','æ¡':'æ¢','å£°':'è²'
};
const TS_MAP = Object.fromEntries(Object.entries(ST_MAP).map(([s,t])=>[t,s]));

/* æŠŠå­—ä¸²åšç°¡ç¹æ“´å±•ï¼šå‚³å› [åŸå­—ä¸², ç°¡è½‰ç¹ç‰ˆ, ç¹è½‰ç°¡ç‰ˆ]ï¼ˆå»é‡ï¼‰ */
function expandHan(s=''){
  const toT = [...s].map(ch => ST_MAP[ch] || ch).join('');
  const toS = [...s].map(ch => TS_MAP[ch] || ch).join('');
  return Array.from(new Set([s, toT, toS]));
}

/* æ­£è¦åŒ–ï¼šå»ç©ºç™½ã€å…¨å½¢è½‰åŠå½¢ã€çµ±ä¸€å°å¯« */
function normalizeText(s=''){
  // NFKC æœƒæŠŠå…¨å½¢æ•¸å­—è‹±æ–‡å­—å…ƒæ¨™é»è½‰ç‚ºåŠå½¢
  return s.normalize('NFKC').toLowerCase().replace(/\s+/g,'');
}

/* è§£æåƒ¹æ ¼æŸ¥è©¢ï¼šæ”¯æ´ < <= = >= > ä»¥åŠ Â¥ / io$ */
function parsePriceQuery(q){
  // e.g. "â‰¤60" "io$<=1" ">= 100" "Â¥=66" "60"
  const m = q.replace(/\s+/g,'').match(/^(io\$|Â¥|ï¿¥)?\s*(<=|â‰¥|>=|<|>|=)?\s*([\d.]+)$/i);
  if(!m) return null;
  let [, unit, op, num] = m;
  op = op || '=';                         // é»˜èªç­‰æ–¼
  let value = parseFloat(num||'0');
  if(!isFinite(value)) return null;
  // io$ è½‰äººæ°‘å¹£
  if(unit && /^io\$/i.test(unit)) value = value * IO_TO_CNY;
  // ç„¡å–®ä½ä½†å°æ–¼ 5 çš„æ•¸å­—ï¼Œè‹¥å¸¶æœ‰ "io$" å­—æ¨£å‰‡å·²è™•ç†ï¼›å¦å‰‡è¦–ç‚º CNY
  return { op, valueCNY: value };
}

/* é–‹é—œæœå°‹åˆ— */
function toggleSearch(force){
  const bar = document.getElementById('searchBar');
  const input = document.getElementById('searchInput');
  const box = document.getElementById('searchSuggest');
  if(!bar) return;

  const isOpen = bar.classList.contains('show');
  const wantOpen = (typeof force === 'boolean') ? force : !isOpen;

  if(wantOpen){
    bar.classList.add('show');
    bar.setAttribute('aria-hidden','false');
    setTimeout(()=> input?.focus(), 160);
    if(box) box.style.display='block';
  }else{
    bar.classList.remove('show');
    bar.setAttribute('aria-hidden','true');
    if(input) input.value='';
    if(box){ box.style.display='none'; box.innerHTML=''; }  // é—œæ‰å»ºè­°
    restoreAllProducts();
  }
}

/* é‚„åŸä¸»æ¸…å–®èˆ‡ â‰¤IO$1 å€å¡Š */
function restoreAllProducts(){
  const gridAll = document.getElementById('productGrid');
  const gridCheap = document.getElementById('cheapGrid');
  if(!gridAll) return;
  gridAll.innerHTML = '';
  PRODUCTS.forEach(p => gridAll.appendChild(makeProductCard(p, false)));
  if(gridCheap){
    gridCheap.innerHTML = '';
    PRODUCTS.forEach(p=>{
      const price=displayPrice(p);
      if(price<=60) gridCheap.appendChild(makeProductCard(p, true));
    });
  }
}

/* åŸ·è¡Œæœå°‹ */
function runSearch(){
  const input = document.getElementById('searchInput');
  if(!input) return;

  const raw = (input.value||'').trim();

  // === é€™æ®µæ˜¯æ–°åŠ çš„ã€Œå¯†ç¢¼æ·å¾‘ã€ï¼š*G~admin â†’ ç›´æ¥è·³è½‰ ===
  // è‹¥æƒ³å¤§å°å¯«å¿…é ˆå®Œå…¨ç›¸åŒï¼ŒæŠŠ /i æ‹¿æ‰ï¼Œæ”¹æˆ raw === '*G~admin'
  if (/^\*G~admin$/i.test(raw)) {
    location.href = 'Grove. Control-Yuan.html';
    return;
  }

  // â†“â†“â†“ ä¸‹é¢å…¨æ˜¯ä½ åŸæœ¬å°±æœ‰çš„æœå°‹é‚è¼¯ï¼Œä¿æŒä¸è®Š â†“â†“â†“
  const { mode, text } = parseQueryMode(raw);
  const qNorm = normalizeText(text);

  if(!qNorm){ restoreAllProducts(); return; }

  // è§£æï¼šGIDï¼ˆç¶­æŒåŸè¡Œç‚ºï¼‰
  const gidLike = qNorm.match(/[a-z0-9]{16,26}/i)?.[0];

  // è§£æï¼šæ–‡å­—éµï¼ˆåšç°¡ç¹å±•é–‹ï¼‰
  const textKeys = expandHan(text).map(normalizeText);

  // è§£æï¼šåƒ¹æ ¼ï¼ˆåªæœ‰ mode==='price' æ‰è§£æï¼‰
  let priceFilter = null;
  if(mode==='price'){
    // æ”¯æ´ "~60" / "~ io$1"
    const priceMatch = qNorm
      .replace(/^rmb/,'').replace(/^cny/,'').replace(/^y?uan/,'');
    priceFilter = parsePriceQuery(priceMatch);
    if(!priceFilter){  // ä½¿ç”¨è€…å¯èƒ½è¼¸å…¥éŒ¯
      restoreAllProducts();
      return;
    }
  }

  // ===== çœŸæ­£ç¯©é¸ =====
  const results = PRODUCTS.filter(p=>{
    const title = normalizeText(p.title||'');
    const sellerName = normalizeText((p.seller?.nickname) || (p.seller?.username) || '');

    // GID å‘½ä¸­
    if(gidLike){
      if(String(p.objectId).toLowerCase().includes(gidLike)) return true;
      if(String(p.seller?.objectId||'').toLowerCase().includes(gidLike)) return true;
    }

    // åƒ¹æ ¼ï¼ˆåªæœ‰åœ¨ mode==='price' æ™‚æœƒç”Ÿæ•ˆï¼‰
    // åƒ¹æ ¼ï¼ˆåªæœ‰åœ¨ mode==='price' æ™‚æœƒç”Ÿæ•ˆï¼‰
if (priceFilter) {
  const price = Number(displayPrice(p) || 0);
  const v = priceFilter.valueCNY;
  // ç”¨ç­‰æ–¼ï¼ˆå…è¨±æµ®é»æ•¸å¾®èª¤å·®ï¼‰
  const ok = Math.abs(price - v) < 1e-6;
  if (!ok) return false;
}

    // æ–‡å­—å‘½ä¸­ï¼šæ ¹æ“šæ¨¡å¼ä¸åŒæ±ºå®šæ¯”å°ç¯„åœ
    if(mode==='title'){
      // åªçœ‹å•†å“åç¨±
      const hit = textKeys.some(k => title.includes(k));
      if(!hit) return false;
    }else{
      // free / å…¶ä»–ï¼šå•†å“åæˆ–è³£å®¶åéƒ½å¯
      if(textKeys.length){
        const hit = textKeys.some(k => (title.includes(k) || sellerName.includes(k)));
        // è‹¥æ²’æœ‰ä»»ä½•å…¶å®ƒæ¢ä»¶ï¼ˆä¸æ˜¯åƒ¹æ ¼ã€ä¸æ˜¯ gidï¼‰ï¼Œè€Œä¸”æ–‡å­—æ²’ä¸­ï¼Œå°±æ’é™¤
        if(!hit && !priceFilter && !gidLike) return false;
      }
    }

    return true;
  });

  // ====== è‹¥æ˜¯ç´”æ‰¾äººï¼ˆåƒ limï¼‰ï¼Œä½†é‚£äººæ²’æœ‰å•†å“ â†’ ä¸‹æ–¹ä¸å‹• ======
  const onlyText = (mode!=='price' && !gidLike && textKeys.length>0);
  const noProductFound = results.length===0;
  const hitUserNoProduct =
    (LAST_USER_Q && normalizeText(LAST_USER_Q) === normalizeText(text) &&
     LAST_USER_LIST.some(u =>
       (normalizeText(u.nickname||u.username||'').includes(normalizeText(text)) ||
        (u.id||'').toLowerCase().includes(normalizeText(text))) &&
       (u.productCount|0)===0
     )
    );

  if(onlyText && noProductFound && hitUserNoProduct){
    // é€™ä»£è¡¨ä½¿ç”¨è€…æ˜¯åœ¨æ‰¾äººï¼ˆex: limï¼‰ä½†å°æ–¹æ²’ä¸Šæ¶ â†’ ä¿æŒå•†å“æ¸…å–®ä¸è®Š
    restoreAllProducts();
    return;
  }

  // ====== æ¸²æŸ“ ======
  const gridAll = document.getElementById('productGrid');
  const gridCheap = document.getElementById('cheapGrid');

  if(gridAll){
    gridAll.innerHTML = '';
    results.forEach(p => gridAll.appendChild(makeProductCard(p, false)));
  }
  if(gridCheap){
    gridCheap.innerHTML = '';
    results.forEach(p=>{
      const price=displayPrice(p);
      if(price<=60) gridCheap.appendChild(makeProductCard(p, true));
    });
  }
}
/** ====== å•Ÿå‹• ====== */
renderNav();
loadProducts();

</script>
<script>
// ==== å»£å‘Šæ¿è³‡æ–™ ====
let AD_LIST = [];
let AD_IDX = 0;
let AD_TIMER = null;

// å°è¦½åˆ—ï¼šè£œä¸Šã€ŒæŠ•æ”¾å»£å‘Šã€æŒ‰éˆ•æ§åˆ¶
const _origRenderNav = renderNav;
renderNav = function(){
  _origRenderNav();
  const user = JSON.parse(localStorage.getItem('sg_user') || 'null');
  const btn = document.getElementById('adCreateBtn');
  if(btn) btn.style.display = user ? 'inline-block' : 'none';
};

// âœ… è¦†å¯«å®Œï¼Œç«‹åˆ»å†è·‘ä¸€æ¬¡ï¼Œè®“æŒ‰éˆ•ç‹€æ…‹æ­£ç¢º
renderNav();

// å·¥å…·ï¼šISO from input[type=datetime-local]
function toISO(dtLocal){
  if(!dtLocal) return null;
  const d = new Date(dtLocal);
  if(isNaN(d.getTime())) return null;
  return d.toISOString();
}

// è®€å–å»£å‘Š
async function loadAds(){
  // é¡¯ç¤ºä¸­çš„æ¢ä»¶ï¼šactive=trueï¼ˆé è¨­ï¼‰ã€æ™‚é–“åœ¨ start~end ä¹‹å…§ï¼ˆè‹¥æœ‰è¨­å®šï¼‰
  const nowIso = new Date().toISOString();
  const where = {
    active: { "$ne": false },
    "$and": [
      { "$or": [ { startAt: { "$exists": false } }, { startAt: { "$lte": { "__type":"Date","iso": nowIso } } } ] },
      { "$or": [ { endAt:   { "$exists": false } }, { endAt:   { "$gte": { "__type":"Date","iso": nowIso } } } ] }
    ]
  };
  const url = `${API}/classes/Ad?where=${encodeURIComponent(JSON.stringify(where))}&order=-createdAt&limit=12`;
  try{
    const r = await fetch(url, { headers:{'X-LC-Id':APP_ID,'X-LC-Key':APP_KEY} });
    const d = await r.json();
    if(!r.ok){ console.warn('loadAds error', d); return; }
    AD_LIST = (d.results||[]).map(x=>({
      id: x.objectId,
      title: x.title || '',
      imageUrl: x.imageUrl || (Array.isArray(x.images)&&x.images[0]) || '',
      linkUrl: x.linkUrl || '#'
    })).filter(x=>x.imageUrl && x.linkUrl);

    renderAds();
  }catch(e){ console.warn(e); }
}

function renderAds(){
  const track = document.getElementById('adTrack');
  const dots  = document.getElementById('adDots');
  if(!track || !dots) return;

  track.innerHTML = '';
  dots.innerHTML  = '';

  if(!AD_LIST.length){
  const empty = document.createElement('div');
  empty.className = 'hero-slide';

  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="1120" height="420">
    <defs>
      <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#eee"/>
        <stop offset="1" stop-color="#ddd"/>
      </linearGradient>
    </defs>
    <rect width="100%" height="100%" fill="url(#g)"/>
    <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
          font-family="system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif"
          font-size="36" fill="#888">å»£å‘Šä½ï¼ˆå°šç„¡æŠ•æ”¾ï¼‰</text>
  </svg>`.trim();

  const dataUri = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  empty.innerHTML = `<img src="${dataUri}" alt="å»£å‘Šä½ï¼ˆå°šç„¡æŠ•æ”¾ï¼‰">`;
  track.appendChild(empty);
  clearInterval(AD_TIMER); AD_TIMER=null;
  return;
}

  AD_LIST.forEach((ad,i)=>{
    const slide = document.createElement('div');
    slide.className = 'hero-slide';
    slide.innerHTML = `
      <a href="${ad.linkUrl}" target="_blank" rel="noopener noreferrer">
        <img src="${ad.imageUrl}" alt="${escapeHTML(ad.title||'å»£å‘Š')}">
      </a>`;
    track.appendChild(slide);

    const dot = document.createElement('div');
    dot.className = 'hero-dot' + (i===AD_IDX?' active':'');
    dot.onclick = ()=>adGo(i);
    dots.appendChild(dot);
  });

  adGo(AD_IDX||0, true);
  adAutoplay();
}

function adGo(idx, noAnim=false){
  if(!AD_LIST.length) return;
  AD_IDX = (idx + AD_LIST.length) % AD_LIST.length;
  const track = document.getElementById('adTrack');
  const dots  = [...document.querySelectorAll('.hero-dot')];
  if(noAnim) track.style.transition='none'; else track.style.transition='transform .45s ease';
  track.style.transform = `translateX(${-AD_IDX*100}%)`;
  dots.forEach((d,i)=>d.classList.toggle('active', i===AD_IDX));
  // ä¹‹å¾Œçš„å‹•ç•«è¦æ¢å¾©
  if(noAnim){ requestAnimationFrame(()=>track.style.transition='transform .45s ease'); }
}
function adNext(){ adGo(AD_IDX+1); }
function adPrev(){ adGo(AD_IDX-1); }
function adAutoplay(){
  if(AD_TIMER) clearInterval(AD_TIMER);
  AD_TIMER = setInterval(adNext, 4000);
}

// è§¸æ§æ»‘å‹•
(function(){
  let startX=0, delta=0, touching=false;
  const frame = document.getElementById('adHero');
  if(!frame) return;
  frame.addEventListener('touchstart', e=>{ touching=true; startX=e.touches[0].clientX; delta=0; if(AD_TIMER) clearInterval(AD_TIMER); },{passive:true});
  frame.addEventListener('touchmove', e=>{ if(!touching) return; delta = e.touches[0].clientX - startX; },{passive:true});
  frame.addEventListener('touchend', ()=>{ touching=false; if(Math.abs(delta)>40){ delta>0 ? adPrev() : adNext(); } adAutoplay(); });
})();

// é–‹å•Ÿ/é—œé–‰ modalï¼ˆå…±ç”¨ï¼‰
function openAdModal(){
  const user = JSON.parse(localStorage.getItem('sg_user')||'null');
  if(!user){ alert('è«‹å…ˆç™»å…¥å†æŠ•æ”¾å»£å‘Š'); openLogin(); return; }
  document.getElementById('adErr').textContent = '';
  document.getElementById('adModal').style.display='flex';
}

// å»ºç«‹å»£å‘Šï¼ˆä¸Šå‚³åœ–ç‰‡ â†’ å»ºç«‹ Ad ç‰©ä»¶ï¼‰
async function createAd(){
  const user = JSON.parse(localStorage.getItem('sg_user')||'null');
  const token = localStorage.getItem('sg_token')||'';
  if(!user || !token){ alert('è«‹å…ˆç™»å…¥'); return; }

  const title = (document.getElementById('adTitle').value||'').trim();
const errEl = document.getElementById('adErr');
errEl.textContent = '';

const rawLink = (document.getElementById('adLink').value || '').trim();
// å¯é¸é€£çµï¼šæœ‰å¡«æ‰æª¢æŸ¥ http(s)
if (rawLink && !/^https?:\/\//i.test(rawLink)) {
  errEl.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ http(s) é€£çµ';
  return;
}
const finalLink = rawLink || '#';

const f     = document.getElementById('adImage').files[0];
const start = document.getElementById('adStart').value;
const end   = document.getElementById('adEnd').value;

if(!f){ errEl.textContent='è«‹é¸æ“‡ä¸€å¼µå»£å‘Šåœ–ç‰‡'; return; }
if(f.size > 3*1024*1024){ errEl.textContent='åœ–ç‰‡è«‹å°æ–¼ç­‰æ–¼ 3MB'; return; }

  try{
    // 1) ä¸Šå‚³åœ–ç‰‡
    const base64 = await fileToBase64(f);
    const uf = await fetch(`${API}/files/${encodeURIComponent(f.name)}`,{
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY },
      body: JSON.stringify({ base64 })
    });
    const ud = await uf.json();
    if(!uf.ok) throw new Error(ud.error || 'åœ–ç‰‡ä¸Šå‚³å¤±æ•—');

    // 2) å»ºç«‹ Ad ç‰©ä»¶ï¼ˆå…¬é–‹å¯è®€ã€æ“æœ‰è€…å¯å¯«ï¼‰
    const payload = {
  title,
  linkUrl: finalLink,
  imageUrl: ud.url,
  owner: { "__type":"Pointer","className":"_User","objectId": user.objectId },
  active: true,
  ...(start ? { startAt: { "__type":"Date","iso": toISO(start) } } : {}),
  ...(end   ? { endAt:   { "__type":"Date","iso": toISO(end) } } : {}),
  ACL: {
    "*": { "read": true },
    [user.objectId]: { "read": true, "write": true }
  }
};
    const cr = await fetch(`${API}/classes/Ad`,{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY,
        'X-LC-Session': token
      },
      body: JSON.stringify(payload)
    });
    const cd = await cr.json();
    if(!cr.ok) throw new Error(cd.error || 'å»ºç«‹å»£å‘Šå¤±æ•—');

    closeModal('adModal');
    alert('âœ… å»£å‘Šå·²æŠ•æ”¾ï¼');
    await loadAds(); // ç«‹å³åˆ·æ–°å»£å‘Šæ¿
  }catch(e){
    errEl.textContent = e.message || 'æŠ•æ”¾å¤±æ•—';
  }
}

// æ¯ 60 ç§’è¼•é‡è¼ªè©¢æ–°å»£å‘Šï¼ˆç„¡ LiveQueryï¼‰
setInterval(loadAds, 60000);

// å•Ÿå‹•ï¼šè¼‰å…¥å»£å‘Š + ä½ åŸæœ¬çš„å•†å“æµç¨‹ç…§å¸¸
loadAds();
// Esc é—œé–‰æœå°‹
document.addEventListener('keydown', (e)=>{
  if(e.key==='Escape') toggleSearch(false);
});

// é»æ“Šé é¢ç©ºç™½è™•æ”¶èµ·ï¼ˆé †ä¾¿é—œé–‰å»ºè­°æ¸…å–®ï¼‰
document.addEventListener('click', (e)=>{
  const bar = document.getElementById('searchBar');
  const btn = document.getElementById('searchBtn');
  const sug = document.getElementById('searchSuggest');
  if(!bar || !btn) return;
  const within = bar.contains(e.target) || btn.contains(e.target);
  if(!within && bar.classList.contains('show')){
    toggleSearch(false);
    if(sug){ sug.style.display='none'; sug.innerHTML=''; }
  }
});
</script>
<script src="im.js?v=0.1.2"></script>
<script src="lioc.js?v=0.1.1"></script>
<!--=================-->
<p style="text-align: center; font-size: 13px; color: #999; margin-top: 40px;">
  ğŸ¾ Â© 2024 yinnlimçš„å°å®‡å®™ï½œå…§å®¹èˆ‡è¨­è¨ˆçš†ç”±ç³–ç³–æœ¬äººç”¨æ„›è£½ä½œ ğŸ’<br>
  æœªç¶“æˆæ¬Šè«‹å‹¿éš¨æ„ä½¿ç”¨ã€ç›œè½‰å–” ğŸ™…â€â™€ï¸ è¬è¬ä½ çš„å°Šé‡èˆ‡æº«æŸ” ğŸ’Œ
</p>
</body>
</html>