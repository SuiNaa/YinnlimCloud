<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>message</title>
<style>
  :root{ --brand:#6c4ef7; --muted:#777; --accent:#e91e63; }
  *{box-sizing:border-box}

  html, body{ height:100%; margin:0; }
  body{
    font-family:system-ui, -apple-system, "Noto Sans TC", Arial, sans-serif;
    background:#fafafa; color:#222;
    overflow:hidden; overscroll-behavior:contain;
  }

  .topbar{ position:sticky; top:0; background:#fff; border-bottom:1px solid #eee; padding:10px 14px; display:flex; align-items:center; gap:12px; z-index:10; }
  .topbar a{ color:var(--brand); text-decoration:none; font-weight:800; }

  .wrap{ height:calc(100dvh - 52px); display:grid; grid-template-columns: 320px 1fr; overflow:hidden; }

  .left{ border-right:1px solid #eee; background:#fff; overflow:auto; -webkit-overflow-scrolling:touch; }
  .right{ display:flex; flex-direction:column; min-height:0; }
  .empty{ display:flex; align-items:center; justify-content:center; color:#999; }

  .thread{ display:flex; gap:10px; padding:12px 12px; border-bottom:1px solid #f3f3f3; cursor:pointer; align-items:center; }
  .thread:hover{ background:#fafafa; }
  .thread.active{ background:#f0edff; }
  .avatar{ width:44px; height:44px; border-radius:50%; object-fit:cover; background:#f3f3f3; border:1px solid #eee; }
  .t-main{ flex:1; min-width:0; }
  .t-name{ font-weight:800; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .t-last{ color:#777; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .t-meta{ display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
  .badge{ min-width:18px; height:18px; padding:0 5px; border-radius:999px; background:#e91e63; color:#fff; font-size:12px; line-height:18px; text-align:center; font-weight:800; box-shadow:0 2px 6px rgba(0,0,0,.2); }
  .time{ color:#999; font-size:12px; }

  .chat-head{ background:#fff; border-bottom:1px solid #eee; padding:10px 14px; display:flex; align-items:center; gap:10px; }
  .chat-name{ font-weight:900; }

  .chat-body{ flex:1 1 auto; overflow:auto; -webkit-overflow-scrolling:touch; padding:14px; background:#fafafa; }

  .chat-foot{ position:sticky; bottom:0; z-index:5; border-top:1px solid #eee; background:#fff; padding:10px; display:flex; gap:8px; flex-shrink:0; }
/*åˆªé™¤---------------------*/
.msg-tools{ margin-top:4px; text-align:right; }
.msg-tools .link{
  font-size:12px;
  color:#e91e63;
  background:none;
  border:none;
  cursor:pointer;
}
.msg-tools .link:hover{ text-decoration:underline; }


/*-------------------------*/
  .msg{ display:flex; gap:10px; margin:8px 0; align-items:flex-end; }
  .msg.them{ flex-direction:row; }
  .msg.me{ flex-direction:row-reverse; }
/* å”¯ä¸€ã€æ­£ç¢ºç‰ˆï¼šè®“å…§å®¹å€æœ‰å¯ç”¨å¯¬åº¦ï¼Œæ³¡æ³¡æ‰ä¸æœƒè¢«æ“ æˆç›´æ¢ */
.msg .content{
  display:flex;
  flex-direction:column;
  align-items:flex-start;   /* å°æ–¹åœ¨å·¦ */
  flex:1 1 auto;            /* â† é—œéµï¼šçµ¦å®ƒå¯ç”¨å¯¬åº¦ */
  min-width:0;
  max-width:68%;
}
.msg.me .content{ align-items:flex-end; } /* æˆ‘æ–¹åœ¨å³ */

/* æ³¡æ³¡ç¶­æŒé€™æ¨£å³å¯ï¼ˆä½ åŸæœ¬å°±æœ‰ï¼‰ */
.bubble{
  display:inline-block;     /* ä¾å…§å®¹æ”¶ç¸® */
  max-width:68%;
  padding:10px 12px;
  border-radius:12px;
  background:#fff;
  border:1px solid #eee;
  line-height:1.45;
  word-break:break-word;
  white-space:pre-wrap;     /* ä¿ç•™ä½ çœŸçš„è¼¸å…¥çš„æ›è¡Œ */
}
  .msg.me .bubble{ background:#6c4ef7; color:#fff; border-color:transparent; }

  .input{ 
    min-height: 30px;
    flex:1; padding:10px 12px; 
    border-radius:12px; 
    border:1px solid #ddd; 
    outline:none;
    resize:none;              /* ç¦æ­¢æ‹–æ‹‰å¤§å° */
  line-height:1.45;
  max-height:30dvh;         /* æœ€å¤šé•·åˆ°ç•«é¢ 30% é«˜ */
  overflow:auto; 
  }
  .btn{ padding:10px 14px; border-radius:12px; border:1px solid #ddd; background:#fff; font-weight:700; cursor:pointer; }
  .btn.primary{ background:var(--brand); color:#fff; border-color:transparent; }

  @media (max-width:900px){
    .wrap{ grid-template-columns: 1fr; }
    .left{ height:42dvh; }
    .right{ height:calc(100dvh - 52px - 42dvh); min-height:0; }
  }
  .msg.pending{ opacity:.7 }
  /* ========== ä¸»é¡Œè®Šæ•¸ ========== */
:root{
  --brand:#6c4ef7;
  --muted:#777;
  --accent:#e91e63;

  /* ç™½å¤©ä¸‹æ‹‰ï¼šæ·¡ç²‰ */
  --dropdown-bg:#fdeaff;
  --dropdown-border:#f5ccff;
  --dropdown-text:#4a3a6a;
}

html[data-theme="dark"]{
  --text:#cfc3ff;
  --muted:#9a8fd1;
  --brand:#a48cff;
  --accent:#bf66ff;

  --card-bg:#161222;
  --card-border:#2b2440;
  --page-bg:#0f0b1a;

  --btn-bg:#1b1629;
  --btn-border:#2b2440;
  --btn-text:#cfc3ff;

  --shadow:0 10px 28px rgba(0,0,0,.45);
}

/* ========== å…¨å±€è‰²ç³» ========== */
html[data-theme="dark"] body{ background:var(--page-bg); color:var(--text); }
html[data-theme="dark"] .muted{ color:var(--muted); }
html[data-theme="dark"] .topbar,
html[data-theme="dark"] .left,
html[data-theme="dark"] .right,
html[data-theme="dark"] .chat-head,
html[data-theme="dark"] .chat-foot{
  background:var(--card-bg);
  border-color:var(--card-border);
  color:var(--text);
}
html[data-theme="dark"] .bubble{ background:var(--card-bg); border:1px solid var(--card-border); color:var(--text); }
html[data-theme="dark"] .msg.me .bubble{ background:var(--brand); color:#161222; border-color:transparent; }
html[data-theme="dark"] .thread.active{ background:rgba(164,140,255,.15); }

/* ========== å³ä¸Šè§’åœ“çƒæŒ‰éˆ• + ä¸‹æ‹‰é¸å–® ========== */
.menu-wrap{ position:relative; display:inline-flex; gap:8px; align-items:center; }

/* åœ“çƒæŒ‰éˆ• */
.menu-btn{
  width:34px; height:34px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:16px; font-weight:700; line-height:1;
  background:var(--brand); color:#fff; border:none;
  cursor:pointer; transition:transform .2s ease, background .2s ease, box-shadow .2s ease;
  box-shadow:0 4px 12px rgba(108,78,247,.22);
}
.menu-btn:hover{ transform:scale(1.08); }
.menu-btn:active{ transform:scale(.95); }
html[data-theme="dark"] .menu-btn{
  background:var(--btn-bg);
  border:1px solid var(--btn-border);
  color:var(--btn-text);
  box-shadow:none;
}

/* ä¸‹æ‹‰é¸å–® */
.dropdown{
  position:absolute; top:calc(100% + 8px); left:0;
  transform:translateX(8px) translateY(-6px) scale(.98);
  opacity:0; visibility:hidden; pointer-events:none;
  min-width:220px; max-width:min(320px,80vw);
  border-radius:14px; padding:8px; z-index:999;
  transition:opacity .16s ease, transform .18s cubic-bezier(.2,.8,.2,1);
  background:var(--dropdown-bg); color:var(--dropdown-text);
  border:1px solid var(--dropdown-border);
  box-shadow:0 16px 32px rgba(0,0,0,.18);
}
.dropdown.show{
  transform:translateX(8px) translateY(0) scale(1);
  opacity:1; visibility:visible; pointer-events:auto;
}
/* å»æ‰çªèµ·ç®­é ­ */
.dropdown::after{ content:none; }
.dropdown .item{ width:100%; text-align:left; padding:10px 12px; border:0; background:transparent; color:inherit; border-radius:8px; cursor:pointer; transition:.12s; }
.dropdown .item:hover{ background:rgba(108,78,247,.10); transform:translateY(-1px); }
html[data-theme="dark"] .dropdown{ background:var(--card-bg); color:var(--text); border:1px solid var(--card-border); box-shadow:var(--shadow); }

/* å°è¢å¹•è‡ªå‹•é å·¦ */
@media(max-width:560px){
  .dropdown, .dropdown.show{ left:0 !important; transform:translateX(0) translateY(0) scale(1); }
}
/* å¤œé–“æ¨¡å¼ï¼šæ•´é«” */
html[data-theme="dark"] body{
  background: var(--page-bg);
  color: var(--text);
}

/* å¤œé–“æ¨¡å¼ï¼šåˆ—è¡¨/é ­/èŠå¤©å€/è¼¸å…¥å€ */
html[data-theme="dark"] .topbar,
html[data-theme="dark"] .left,
html[data-theme="dark"] .chat-head,
html[data-theme="dark"] .chat-foot{
  background: var(--card-bg);
  border-color: var(--card-border);
  color: var(--text);
}

/* â† é€™è¡Œæ˜¯ä½ æ¼æ‰çš„ï¼Œæ‰€ä»¥çœ‹èµ·ä¾†æ•´ç‰‡ç™½ */
html[data-theme="dark"] .chat-body{
  background: var(--page-bg);
}

/* æ³¡æ³¡ã€æˆ‘æ–¹æ³¡æ³¡ */
html[data-theme="dark"] .bubble{
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  color: var(--text);
}
html[data-theme="dark"] .msg.me .bubble{
  background: var(--brand);
  color: #161222;
  border-color: transparent;
}

/* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
html[data-theme="dark"] .input{
  background: transparent;
  border: 1px solid var(--card-border);
  color: var(--text);
}
html[data-theme="dark"] .btn{
  background: var(--btn-bg);
  border: 1px solid var(--btn-border);
  color: var(--btn-text);
}
html[data-theme="dark"] .btn.primary{
  background: var(--brand);
  color: #161222;
  border-color: transparent;
}

/* å·¦å´åˆ—è¡¨ hover èˆ‡é¸ä¸­æ…‹ï¼ˆå¯é¸ï¼‰ */
html[data-theme="dark"] .thread:hover{ background: #1b1629; }
html[data-theme="dark"] .thread.active{ background: rgba(164,140,255,.15); }
/*BUg*/
/* å°å°åˆªé™¤å¾½ç« ï¼šè²¼è‘—é ­è²¼ï¼Œä¸æ¨æ“ ç‰ˆé¢ */
.msg{ position:relative; }               /* è®“å­å…ƒç´ å¯ä»¥çµ•å°å®šä½ */
.delbtn{
  position:absolute;
  bottom:-4px;                           /* é æ°£æ³¡åº•ç·£ä¸€é»é» */
  font-size:12px;
  padding:2px 6px;
  border-radius:8px;
  border:1px solid #f0cddd;
  background:#fff0f3;
  color:#d23a5b;
  line-height:1;
  cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,.06);
}
.delbtn:hover{ background:#ffe6ec; }

/* å·¦å³å…©é‚Šå®šä½ï¼šé ­è²¼å¯¬ 44px + é–“è· 10px = 54px */
.msg.them .delbtn{ left:54px; }          /* å°æ–¹è¨Šæ¯ï¼šè²¼å·¦é‚Šé ­è²¼ */
.msg.me   .delbtn{ right:54px; }         /* æˆ‘æ–¹è¨Šæ¯ï¼šè²¼å³é‚Šé ­è²¼ */

</style>
</head>
<body>
  <div class="topbar">
<div class="menu-wrap">
  <a href="javascript:goBack()">â† è¿”å›</a>
  <button id="menuBtn" class="menu-btn" aria-expanded="false" onclick="toggleMenu()">%</button>
  <div id="menuDrop" class="dropdown" role="menu">
    <!-- ç¬¬ä¸€å€‹é¸é …ï¼šåˆ‡æ›æ¨¡å¼ -->
    <button class="item" onclick="toggleTheme()" id="modeItem">åˆ‡æ›æ¨¡å¼ï¼šå¤œé–“</button>
     <button class="item" onclick="location.href='../index.html'">ä¸»é </button>
    <button class="item" onclick="location.href='Grove.Examination-Yuan.html'">åƒåŠ ç®¡ç†å“¡</button>
    <button class="item" onclick="location.href='Grove. Control-Yuan.html'">Control</button>
    <button class="item" onclick="location.href='Grove.Executive-Yuan.html'">Executive</button>
    <button class="item" onclick="location.href='Grove.Judicial-Yuan.html'">ç”³è¨´</button>
    <button class="item" onclick="location.href='Grove.Legislative-Yuan.html'">Legislative</button>
    <button class="item" onclick="location.href='vote.html'">æŠ•ç¥¨å°ˆå€</button>
    <button class="item" onclick="location.href='constitution.html'">ç¶²ç«™ç”³æ˜</button>
  </div>
</div>
    <div style="margin-left:auto"><a href="shopping.html">å•†åŸé¦–é </a></div>
  </div>

  <div class="wrap">
    <div class="left" id="threadList"></div>
    <div class="right">
      <div class="chat-head" id="chatHead" style="display:none">
        <img id="chatAvatar" class="avatar" alt="">
        <div class="chat-name" id="chatName">â€”</div>
      </div>
      <div class="chat-body" id="chatBody">
        <div class="empty" id="emptyHint">é¸ä¸€å€‹èŠå¤©çœ‹çœ‹æ”¶åˆ°çš„è¨Šæ¯å§ï½</div>
      </div>
      <div class="chat-foot" id="chatFoot" style="display:none">
        <textarea id="msgInput" class="input" rows="1" placeholder="Enter æ›è¡Œï¼ŒCtrl/âŒ˜+Enter é€å‡º"></textarea>
        <button class="btn primary" onclick="sendMessage()">å‚³é€</button>
      </div>
    </div>
  </div>
<audio id="ding" preload="auto">
  <source src="data:audio/mp3;base64,//uQZAAAAAAAA..." type="audio/mpeg">
</audio>
<script>
const API     = "https://zdqo2eqb.lc-cn-n1-shared.com/1.1";
const APP_ID  = "ZDqo2eQBcSChCfRgwix9jUeI-gzGzoHsz";
const APP_KEY = "U66ybZWAD99LrT9zJnQlW52H";
const CURRENCY_SIGN = 'Â¥';
const money = n => Number(n||0).toLocaleString('zh-TW');

function getDismissedMap(){
  try{ return JSON.parse(localStorage.getItem('sg_dismissed_threads')||'{}'); }
  catch(e){ return {}; }
}
function setDismissedMap(mp){
  localStorage.setItem('sg_dismissed_threads', JSON.stringify(mp||{}));
}
// èªè­‰ä¿è­·
(function guard(){
  const token = localStorage.getItem('sg_token');
  const user  = JSON.parse(localStorage.getItem('sg_user') || 'null');
  if(!token || !user){ location.replace('index.html?redirect=messages'); }
})();

const me = JSON.parse(localStorage.getItem('sg_user')||'null');
const mePtr = { "__type":"Pointer","className":"_User","objectId": me.objectId };
const token = localStorage.getItem('sg_token');
const AUTH  = { 'X-LC-Id': APP_ID, 'X-LC-Key': APP_KEY, 'X-LC-Session': token };

const DEFAULT_AVATAR = 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect width="100%" height="100%" rx="40" ry="40" fill="#f3f3f3"/><text x="50%" y="55%" text-anchor="middle" font-size="28">ğŸ™‚</text></svg>`);

let CURRENT_PARTNER = null;
let THREADS = [];

/* === å…¨åŸŸå°å‘å‡½å¼ï¼ˆé—œéµï¼‰ === */
function goProfile(uid){
  if(!uid) return;
  if(uid === me.objectId){ location.href = 'user.html'; }
  else{ location.href = 'seller.html?uid=' + encodeURIComponent(uid); }
}
window.goProfile = goProfile;

/* è®€ã€Œå«æˆ‘ã€çš„è¨Šæ¯ï¼Œå‰ç«¯èšåˆæˆæœƒè©± */
async function fetchConversations(){
  const orWhere = { "$or":[ { to: mePtr }, { from: mePtr } ] };
  const where = encodeURIComponent(JSON.stringify(orWhere));
  const url = `${API}/classes/Message?where=${where}&order=-createdAt&limit=100&include=from,to`;

  const res = await fetch(url, { headers: AUTH });
  const data = await res.json();
  if(!res.ok){ console.warn('fetchConversations error:', data); return []; }

  const map = new Map();
  data.results.forEach(m=>{
    const from = m.from, to = m.to;
    const fromId = from && from.objectId;
    const toId   = to   && to.objectId;
    if(!fromId || !toId) return;

    const partnerId   = (fromId === me.objectId) ? toId : fromId;
    const plusUnread = (toId === me.objectId && m.read === false) ? 1 : 0;
    const partnerObj  = (fromId === me.objectId ? to : from) || {};
    if(!map.get(partnerId)){
      map.set(partnerId, {
        partnerId,
        lastMsg: m,
        unread: plusUnread,
        user: {
          objectId: partnerId,
          nickname: partnerObj.nickname || partnerObj.username || '',
          avatarUrl: partnerObj.avatarUrl || ''
        }
      });
    }else{
      map.get(partnerId).unread += plusUnread;
    }
  });

  const list = Array.from(map.values());
  const needIds = list.filter(t => !(t.user.nickname && t.user.avatarUrl)).map(t => t.partnerId);
  if(needIds.length){ await hydrateUsers(list, needIds); }
  return list;
}

async function hydrateUsers(list, ids){
  const where = encodeURIComponent(JSON.stringify({ objectId: { "$in": ids } }));
  const url = `${API}/users?where=${where}&limit=${ids.length}`;
  try{
    const res = await fetch(url, { headers: AUTH });
    const data = await res.json();
    if(!res.ok) return;
    const dict = new Map();
    (data.results||[]).forEach(u=>dict.set(u.objectId, u));
    list.forEach(t=>{
      const u = dict.get(t.partnerId);
      if(u){
        t.user.nickname = u.nickname || u.username || t.user.nickname || '';
        t.user.avatarUrl = u.avatarUrl || t.user.avatarUrl || '';
      }
    });
  }catch(e){}
}

/* å·¦å´æ¸…å–® */
function renderThreads(){
  const box = document.getElementById('threadList');
  box.innerHTML = '';

  const dismissed = getDismissedMap();
  const visible = (THREADS||[]).filter(t=>{
    const last = t.lastMsg;
    if(!last) return false; // æ²’ä»»ä½•è¨Šæ¯å°±ä¸é¡¯ç¤º
    const lastTime = new Date(last.updatedAt || last.createdAt || 0).getTime();
    const cut = dismissed[t.partnerId] ? new Date(dismissed[t.partnerId]).getTime() : 0;
    // åªæœ‰ã€Œæœ€å¾Œè¨Šæ¯æ²’æœ‰æ¯”æˆ‘ç§»é™¤æ™‚æ›´æ–°ã€æ‰éš±è—ï¼›æœ‰æ–°è¨Šæ¯å°±æœƒå›ä¾†
    return lastTime > cut;
  });

  if(!visible.length){
    box.innerHTML = `<div class="empty" style="height:100%">ç›®å‰æ²’æœ‰ä»»ä½•è¨Šæ¯</div>`;
    return;
  }

  visible.forEach(t=>{
    const a = document.createElement('div');
    a.className = 'thread' + (t.partnerId===CURRENT_PARTNER?' active':'');
    a.onclick = ()=> openThread(t.partnerId);

    const u=t.user||{}, ava=u.avatarUrl||DEFAULT_AVATAR, name=u.nickname||'ç”¨æˆ¶';
    const last = t.lastMsg ? (t.lastMsg.kind==='order' ? 'ğŸ§¾ è¨‚å–®å·²æäº¤' : (t.lastMsg.text || 'ï¼ˆåœ–ç‰‡ï¼å…§å®¹ï¼‰')) : '';
    const time = t.lastMsg ? timeAgo(t.lastMsg.createdAt) : '';

    a.innerHTML = `
      <img class="avatar" src="${ava}" alt="">
      <div class="t-main">
        <div class="t-name">${escapeHTML(name)}</div>
        <div class="t-last">${escapeHTML(last)}</div>
      </div>
      <div class="t-meta">
        <div class="time">${time}</div>
        ${t.unread>0 ? `<div class="badge">${t.unread>99?'99+':t.unread}</div>` : ''}
        <button class="link" onclick="dismissThread('${t.partnerId}', event)">ç§»é™¤</button>
      </div>`;
    box.appendChild(a);
  });
}
function dismissThread(pid, ev){
  if(ev){ ev.stopPropagation(); ev.preventDefault(); } // ä¸è¦è§¸ç™¼ openThread

  const mp = getDismissedMap();
  // ç”¨ã€Œç›®å‰è¢å¹•ä¸Šé€™å€‹æœƒè©±çš„æœ€å¾Œè¨Šæ¯æ™‚é–“ã€æˆ–ç¾åœ¨æ™‚é–“åšè¨˜éŒ„
  const th = (THREADS||[]).find(t=>t.partnerId===pid);
  const lastISO = (th && th.lastMsg && (th.lastMsg.updatedAt || th.lastMsg.createdAt)) || new Date().toISOString();
  mp[pid] = lastISO;
  setDismissedMap(mp);

  // ç«‹å³é‡ç•«
  renderThreads();

  // è‹¥æ­£åœ¨çœ‹é€™å€‹æœƒè©±ï¼Œå³å´ä¹Ÿæ”¶èµ·
  if(CURRENT_PARTNER === pid){
    CURRENT_PARTNER = null;
    stopThreadPolling && stopThreadPolling();
    document.getElementById('chatHead').style.display='none';
    document.getElementById('chatBody').innerHTML = '<div class="empty">å·²ç§»é™¤æ­¤èŠå¤©</div>';
    document.getElementById('chatFoot').style.display='none';
  }
}
/* æ‰“é–‹æœƒè©± */
/* æ‰“é–‹æœƒè©±ï¼ˆå®Œæ•´è¦†è“‹ç‰ˆï¼‰ */
async function openThread(partnerId){
  CURRENT_PARTNER = partnerId;
  renderThreads();

  const t = THREADS.find(x=>x.partnerId===partnerId);

  // ---- å®‰å…¨é¡¯ç¤º/éš±è— ----
  const head  = document.getElementById('chatHead');
  const foot  = document.getElementById('chatFoot');
  const empty = document.getElementById('emptyHint');
  if (empty) empty.style.display = 'none';
  if (head)  head.style.display  = 'flex';
  if (foot)  foot.style.display  = 'flex';

  // ---- è¨­å®šæŠ¬é ­ï¼ˆæœ‰å°±è¨­ï¼Œæ²’æœ‰å°±è·³éï¼Œé¿å… null å ±éŒ¯ï¼‰----
  const chatAva  = document.getElementById('chatAvatar');
  const chatName = document.getElementById('chatName');
  if (chatAva)  {
    chatAva.src = (t?.user?.avatarUrl || DEFAULT_AVATAR);
    chatAva.onclick  = ()=> goProfile(partnerId);
  }
  if (chatName) {
    chatName.textContent = t?.user?.nickname || 'ç”¨æˆ¶';
    chatName.onclick = ()=> goProfile(partnerId);
  }

  // ---- æŠ“è¨Šæ¯ ----
  const where = {
    "$or":[
      { from: mePtr, to: { "__type":"Pointer","className":"_User","objectId": partnerId } },
      { from: { "__type":"Pointer","className":"_User","objectId": partnerId }, to: mePtr }
    ]
  };
  const url = `${API}/classes/Message?where=${encodeURIComponent(JSON.stringify(where))}&order=createdAt&limit=200&include=from,to,order,product`;
  const res = await fetch(url, { headers: AUTH });
  const data = await res.json();
  if(!res.ok){ console.warn('openThread error:', data); return; }

  renderChat(data.results||[]);
scrollToBottom(true);     // æ‰“é–‹æœƒè©±æ™‚ä¸€å®šæ²åº•

  // ---- æ¨™è¨˜æœªè®€ç‚ºå·²è®€ ----
  const needRead = (data.results||[]).filter(m=> m.to && m.to.objectId===me.objectId && (m.read===false || m.read==="false"));
  for(const m of needRead){
    try{
      await fetch(`${API}/classes/Message/${m.objectId}`,{
        method:'PUT',
        headers:{ ...AUTH, 'Content-Type':'application/json' },
        body: JSON.stringify({ read: true })
      });
    }catch(e){}
  }

  // ---- æ›´æ–°å·¦å´æ¸…å–®ä¸¦å•Ÿå‹•è¼ªè©¢ ----
  THREADS = await fetchConversations();
  renderThreads();
  startThreadPolling(partnerId);
}
// è®“ textarea è‡ªå‹•å¢é«˜ + å¿«æ·éµï¼šCtrl/âŒ˜+Enter é€å‡ºï¼ˆEnter åªæ˜¯æ›è¡Œï¼‰
(function enhanceInput(){
  const ta = document.getElementById('msgInput');
  if(!ta) return;
  const autoGrow = ()=>{
    ta.style.height = 'auto';
    ta.style.height = Math.min(ta.scrollHeight, ta.parentElement.clientHeight*0.9) + 'px';
  };
  ta.addEventListener('input', autoGrow);
  autoGrow();

  ta.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)){
      e.preventDefault();
      sendMessage();
    }
  });
})();
let __threadPollTimer = null;
let __lastUpdateISO = null;

// å•Ÿå‹•ç•¶å‰æœƒè©±çš„çŸ­è¼ªè©¢
function startThreadPolling(partnerId){
  stopThreadPolling(); // å…ˆåœæ‰èˆŠçš„

  // å¾ç¾åœ¨èµ·æŠ“ã€Œæ¯”é€™å€‹æ™‚é–“æ›´æ–°éã€çš„
  __lastUpdateISO = new Date().toISOString();

  const tick = async ()=>{
    // åªæŠ“é€™å€‹æœƒè©±çš„è¨Šæ¯ï¼Œå« from/toï¼Œæˆ‘æ–¹æˆ–å°æ–¹å‚³çš„éƒ½ç®—
    const where = {
      "$or":[
        { from: mePtr, to: { "__type":"Pointer","className":"_User","objectId": partnerId } },
        { from: { "__type":"Pointer","className":"_User","objectId": partnerId }, to: mePtr }
      ],
      "updatedAt": { "$gt": { "__type":"Date","iso": __lastUpdateISO } }
    };
    const url = `${API}/classes/Message?where=${encodeURIComponent(JSON.stringify(where))}&order=createdAt&limit=200&include=from,to`;
    try{
      const res = await fetch(url, { headers: AUTH });
      const data = await res.json();
      if(res.ok && Array.isArray(data.results)){
        // æ›´æ–°æœ€å¾Œæ™‚é–“ï¼ˆç”¨å›æ‡‰è£¡æœ€å¤§çš„ updatedAtï¼‰
        data.results.forEach(m=>{ if(m.updatedAt && m.updatedAt > __lastUpdateISO) __lastUpdateISO = m.updatedAt; });
        reconcileChat(partnerId); // åšä¸€æ¬¡å…¨é‡å°é½Šï¼ˆè¦‹ä¸‹ï¼‰
      }
    }catch(e){}
    __threadPollTimer = setTimeout(tick, 800);  // 800ms ä¸‹ä¸€è¼ª
  };
  tick();
}

function stopThreadPolling(){
  if(__threadPollTimer){ clearTimeout(__threadPollTimer); __threadPollTimer = null; }
}
// è®“è¼ªè©¢æ‹¿åˆ°æ›´æ–°å¾Œèƒ½é‡ç•«ç•«é¢
async function reconcileChat(partnerId){
  // åªå…è¨±æ›´æ–°ç•¶å‰æ­£åœ¨çœ‹çš„æœƒè©±ï¼Œé¿å…èˆŠè¼ªè©¢äº‚å‹• DOM
  if (partnerId !== CURRENT_PARTNER) return;

  const where = {
    "$or":[
      { from: mePtr, to: { "__type":"Pointer","className":"_User","objectId": partnerId } },
      { from: { "__type":"Pointer","className":"_User","objectId": partnerId }, to: mePtr }
    ]
  };
  const url = `${API}/classes/Message?where=${encodeURIComponent(JSON.stringify(where))}` +
              `&order=createdAt&limit=200&include=from,to,order,product`;

  try{
    const res = await fetch(url, { headers: AUTH });
    const data = await res.json();
    if(res.ok){
      renderChat(data.results || []);
      // renderChat(data.results||[]) ä¹‹å¾Œ
(data.results||[]).forEach(m=>{
  if (m.to && m.to.objectId === me.objectId &&
      (!m.from || m.from.objectId !== me.objectId)) {
    notifyNewMessage(m);
  }
});
      // åœ¨ tick() è£¡ï¼ŒæˆåŠŸæŠ“åˆ° data.results å¾Œï¼ŒåŠ ï¼š
if (Array.isArray(data.results)) {
  // åªæŒ‘ï¼šå°æˆ‘(to=me)ã€ä¸æ˜¯æˆ‘è‡ªå·±ç™¼(from!=me)ã€æœªè®€ æˆ– å‰›æ›´æ–°çš„
  const news = data.results.filter(m =>
    m.to && m.to.objectId === me.objectId &&
    (!m.from || m.from.objectId !== me.objectId)
  );
  news.forEach(notifyNewMessage);
}
      scrollToBottom();         // ä¸å¼·åˆ¶
    }
  }catch(e){
    // éœé»˜å¤±æ•—ï¼Œä¸é˜»æ–·è¼ªè©¢
  }
}
/* èŠå¤©è¨Šæ¯ï¼ˆå«è¨‚å–®å¡ï¼‰ */
function renderChat(list){
  const box = document.getElementById('chatBody');
  box.innerHTML = '';
  if(!list.length){
    box.innerHTML = `<div class="empty">é‚„æ²’æœ‰ä»»ä½•è¨Šæ¯</div>`;
    return;
  }
  list.forEach(m=>{
    const mine = m.from && m.from.objectId === me.objectId;
    const row = document.createElement('div');
    row.className = 'msg ' + (mine?'me':'them');
    row.dataset.id = m.objectId || '';

    const ava  = mine ? (me.avatarUrl||DEFAULT_AVATAR) : ((m.from&&m.from.avatarUrl)||DEFAULT_AVATAR);
    const avatarHtml = `<img class="avatar" src="${ava}" alt="">`;

    if (m.kind === 'order' && m.order){
      const o = m.order || {};
      const addr = o.address || {};
      const unitPrice = (o.unitPrice ?? o.price) || 0;
      const qty       = (o.quantity ?? 1);
      const total     = (o.totalPrice ?? (unitPrice * qty)) || unitPrice;
      const proof     = o.payProofUrl || '';
      const io        = o.io || (m.data && m.data.io) || '';

      row.innerHTML = `
        ${avatarHtml}
        <div class="bubble" style="max-width:520px">
          <div style="font-weight:800; margin-bottom:6px">ğŸ§¾ è¨‚å–®è³‡è¨Š</div>
          <div><b>å•†å“</b>ï¼š${escapeHTML(o.productTitle || m.product?.title || '')}</div>
          <div><b>è¦æ ¼</b>ï¼š${escapeHTML(o.variantName || '')}</div>
          ${io ? `<div><b>IO</b>ï¼š<code style="font-family:ui-monospace,monospace">${escapeHTML(io)}</code></div>` : ''}
          <div><b>å–®åƒ¹</b>ï¼š${CURRENCY_SIGN}${money(unitPrice)}</div>
          ${qty ? `<div><b>æ•¸é‡</b>ï¼š${qty}</div>` : ''}
          <div><b>é‡‘é¡</b>ï¼š${CURRENCY_SIGN}${money(total)}</div>
          <div style="margin:8px 0;"><b>æ”¶ä»¶åœ°å€</b>ï¼š
            ${escapeHTML([addr.countryCode, addr.province, addr.city, addr.district, addr.detail].filter(Boolean).join(' '))}
          </div>
          ${proof ? `<div style="margin-top:6px"><b>ä»˜æ¬¾æˆªåœ–</b><br><img src="${proof}" style="max-width:100%; border:1px solid #eee; border-radius:8px"></div>`:''}
        </div>
      `;
   }else{
  const mine = m.from && m.from.objectId === me.objectId;
  const delBtn = (mine && canDeleteMsg(m)) ? `<button class="delbtn">åˆªé™¤</button>` : '';

  row.innerHTML = `
    ${avatarHtml}
    <div class="content">
      <div class="bubble">${escapeHTML(m.text || '')}</div>
    </div>
    ${delBtn}
  `;
}
    box.appendChild(row);
  });
}
// å…¨å±€åªæ›ä¸€æ¬¡
document.getElementById('chatBody').addEventListener('click', (e)=>{
  const btn = e.target.closest('.delbtn');
  if(!btn) return;
  const row = btn.closest('.msg');
  const id  = row && row.dataset.id;
  if(id) deleteMyMessage(id);   // â† ç›´æ¥ç”¨ .msg çš„ data-id
});
// å°‡å–®ä¸€è¨Šæ¯æ’å…¥ç•«é¢ï¼ˆmineForce=true è¡¨ç¤ºé€™å‰‡ä¸€å®šè¦–ç‚ºè‡ªå·±ç™¼çš„ï¼‰
function appendChatMessage(m, mineForce){
  const box  = document.getElementById('chatBody');
  const mine = (mineForce!==undefined) ? mineForce : (m.from && m.from.objectId===me.objectId);

  const row = document.createElement('div');
  row.className = 'msg ' + (mine ? 'me' : 'them');
  if(m._temp) row.classList.add('pending');
  row.dataset.id = m.objectId || '';

  const ava = mine ? (me.avatarUrl || DEFAULT_AVATAR)
                   : ((m.from && m.from.avatarUrl) || DEFAULT_AVATAR);

  const avatarHtml = `<img class="avatar" src="${ava}" alt="">`;
  const delBtn = (mine && canDeleteMsg(m)) ? `<button class="delbtn">åˆªé™¤</button>` : '';

row.innerHTML = `
  ${avatarHtml}
  <div class="content">
    <div class="bubble">${escapeHTML(m.text || m.body || '')}</div>
  </div>
  ${delBtn}
`;
  box.appendChild(row);
}

/* å‚³é€è¨Šæ¯ï¼ˆå¯é¸ï¼‰ */
let SENDING = false; // ç°¡å–®é˜²æŠ–ï¼Œé¿å…é€£æŒ‰é€ æˆé‡è¤‡

async function sendMessage(){
  if(!CURRENT_PARTNER || SENDING) return;
  const input = document.getElementById('msgInput');
  const text  = (input.value || '').trim();
  if(!text) return;

  // å…ˆæŠŠè¼¸å…¥æ¡†æ¸…ç©ºï¼Œé¡¯ç¤ºä¸€æ¢ã€Œæš«æ™‚è¨Šæ¯ã€
  input.value = '';
  const tempId = 'tmp_' + Date.now();
  const tempMsg = {
    objectId: tempId,
    kind: 'chat',
    text,
    body: text,
    createdAt: new Date().toISOString(),
    from: { "__type":"Pointer","className":"_User","objectId": me.objectId, avatarUrl: me.avatarUrl || '' },
    to:   { "__type":"Pointer","className":"_User","objectId": CURRENT_PARTNER },
    _temp: true
  };
  appendChatMessage(tempMsg, true);
scrollToBottom(true);     // æˆ‘è‡ªå·±ç™¼è¨Šæ¯ä¸€å®šæ²åº•

  // é€åˆ°å¾Œç«¯
const payload = {
  kind:'chat',
  from:{ "__type":"Pointer","className":"_User","objectId": me.objectId },
  to:{ "__type":"Pointer","className":"_User","objectId": CURRENT_PARTNER },
  text, body:text, read: false
};

  SENDING = true;
  try{
    const res  = await fetch(`${API}/classes/Message`,{
      method:'POST', headers:{ ...AUTH, 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || 'send fail');

    // æŠŠæš«æ™‚è¨Šæ¯æ›æˆæ­£å¼ï¼ˆç§»é™¤ pending æ¨£å¼ã€æ›´æ–° idï¼‰
    const node = document.querySelector(`.msg[data-id="${tempId}"]`);
    if(node){
      node.classList.remove('pending');
      node.dataset.id = data.objectId || '';
    }

    // å·¦å´æœƒè©±æ›´æ–°ä¸€ä¸‹æœ€å¾Œä¸€å‰‡è¨Šæ¯
    const th = THREADS.find(t => t.partnerId === CURRENT_PARTNER);
    if(th){
      th.lastMsg = { ...tempMsg, _temp: undefined, objectId: data.objectId || tempId };
      renderThreads();
    }
  }catch(e){
    // å¤±æ•—çš„è©±æ¨™è¨˜ä¸€ä¸‹ & é‚„åŸè¼¸å…¥æ¡†å…§å®¹æ–¹ä¾¿é‡é€
    const node = document.querySelector(`.msg[data-id="${tempId}"] .bubble`);
    if(node){
      node.innerHTML += `<div style="color:#b00020; font-size:12px; margin-top:6px">å‚³é€å¤±æ•—</div>`;
    }
    input.value = text;
    alert(e.message || 'å‚³é€å¤±æ•—');
  }finally{
    SENDING = false;
  }
}

/* å·¥å…· */
function timeAgo(iso){
  const t = new Date(iso).getTime();
  const d = Date.now() - t;
  const sec = Math.round(d/1000);
  if(sec<60) return 'å‰›å‰›';
  const min=Math.round(sec/60); if(min<60) return `${min} åˆ†é˜å‰`;
  const hr=Math.round(min/60);  if(hr<24)  return `${hr} å°æ™‚å‰`;
  const dd=Math.round(hr/24);   if(dd<7)   return `${dd} å¤©å‰`;
  return new Date(iso).toLocaleDateString();
}
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }
/* å·¥å…· */
// --- è‡ªå‹•æ²åº•ï¼šåªåœ¨éœ€è¦æ™‚ ---
let STICKY_BOTTOM = true;   // ä¸€é–‹å§‹åœ¨åº•éƒ¨

function isNearBottom(el, gap=80){
  return (el.scrollHeight - el.scrollTop - el.clientHeight) <= gap;
}

// ç¶ä¸€æ¬¡ï¼šä½¿ç”¨è€…æ‰‹å‹•æ²å‹•æ™‚æ›´æ–° STICKY_BOTTOM
(function bindStickyWatcher(){
  const el = document.getElementById('chatBody');
  if(!el) return;
  el.addEventListener('scroll', ()=>{
    STICKY_BOTTOM = isNearBottom(el);
  }, { passive:true });
})();

// åªæœ‰åœ¨ sticky æˆ–å¼·åˆ¶(force=true)æ™‚æ‰æ²åˆ°åº•
function scrollToBottom(force=false){
  const el = document.getElementById('chatBody');
  if(!el) return;

  if(!force && !STICKY_BOTTOM) return; // ä½ åœ¨çœ‹èˆŠè¨Šæ¯ï¼Œå°±åˆ¥æ‰“æ“¾

  requestAnimationFrame(()=>{ el.scrollTop = el.scrollHeight; });

  // åœ–ç‰‡è¼‰å®Œå†è£œä¸€æ¬¡ï¼ˆåŒæ¨£éµå®ˆ stickyï¼‰
  const imgs = el.querySelectorAll('img');
  let left = imgs.length;
  if(left===0) return;
  imgs.forEach(im=>{
    const done = ()=>{
      left--;
      if(left===0 && (force || STICKY_BOTTOM)){
        requestAnimationFrame(()=>{ el.scrollTop = el.scrollHeight; });
      }
    };
    if(im.complete) done(); else im.addEventListener('load', done, { once:true });
  });
}

/* å•Ÿå‹• & è¼ªè©¢ */
(async function start(){
  THREADS = await fetchConversations();
  renderThreads();
})();
setInterval(async ()=>{
  THREADS = await fetchConversations();
  renderThreads();
}, 2000);
</script>
<script>
/* åªåšã€Œè®€ ?to= ä¸¦æ‰“é–‹ã€ï¼›ä¸æ”¹ä½ çš„è¼ªè©¢ã€ä¸é€ä»»ä½•è¨Šæ¯ */
(function () {
  var to = new URLSearchParams(location.search).get('to');
  if (!to) return;

  function ready() {
    // ä¸èƒ½ç”¨ window.API / window.AUTHï¼›ç›´æ¥æª¢æŸ¥å‡½å¼æ˜¯å¦å­˜åœ¨
    return (typeof renderThreads === 'function' &&
            typeof openThread === 'function'); 
  }

  async function fetchUserBrief(id){
    try{
      // é€™è£¡å¯ä»¥ç›´æ¥ç”¨ API / AUTHï¼ˆåŒä¸€å…¨åŸŸè…³æœ¬ä½œç”¨åŸŸå¯å–åˆ°ï¼‰
      const where = encodeURIComponent(JSON.stringify({ objectId: id }));
      const r = await fetch(`${API}/users?where=${where}&limit=1`, { headers: AUTH });
      const d = await r.json();
      if (!r.ok || !d.results || !d.results.length){
        return { objectId:id, nickname:'ç”¨æˆ¶', avatarUrl:'' };
      }
      const u = d.results[0];
      return {
        objectId: id,
        nickname: u.nickname || u.username || 'ç”¨æˆ¶',
        avatarUrl: u.avatarUrl || ''
      };
    }catch(e){
      return { objectId:id, nickname:'ç”¨æˆ¶', avatarUrl:'' };
    }
  }

  (async function boot(){
    // ç­‰åˆ° renderThreads / openThread å¯ç”¨å°±é–‹å§‹
    await new Promise(res=>{
      (function wait(){ if(ready()) return res(); requestAnimationFrame(wait); })();
    });

    const brief = await fetchUserBrief(to);
    if (!Array.isArray(window.THREADS)) window.THREADS = [];
    const idx = window.THREADS.findIndex(t => t.partnerId === to);
    if (idx === -1){
      window.THREADS.unshift({
        partnerId: to,
        lastMsg: null,
        unread: 0,
        user: brief
      });
    }else{
      window.THREADS[idx].user = { ...(window.THREADS[idx].user||{}), ...brief };
    }

    renderThreads();
    openThread(to);

    // ä¿éšªåˆ·æ–°ä¸€æ¬¡æŠ¬é ­
    setTimeout(function(){
      if (window.CURRENT_PARTNER === to) openThread(to);
    }, 1200);

    // æŠŠè¼¸å…¥æ¡†èšç„¦
    var inp = document.getElementById('msgInput');
    if (inp && typeof inp.focus === 'function') inp.focus();
  })();
})();
//================= åˆ‡æ› =================
function canDeleteMsg(m){
  if(!m || !m.createdAt) return false;
  const mine = m.from && m.from.objectId === me.objectId;
  if(!mine) return false;
  const age = Date.now() - new Date(m.createdAt).getTime();
  return age <= 2*60*1000; // 2 åˆ†é˜
}

async function deleteMyMessage(mOrId){
  const id = (typeof mOrId === 'string') ? mOrId : (mOrId && mOrId.objectId);
  if(!id) return;

  const node = document.querySelector(`.msg[data-id="${id}"]`);
  if(node){ node.classList.add('pending'); } // æ·¡å‡ºæ•ˆæœ

  try{
    // 1) å˜—è©¦ç¡¬åˆªï¼ˆçœŸæ­£å¾è³‡æ–™è¡¨ç§»é™¤ï¼‰
    const r = await fetch(`${API}/classes/Message/${id}`,{
      method:'DELETE', headers: AUTH
    });

    if(!r.ok){
      // 2) è‹¥æ²’æœ‰åˆªæ¬Šå°±åšã€Œåªå°æˆ‘éš±è—ã€
      const r2 = await fetch(`${API}/classes/Message/${id}`,{
        method:'PUT',
        headers:{ ...AUTH, 'Content-Type':'application/json' },
        body: JSON.stringify({ deletedFor: { "__op":"AddUnique", "objects":[ me.objectId ] } })
      });
      if(!r2.ok) throw new Error('delete/soft-delete failed');
    }

    // 3) ä¸ç®¡ç¡¬åˆªæˆ–è»ŸåˆªæˆåŠŸï¼Œå‰ç«¯éƒ½æŠŠé€™å‰‡ç›´æ¥ç§»é™¤
    if(node) node.remove();

    // å¦‚æœé€™å‰‡æ˜¯å·¦å´æ¸…å–®çš„æœ€å¾Œä¸€æ¢ï¼Œæ›´æ–°ä¸€ä¸‹
    const th = THREADS.find(t => t.partnerId === CURRENT_PARTNER);
    if(th && th.lastMsg && th.lastMsg.objectId === id){
      // é‡æ–°æŠ“ä¸€æ¬¡ç•¶å‰æœƒè©±ï¼Œæ‰¾æ–°çš„æœ€å¾Œä¸€æ¢
      openThread(CURRENT_PARTNER);
    }else{
      renderThreads();
    }
  }catch(e){
    alert('åˆªé™¤å¤±æ•—ï¼š'+(e.message||'')); 
    if(node) node.classList.remove('pending');
  }
}
// åªæ›ä¸€æ¬¡ï¼šé  .msg çš„ data-id å–å¾—çœŸæ­£ id
document.getElementById('chatBody').addEventListener('click', (e)=>{
  const btn = e.target.closest('.delbtn');
  if(!btn) return;
  const row = btn.closest('.msg');
  const id  = row && row.dataset.id;
  if(id) deleteMyMessage(id);
});
/* ======= é€šçŸ¥ï¼šæ¬Šé™ã€å»é‡ã€ç™¼é€ ======= */
const NOTI_KEY   = 'sg_notified_ids';
let NOTI_SEEN    = new Set(JSON.parse(localStorage.getItem(NOTI_KEY) || '[]').slice(-500));

function saveNotiSeen(){
  try{
    // åªä¿ç•™æœ€è¿‘ 500 ç­†ï¼Œé¿å… localStorage å¤ªå¤§
    const arr = Array.from(NOTI_SEEN).slice(-500);
    localStorage.setItem(NOTI_KEY, JSON.stringify(arr));
  }catch(e){}
}

async function ensureNotifyPermission(){
  if (!('Notification' in window)) return false;
  if (Notification.permission === 'granted') return true;
  if (Notification.permission === 'denied') return false;
  try{
    const p = await Notification.requestPermission();
    return p === 'granted';
  }catch(e){ return false; }
}

/** åœ¨æœ‰æ–°è¨Šæ¯ï¼ˆå°æˆ‘ã€ä¸”ä¸æ˜¯æˆ‘è‡ªå·±ï¼‰æ™‚å‘¼å« */
async function notifyNewMessage(msg){
  // å»é‡ï¼šåŒä¸€å‰‡ä¸è¦é‡è¤‡æé†’
  const id = msg.objectId || msg._id || (msg.createdAt + (msg.text||'')); 
  if (!id || NOTI_SEEN.has(id)) return;
  NOTI_SEEN.add(id); saveNotiSeen();

  const ok = await ensureNotifyPermission();
  const title = (msg.from && (msg.from.nickname||msg.from.username)) || 'æ–°è¨Šæ¯';
  const body  = msg.text || msg.body || 'ï¼ˆåœ–ç‰‡ï¼å…§å®¹ï¼‰';
  const icon  = (msg.from && msg.from.avatarUrl) || '/favicon.ico';

  if (ok){
    const n = new Notification(title, {
      body, icon,
      tag: id,                   // åŒ tag çš„é€šçŸ¥æœƒè¢«åˆä½µ
      renotify: false,           // ä¸é‡è¤‡éœ‡å‹•/è²éŸ³
      data: { fromId: msg.from && msg.from.objectId }
    });
    // é»æ“Šé€šçŸ¥ â†’ å›åˆ°åˆ†é  & è‡ªå‹•æ‰“é–‹é€™å€‹å°è©±
    n.onclick = () => {
      window.focus();
      if (n.data && n.data.fromId) openThread(n.data.fromId);
      n.close();
    };
  }
  // è²éŸ³ï¼ˆå¯èƒ½éœ€è¦ä½¿ç”¨è€…äº’å‹•å¾Œæ‰å…è¨±ï¼‰
  try{ document.getElementById('ding')?.play?.(); }catch(e){}
  // æ‰‹æ©Ÿéœ‡å‹•
  try{ navigator.vibrate && navigator.vibrate(120); }catch(e){}
}
function goBack(){
  if (document.referrer && document.referrer !== location.href) {
    // æœ‰ä¾†æºé  â†’ å›ä¸Šä¸€é 
    history.back();
  } else {
    // æ²’ä¾†æºï¼ˆä¾‹å¦‚ç›´æ¥è¼¸å…¥ç¶²å€é€²ä¾†ï¼‰â†’ çµ¦å€‹é è¨­
    location.href = "shopping.html";  
  }
}
</script>
<script src="im.js"></script>
<!--=================-->
<p style="text-align: center; font-size: 13px; color: #999; margin-top: 40px;">
  ğŸ¾ Â© 2024 yinnlimçš„å°å®‡å®™ï½œå…§å®¹èˆ‡è¨­è¨ˆçš†ç”±ç³–ç³–æœ¬äººç”¨æ„›è£½ä½œ ğŸ’<br>
  æœªç¶“æˆæ¬Šè«‹å‹¿éš¨æ„ä½¿ç”¨ã€ç›œè½‰å–” ğŸ™…â€â™€ï¸ è¬è¬ä½ çš„å°Šé‡èˆ‡æº«æŸ” ğŸ’Œ
</p>
</body>
</html>