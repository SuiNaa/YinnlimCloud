<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ç¶²ç«™ç”³æ˜</title>
<style>
  :root{ --bg:#f6f3ea; --text:#222; --muted:#666; --card:#fff; --border:#eee; --brand:#6c4ef7; }
  *{ box-sizing:border-box }

  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family:"DFKai-SB","KaiTi","æ¨™æ¥·é«”","BiauKai",serif;
  }
  .wrap{ max-width:980px; margin:0 auto; padding:20px 14px 80px; }
  header.top{ display:flex; align-items:flex-start; gap:12px; margin-bottom:12px; }
  h1{ margin:0; font-size:22px; }
  .hint{ color:var(--muted); font-size:13px; }

  .toolbar{ margin-left:auto; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .btn{ padding:8px 12px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; font-weight:800; }
  .btn[disabled]{ opacity:.5; cursor:not-allowed; }

  .themes{ display:flex; gap:8px; align-items:center; }
  .swatch{ width:22px; height:22px; border-radius:50%; border:1px solid rgba(0,0,0,.08); cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,.06); background:#fff; }
  .swatch[aria-selected="true"]{ outline:2px solid var(--text); }

  .editor{ min-height:calc(100vh - 120px); padding:4px 0; outline:none; }
  .editor[contenteditable="false"]{ user-select:text; }
  .editor:empty::before{ content: attr(data-placeholder); color:#999; }

  /* é¡è‰²ä¸»é¡Œ */
  body.theme-pink  { --bg:#fff6f9; --card:#fff; --border:#ffd9e6; --brand:#ff66a3; }
  body.theme-blue  { --bg:#f3f7ff; --card:#fff; --border:#d9e2ff; --brand:#5a7dff; }
  body.theme-purple{ --bg:#f6f3ff; --card:#fff; --border:#e0d6ff; --brand:#7a5aff; }
  body.theme-dark  { --bg:#0f1115; --text:#f0f0f0; --muted:#9aa3b2; --card:#171a21; --border:#2a2f3a; --brand:#8e7aff; }

  .toast{ position:fixed; left:50%; bottom:24px; transform:translateX(-50%); background:#000; color:#fff; padding:8px 12px; border-radius:10px; opacity:0; transition:opacity .18s; z-index:10; }

  /* æ¨™é¡Œæ¨£å¼ï¼ˆç„¡å³å´ç·šï¼‰ */
  .heading{ font-weight:900; font-size:20px; letter-spacing:.5px; margin:18px 0 10px; }

  /* ç´«è‰²åˆ†å‰²ç·š */
  .divider{ height:2px; background:var(--brand); border-radius:2px; margin:10px 0 14px; }

  /* h1 å³å´å³æ™‚ç‹€æ…‹ */
  .live { margin-left:8px; font-size:12px; color:var(--muted); line-height:22px; }
  .live.fade { opacity:.15; transition:opacity .5s; }

  /* å­—é«”æ¨£å¼é¢æ¿ï¼ˆå½ˆå‡ºï¼‰ */
.stylebox{
  position: fixed;               /* ğŸš© æ”¹æˆ fixed */
  z-index:1000; display:none;
  padding:10px; border:1px solid #ddd; border-radius:12px; background:#fff;
  box-shadow:0 10px 28px rgba(0,0,0,.18);
  gap:10px; align-items:center;
}
  .stylebox-row{ display:flex; gap:10px; align-items:center; }
  .stylebox input[type="color"]{ width:36px; height:28px; padding:0; border:none; background:transparent; }
  .stylebox input[type="range"]{ width:180px; }
  .stylebox .mini{ font-size:12px; padding:6px 8px; }
</style>
</head>
<body>
<div class="wrap">
  <header class="top">
    <button class="btn" onclick="goBack()">â† è¿”å›</button>
    <!-- æ–°å¢ï¼šå­—é«”é¡è‰²/å¤§å°æŒ‰éˆ•ï¼ˆåœ¨è¿”å›æ—é‚Šï¼‰ -->
    <button class="btn" id="btnStyle" disabled>æ·»åŠ å­—é«”é¡è‰²èˆ‡å¤§å°</button>

    <div>
      <h1 id="docTitle">ç¶²ç«™è¦å‰‡ï¼ˆæ†²ç« ï¼‰ <span id="liveStatus" class="live">è®€å–ä¸­â€¦</span></h1>
      <div class="hint" id="permHint">è®€å–ä¸­â€¦</div>
    </div>

    <div class="toolbar">
      <div class="themes" title="èƒŒæ™¯ä¸»é¡Œ">
        <div class="swatch" data-theme="pink"   style="background:#ffd5e6"></div>
        <div class="swatch" data-theme="blue"   style="background:#cfe0ff"></div>
        <div class="swatch" data-theme="purple" style="background:#d9d0ff"></div>
        <div class="swatch" data-theme="dark"   style="background:#1c2130"></div>
      </div>
      <button class="btn" id="btnHeading" disabled>è¨­ç‚ºæ¨™é¡Œ</button>
      <button class="btn" id="btnDivider" disabled>åŠ å…¥åˆ†å‰²ç·š</button>
      <button class="btn" id="btnDelDivider" disabled>åˆªé™¤åˆ†å‰²ç·š</button>
    </div>
  </header>

  <div id="editor" class="editor" contenteditable="false"
       role="textbox" aria-multiline="true"
       data-placeholder="è«‹é–‹å§‹æ’°å¯«è¦å‰‡â€¦"></div>
</div>

<!-- å­—é«”æ¨£å¼é¢æ¿ -->
<div id="styleBox" class="stylebox">
  <div class="stylebox-row">
    <label>é¡è‰²ï¼š</label>
    <input id="colorPicker" type="color" value="#000000">
    <button class="btn mini" id="btnClearColor">å–æ¶ˆé¡è‰²</button>
  </div>
  <div class="stylebox-row">
    <label>å¤§å°ï¼š</label>
    <input id="sizeRange" type="range" min="12" max="48" step="1" value="16">
    <span id="sizeLabel" style="width:36px;text-align:right;">16</span>px
  </div>
</div>

<div id="toast" class="toast">â€”</div>

<script>
/* ===== åŸºæœ¬è¨­å®š ===== */
const API="https://zdqo2eqb.lc-cn-n1-shared.com/1.1";
const APP_ID="ZDqo2eQBcSChCfRgwix9jUeI-gzGzoHsz";
const APP_KEY="U66ybZWAD99LrT9zJnQlW52H";
const SUPER_UID="68b19eeb90ed2201c4839219";
/* ===== ç«‹æ³•é™¢é€šé—œè­‰ + ä¾†æºé©—è­‰ ===== */
// è®€ä¸€æ¬¡æ€§é€šé—œè­‰
function readPass(){
  try{
    const raw = sessionStorage.getItem('constitution_pass');
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{ return null; }
}
// æ¶ˆè€—ä¸¦é©—è­‰é€šé—œè­‰ï¼ˆå¿…é ˆ uid ç¬¦åˆã€from=legislatureã€æœªéæœŸï¼‰
function consumePass(expectedUid){
  const p = readPass();
  const ok = !!p
    && p.uid === expectedUid
    && p.from === 'legislature'
    && typeof p.exp === 'number'
    && Date.now() <= p.exp;
  if(p) sessionStorage.removeItem('constitution_pass'); // ä¸€æ¬¡æ€§
  return ok;
}
// ä¾†æºé æ˜¯å¦çœŸçš„æ˜¯åŒç«™çš„ legislature.htmlï¼ˆå®¹è¨±æŸ¥è©¢åƒæ•¸ï¼‰
function cameFromLegislature(){
  try{
    if(!document.referrer) return false;
    const r = new URL(document.referrer);
    const here = new URL(location.href);
    if(r.origin !== here.origin) return false;
    return /legislature\.html$/i.test(r.pathname);
  }catch{ return false; }
}
const AUTH={ 'X-LC-Id':APP_ID,'X-LC-Key':APP_KEY };
function lc(){ const t=localStorage.getItem('sg_token'); return t?{...AUTH,'X-LC-Session':t}:AUTH; }
function h(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
function toast(s){const t=document.getElementById('toast'); t.textContent=s; t.style.opacity='1'; setTimeout(()=>t.style.opacity='0',1500);}

let ME=null, CAN_EDIT=false, DOC=null, LAST_UPDATED_AT=null;
// åªè¦è¦–å£å°ºå¯¸/åç§»æ”¹è®Šï¼Œå°±é‡ç®—ä½ç½®ï¼ˆæ”¯æ´ iPad éµç›¤/ç¸®æ”¾ï¼‰
window.addEventListener('resize', repositionStyleBox);
window.addEventListener('scroll', repositionStyleBox, { passive: true });
if (window.visualViewport) {
  visualViewport.addEventListener('resize', repositionStyleBox);
  visualViewport.addEventListener('scroll',  repositionStyleBox);
}
function consumeUrlPass(expectedUid){
  try{
    const url = new URL(location.href);
    const from = url.searchParams.get('from');
    const u    = url.searchParams.get('u');
    const t    = parseInt(url.searchParams.get('t') || '0', 10);

    const ok = (from === 'legislature') &&
               (u === expectedUid) &&
               Number.isFinite(t) &&
               Date.now() <= t;

    if(ok){
      // ç«‹å³ä½œå»¢ï¼ˆæ¸…æ‰åƒæ•¸ï¼Œé¿å…é‡æ–°æ•´ç†åˆé€šéï¼‰
      url.searchParams.delete('from');
      url.searchParams.delete('u');
      url.searchParams.delete('t');
      history.replaceState(null, '', url.toString());
      return true;
    }
  }catch{}
  return false;
}
// ä½ åŸæœ¬å°±æœ‰ selectionchangeï¼›æŠŠå‘¼å«æ”¹æˆä¸Šé¢çš„ repositionStyleBox
document.addEventListener('selectionchange', ()=>{
  if (styleBox.style.display === 'block') {
    const r = getRangeInEditor();
    if (r) savedRange = r.cloneRange();
    repositionStyleBox();      // ğŸš© ç”¨æ–°å‡½å¼
  }
});

/* ===== ç‹€æ…‹å­—ï¼ˆh1 å³å´ï¼‰ ===== */
const live = {
  el: null, timer: null,
  set(txt){
    if(!this.el) this.el=document.getElementById('liveStatus');
    this.el.classList.remove('fade');
    this.el.textContent = txt;
    if(this.timer) clearTimeout(this.timer);
    if (txt.startsWith('âœ…')) {
      this.timer=setTimeout(()=> this.el.classList.add('fade'), 2000);
    }
  }
};

/* ç™»å…¥ */
async function requireLogin(){
  const token=localStorage.getItem('sg_token'); const me=JSON.parse(localStorage.getItem('sg_user')||'null');
  if(!token||!me){ alert('è«‹å…ˆç™»å…¥'); location.replace('index.html'); return false; }
  ME=me; return true;
}

/* æ¬Šé™ */
async function whichInternalGroup(uid){
  if(uid===SUPER_UID) return 'SUPER';
  const p={ "__type":"Pointer","className":"_User","objectId":uid };
  const where=encodeURIComponent(JSON.stringify({ "$or":[{user:p},{User:p}], active:true }));
  for(const t of ['Legislator','Admin','ExamStaff']){
    try{
      const r=await fetch(`${API}/classes/${t}?where=${where}&limit=1`,{headers:lc()});
      if(r.ok){ const d=await r.json(); if(d.results && d.results.length>0) return t; }
    }catch(_){}
  }
  return null;
}

/* è®€å–ï¼å¯«å…¥ */
async function fetchDoc(){
  const where=encodeURIComponent(JSON.stringify({ key:"main" }));
  const r=await fetch(`${API}/classes/ConstitutionDoc?where=${where}&limit=1`,{headers:lc()});
  const d=await r.json();
  if(!r.ok) throw new Error(d.error||'è®€å–å¤±æ•—');
  if(!d.results || !d.results[0]) throw new Error('å°šæœªå»ºç«‹ ConstitutionDocï¼ˆkey="main"ï¼‰ã€‚');
  DOC=d.results[0]; LAST_UPDATED_AT=DOC.updatedAt; return DOC;
}
async function saveDoc({content,theme,force}={}){
  if(!CAN_EDIT || !DOC) return;
  live.set('å„²å­˜ä¸­â€¦');
  const latest=await fetch(`${API}/classes/ConstitutionDoc/${DOC.objectId}`,{headers:lc()});
  const snap=await latest.json();
  if(latest.ok && snap.updatedAt && !force && snap.updatedAt!==LAST_UPDATED_AT){
    toast('æœ‰æ–°ç‰ˆæœ¬è¢«å…¶ä»–äººæ›´æ–°äº†'); live.set('âš ï¸ æœ‰æ–°ç‰ˆæœ¬'); return;
  }
  const body={};
  if(typeof content==='string') body.content=content;
  if(typeof theme==='string') body.theme=theme;
  body.lastEditedBy={ "__type":"Pointer","className":"_User","objectId":ME.objectId };
  const r=await fetch(`${API}/classes/ConstitutionDoc/${DOC.objectId}`,{
    method:'PUT', headers:{'Content-Type':'application/json',...lc()}, body:JSON.stringify(body)
  });
  const d=await r.json();
  if(!r.ok){ live.set('âŒ å„²å­˜å¤±æ•—'); throw new Error(d.error||'å„²å­˜å¤±æ•—'); }
  LAST_UPDATED_AT=d.updatedAt||LAST_UPDATED_AT;
  live.set('âœ… å·²å„²å­˜');
}

/* ä¸»é¡Œ */
function applyTheme(name,persist){
  document.body.classList.remove('theme-pink','theme-blue','theme-purple','theme-dark');
  document.body.classList.add('theme-'+name);
  document.querySelectorAll('.swatch').forEach(s=>s.setAttribute('aria-selected', s.dataset.theme===name));
  if(persist && CAN_EDIT){ saveDoc({theme:name}).catch(e=>toast(e.message||'ä¸»é¡Œå„²å­˜å¤±æ•—')); }
  else { localStorage.setItem('constitution_theme', name); }
}

/* iPad/ç©ºç™½èšç„¦è£œä¸ï¼ˆæ›´ä¿å®ˆï¼‰ */
function ensureEditorReady(){
  const ed = document.getElementById('editor');
  if (!CAN_EDIT || !ed) return;
  const onlyText = (ed.textContent || '').replace(/\u200B/g,'').trim();
  if (!ed.innerHTML || onlyText === '') {
    ed.innerHTML = '';
    const p = document.createElement('p');
    p.appendChild(document.createElement('br'));
    ed.appendChild(p);
  }
  requestAnimationFrame(() => {
    if (!document.body.contains(ed)) return;
    try { ed.focus({ preventScroll: true }); } catch { ed.focus(); }
    const sel = (typeof window.getSelection === 'function') ? window.getSelection() : null;
    if (!sel) return;
    const last = ed.lastChild;
    if (last && last.nodeType === 1) sel.collapse(last, last.childNodes.length);
    else sel.collapse(ed, ed.childNodes.length);
  });
}

/* ç·¨è¼¯ç‹€æ…‹ */
function setEditable(on){
  const ed = document.getElementById('editor');
  const toolbar = document.querySelector('.toolbar'); // ä¸»é¡Œ + ä¸‰å€‹æŒ‰éˆ•éƒ½åœ¨é€™è£¡
  ed.setAttribute('contenteditable', on ? 'true' : 'false');

  // ç·¨è¼¯å·¥å…·æ•´çµ„é¡¯ç¤º / éš±è—
  if(toolbar) toolbar.style.display = on ? 'flex' : 'none';

  // è¬ä¸€ä½ æƒ³åªç¦ç”¨ä¸éš±è—ï¼Œä¹Ÿä¿ç•™é€™è¡Œï¼š
  ['btnStyle','btnHeading','btnDivider','btnDelDivider'].forEach(id=>{
    const b=document.getElementById(id); if(b) b.disabled=!on;
  });

  const hint=document.getElementById('permHint');
  if(hint) hint.textContent = on ? 'ä½ å…·æœ‰ç·¨è¼¯æ¬Šé™ï¼ˆå³æ™‚å„²å­˜ï¼‰' : 'å”¯è®€æ¨¡å¼';

  if (on) ensureEditorReady();
}

/* å³æ™‚å„²å­˜ï¼ˆé˜²æŠ–ï¼‰ */
let saveTimer=null;
function scheduleAutosave(){
  if(!CAN_EDIT) return;
  live.set('å„²å­˜ä¸­â€¦');
  clearTimeout(saveTimer);
  saveTimer=setTimeout(async ()=>{ try{ await saveDoc({content:document.getElementById('editor').innerHTML}); }catch(e){ toast(e.message||'å„²å­˜å¤±æ•—'); } },600);
}
// æ¸…ç†ä½”ä½å­—å…ƒï¼ˆWORD JOINERï¼‰ï¼Œé¿å…æ®˜ç•™åœ¨å…§å®¹è£¡
document.getElementById('editor').addEventListener('input', ()=>{
  const ed = document.getElementById('editor');
  ed.querySelectorAll('span[data-probe]').forEach(sp=>{
    if (sp.textContent && sp.textContent.indexOf('\u2060') !== -1) {
      sp.textContent = sp.textContent.replace(/\u2060/g,'');
      sp.removeAttribute('data-probe');
    }
    if (sp.textContent === '') sp.replaceWith(document.createTextNode(''));
  });
});
/* å·¥å…·ï¼šRange å–å¾—/è¨­å®š */
function getRangeInEditor(){
  const ed=document.getElementById('editor');
  const sel=window.getSelection();
  if(!sel || sel.rangeCount===0) return null;
  const r=sel.getRangeAt(0);
  return ed.contains(r.commonAncestorContainer) ? r : null;
}
function setSelectionToAfter(node){
  const range=document.createRange();
  range.setStartAfter(node); range.collapse(true);
  const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
}

/* ===== å…§å®¹æ“ä½œ ===== */
/* è¨­ç‚ºæ¨™é¡Œ */
function makeHeadingFromSelection(){
  if(!CAN_EDIT) return;
  const r=getRangeInEditor();
  const ed=document.getElementById('editor');
  if(!r){ ed.focus(); return; }
  if(r.collapsed){
    const el=document.createElement('div'); el.className='heading'; el.textContent='ï¼ˆè«‹è¼¸å…¥æ¨™é¡Œï¼‰';
    r.insertNode(el); setSelectionToAfter(el); scheduleAutosave(); return;
  }
  const el=document.createElement('div'); el.className='heading'; el.textContent=r.toString();
  r.deleteContents(); r.insertNode(el); setSelectionToAfter(el); scheduleAutosave();
}

/* æ’å…¥/åˆªé™¤åˆ†å‰²ç·š */
function insertPurpleDividerAtCaret(){
  if(!CAN_EDIT) return;
  const r=getRangeInEditor(); const ed=document.getElementById('editor');
  const line=document.createElement('div'); line.className='divider';
  if(!r){ ed.appendChild(line); } else { r.insertNode(line); setSelectionToAfter(line); }
  scheduleAutosave();
}
function deleteNearestDivider(){
  if(!CAN_EDIT) return;
  const ed=document.getElementById('editor'); const r=getRangeInEditor();
  if(!r){ ed.focus(); return; }
  const caretRect=r.getBoundingClientRect(); const divs=Array.from(ed.querySelectorAll('.divider'));
  if(divs.length===0) return;
  let best=null,bestDist=Infinity;
  divs.forEach(d=>{
    const dr=d.getBoundingClientRect();
    const cx=dr.left+dr.width/2, cy=dr.top+dr.height/2;
    const dx=(caretRect.left+caretRect.width/2)-cx;
    const dy=(caretRect.top+caretRect.height/2)-cy;
    const dist=Math.abs(dy)+Math.abs(dx)*0.2;
    if(dist<bestDist){bestDist=dist;best=d;}
  });
  if(best){
    const next=best.nextSibling; best.remove();
    if(next){ setSelectionToAfter(next.previousSibling || next); }
    else{
      const range=document.createRange(); range.selectNodeContents(ed); range.collapse(false);
      const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
    }
    scheduleAutosave();
  }
}

/* ===== å­—é«”é¡è‰²èˆ‡å¤§å°ï¼šé¢æ¿ & é‚è¼¯ ===== */
const styleBox = document.getElementById('styleBox');
let savedRange = null; // æ°¸é è¨˜ä½ç•¶å‰è¦æ“ä½œçš„é¸å€

function saveSelection(){
  const r = getRangeInEditor();
  if (r) savedRange = r.cloneRange();
}

function restoreSelection(){
  if (!savedRange) return null;
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(savedRange);
  // ç¢ºèª savedRange ä»åœ¨ editor è£¡ï¼ˆé¿å…DOMè®Šå‹•å¾Œå¤±æ•ˆï¼‰
  const r = getRangeInEditor();
  return r || null;
}
const colorPicker = document.getElementById('colorPicker');
const sizeRange = document.getElementById('sizeRange');
const sizeLabel = document.getElementById('sizeLabel');
const btnClearColor = document.getElementById('btnClearColor');
let styleRange = null; // é–‹é¢æ¿æ™‚è¨˜éŒ„çš„ range
// å–å¾—è¦–å£è³‡è¨Šï¼ˆæ”¯æ´ iOS çš„ visualViewportï¼‰
function getViewportBox(){
  const vv = window.visualViewport;
  if (vv) {
    return {
      left: vv.offsetLeft,
      top: vv.offsetTop,
      width: vv.width,
      height: vv.height
    };
  }
  return { left: 0, top: 0, width: window.innerWidth, height: window.innerHeight };
}

// æŠŠ styleBox æ”¾åœ¨ range é™„è¿‘ï¼Œä¸¦ä¸”ä¸è¶…å‡ºè¦–çª—
function placeStyleBoxAtRange(range){
  const box = styleBox;
  if (!box || !range) return;

  // å…ˆé¡¯ç¤ºï¼Œæ‰èƒ½é‡åˆ°å¯¬é«˜
  box.style.display = 'block';

  const rect = range.getBoundingClientRect();
  const vp = getViewportBox();
  const margin = 8; // èˆ‡é‚Šç•Œ/é¸å€çš„é–“è·
  const bw = box.offsetWidth || 260;
  const bh = box.offsetHeight || 80;

  // å„ªå…ˆæ”¾åœ¨é¸å€ä¸‹æ–¹ï¼›å¦‚æœä¸‹æ–¹ç©ºé–“ä¸å¤ ï¼Œå°±æ”¾ä¸Šæ–¹
  let topCandidate = rect.bottom + margin;
  const bottomRoom = vp.top + vp.height - (rect.bottom + margin) - bh;
  if (bottomRoom < 0) {
    topCandidate = rect.top - bh - margin;
  }

  // æ°´å¹³ç½®ä¸­ï¼Œç„¶å¾Œå¤¾ä½å·¦å³é‚Šç•Œ
  let leftCandidate = rect.left + rect.width/2 - bw/2;
  leftCandidate = Math.max(vp.left + margin, Math.min(leftCandidate, vp.left + vp.width - margin - bw));

  // å†å¤¾ä½ä¸Šä¸‹é‚Šç•Œ
  topCandidate  = Math.max(vp.top + margin, Math.min(topCandidate,  vp.top + vp.height - margin - bh));

  // å¯«å›ï¼ˆfixed åŸºæ–¼è¦–å£ï¼‰
  box.style.left = `${leftCandidate}px`;
  box.style.top  = `${topCandidate}px`;
}
function showStyleBox(){
  if(!CAN_EDIT) return;
  saveSelection();
  const r = savedRange || getRangeInEditor();
  if(!r){ ensureEditorReady(); return; }
  placeStyleBoxAtRange(r);     // ğŸš© ç”¨æ–°å‡½å¼å®šä½
}

// è®“é¢æ¿è·Ÿè‘—é¸å€ç§»å‹• & å¤¾é‚Šç•Œ
function repositionStyleBox(){
  if (styleBox.style.display !== 'block') return;
  const r = savedRange || getRangeInEditor();
  if (!r) return;
  placeStyleBoxAtRange(r);     // ğŸš© ç”¨æ–°å‡½å¼å®šä½
}

function hideStyleBox(){ styleBox.style.display='none'; }

/* å°‡æ¨£å¼å¥—åœ¨ styleRange æˆ–ç›®å‰é¸å– */
function applyStyle({ color = null, size = null, clearColor = false } = {}) {
  // æ¯æ¬¡æ“ä½œå‰æŠŠé¸å€é‚„åŸå›ç·¨è¼¯å™¨
  const r = restoreSelection();
  if (!r) return;

  const sel = window.getSelection();

  // -------- æƒ…æ³ Aï¼šåªæœ‰æ¸¸æ¨™ï¼ˆæœªé¸å­—ï¼‰ --------
  if (r.collapsed) {
    if (clearColor) {
      // å¾€ä¸Šæ‰¾æœ€è¿‘æœ‰ color çš„ç¥–å…ˆï¼ŒæŠŠ color æ‹”æ‰å³å¯
      let el = r.startContainer.nodeType === 1 ? r.startContainer : r.startContainer.parentElement;
      while (el && el !== document.getElementById('editor')) {
        if (el.style && el.style.color) { el.style.color = ''; break; }
        el = el.parentElement;
      }
    }
    // æ’ä¸€å€‹æœ‰æ¨£å¼çš„ spanï¼Œä¹‹å¾Œæ‰“å­—æ²¿ç”¨ï¼ˆWORD JOINER é¿å…å°é»ï¼‰
    const span = document.createElement('span');
    if (!clearColor && color) span.style.color = color;
    if (size) span.style.fontSize = size + 'px';
    span.textContent = '\u2060';
    span.setAttribute('data-probe', '1');

    r.insertNode(span);

    // æ¸¸æ¨™ç•™åœ¨é€™å€‹ span å…§éƒ¨ï¼Œæ–¹ä¾¿é€£çºŒæ“ä½œ
    const nr = document.createRange();
    nr.selectNodeContents(span);
    nr.collapse(true);
    sel.removeAllRanges(); sel.addRange(nr);
    saveSelection();       // è¨˜ä½æ–°çš„é¸å€
    scheduleAutosave();
    return;
  }

  // -------- æƒ…æ³ Bï¼šæœ‰é¸åˆ°ä¸€æ®µæ–‡å­— --------
  if (clearColor) {
    // 1) å–å‡ºé¸å€å…§å®¹
    const frag = r.extractContents();

    // 2) èµ°è¨ª fragmentï¼ŒæŠŠæ‰€æœ‰å…ƒç´ çš„ color æ¸…æ‰
    const clearNodeColor = (node) => {
      if (node.nodeType === 1 && node.style) node.style.color = '';
      for (let i = 0; i < node.childNodes.length; i++) clearNodeColor(node.childNodes[i]);
    };
    clearNodeColor(frag);

    // 3) ç”¨ä¸€å€‹è‡¨æ™‚åŒ…è£å™¨æ”¾å›å»ï¼ˆç‚ºäº†å¥½è¨­å®šã€Œä»ä¿æŒé¸å–ã€ï¼‰
    const wrapper = document.createElement('span'); // ä¸åŠ æ¨£å¼
    wrapper.appendChild(frag);
    r.insertNode(wrapper);

    // 4) æŠŠé¸å–è¨­ç‚º wrapper çš„å…§å®¹
    const nr = document.createRange();
    nr.selectNodeContents(wrapper);
    sel.removeAllRanges(); sel.addRange(nr);
    saveSelection();
    scheduleAutosave();
    return;
  }

  // ä¸æ˜¯æ¸…é¡è‰²ï¼šå¥—é¡è‰²/å¤§å° -> ç”¨ span åŒ…ä½åŸä¾†é¸å€
  const span = document.createElement('span');
  if (color) span.style.color = color;
  if (size)  span.style.fontSize = size + 'px';

  try {
    // è‹¥é¸å€æ˜¯ã€Œç´”æ–‡å­—æˆ–å¯æ•´é«”åŒ…ä½çš„ç¯€é»ã€ï¼Œé€™æ‹›æœ€å¿«
    r.surroundContents(span);
  } catch {
    // å«éƒ¨åˆ†ç¯€é»é‚Šç•Œæ™‚æœƒ throwï¼Œæ”¹ç‚ºæŠ½å‡ºå¾Œå†åŒ…å›
    const frag = r.extractContents();
    span.appendChild(frag);
    r.insertNode(span);
  }

  // å†æŠŠé¸å–è¨­ç‚ºå‰›å‰›çš„å…§å®¹ï¼ˆä¸æ˜¯æ”¾åˆ°å¾Œé¢ï¼Œé¿å…é¸å–æ¶ˆå¤±ï¼‰
  const nr = document.createRange();
  nr.selectNodeContents(span);
  sel.removeAllRanges(); sel.addRange(nr);
  saveSelection();

  scheduleAutosave();
}

/* äº‹ä»¶ï¼šé¡è‰²/å¤§å°/æ¸…é™¤é¡è‰² */
colorPicker.addEventListener('input', ()=>{
  restoreSelection();
  applyStyle({ color: colorPicker.value });
});

sizeRange.addEventListener('input', ()=>{
  sizeLabel.textContent = sizeRange.value;
  restoreSelection();
  applyStyle({ size: parseInt(sizeRange.value, 10) });
});

btnClearColor.addEventListener('click', (e)=>{
  e.preventDefault();
  restoreSelection();
  applyStyle({ clearColor: true });
});
document.addEventListener('selectionchange', ()=>{
  if (styleBox.style.display === 'block') {
    const r = getRangeInEditor();
    if (r) savedRange = r.cloneRange();
  }
});

document.addEventListener('selectionchange', ()=>{
  if (styleBox.style.display === 'block') {
    const r = getRangeInEditor();
    if (r) savedRange = r.cloneRange();
    repositionStyleBox();
  }
});
/* é»ä»»æ„è™•é—œé–‰é¢æ¿ï¼ˆä½†é»é¢æ¿æœ¬èº«ä¸é—œï¼‰ */
document.addEventListener('mousedown', (e)=>{
  if(styleBox.style.display==='block' && !styleBox.contains(e.target) && e.target.id!=='btnStyle'){
    hideStyleBox();
  }
});

/* å•Ÿå‹• */
(async()=>{
  live.set('è®€å–ä¸­â€¦');
  if(!await requireLogin()) return;

  const GROUP = await whichInternalGroup(ME.objectId);
const IS_INTERNAL = (GROUP === 'SUPER' || !!GROUP);

// å…©ç¨®é€šé—œæ–¹å¼ã€Œæ“‡ä¸€ã€å³å¯ï¼šsessionStorage æˆ– URL åƒæ•¸
const PASS_FROM_SESSION = consumePass(ME.objectId) && cameFromLegislature();
const PASS_FROM_URL     = consumeUrlPass(ME.objectId);

// ä»ç„¶å¿…é ˆæ˜¯å…§éƒ¨ï¼ˆå« SUPERï¼‰ï¼Œä¸”é€šé—œæˆåŠŸ
CAN_EDIT = !!IS_INTERNAL && (PASS_FROM_SESSION || PASS_FROM_URL);

  try{
    const doc=await fetchDoc();
    document.getElementById('docTitle').firstChild.textContent = (doc.title || 'ç¶²ç«™è¦å‰‡ï¼ˆæ†²ç« ï¼‰')+' ';
    document.getElementById('editor').innerHTML = doc.content || '';
    let theme=doc.theme || 'pink';
    if(!CAN_EDIT) theme = localStorage.getItem('constitution_theme') || theme;
    applyTheme(theme,false);
    live.set('âœ… å·²è¼‰å…¥');
  }catch(e){ alert(e.message||'è¼‰å…¥å¤±æ•—'); live.set('âŒ è¼‰å…¥å¤±æ•—'); }

  setEditable(CAN_EDIT);

  document.querySelectorAll('.swatch').forEach(s=>{
    s.addEventListener('click', ()=> applyTheme(s.dataset.theme||'pink', true));
  });

  const ed=document.getElementById('editor');
  ed.addEventListener('input', scheduleAutosave);

  document.getElementById('btnHeading').addEventListener('click', makeHeadingFromSelection);
  document.getElementById('btnDivider').addEventListener('click', insertPurpleDividerAtCaret);
  document.getElementById('btnDelDivider').addEventListener('click', deleteNearestDivider);

  /* æ–°å¢ï¼šæ‰“é–‹æ¨£å¼é¢æ¿ */
  document.getElementById('btnStyle').addEventListener('click', showStyleBox);
  // é¿å…é»é¢æ¿è£¡çš„æ±è¥¿æŠŠç„¦é»å¸¶èµ°ï¼ˆä¿æŒç·¨è¼¯å™¨é¸å€ï¼‰
styleBox.addEventListener('mousedown', (e)=>{
  if (!e.target.closest('input,button,label')) {
    e.preventDefault();
  }
});
})();

/* è¿”å› */
function goBack(){
  try{
    const ref=document.referrer||''; const same=ref && new URL(ref).origin===location.origin;
    if(same){ location.href=ref; return; }
  }catch(e){}
  if(history.length>1){ history.back(); return; }
  location.href='shopping.html';
}
</script>
</body>
</html>