<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>æˆ‘çš„ç™¼è²¨</title>
<style>
  :root{ --brand:#6c4ef7; --muted:#777; --accent:#e91e63; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Noto Sans TC",Arial,sans-serif;background:#fafafa;color:#222;}
  .topbar{position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #eee; padding:10px 14px; display:flex; align-items:center; gap:10px;}
  .topbar a{ color:var(--brand); text-decoration:none; font-weight:800; }
  .wrap{ max-width:980px; margin:0 auto; padding:18px 14px 48px; }

  .list{ display:grid; gap:12px; }
  .card{
    background:#fff; border:1px solid #eee; border-radius:14px; padding:12px;
    box-shadow:0 6px 16px rgba(0,0,0,.06); display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;
  }
  .thumb{ width:64px; height:64px; border-radius:10px; object-fit:cover; background:#f3f3f3; border:1px solid #eee; }
  .meta{ flex:1 1 360px; min-width:260px; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .muted{ color:var(--muted); }
  .price{ color:#e91e63; font-weight:900; }
  .actions{ display:flex; gap:8px; margin-left:auto; }

  .btn{ padding:8px 12px; border-radius:10px; border:1px solid #ddd; background:#fff; font-weight:800; cursor:pointer; }
  .btn.primary{ background:var(--brand); color:#fff; border-color:transparent; }
  .btn.ghost{ background:#fff; }
  .btn.done{ background:#6c4ef7; color:#fff; border-color:transparent; box-shadow:0 0 0 3px rgba(108,78,247,.15), 0 8px 18px rgba(108,78,247,.25); }

  /* å…±ç”¨å½ˆçª— */
  .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px; z-index:1000; }
  .dlg{ width:min(560px, 94vw); background:#fff; border:1px solid #eee; border-radius:16px; overflow:hidden; box-shadow:0 16px 40px rgba(0,0,0,.18); }
  .dlg header{ position:sticky; top:0; background:#fff; padding:12px 14px; font-weight:900; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;}
  .dlg .body{ padding:14px; max-height:70vh; overflow:auto; -webkit-overflow-scrolling:touch; }
  .field{ margin:10px 0; }
  .label{ font-size:12px; color:#777; margin-bottom:6px; }
  .input, .file, textarea{ width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px; outline:none; }
  textarea{ min-height:110px; resize:vertical; }
  .dlg .actions{ position:sticky; bottom:0; background:#fff; display:flex; gap:10px; justify-content:flex-end; padding:10px 14px; border-top:1px solid #eee; }
  .hint{ color:#777; font-size:12px; }
  .err{ color:#b00020; font-size:13px; margin-top:6px; }
  .closex{ cursor:pointer; font-size:22px; color:#888; line-height:1; }

  /* å¯©æŸ¥è¦–çª—æ¨£å¼ */
  .review-grid{ display:grid; grid-template-columns: 110px 1fr; gap:10px 12px; align-items:center; }
  .addr{ line-height:1.7; }
  .proof{ max-width:220px; border:1px solid #eee; border-radius:10px; background:#fff; }
  .btn.disabled{ opacity:.45; pointer-events:none; filter:grayscale(1); }
  /* === ä¸»é¡Œè®Šæ•¸ï¼ˆå«ç™½å¤©æ·¡ç²‰é¸å–®ï¼‰ === */
:root{
  --brand:#6c4ef7; --muted:#777; --accent:#e91e63;
  --dropdown-bg:#fdeaff;        /* æ·¡ç²‰ */
  --dropdown-border:#f5ccff;
  --dropdown-text:#4a3a6a;
}
html[data-theme="dark"]{
  --text:#cfc3ff; --muted:#9a8fd1; --brand:#a48cff; --accent:#bf66ff;
  --card-bg:#161222; --card-border:#2b2440; --page-bg:#0f0b1a;
  --btn-bg:#1b1629; --btn-border:#2b2440; --btn-text:#cfc3ff;
  --shadow:0 10px 28px rgba(0,0,0,.45);
}

/* === åœ“çƒæŒ‰éˆ• === */
.menu-wrap{ position:relative; display:inline-flex; gap:8px; align-items:center; }
.menu-btn{
  width:34px; height:34px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:16px; font-weight:800; line-height:1;
  background:var(--brand); color:#fff; border:none; cursor:pointer;
  transition:transform .18s ease, box-shadow .18s ease;
  box-shadow:0 6px 14px rgba(108,78,247,.22);
}
.menu-btn:hover{ transform:scale(1.08); }
.menu-btn:active{ transform:scale(.95); }
html[data-theme="dark"] .menu-btn{
  background:var(--btn-bg); border:1px solid var(--btn-border); color:var(--btn-text); box-shadow:none;
}

/* === ä¸‹æ‹‰é¸å–®ï¼ˆç™½å¤©æ·¡ç²‰ï¼›å¤œé–“æš—è‰²ï¼›ç„¡çªèµ·ï¼‰ === */
.dropdown{
  position:absolute; top:calc(100% + 8px); left:0;
  transform:translateX(8px) translateY(-6px) scale(.98);
  opacity:0; visibility:hidden; pointer-events:none;
  min-width:220px; max-width:min(320px,80vw);
  background:var(--dropdown-bg); color:var(--dropdown-text);
  border:1px solid var(--dropdown-border);
  border-radius:14px; padding:8px; z-index:1200;
  box-shadow:0 16px 32px rgba(0,0,0,.18);
  transition:opacity .16s ease, transform .18s cubic-bezier(.2,.8,.2,1);
}
.dropdown.show{ transform:translateX(8px) translateY(0) scale(1); opacity:1; visibility:visible; pointer-events:auto; }
.dropdown::after{ content:none; }           /* â† å»æ‰çªèµ· */
.dropdown .item{ width:100%; text-align:left; padding:10px 12px; border:0; background:transparent; color:inherit; border-radius:8px; cursor:pointer; transition:.12s; }
.dropdown .item:hover{ background:rgba(108,78,247,.10); transform:translateY(-1px); }
@media (max-width:560px){
  .dropdown, .dropdown.show{ left:0 !important; transform:translateX(0) translateY(0) scale(1); }
}
html[data-theme="dark"] .dropdown{
  background:var(--card-bg); color:var(--text); border:1px solid var(--card-border); box-shadow:var(--shadow);
}

/* === å¤œé–“æ•´é  === */
html[data-theme="dark"] body{ background:var(--page-bg); color:var(--text); }
html[data-theme="dark"] .topbar{ background:var(--card-bg); border-color:var(--card-border); }
html[data-theme="dark"] .wrap{ color:var(--text); }

/* å¡ç‰‡ã€åˆ—è¡¨ã€æŒ‰éˆ•ã€æ–‡å­—è‰² */
html[data-theme="dark"] .card{ background:var(--card-bg); border:1px solid var(--card-border); box-shadow:var(--shadow); }
html[data-theme="dark"] .muted{ color:var(--muted); }
html[data-theme="dark"] .btn{ background:var(--btn-bg); border:1px solid var(--btn-border); color:var(--btn-text); }
html[data-theme="dark"] .btn.primary{ background:var(--brand); color:#161222; border-color:transparent; }

/* å½ˆçª—èˆ‡é®ç½© */
html[data-theme="dark"] .backdrop{ background:rgba(0,0,0,.45); }
html[data-theme="dark"] .dlg{ background:var(--card-bg); color:var(--text); border:1px solid var(--card-border); box-shadow:var(--shadow); }
html[data-theme="dark"] .dlg header{ background:var(--card-bg); border-bottom:1px solid var(--card-border); }
html[data-theme="dark"] .dlg .actions{ background:var(--card-bg); border-top:1px solid var(--card-border); }

/* è¼¸å…¥æ¡† / æª”æ¡ˆ / å¤šè¡Œ */
html[data-theme="dark"] .input,
html[data-theme="dark"] .file,
html[data-theme="dark"] textarea{
  background:transparent; color:var(--text); border:1px solid var(--card-border);
}

/* å°ç¸®åœ–é‚Šæ¡†åœ¨æš—è‰² */
html[data-theme="dark"] .thumb{ background:#1e1930; border:1px solid var(--card-border); }
</style>
</head>
<body>
  <div class="topbar">
    <div class="menu-wrap">
       <a href="user.html">â† è¿”å›å€‹äººä¸»é </a>
  <button id="menuBtn" class="menu-btn" aria-expanded="false" onclick="toggleMenu()">%</button>
  <div id="menuDrop" class="dropdown" role="menu">
    <!-- ç¬¬ä¸€å€‹é¸é …ï¼šåˆ‡æ›æ¨¡å¼ -->
    <button class="item" onclick="toggleTheme()" id="modeItem">åˆ‡æ›æ¨¡å¼ï¼šå¤œé–“</button>
     <button class="item" onclick="location.href='../index.html'">ä¸»é </button>
    <button class="item" onclick="location.href='Grove.Examination-Yuan.html'">åƒåŠ ç®¡ç†å“¡</button>
    <button class="item" onclick="location.href='Grove. Control-Yuan.html'">Control</button>
    <button class="item" onclick="location.href='Grove.Executive-Yuan.html'">Executive</button>
    <button class="item" onclick="location.href='Grove.Judicial-Yuan.html'">ç”³è¨´</button>
    <button class="item" onclick="location.href='Grove.Legislative-Yuan.html'">Legislative</button>
    <button class="item" onclick="location.href='vote.html'">æŠ•ç¥¨å°ˆå€</button>
    <button class="item" onclick="location.href='constitution.html'">ç¶²ç«™ç”³æ˜</button>
  </div>
</div>
    <a href="messages.html" style="margin-left:auto">æˆ‘çš„è¨Šæ¯</a>
  </div>

  <div class="wrap">
    <h2 style="margin:0 0 12px">æˆ‘çš„ç™¼è²¨</h2>
    <div id="orderList" class="list"></div>
  </div>

  <!-- å¯©æŸ¥è¨‚å–® Modal -->
  <div id="reviewDlg" class="backdrop">
    <div class="dlg">
      <header>
        <div>å¯©æŸ¥è¨‚å–®</div>
        <div class="closex" onclick="closeReview()">Ã—</div>
      </header>
      <div class="body">
        <div class="review-grid">
        <div class="label">IO</div>
        <div id="rvIo">â€”</div>
          <div class="label">è²·å®¶</div>
          <div id="rvBuyer">â€”</div>

          <div class="label">ä¸‹å–®æ™‚é–“</div>
          <div id="rvTime">â€”</div>

          <div class="label">å•†å“</div>
          <div id="rvTitle">â€”</div>

          <div class="label">è¦æ ¼</div>
          <div id="rvSpec">â€”</div>

          <div class="label">å–®åƒ¹ / æ•¸é‡</div>
          <div id="rvUnitQty">â€”</div>

          <div class="label">ç¸½é¡</div>
          <div id="rvTotal" class="price">â€”</div>

          <div class="label">æ”¶ä»¶åœ°å€</div>
          <div id="rvAddr" class="addr">â€”</div>

          <div class="label">ä»˜æ¬¾æˆªåœ–</div>
          <div><img id="rvProof" class="proof" alt="ä»˜æ¬¾æˆªåœ–"></div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" onclick="closeReview()">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- ç™¼è²¨ Modal -->
  <div id="shipDlg" class="backdrop">
    <div class="dlg">
      <header>
        <div>ç¢ºèªç™¼è²¨</div>
        <div class="closex" onclick="closeShip()">Ã—</div>
      </header>
      <div class="body">
        <div class="field">
          <div class="label">æ”¶è²¨æ–¹æš±ç¨±</div>
          <input id="shipRecv" class="input" type="text" placeholder="å®¢æˆ¶æš±ç¨±ï¼ˆé å¡«ï¼‰">
        </div>
        <div class="field">
          <div class="label">å¿«éå–®è™Ÿ</div>
          <input id="shipTrack" class="input" type="text" placeholder="è«‹è¼¸å…¥ç‰©æµ/å¿«éå–®è™Ÿ">
        </div>
        <div class="hint">é€å‡ºå¾Œæœƒä»¥è¨Šæ¯é€šçŸ¥å®¢æˆ¶ï¼Œä¸¦å°‡è¨‚å–®ç‹€æ…‹æ”¹ç‚ºã€Œå·²ç™¼è²¨ã€ã€‚</div>
        <div id="shipErr" class="err"></div>
      </div>
      <div class="actions">
        <button class="btn" onclick="closeShip()">å–æ¶ˆ</button>
        <button class="btn primary" onclick="submitShip()">å‚³é€çµ¦å®¢æˆ¶</button>
      </div>
    </div>
  </div>

  <!-- é§å› Modal -->
  <div id="rejectDlg" class="backdrop">
    <div class="dlg">
      <header>
        <div>å¯©æŸ¥ä¸é€šéï¼é§å›</div>
        <div class="closex" onclick="closeReject()">Ã—</div>
      </header>
      <div class="body">
        <div class="field">
          <div class="label">é§å›ç†ç”±</div>
          <textarea id="rejReason" class="input" placeholder="è«‹ç°¡è¿°åŸå› â€¦"></textarea>
        </div>
        <div class="field">
          <div class="label">åœ–ç‰‡è­‰æ˜ï¼ˆå¯é¸ï¼‰</div>
          <input id="rejProof" class="file" type="file" accept="image/*">
        </div>
        <div class="hint">é€å‡ºå¾Œæœƒä»¥è¨Šæ¯é€šçŸ¥å®¢æˆ¶ï¼Œä¸¦å°‡è¨‚å–®ç‹€æ…‹æ”¹ç‚ºã€Œå·²é§å›ã€ã€‚</div>
        <div id="rejErr" class="err"></div>
      </div>
      <div class="actions">
        <button class="btn" onclick="closeReject()">å–æ¶ˆ</button>
        <button class="btn primary" onclick="submitReject()">å‚³é€çµ¦å®¢æˆ¶</button>
      </div>
    </div>
  </div>

<script>
const API     = "https://zdqo2eqb.lc-cn-n1-shared.com/1.1";
const APP_ID  = "ZDqo2eQBcSChCfRgwix9jUeI-gzGzoHsz";
const APP_KEY = "U66ybZWAD99LrT9zJnQlW52H";
const CURRENCY_SIGN = 'Â¥';
(function guard(){
  const t = localStorage.getItem('sg_token');
  const u = JSON.parse(localStorage.getItem('sg_user')||'null');
  if(!t || !u){ location.replace('index.html?redirect=ipuser'); }
})();
const me    = JSON.parse(localStorage.getItem('sg_user')||'null');
const token = localStorage.getItem('sg_token');
const AUTH  = { 'X-LC-Id': APP_ID, 'X-LC-Key': APP_KEY, 'X-LC-Session': token };

const DEFAULT_AVATAR = 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect width="100%" height="100%" rx="40" ry="40" fill="#f3f3f3"/><text x="50%" y="55%" text-anchor="middle" font-size="28">ğŸ™‚</text></svg>`);
const money = n => Number(n||0).toLocaleString('zh-TW');

let ORDERS = [];
let CURRENT_ORDER = null;

/* ===== è®€å–® ===== */
async function fetchMyOrders(){
  const where = encodeURIComponent(JSON.stringify({
    seller: { "__type":"Pointer","className":"_User","objectId": me.objectId }
  }));
  const url = `${API}/classes/Order?where=${where}&order=-createdAt&limit=200&include=buyer,product`;
  const res = await fetch(url, { headers: AUTH });
  const data = await res.json();
  if(!res.ok){ console.warn('fetchMyOrders error', data); return []; }
  const list = data.results || [];

  await hydrateBuyers(list);
  await fillBuyerByMessages(list);

  return list;
}

// æ‰¹æ¬¡æŠŠç¼ºæš±ç¨±/é ­è²¼çš„ buyer è£œé½Šï¼›å¤±æ•—æ™‚é€ç­† GET /users/{id}
async function hydrateBuyers(list){
  const needIds = Array.from(new Set(
    (list||[]).map(o => o?.buyer?.objectId).filter(Boolean)
  ));
  if(!needIds.length) return;

  const got = new Map();
  try{
    const where = encodeURIComponent(JSON.stringify({ objectId: { "$in": needIds } }));
    const url = `${API}/users?where=${where}&limit=${needIds.length}`;
    const res = await fetch(url, { headers: { ...AUTH } });
    const data = await res.json();
    if(res.ok){ (data.results||[]).forEach(u => got.set(u.objectId, u)); }
  }catch(e){}

  const still = needIds.filter(id => !got.has(id));
  for(const id of still){
    try{
      const r = await fetch(`${API}/users/${id}`, { headers: { ...AUTH } });
      const u = await r.json();
      if(r.ok && u && u.objectId) got.set(id, u);
    }catch(e){}
  }

  list.forEach(o=>{
    const id = o?.buyer?.objectId;
    const u  = id && got.get(id);
    if(u){
      o.buyer.nickname = u.nickname || u.username || '';
      o.buyer.username = u.username || o.buyer?.username || '';
      o.buyer.avatarUrl = (u.avatarUrl || '').replace(/^http:\/\//, 'https://');
    }
  });
}

// è‹¥ buyer ç¼ºå¤±ï¼Œé€é Message(kind='order') æ‰¾åˆ°ä¸‹å–®è€…ï¼ˆfromï¼‰
async function fillBuyerByMessages(list){
  const tasks = [];
  for(const o of (list||[])){
    if(o.buyer && o.buyer.objectId) continue;
    tasks.push((async ()=>{
      try{
        const where = encodeURIComponent(JSON.stringify({
          kind:'order',
          order:{ "__type":"Pointer","className":"Order","objectId": o.objectId }
        }));
        const url = `${API}/classes/Message?where=${where}&order=createdAt&limit=1&include=from`;
        const res = await fetch(url, { headers: AUTH });
        const data = await res.json();
        if(!res.ok) return;
        const m = (data.results||[])[0];
        const u = m && m.from;
        if(u && u.objectId){
          // è‹¥æ²’æœ‰æš±ç¨±ï¼Œå†è£œ GET /users/{id}
          if(!u.nickname && !u.username){
            try{
              const r = await fetch(`${API}/users/${u.objectId}`, { headers: { ...AUTH }});
              const full = await r.json();
              if(r.ok && full){ u.nickname = full.nickname || full.username || ''; u.username = full.username || ''; u.avatarUrl = full.avatarUrl || ''; }
            }catch(e){}
          }
          o.buyer = {
            "__type":"Pointer","className":"_User","objectId": u.objectId,
            nickname: u.nickname || u.username || '',
            username: u.username || '',
            avatarUrl: (u.avatarUrl || '').replace(/^http:\/\//,'https://')
          };
        }
      }catch(e){}
    })());
  }
  await Promise.all(tasks);
}

/* ===== UI ===== */
function renderList(list){
  const box = document.getElementById('orderList');
  list = (list || []).filter(o => !o.archivedBySeller); // â† æ–°å¢
  box.innerHTML = '';
  if(!list.length){
    box.innerHTML = `<div class="muted">ç›®å‰å°šç„¡è¨‚å–®ã€‚</div>`;
    return;
  }
  list.forEach(o=>{
    const buyer = o.buyer || {};
    const p = o.product || {};
    const dt = new Date(o.createdAt);
    const thumb = p.imageUrl || (Array.isArray(p.images)&&p.images[0]) || DEFAULT_AVATAR;
    const unitPrice = (o.unitPrice ?? o.price) || 0;
    const qty = (o.quantity ?? 1);
    const total = (o.totalPrice ?? (unitPrice*qty)) || unitPrice;

    const buyerName =
      (buyer && (buyer.nickname || buyer.username)) ||
      (buyer && buyer.objectId === me.objectId ? (me.nickname || me.username || '') : '') ||
      (buyer && buyer.objectId ? ('#' + buyer.objectId.slice(-6)) : 'â€”');
    const io = o.io || '';
    const card = document.createElement('div');
    card.className='card';
    card.id = `order_${o.objectId}`;
    card.innerHTML = `
      <img class="thumb" src="${thumb}" alt="">
      <div class="meta">
        <div class="row">
          <div style="font-weight:900">${escapeHTML(p.title || o.productTitle || 'æœªå‘½åå•†å“')}</div>
          <div class="muted">ï¼ˆè¦æ ¼ï¼š${escapeHTML(o.variantName || '')}ï¼‰</div>
        </div>
        ${io ? `<div class="row"><div class="muted">IOï¼š<code style="font-family:ui-monospace,monospace">${escapeHTML(io)}</code></div></div>` : ''}
        <div class="row">
          <div>è²·å®¶ï¼š<b>${escapeHTML(buyerName)}</b></div>
          <div class="muted">ï½œ è³¼è²·æ—¥æœŸï¼š${dt.toLocaleString()}</div>
        </div>
        <div class="row" style="margin-top:4px">
           <div>å–®åƒ¹ï¼š<span class="price">${CURRENCY_SIGN}${money(unitPrice)}</span></div>
          ${qty?`<div>ï½œ æ•¸é‡ï¼š${qty}</div>`:''}
          <div>ï½œ ç¸½é¡ï¼š<span class="price">${CURRENCY_SIGN}${money(total)}</span></div>
          <div class="muted">ï½œ ç‹€æ…‹ï¼š${escapeHTML(o.status || 'submitted')}</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn ghost" onclick="openReview('${o.objectId}')">å¯©æŸ¥è¨‚å–®</button>
        <button class="btn ghost ${o.status==='shipped'?'done':''}" onclick="openShip('${o.objectId}')">ç¢ºèªç™¼è²¨</button>
        <button class="btn ghost ${o.status==='rejected'?'done':''}" onclick="openReject('${o.objectId}')">å¯©æŸ¥ä¸é€šéé§å›</button>
      </div>
    `;
    // è‹¥å·²ç°½æ”¶ï¼šæŠŠæŒ‰éˆ•æ•´çµ„æ›æˆã€Œå·²ç°½æ”¶ + åˆªé™¤è¨‚å–®ã€
if (o.status === 'received') {
  const acts = card.querySelector('.actions');
  acts.innerHTML = `
    <button class="btn disabled" disabled>å·²ç°½æ”¶</button>
    <button class="btn ghost" onclick="sellerDelete('${o.objectId}')">åˆªé™¤è¨‚å–®</button>
  `;
}
    // å·²ç°½æ”¶ï¼šæ•´çµ„æ›æˆã€Œå·²ç°½æ”¶ + åˆªé™¤è¨‚å–®ã€ï¼ˆä½ åŸæœ¬å°±æœ‰ï¼Œä¿ç•™ï¼‰
if (o.status === 'received') {
  const acts = card.querySelector('.actions');
  acts.innerHTML = `
    <button class="btn disabled" disabled>å·²ç°½æ”¶</button>
    <button class="btn ghost" onclick="sellerDelete('${o.objectId}')">åˆªé™¤è¨‚å–®</button>
  `;
}

// === äº’æ–¥é‚è¼¯ ===
// è‹¥å·²ç™¼è²¨ï¼šç™¼è²¨éµç°æ‰ï¼Œé§å›éµä¹Ÿç°æ‰
if (o.status === 'shipped') {
  const btns = card.querySelectorAll('.actions .btn');
  const shipBtn = btns[1];  // 0:å¯©æŸ¥è¨‚å–® 1:ç¢ºèªç™¼è²¨ 2:é§å›
  const rejBtn  = btns[2];
  if (shipBtn) {
    shipBtn.textContent = 'å·²ç™¼è²¨';
    shipBtn.classList.remove('ghost','done');
    shipBtn.classList.add('disabled');
    shipBtn.setAttribute('disabled','disabled');
  }
  if (rejBtn) {
    rejBtn.classList.remove('ghost','done');
    rejBtn.classList.add('disabled');
    rejBtn.setAttribute('disabled','disabled');
  }
}

// è‹¥å·²é§å›ï¼šé§å›éµç°æ‰ï¼Œç™¼è²¨éµä¹Ÿç°æ‰
if (o.status === 'rejected') {
  const btns = card.querySelectorAll('.actions .btn');
  const shipBtn = btns[1];
  const rejBtn  = btns[2];
  if (rejBtn) {
    rejBtn.textContent = 'å·²é§å›';
    rejBtn.classList.remove('ghost','done');
    rejBtn.classList.add('disabled');
    rejBtn.setAttribute('disabled','disabled');
  }
  if (shipBtn) {
    shipBtn.classList.remove('ghost','done');
    shipBtn.classList.add('disabled');
    shipBtn.setAttribute('disabled','disabled');
  }
}
    box.appendChild(card);
  });
}
async function sellerDelete(oid){
  if(!confirm('ç¢ºå®šå¾æ¸…å–®ç§»é™¤æ­¤è¨‚å–®ï¼Ÿï¼ˆåƒ…å•†å®¶ç«¯è»Ÿåˆªé™¤ï¼Œä¸å½±éŸ¿è²·å®¶è³‡æ–™ï¼‰')) return;
  try{
    // å¾Œç«¯æ¨™è¨˜è»Ÿåˆªé™¤
    const r = await fetch(`${API}/classes/Order/${oid}`,{
      method:'PUT',
      headers:{ ...AUTH, 'Content-Type':'application/json' },
      body: JSON.stringify({ archivedBySeller: true })
    });
    const d = await r.json();
    if(!r.ok) throw new Error(d.error || 'åˆªé™¤å¤±æ•—');

    // å‰ç«¯ç«‹å³ç§»é™¤
    const idx = ORDERS.findIndex(x=>x.objectId===oid);
    if(idx>=0) ORDERS.splice(idx,1);
    const el = document.getElementById(`order_${oid}`);
    if(el) el.remove();

    // è‹¥åˆ—è¡¨å·²ç©ºï¼Œé‡ç¹ªæç¤º
    if((ORDERS.filter(o=>!o.archivedBySeller)).length === 0){
      renderList(ORDERS);
    }

    alert('âœ… å·²åˆªé™¤è¨‚å–®ï¼ˆå•†å®¶ç«¯ï¼‰');
  }catch(e){
    alert(e.message || 'æ“ä½œå¤±æ•—');
  }
}
function markButtons(orderId, which){
  const card = document.getElementById(`order_${orderId}`);
  if(!card) return;
  const btns = card.querySelectorAll('.actions .btn');
  if(which==='ship') btns[1].classList.add('done');
  if(which==='reject') btns[2].classList.add('done');
}

/* ===== å¯©æŸ¥è¨‚å–® ===== */
function openReview(oid){
  const o = ORDERS.find(x => x.objectId === oid);
  if (!o) return;

  // å…ˆæ‹¿åˆ° io å†å¯«å…¥ç•«é¢
  const io = o.io || '';
  document.getElementById('rvIo').textContent = io || 'â€”';

  const buyerName =
    (o.buyer && (o.buyer.nickname || o.buyer.username)) ||
    (o.buyer && o.buyer.objectId===me.objectId ? (me.nickname||me.username||'') : '') || 'â€”';
  const dt = new Date(o.createdAt).toLocaleString();
  const unitPrice = (o.unitPrice ?? o.price) || 0;
  const qty = (o.quantity ?? 1);
  const total = (o.totalPrice ?? (unitPrice*qty)) || unitPrice;

  const addr = o.address || {};
  const addrText = [
    addr.countryCode ? `(${addr.countryCode})` : '',
    addr.province || '', addr.city || '', addr.district || '', addr.detail || ''
  ].filter(Boolean).join(' / ');

  document.getElementById('rvBuyer').textContent = buyerName;
  document.getElementById('rvTime').textContent  = dt;
  document.getElementById('rvTitle').textContent = o.productTitle || o.product?.title || 'â€”';
  document.getElementById('rvSpec').textContent  = o.variantName || 'â€”';
  document.getElementById('rvUnitQty').textContent = `${CURRENCY_SIGN}${money(unitPrice)} Ã— ${qty}`;
  document.getElementById('rvTotal').textContent = `${CURRENCY_SIGN}${money(total)}`;
  document.getElementById('rvAddr').textContent  = addrText || 'â€”';

  const proof = (o.payProofUrl || '').replace(/^http:\/\//, 'https://');
  const im = document.getElementById('rvProof');
  if (proof) { im.src = proof; im.style.display = 'block'; }
  else { im.removeAttribute('src'); im.style.display = 'none'; }

  document.getElementById('reviewDlg').style.display = 'flex';
}
function closeReview(){ document.getElementById('reviewDlg').style.display='none'; }
//=================
// é–‹å•Ÿã€Œç¢ºèªç™¼è²¨ã€è¦–çª—
function openShip(oid){
  CURRENT_ORDER = ORDERS.find(o=>o.objectId===oid) || null;
  if(!CURRENT_ORDER) return;
  document.getElementById('shipRecv').value  = (CURRENT_ORDER.buyer?.nickname || CURRENT_ORDER.buyer?.username || '');
  document.getElementById('shipTrack').value = CURRENT_ORDER.trackingNumber || '';
  document.getElementById('shipErr').textContent = '';
  document.getElementById('shipDlg').style.display = 'flex';
}
function closeShip(){ document.getElementById('shipDlg').style.display='none'; }

// é–‹å•Ÿã€Œå¯©æŸ¥ä¸é€šéï¼é§å›ã€è¦–çª—
function openReject(oid){
  CURRENT_ORDER = ORDERS.find(o=>o.objectId===oid) || null;
  if(!CURRENT_ORDER) return;
  document.getElementById('rejReason').value = '';
  document.getElementById('rejProof').value = '';
  document.getElementById('rejErr').textContent = '';
  document.getElementById('rejectDlg').style.display = 'flex';
}
function closeReject(){ document.getElementById('rejectDlg').style.display='none'; }

// æª”æ¡ˆä¸Šå‚³å·¥å…·ï¼ˆsubmitReject æœƒç”¨åˆ°ï¼‰
function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload = ()=> resolve(fr.result.split(',')[1]);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}
async function uploadOne(file){
  const base64 = await fileToBase64(file);
  const r = await fetch(`${API}/files/${encodeURIComponent(file.name)}`,{
    method:'POST',
    headers:{...AUTH,'Content-Type':'application/json'},
    body: JSON.stringify({ base64 })
  });
  const data = await r.json();
  if(!r.ok) throw new Error(data.error || 'æª”æ¡ˆä¸Šå‚³å¤±æ•—');
  return data.url;
}
// ===== ç™¼è²¨ =====
async function submitShip(){
  if(!CURRENT_ORDER) return;
  const buyer = CURRENT_ORDER.buyer || {};
  const recv  = document.getElementById('shipRecv').value.trim();
  const track = document.getElementById('shipTrack').value.trim();
  if(!track){ document.getElementById('shipErr').textContent='è«‹è¼¸å…¥å¿«éå–®è™Ÿ'; return; }
  if(!buyer.objectId){ document.getElementById('shipErr').textContent='æ‰¾ä¸åˆ°è²·å®¶ IDï¼Œç„¡æ³•é€šçŸ¥'; return; }

  try{
    // æ›´æ–°è¨‚å–®ç‚ºå·²ç™¼è²¨
    const put = await fetch(`${API}/classes/Order/${CURRENT_ORDER.objectId}`,{
      method:'PUT',
      headers:{ ...AUTH, 'Content-Type':'application/json' },
      body: JSON.stringify({
        status:'shipped',
        trackingNumber: track,
        shippedAt: { "__type":"Date","iso": new Date().toISOString() }
      })
    });
    const putData = await put.json();
    if(!put.ok) throw new Error(putData.error || 'æ›´æ–°è¨‚å–®å¤±æ•—');

    // é€è¨Šæ¯ï¼ˆä¸€å®šè¦æœ‰ bodyï¼‰
    const io = CURRENT_ORDER.io || '';
const msgText = `æ‚¨çš„è¨‚å–®å·²ç™¼è²¨ï¼š${CURRENT_ORDER.productTitle || CURRENT_ORDER.product?.title || ''}ï¼ˆå–®è™Ÿï¼š${track}ï¼‰${io ? `ï½œIOï¼š${io}` : ''}`;
const payload = {
  kind: 'ship',
  text: msgText,
  body: msgText, // â˜… å¿…å¡«
  from:{ "__type":"Pointer","className":"_User","objectId": me.objectId },
  to:  { "__type":"Pointer","className":"_User","objectId": buyer.objectId },
  order:{ "__type":"Pointer","className":"Order","objectId": CURRENT_ORDER.objectId },
  product: CURRENT_ORDER.product ? { "__type":"Pointer","className":"Product","objectId": CURRENT_ORDER.product.objectId } : undefined,
  data:{ trackingNumber: track, receiverNickname: recv, io }
};
    const res = await fetch(`${API}/classes/Message`,{
      method:'POST',
      headers:{ ...AUTH, 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || 'è¨Šæ¯é€å‡ºå¤±æ•—');

    // æˆåŠŸé€å‡ºè¨Šæ¯ä¹‹å¾Œ â€¦
// æˆåŠŸé€å‡ºè¨Šæ¯ä¹‹å¾Œ â€¦
closeShip();
CURRENT_ORDER.status = 'shipped'; // è¨˜ä½æœ¬åœ°ç‹€æ…‹

const card = document.getElementById(`order_${CURRENT_ORDER.objectId}`);
if (card) {
  const btns = card.querySelectorAll('.actions .btn');
  const shipBtn = btns[1];
  const rejBtn  = btns[2];

  if (shipBtn) {
    shipBtn.textContent = 'å·²ç™¼è²¨';
    shipBtn.classList.remove('ghost','done');
    shipBtn.classList.add('disabled');
    shipBtn.setAttribute('disabled','disabled');
  }
  if (rejBtn) {
    rejBtn.classList.remove('ghost','done');
    rejBtn.classList.add('disabled');
    rejBtn.setAttribute('disabled','disabled');
  }
}

alert('âœ… å·²ç™¼è²¨ä¸¦é€šçŸ¥å®¢æˆ¶');
  }catch(e){
    document.getElementById('shipErr').textContent = e.message || 'é€å‡ºå¤±æ•—';
  }
}

// ===== é§å› =====
async function submitReject(){
  if(!CURRENT_ORDER) return;
  const buyer = CURRENT_ORDER.buyer || {};
  const reason = document.getElementById('rejReason').value.trim();
  const pf = document.getElementById('rejProof').files[0];
  if(!reason){ document.getElementById('rejErr').textContent='è«‹å¡«å¯«é§å›ç†ç”±'; return; }
  if(!buyer.objectId){ document.getElementById('rejErr').textContent='æ‰¾ä¸åˆ°è²·å®¶ IDï¼Œç„¡æ³•é€šçŸ¥'; return; }

  try{
    let proofUrl = '';
    if(pf) proofUrl = await uploadOne(pf);

    // æ›´æ–°è¨‚å–®ç‚ºå·²é§å›
    const put = await fetch(`${API}/classes/Order/${CURRENT_ORDER.objectId}`,{
      method:'PUT',
      headers:{ ...AUTH, 'Content-Type':'application/json' },
      body: JSON.stringify({
        status:'rejected',
        rejectReason: reason,
        rejectProofUrl: proofUrl
      })
    });
    const putData = await put.json();
    if(!put.ok) throw new Error(putData.error || 'æ›´æ–°è¨‚å–®å¤±æ•—');

    // é€è¨Šæ¯ï¼ˆä¸€å®šè¦æœ‰ bodyï¼‰
    const io = CURRENT_ORDER.io || '';
const msgText = `è¨‚å–®å¯©æŸ¥æœªé€šéï¼š${reason}${io ? `ï½œIOï¼š${io}` : ''}`;
const payload = {
  kind: 'reject',
  text: msgText,
  body: msgText, // â˜… å¿…å¡«
  from:{ "__type":"Pointer","className":"_User","objectId": me.objectId },
  to:  { "__type":"Pointer","className":"_User","objectId": buyer.objectId },
  order:{ "__type":"Pointer","className":"Order","objectId": CURRENT_ORDER.objectId },
  product: CURRENT_ORDER.product ? { "__type":"Pointer","className":"Product","objectId": CURRENT_ORDER.product.objectId } : undefined,
  data:{ reason, proofUrl, io }
};
    const res = await fetch(`${API}/classes/Message`,{
      method:'POST',
      headers:{ ...AUTH, 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || 'è¨Šæ¯é€å‡ºå¤±æ•—');

    // é—œæ‰è¦–çª—
closeReject();

// è¨˜ä½æœ¬åœ°ç‹€æ…‹
CURRENT_ORDER.status = 'rejected';

// ç›´æ¥æŠŠå¡ç‰‡ä¸Šçš„å…©å€‹æŒ‰éˆ•ç°æ‰
const card = document.getElementById(`order_${CURRENT_ORDER.objectId}`);
if (card) {
  const btns   = card.querySelectorAll('.actions .btn'); // 0: å¯©æŸ¥è¨‚å–® 1: ç¢ºèªç™¼è²¨ 2: é§å›
  const shipBtn= btns[1];
  const rejBtn = btns[2];

  if (rejBtn) {
    rejBtn.textContent = 'å·²é§å›';
    rejBtn.classList.remove('ghost','done');
    rejBtn.classList.add('disabled');
    rejBtn.setAttribute('disabled','disabled');
  }
  if (shipBtn) {
    shipBtn.classList.remove('ghost','done');
    shipBtn.classList.add('disabled');
    shipBtn.setAttribute('disabled','disabled');
  }
}

// æç¤º
alert('âœ… å·²é§å›ä¸¦é€šçŸ¥å®¢æˆ¶');
  }catch(e){
    document.getElementById('rejErr').textContent = e.message || 'é€å‡ºå¤±æ•—';
  }
}

/* ===== å•Ÿå‹•ï¼šè¼‰å…¥åˆ—è¡¨ & è¼ªè©¢ ===== */
(async function start(){
  ORDERS = await fetchMyOrders();
  renderList(ORDERS);
})();
setInterval(async ()=>{
  ORDERS = await fetchMyOrders();
  renderList(ORDERS);
}, 12000);

/* utils */
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }
</script>
<script src="im.js"></script>
<!--=================-->
<p style="text-align: center; font-size: 13px; color: #999; margin-top: 40px;">
  ğŸ¾ Â© 2024 yinnlimçš„å°å®‡å®™ï½œå…§å®¹èˆ‡è¨­è¨ˆçš†ç”±ç³–ç³–æœ¬äººç”¨æ„›è£½ä½œ ğŸ’<br>
  æœªç¶“æˆæ¬Šè«‹å‹¿éš¨æ„ä½¿ç”¨ã€ç›œè½‰å–” ğŸ™…â€â™€ï¸ è¬è¬ä½ çš„å°Šé‡èˆ‡æº«æŸ” ğŸ’Œ
</p>
</body>
</html>