<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>å€‹äººä¸»é </title>
<style>
  body{ 
  margin:0; 
  font-family: "DFKai-SB","KaiTi","æ¨™æ¥·é«”","BiauKai",serif; 
  background:#fafafa; 
  color:#222; 
}
  .wrap{ max-width:960px; margin:0 auto; padding:24px 16px 48px; }
  .topbar{ position:sticky; top:0; background:rgba(255,255,255,.7);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    border-bottom:1px solid #eee; padding:12px 16px; display:flex; align-items:center; gap:12px; z-index:10; }
  .topbar a{ color:var(--brand); text-decoration:none; font-weight:700; }
  .card{ margin-top:16px; background:#fff; border:1px solid #eee; border-radius:16px;
    box-shadow:0 8px 20px rgba(0,0,0,.06); padding:18px; }
  .profile{ display:flex; gap:18px; align-items:center; flex-wrap:wrap; }
  .avatar{ width:96px; height:96px; border-radius:50%; object-fit:cover; background:#f3f3f3; border:1px solid #eee; }
  .name{ font-size:22px; font-weight:800; }
  .muted{ color:var(--muted); font-size:14px; }
  .btn{ padding:10px 14px; border-radius:10px; border:1px solid #ddd; background:#fff; font-weight:600; cursor:pointer; }
  .btn.primary{ background:var(--brand); color:#fff; border-color:transparent; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; }

  /* å•†å“ */
  .my-grid{ display:grid; gap:14px; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
  .pcard{ border:1px solid #eee; border-radius:12px; overflow:hidden; background:#fff; box-shadow:0 6px 16px rgba(0,0,0,.06); }
  .pthumb{ width:100%; height:120px; object-fit:cover; background:#f3f3f3; display:block; }
  .pbody{ padding:10px; }
  .ptitle{ font-weight:700; font-size:14px; line-height:1.35; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:6px; }
  .pprice{ color:#e91e63; font-weight:800; }
  .pactions{ display:flex; justify-content:flex-end; padding:0 10px 10px; }
  .pdel{ border:1px solid #ddd; background:#fff; border-radius:8px; padding:6px 8px; cursor:pointer; font-weight:700; }

  /* Modalï¼šç·¨è¼¯å€‹è³‡ */
  .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:1000; padding:16px;}
  .dlg{ width:min(520px, 92vw); background:#fff; border-radius:16px; overflow:hidden; border:1px solid #eee; box-shadow:0 12px 32px rgba(0,0,0,.18);}
  .dlg header{ padding:14px 16px; font-weight:800; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;}
  .dlg .body{ padding:16px;}
  .dlg .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
  .dlg .field{ margin:10px 0;}
  .dlg label{ display:block; font-size:13px; color:#777; margin-bottom:6px;}
  .dlg .input, .dlg .file{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #ddd; outline:none;}
  .dlg .actions{ display:flex; gap:10px; justify-content:flex-end; padding:0 16px 16px;}
  .closex{ cursor:pointer; font-size:22px; line-height:1; color:#888;}
  .danger{ color:#b00020; font-weight:800; }
  .hint{ font-size:12px; color:#777; }
  .ok{ background:var(--brand); color:#fff; border:1px solid transparent; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700;}
  .btn-plain{ padding:10px 14px; border:1px solid #ddd; background:#fff; border-radius:10px; cursor:pointer; font-weight:700;}

  /* ç™¼ä½ˆå•†å“ Dialog */
  .pb-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:1000; padding:16px;}
  .pb{ width:min(820px, 96vw); max-height:92vh; overflow:auto; background:#fff; border-radius:16px; border:1px solid #eee; box-shadow:0 12px 32px rgba(0,0,0,.18);}
  .pb header{ padding:14px 16px; font-weight:800; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;}
  .pb .body{ padding:16px;}
  .pb .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start;}
  .pb .field{ margin:10px 0; flex:1 1 240px;}
  .pb label{ display:block; font-size:13px; color:#777; margin-bottom:6px;}
  .pb .input, .pb .file, .pb textarea{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #ddd; outline:none;}
  .pb textarea{ min-height:120px; resize:vertical;}
  .pill{ display:inline-flex; align-items:center; gap:8px; border:1px solid #ddd; border-radius:12px; padding:6px 10px;}
  .switch{ display:inline-flex; align-items:center; gap:8px; }
  .spec-row{ display:grid; grid-template-columns: 1.2fr .8fr 1fr 1fr auto; gap:8px; align-items:center; margin-bottom:8px; }
  .spec-row.hidden{ display:none; }

  /* å¾½ç«  */
  .btn.badge-host{ position:relative; padding-right:30px; }
  .dotbadge{
    position:absolute; top:-6px; right:-6px;
    min-width:18px; height:18px; padding:0 6px;
    border-radius:999px; background:#3b82f6; color:#fff;
    font-size:12px; line-height:18px; text-align:center; font-weight:800;
    box-shadow:0 2px 6px rgba(0,0,0,.2); display:none;
  }
  /* æ”¶è—å½ˆçª—ï¼šå›ºå®šæ¡†å¤§å°ï¼Œå…§å®¹å¯æ²å‹• */
.dlg.fav{
  width: min(720px, 92vw);   /* å›ºå®šå¯¬åº¦ä¸Šé™ */
  height: min(70vh, 560px);  /* å›ºå®šé«˜åº¦ä¸Šé™ï¼ˆä½ è¦æ›´é«˜å¯æ”¹ï¼‰*/
  display: flex;
  flex-direction: column;    /* è®“ header / body / actions å‚ç›´æ’åˆ— */
}

/* è®“å…§å®¹å€å¯ä¸Šä¸‹æ»‘å‹• */
.dlg.fav .body{
  flex: 1 1 auto;
  overflow: auto;
  -webkit-overflow-scrolling: touch; /* iOS æ…£æ€§æ²å‹• */
}

/* è®“é ‚éƒ¨/åº•éƒ¨å›ºå®šåœ¨æ¡†å…§ï¼ˆå¯é¸ï¼Œä½†é«”é©—æ›´å¥½ï¼‰ */
.dlg.fav header{
  position: sticky;
  top: 0;
  background: #fff;
  z-index: 1;
  border-bottom: 1px solid #eee;
}
.dlg.fav .actions{
  position: sticky;
  bottom: 0;
  background: #fff;
  border-top: 1px solid #eee;
}
/* ====== ä¸»é¡Œè®Šæ•¸ï¼ˆç™½å¤© / å¤œé–“ï¼‰====== */
:root{
  --brand:#6c4ef7;
  --muted:#777;
  --bg:#fafafa;
  --text:#222;
  --card-bg:#fff;
  --border:#eee;
  --topbar-bg: rgba(255,255,255,.7);
  --price:#e91e63;   /* ç™½å¤©åƒ¹éŒ¢ */
  --link:#6c4ef7;
}
:root[data-theme="dark"]{
  --bg:#0f0b1a;
  --text:#cfc3ff;
  --muted:#9a8fd1;
  --card-bg:#161222;
  --border:#2b2440;
  --topbar-bg: rgba(20,16,34,.7);
  --brand:#a48cff;
  --link:#b39cff;
  --price:#bf66ff;   /* å¤œé–“åƒ¹éŒ¢ï¼šæ·±ç´« */
}

/* ====== å…¨ç«™ä»¥è®Šæ•¸è¦†è“‹ï¼ˆ!important ç¢ºä¿è“‹éä½ å‰é¢çš„å›ºå®šè‰²ï¼‰ ====== */
body{
  background:var(--bg) !important;
  color:var(--text) !important;
  font-family:"DFKai-SB","KaiTi","æ¨™æ¥·é«”","BiauKai",serif !important; /* å°æ¥·ä¸€ç›´ä¿ç•™ */
}
.topbar{
  background:var(--topbar-bg) !important;
  border-bottom:1px solid var(--border) !important;
}
.topbar a{ color:var(--brand) !important; }

/* å¡ç‰‡/é¢æ¿ */
.card,.pcard,.dlg,.pb,.dropdown{
  background:var(--card-bg) !important;
  border:1px solid var(--border) !important;
  color:var(--text) !important;
}
.dlg header{ border-bottom:1px solid var(--border) !important; }

/* æ–‡å­—é¡è‰² */
.muted{ color:var(--muted) !important; }

/* åƒ¹æ ¼ */
.pprice{ color:var(--price) !important; }

/* æŒ‰éˆ• */
.btn{ background:var(--card-bg) !important; border:1px solid var(--border) !important; color:var(--text) !important; }
.btn.primary{ background:var(--brand) !important; color:#fff !important; border-color:transparent !important; }

/* å…§æ–‡è¼¸å…¥æ¡† */
.dlg .input, .dlg .file, .pb .input, .pb .file, .pb textarea{
  background:transparent !important;
  border:1px solid var(--border) !important;
  color:var(--text) !important;
}

/* åœ–åƒåº•è‰²ï¼ˆé¿å…å¤ªäº®ï¼‰ */
.avatar, .pthumb{ background:var(--border) !important; }

/* ä¸‹æ‹‰é¸å–® hover åœ¨å…©ç¨®ä¸»é¡Œéƒ½æ¸…æ¥š */
.dropdown .item:hover{ background:rgba(108,78,247,.12) !important; }

/* é€£çµè‰² */
a{ color:var(--link); }
/* --- ä¸‹æ‹‰é¸å–®æŒ‰éˆ•å¤–è§€ï¼ˆå¯å…±ç”¨ä¸»é¡Œè®Šæ•¸ï¼‰ --- */
.menu-wrap{ position:relative; }
.menu-btn{
  padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:800; line-height:1;
  border:1px solid var(--border); background:var(--card-bg); color:var(--text);
}

/* ä¸‹æ‹‰ï¼šé è¨­éš±è— + å‹•ç•« */
.dropdown{
  position:absolute; right:0; top:calc(100% + 8px);
  min-width:200px;
  background:var(--card-bg); color:var(--text);
  border:1px solid var(--border); border-radius:12px;
  box-shadow:0 12px 28px rgba(0,0,0,.22);
  padding:8px; z-index:1000;

  /* éš±è—ç‹€æ…‹ + å‹•ç•«èµ·é» */
  opacity:0; transform:translateY(-6px) scale(.98);
  visibility:hidden; pointer-events:none;
  transition:opacity .16s ease, transform .18s ease, visibility 0s linear .16s;
}
.dropdown.show{
  opacity:1; transform:translateY(0) scale(1);
  visibility:visible; pointer-events:auto;
  transition:opacity .16s ease, transform .18s ease;
}

.dropdown .item{
  width:100%; text-align:left; padding:10px 12px;
  background:transparent; border:none; border-radius:8px;
  color:inherit; cursor:pointer; font-size:14px;
}
.dropdown .item:hover{ background:rgba(108,78,247,.12); }

/* --- å¤œé–“æ¨¡å¼ä¸‹çš„æŒ‰éˆ•é¡è‰²ï¼ˆæš—åº• + ç´«å¤–ç·šæ–‡å­—ï¼‰ --- */
:root[data-theme="dark"]{
  --btn-bg:#1b1530;        /* æŒ‰éˆ•æš—åº• */
  --btn-border:#3a2f55;    /* æŒ‰éˆ•é‚Šç·š */
  --btn-text:#cfc3ff;      /* ç´«å¤–ç·šæ–‡å­— */
}
:root:not([data-theme="dark"]){
  --btn-bg:var(--card-bg);
  --btn-border:var(--border);
  --btn-text:var(--text);
}
.btn{
  background:var(--btn-bg) !important;
  border:1px solid var(--btn-border) !important;
  color:var(--btn-text) !important;
}
/* ä¸»è¦æŒ‰éˆ•ç¶­æŒå“ç‰Œè‰²ï¼ˆä½ ä¹Ÿå¯æ”¹æˆå’Œä¸€èˆ¬æŒ‰éˆ•ä¸€æ¨£ï¼‰ */
.btn.primary{
  background:var(--brand) !important;
  color:#fff !important; border-color:transparent !important;
}

/* è®“ <button><a></a></button> çš„ a è·Ÿè‘—è®Šè‰²ï¼ˆæŠŠä½ åŸæœ¬ inline style è“‹æ‰ï¼‰ */
.btn a{ color:inherit !important; text-decoration:none; }

/* å¡ç‰‡åœ“è§’é‚Šç·šåœ¨æš—è‰²æ›´æŸ”å’Œï¼ˆé¸é…ï¼‰ */
.card,.pcard,.dlg,.pb{ border-color:var(--border) !important; }
.t{
  text-decoration: none;
  color: rgb(158, 88, 255);
}
</style>
</head>
<body>
  <div class="topbar">
    <a href="shopping.html">â† Esc Store</a>
    <div style="margin-left:auto" class="row">
      <button class="btn" onclick="logout()">ç™»å‡º</button>
      <div class="menu-wrap">
  <button id="menuBtn" class="menu-btn" aria-expanded="false" onclick="toggleMenu()" title="æ›´å¤šåŠŸèƒ½">%</button>
  <div id="menuDrop" class="dropdown" role="menu">
    <!-- ç¬¬ä¸€å€‹é¸é …ï¼šåˆ‡æ›æ¨¡å¼ -->
    <button class="item" onclick="toggleTheme()" id="modeItem">åˆ‡æ›æ¨¡å¼ï¼šå¤œé–“</button>
    <button class="item" onclick="location.href='../index.html'">ä¸»é </button>
    <button class="item" onclick="location.href='Grove.Examination-Yuan.html'">åƒåŠ ç®¡ç†å“¡</button>
    <button class="item" onclick="location.href='Grove. Control-Yuan.html'">Control</button>
    <button class="item" onclick="location.href='Grove.Executive-Yuan.html'">Executive</button>
    <button class="item" onclick="location.href='Grove.Judicial-Yuan.html'">ç”³è¨´</button>
    <button class="item" onclick="location.href='Grove.Legislative-Yuan.html'">Legislative</button>
    <button class="item" onclick="location.href='vote.html'">æŠ•ç¥¨å°ˆå€</button>
    <button class="item" onclick="location.href='constitution.html'">ç¶²ç«™ç”³æ˜</button>
  </div>
</div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="profile">
        <img id="pfAvatar" class="avatar" src="" alt="ä½¿ç”¨è€…é ­è²¼"/>
        <div>
          <div class="name" id="pfName">â€”</div>
          <div class="muted" id="pfEmail">â€”</div>
          <div class="muted" id="pfId" style="margin-top:6px">â€”</div>
        </div>
      </div>
      <div style="margin-top:16px" class="row">
        <button class="btn primary" onclick="openEdit()">ç·¨è¼¯å€‹äººè³‡æ–™</button>
        <button class="btn" onclick="openPublish()">ç™¼ä½ˆå•†å“</button>
        <button class="btn badge-host" onclick="markAndGo('messages','messages.html')">
          æˆ‘çš„è¨Šæ¯ <span id="msgBadge" class="dotbadge">0</span>
        </button>
        <button class="btn badge-host" onclick="markAndGo('ship','ipuser.html')">
          æˆ‘çš„ç™¼è²¨ <span id="shipBadge" class="dotbadge">0</span>
        </button>
        <button class="btn badge-host" onclick="markAndGo('buy','io.html')">
          æˆ‘çš„è³¼è²· <span id="buyBadge" class="dotbadge">0</span>
        </button>
        <button class="btn badge-host" onclick="markAndGo('appeal','dellt.html')">
          ç”³è¨´è™•ç† <span id="appealBadge" class="dotbadge">0</span>
        </button>
        <button class="btn"><a href="ioc.html" style="text-decoration: none; color: #222;">æŸ¥è©¢io</a></button>
      </div>
    </div>

    <div class="card" style="margin-top:18px">
  <div style="font-weight:800; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
    <span>æˆ‘çš„å•†å“</span>
    <button class="btn" onclick="openFavorites()">æˆ‘çš„æ”¶è—</button>
  </div>
  <div id="myProducts" class="my-grid"></div>
</div>

  <!-- ç·¨è¼¯å€‹è³‡ -->
  <div class="backdrop" id="editDlg">
    <div class="dlg">
      <header>
        <div>ç·¨è¼¯å€‹äººè³‡æ–™</div>
        <div class="closex" onclick="closeEdit()">Ã—</div>
      </header>
      <div class="body">
        <div class="field">
          <label>æš±ç¨±</label>
          <div class="row">
            <input id="editNickname" class="input" type="text" placeholder="æ–°çš„æš±ç¨±">
            <button class="ok" onclick="updateNickname()">å„²å­˜æš±ç¨±</button>
          </div>
          <div class="hint">æœƒç«‹å³åŒæ­¥åˆ°ä½ çš„å¸³è™Ÿã€‚</div>
        </div>

        <div class="field">
          <label>é ­è²¼ï¼ˆä¸Šå‚³åœ–ç‰‡ï¼‰</label>
          <div class="row">
            <input id="editAvatar" class="file" type="file" accept="image/*">
            <button class="ok" onclick="updateAvatar()">ä¸Šå‚³ä¸¦å¥—ç”¨</button>
          </div>
          <div class="hint">å»ºè­° &lt; 1MBã€‚</div>
        </div>

        <hr style="border:none;border-top:1px solid #eee;margin:14px 0">

        <div class="field">
          <div class="danger">è¨»éŠ·å¸³è™Ÿ</div>
          <div class="hint" style="margin:6px 0 10px">æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œå°‡åˆªé™¤ä½ çš„å¸³è™Ÿè³‡æ–™ã€‚</div>
          <button class="btn-plain danger" onclick="deleteAccount()">æˆ‘è¦æ°¸ä¹…åˆªé™¤æˆ‘çš„å¸³è™Ÿ</button>
        </div>

        <div id="editErr" class="hint" style="color:#b00020"></div>
      </div>
      <div class="actions">
        <button class="btn-plain" onclick="closeEdit()">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- ç™¼ä½ˆå•†å“ -->
  <div class="pb-backdrop" id="publishDlg">
    <div class="pb">
      <header>
        <div>ç™¼ä½ˆå•†å“</div>
        <div class="btn" onclick="closePublish()">Ã—</div>
      </header>
      <div class="body">
        <div class="row">
          <div class="field" style="flex:1">
            <label>å±•ç¤ºåœ–ç‰‡ï¼ˆå°é¢ï¼Œ1 å¼µï¼‰</label>
            <input id="pbCover" class="file" type="file" accept="image/*">
            <div class="muted">å»ºè­° &lt; 1MBã€‚</div>
          </div>
          <div class="field" style="flex:2">
            <label>å•†å“åœ–ç‰‡ï¼ˆæœ€å¤š 5 å¼µï¼‰</label>
            <input id="pbImages" class="file" type="file" accept="image/*" multiple>
            <div class="muted">ç¬¬ä¸€å¼µä¸æœƒè¦†è“‹å°é¢ï¼›åƒ…ä½œç‚ºè¼ªæ’­åœ–ç‰‡ã€‚</div>
          </div>
        </div>

        <div class="row">
          <div class="field"><label>å•†å“æ¨™é¡Œ</label><input id="pbTitle" class="input" type="text" placeholder="ä¾‹ï¼šå¤æ—¥æ¸…æ–°çŸ­è¢–"></div>
          <div class="field" style="flex:2"><label>å•†å“ç°¡è¿°</label><input id="pbSummary" class="input" type="text" placeholder="ä¸€å¥è©±ä»‹ç´¹ä½ çš„å•†å“"></div>
        </div>

        <div class="field">
          <label>è¦æ ¼è¨­å®š</label>
          <div id="specList"></div>
          <div class="row">
            <button class="btn" onclick="addSpec()">ï¼‹æ–°å¢è¦æ ¼</button>
            <div class="switch">
              <input id="samePrice" type="checkbox" checked onchange="togglePriceMode()">
              <label for="samePrice">è¦æ ¼åƒ¹æ ¼ç›¸åŒ</label>
            </div>
          </div>
          <div id="samePriceRow" class="row" style="margin-top:8px;">
            <div class="pill"><span>åƒ¹æ ¼</span><input id="pbPrice" class="input" type="number" min="0" step="1" style="width:140px"></div>
            <div class="pill"><span>æ”¶æ¬¾ç¢¼</span><input id="pbPayCode" class="file" type="file" accept="image/*"></div>
            <div class="muted">æ‰€æœ‰è¦æ ¼å…±ç”¨åŒä¸€åƒ¹æ ¼èˆ‡æ”¶æ¬¾ç¢¼ã€‚</div>
          </div>
        </div>

        <div class="field">
          <label>å•†å“è©³ç´°æè¿°</label>
          <textarea id="pbDetail" class="input" placeholder="æ›´å®Œæ•´çš„ä»‹ç´¹ã€æè³ªã€å°ºå¯¸â€¦ï¼ˆå¯ç•™ç©ºï¼‰"></textarea>
        </div>
        <div class="field">
          <label>è©³ç´°æè¿°åœ–ç‰‡ï¼ˆå¯å¤šå¼µï¼‰</label>
          <input id="pbDetailImages" class="file" type="file" accept="image/*" multiple>
        </div>
         <!-- ï¼è©³ç´°åœ–æ“ºæ”¾ä½ç½® -->
<div class="field">
  <label>è©³ç´°æè¿°åœ–ç‰‡æ“ºæ”¾ä½ç½®</label>
  <div class="row" style="align-items:center; gap:14px">
    <label class="pill" style="cursor:pointer">
      <input type="radio" name="pbImgPos" value="top" checked>
      <span>åœ–ç‰‡ç½®é ‚ï¼ˆåœ¨æ–‡å­—ä¸Šé¢ï¼‰</span>
    </label>
    <label class="pill" style="cursor:pointer">
      <input type="radio" name="pbImgPos" value="bottom">
      <span>åœ–ç‰‡æœ€ä¸‹é¢ï¼ˆæ–‡å­—å…¨éƒ¨ä¹‹å¾Œï¼‰</span>
    </label>

    <!-- åªåœ¨ã€Œç½®ä¸­ã€æ™‚é¡¯ç¤ºï¼šç¬¬ N è¡Œä¹‹å¾Œ -->
    <div id="pbMiddleBox" class="pill" style="display:none">
      <span>æ’åœ¨ã€Œç¬¬</span>
      <input id="pbAfterLine" class="input" type="number" min="0" step="1" value="0" style="width:90px">
      <span>è¡Œã€æ–‡å­—ä¸‹é¢ï¼ˆ0=æœ€å‰é¢ï¼‰</span>
    </div>
  </div>
  <div class="muted">ä¾‹ï¼šå¡« 2 è¡¨ç¤ºåœ¨ç¬¬ 2 è¡Œæ–‡å­—å¾Œé¢æ’å…¥åœ–ç‰‡ç¾¤çµ„ã€‚</div>
</div>
        <div id="pbErr" class="muted danger"></div>
      </div>
      <div class="actions">
        <button class="btn" onclick="closePublish()">å–æ¶ˆ</button>
        <button class="btn ok" onclick="createProduct()">ç™¼ä½ˆ</button>
      </div>
    </div>
  </div>
<!-- æˆ‘çš„æ”¶è— -->
<div class="backdrop" id="favoritesDlg">
  <div class="dlg fav">
    <header>
      <div>æˆ‘çš„æ”¶è—</div>
      <div class="closex" onclick="closeFavorites()">Ã—</div>
    </header>
    <div class="body">
      <div id="favProducts" class="my-grid"></div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
<script>
  AV.init({
    appId: 'ZDqo2eQBcSChCfRgwix9jUeI-gzGzoHsz',
    appKey: 'U66ybZWAD99LrT9zJnQlW52H',
    serverURL: 'https://zdqo2eqb.lc-cn-n1-shared.com'
  });
</script>
<script>
/* ================== åŸºæœ¬å¸¸æ•¸ ================== */
const API     = "https://zdqo2eqb.lc-cn-n1-shared.com/1.1";
const APP_ID  = "ZDqo2eQBcSChCfRgwix9jUeI-gzGzoHsz";
const APP_KEY = "U66ybZWAD99LrT9zJnQlW52H";
const CURRENCY_SIGN = 'Â¥';
const money = n => Number(n||0).toLocaleString('zh-TW');
const IO_TO_CNY = 60;                              // 1 io$ = Â¥60
const fmtIo = n => (Math.round(n*1e5)/1e5).toFixed(5);
const fmtDate = iso => {
  const d = new Date(iso);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mi = String(d.getMinutes()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
};
/* ================== åˆ†çµ„ & æœ€å¾ŒæŸ¥çœ‹æ™‚é–“ ================== */
const GROUPS = {
  ship:   { include: ['order','urge_ship','receive'] },
  buy:    { include: ['ship','reject','appeal_reject','appeal_ok'] },
  appeal: { include: ['appeal','urge_appeal'] },
  messages: { exclude: ['order','urge_ship','receive','ship','reject','appeal_reject','appeal_ok','appeal','urge_appeal'] }
};
const LS_KEY = 'sg_lastSeen';
function getLastSeen(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch(e){ return {}; } }
function setLastSeen(groupKey){
  const all = getLastSeen();
  all[groupKey] = new Date().toISOString();
  localStorage.setItem(LS_KEY, JSON.stringify(all));
}

/* ================== ç™»å…¥å®ˆé–€ ================== */
(function guard(){
  const token = localStorage.getItem('sg_token');
  const user = JSON.parse(localStorage.getItem('sg_user') || 'null');
  if(!token || !user){
    const home = 'index.html';
    location.replace(`${home}?redirect=profile`);
  }
})();

/* ================== å€‹è³‡ ================== */
async function fetchMe(){
  const token = localStorage.getItem('sg_token');
  try{
    const res = await fetch(`${API}/users/me`, {
      headers:{ 'X-LC-Id': APP_ID, 'X-LC-Key': APP_KEY, 'X-LC-Session': token }
    });
    if(res.ok){
      const me = await res.json();
      const user = { objectId: me.objectId, username: me.username, email: me.email, nickname: me.nickname, avatarUrl: me.avatarUrl };
      localStorage.setItem('sg_user', JSON.stringify(user));
      return user;
    }
  }catch(e){}
  return JSON.parse(localStorage.getItem('sg_user') || 'null');
}
function renderProfile(user){
  const avatar = user.avatarUrl || 'https://via.placeholder.com/96?text=ğŸ™‚';
  pfAvatar.src = avatar;
  pfAvatar.alt = `${user.nickname || user.username || 'ç”¨æˆ¶'} çš„é ­è²¼`;
  pfName.textContent = user.nickname || user.username || 'â€”';
  pfEmail.textContent = user.email || '';
  pfId.textContent = `GIDï¼š${user.objectId || ''}`;
}
function logout(){ localStorage.removeItem('sg_token'); localStorage.removeItem('sg_user'); location.href = 'shopping.html'; }

/* ================== å¾½ç« è¨ˆæ•¸ ================== */
async function countUnread(opts){
  const me = JSON.parse(localStorage.getItem('sg_user')||'null');
  const token = localStorage.getItem('sg_token');
  if(!me) return 0;

  const where = {
    to: { "__type":"Pointer","className":"_User","objectId": me.objectId },
    "$or": [ { read:false }, { read:{ "$exists": false } } ]
  };
  if(opts?.include) where.kind = { "$in": opts.include };
  if(opts?.exclude) where.kind = { "$nin": opts.exclude };

  // åªè¨ˆã€Œæœ€å¾ŒæŸ¥çœ‹æ™‚é–“ä¹‹å¾Œã€çš„æ–°æœªè®€
  if(opts?.__groupKey){
    const lastSeen = getLastSeen()[opts.__groupKey];
    if(lastSeen) where.createdAt = { "$gte": { "__type":"Date", "iso": lastSeen } };
  }

  const url = `${API}/classes/Message?where=${encodeURIComponent(JSON.stringify(where))}&count=1&limit=0`;
  try{
    const res = await fetch(url, { headers:{ 'X-LC-Id':APP_ID,'X-LC-Key':APP_KEY,'X-LC-Session': token||'' }});
    const data = await res.json(); if(!res.ok) throw new Error(data.error||'');
    return Number(data.count||0);
  }catch(e){
    console.warn('countUnread error:', e.message||e);
    return 0;
  }
}
function setBadge(elId, n){
  const el = document.getElementById(elId);
  if(!el) return;
  if(n>0){ el.textContent = n>99 ? '99+' : String(n); el.style.display = 'inline-block'; el.parentElement.title = `${n} å‰‡è¨Šæ¯æœªæŸ¥çœ‹`; }
  else { el.style.display = 'none'; el.parentElement.title = ''; }
}
async function loadAllBadges(){
  // ä¸‰çµ„ï¼šå¸¶å„è‡ªçš„ lastSeen
  const ship   = await countUnread({ ...GROUPS.ship,   __groupKey:'ship'   });
  const buy    = await countUnread({ ...GROUPS.buy,    __groupKey:'buy'    });
  const appeal = await countUnread({ ...GROUPS.appeal, __groupKey:'appeal' });

  // ã€Œæˆ‘çš„è¨Šæ¯ã€ä¹Ÿç›´æ¥ç¨ç«‹è¨ˆæ•¸ï¼šæ’é™¤ç³»çµ±é¡åˆ¥ï¼Œä¸¦ä½¿ç”¨è‡ªå·±çš„ lastSeen
  const msg    = await countUnread({ ...GROUPS.messages, __groupKey:'messages' });

  setBadge('shipBadge',   ship);
  setBadge('buyBadge',    buy);
  setBadge('appealBadge', appeal);
  setBadge('msgBadge',    msg);
}
loadAllBadges();
setInterval(loadAllBadges, 10000);

/* é»åˆ†çµ„ï¼šåªè¨˜éŒ„æœ€å¾ŒæŸ¥çœ‹æ™‚é–“ â†’ åˆ·æ–°å¾½ç«  â†’ è·³é  */
async function markAndGo(groupKey, url){
  setLastSeen(groupKey);
  await loadAllBadges();
  location.href = url;
}

/* ================== å€‹è³‡å°è©±æ¡†ï¼šæš±ç¨±/é ­è²¼/åˆªå¸³ ================== */
function openEdit(){
  const u = JSON.parse(localStorage.getItem('sg_user')||'null');
  if(u) document.getElementById('editNickname').value = u.nickname || '';
  document.getElementById('editDlg').style.display='flex';
}
function closeEdit(){ document.getElementById('editDlg').style.display='none'; editErr.textContent=''; }
function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result.split(',')[1]);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}
async function refreshMe(){
  const token = localStorage.getItem('sg_token');
  const res = await fetch(`${API}/users/me`, { headers:{ 'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY, 'X-LC-Session':token } });
  const me = await res.json();
  if(res.ok){
    const user = {
      objectId: me.objectId, username: me.username, email: me.email, nickname: me.nickname,
      avatarUrl: me.avatarUrl ? `${me.avatarUrl}${me.avatarUrl.includes('?')?'&':'?'}v=${Date.now()}` : ''
    };
    localStorage.setItem('sg_user', JSON.stringify(user));
    renderProfile(user);
    return true;
  }
  return false;
}
async function updateNickname(){
  const nick = document.getElementById('editNickname').value.trim();
  const token = localStorage.getItem('sg_token');
  const user = JSON.parse(localStorage.getItem('sg_user')||'null');
  if(!nick){ editErr.textContent='æš±ç¨±ä¸å¯ç‚ºç©º'; return; }
  try{
    const res = await fetch(`${API}/users/${user.objectId}`, {
      method:'PUT',
      headers:{ 'Content-Type':'application/json','X-LC-Id': APP_ID,'X-LC-Key': APP_KEY,'X-LC-Session': token },
      body: JSON.stringify({ nickname: nick })
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || 'æ›´æ–°æš±ç¨±å¤±æ•—');
    await refreshMe();
    editErr.textContent='âœ… å·²æ›´æ–°æš±ç¨±';
  }catch(e){ editErr.textContent = e.message; }
}
async function updateAvatar(){
  const file = document.getElementById('editAvatar').files[0];
  if(!file){ editErr.textContent='è«‹å…ˆé¸æ“‡åœ–ç‰‡'; return; }
  const token = localStorage.getItem('sg_token');
  const user = JSON.parse(localStorage.getItem('sg_user')||'null');
  try{
    const base64 = await fileToBase64(file);
    const fileRes = await fetch(`${API}/files/${encodeURIComponent(file.name)}`, {
      method:'POST', headers:{ 'Content-Type':'application/json','X-LC-Id': APP_ID,'X-LC-Key': APP_KEY }, body: JSON.stringify({ base64 })
    });
    const fileData = await fileRes.json();
    if(!fileRes.ok) throw new Error(fileData.error || 'é ­è²¼ä¸Šå‚³å¤±æ•—');

    const putRes = await fetch(`${API}/users/${user.objectId}`, {
      method:'PUT', headers:{ 'Content-Type':'application/json','X-LC-Id': APP_ID,'X-LC-Key': APP_KEY,'X-LC-Session': token },
      body: JSON.stringify({ avatarUrl: fileData.url })
    });
    const putData = await putRes.json();
    if(!putRes.ok) throw new Error(putData.error || 'å¯«å…¥é ­è²¼å¤±æ•—');

    await refreshMe();
    document.getElementById('editAvatar').value = '';
    editErr.textContent='âœ… å·²æ›´æ–°é ­è²¼';
  }catch(e){ editErr.textContent = e.message; }
}
//è¨»éŠ·===========================================
// ï¼ˆé¸é…ï¼‰åˆªå‰è£œ ACLï¼šè®“æœ¬äººå¯å¯«
async function ensureSelfWritable(uid, token){
  const payload = { ACL: { [uid]: { read: true, write: true } } };
  await fetch(`${API}/users/${uid}`, {
    method:'PUT',
    headers:{ 'Content-Type':'application/json','X-LC-Id':APP_ID,'X-LC-Key':APP_KEY,'X-LC-Session':token },
    body: JSON.stringify(payload)
  });
}
// å‚™æ´ï¼šå‘¼å«é›²ç«¯ deleteAccountï¼ˆåªæœ‰å‰ç«¯åˆªå¤±æ•—æ‰æœƒç”¨åˆ°ï¼‰
 // å‚™æ´ï¼šå‘¼å«é›²ç«¯ deleteMyAccountï¼ˆåªæœ‰å‰ç«¯åˆªå¤±æ•—æ‰æœƒç”¨åˆ°ï¼‰
async function callCloudDeleteAccount() {   // â† åç¨±çµ±ä¸€
  const token = localStorage.getItem('sg_token') || '';
  if (!token) throw new Error('æœªç™»å…¥');

  const res = await fetch(`${API}/functions/deleteMyAccount`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-LC-Id': APP_ID,
      'X-LC-Key': APP_KEY,
      'X-LC-Session': token
    },
    body: JSON.stringify({ hard: true })
  });
  const data = await res.json();
  if (!res.ok) throw new Error((data.error && (data.error.message || data.error)) || 'é›²å‡½æ•¸åˆªé™¤å¤±æ•—');
  return data.result;
}

/* ========== ğŸ”§å¯èª¿æ•´å€ï¼šè³‡æ–™è¡¨èˆ‡ç‹€æ…‹å°æ‡‰ ========== */
/** å¦‚æœä½ çš„è¡¨åæˆ–æ¬„ä½ä¸åŒï¼Œæ”¹é€™è£¡å°±å¥½ **/
const TBL = {
  Product: 'Product',
  Ad: 'Ad', 
  Favorite: 'Favorite',
  Message: 'Message',
  Order: 'Order',    // è‹¥ä½ æ²’æœ‰ Order è¡¨ï¼Œå°‡å…¶è¨­æˆ null å³å¯
  Appeal: 'Report'   // è‹¥ä½ æ²’æœ‰ Appeal è¡¨ï¼Œå°‡å…¶è¨­æˆ null å³å¯
};
// ä¸»è¦é—œè¯æ¬„ä½åç¨±
const FIELDS = {
  // Product
  productSeller: 'seller',

  // Favorite
  favUser: 'user',

  // Messageï¼ˆè¨Šæ¯ï¼‰
  msgFrom: 'from',     // è‹¥ä½ çš„è¨Šæ¯åªæœ‰ to/kindï¼Œä¹Ÿæƒ³åˆªï¼Œå°±æ”¹æŸ¥ where: { to: Pointer(user) } å…©é‚Šéƒ½åˆª
  msgTo: 'to',

  // Orderï¼ˆè¨‚å–®ï¼‰
  orderBuyer: 'buyer',
  orderSeller: 'seller',
  orderStatus: 'status',

  // Appealï¼ˆç”³è¨´ï¼‰
  appealBy: 'by',          // æˆ–è€… 'user' / 'plaintiff'ï¼Œçœ‹ä½ çš„ schema
  appealAgainst: 'against',// æˆ–è€… 'target' / 'defendant'
  appealStatus: 'status'
};

// å“ªäº›ç‹€æ…‹è¦–ç‚ºã€Œæœªè™•ç†ï¼Œç¦æ­¢è¨»éŠ·ã€
const PENDING_ORDER_STATUSES  = ['paid','processing','shipped'];   // ä½ å¯¦éš›ç”¨çš„ç‹€æ…‹å­—ä¸²
const PENDING_APPEAL_STATUSES = ['open','pending','processing'];

/* ========== å·¥å…·ï¼šæŒ‡æ¨™/æŸ¥è©¢/åˆªé™¤ ========== */
const ptrUser = (id) => ({ "__type":"Pointer","className":"_User","objectId": id });

async function queryAll(className, where, token){
  if(!className) return []; // â† æ²’æœ‰é€™è¡¨å°±ç›´æ¥å›ç©º
  const url = `${API}/classes/${className}?where=${encodeURIComponent(JSON.stringify(where))}&limit=1000`;
  const r = await fetch(url, { headers:{ 'X-LC-Id':APP_ID,'X-LC-Key':APP_KEY,'X-LC-Session':token }});
  if (r.status === 404) return [];         // â† é€™ä¸€è¡Œ
  const d = await r.json();
  if(!r.ok) throw new Error(d.error || `æŸ¥è©¢ ${className} å¤±æ•—`);
  return d.results || [];
}

async function countWhere(className, where, token){
  if(!className) return 0; // â† æ²’æœ‰é€™è¡¨å°± 0
  const url = `${API}/classes/${className}?where=${encodeURIComponent(JSON.stringify(where))}&limit=0&count=1`;
  const r = await fetch(url, { headers:{ 'X-LC-Id':APP_ID,'X-LC-Key':APP_KEY,'X-LC-Session':token }});
  if (r.status === 404) return 0;          // â† é€™ä¸€è¡Œ
  const d = await r.json();
  if(!r.ok) throw new Error(d.error || `çµ±è¨ˆ ${className} å¤±æ•—`);
  return Number(d.count||0);
}

async function deleteMany(className, ids, token){
  for(const id of ids){
    const r = await fetch(`${API}/classes/${className}/${id}`, {
      method:'DELETE',
      headers:{ 'X-LC-Id':APP_ID,'X-LC-Key':APP_KEY,'X-LC-Session':token }
    });
    if(!r.ok){
      const d = await r.json().catch(()=>({}));
      throw new Error(d.error || `åˆªé™¤ ${className}/${id} å¤±æ•—`);
    }
  }
}

/* ========== æª¢æŸ¥æ˜¯å¦æœ‰æœªè™•ç†é …ç›®ï¼ˆæœ‰å°±ç¦æ­¢è¨»éŠ·ï¼‰ ========== */
async function hasPendingStuff(userId, token){
  let pendingOrders = 0, pendingAppeals = 0;

  // è¨‚å–®ï¼ˆè²·å®¶æˆ–è³£å®¶ï¼Œåªè¦æœ‰å¾…è™•ç†ç‹€æ…‹å°±æ“‹ï¼‰
  if(TBL.Order){
    const wBuyer = {
      [FIELDS.orderBuyer]: ptrUser(userId),
      [FIELDS.orderStatus]: { "$in": PENDING_ORDER_STATUSES }
    };
    const wSeller = {
      [FIELDS.orderSeller]: ptrUser(userId),
      [FIELDS.orderStatus]: { "$in": PENDING_ORDER_STATUSES }
    };
    const [c1, c2] = await Promise.all([
      countWhere(TBL.Order, wBuyer, token),
      countWhere(TBL.Order, wSeller, token)
    ]);
    pendingOrders = c1 + c2;
  }

  // ç”³è¨´ï¼ˆæè¨´äººæˆ–è¢«ç”³è¨´äººåªè¦æœ‰æœªè™•ç†å°±æ“‹ï¼‰
  if(TBL.Appeal){
    const wA = {
      "$or": [
        { [FIELDS.appealBy]: ptrUser(userId) },
        { [FIELDS.appealAgainst]: ptrUser(userId) }
      ],
      [FIELDS.appealStatus]: { "$in": PENDING_APPEAL_STATUSES }
    };
    pendingAppeals = await countWhere(TBL.Appeal, wA, token);
  }

  return { pendingOrders, pendingAppeals };
}

/* ========== é€£é–åˆªé™¤ï¼šå…ˆåˆªé—œè¯è³‡æ–™ â†’ æœ€å¾Œåˆª _User ========== */
async function cascadeDeleteAll(user, token){
  const uid = user.objectId;

  // ====== 1) Productï¼šå¿…åˆªï¼ˆä»»ä½•ä¸€ç­†å¤±æ•—å°±æ‹‹éŒ¯ï¼Œä¸­æ­¢æ•´é«”æµç¨‹ï¼‰ ======
  if(TBL.Product){
    const prods = await queryAll(TBL.Product, { [FIELDS.productSeller]: ptrUser(uid) }, token);
    for(const p of prods){
      const r = await fetch(`${API}/classes/${TBL.Product}/${p.objectId}`, {
        method:'DELETE',
        headers:{ 'X-LC-Id':APP_ID,'X-LC-Key':APP_KEY,'X-LC-Session':token }
      });
      if(!r.ok){
        const d = await r.json().catch(()=>({}));
        throw new Error(d.error || `å•†å“åˆªé™¤å¤±æ•—ï¼ˆ${p.objectId}ï¼‰`);
      }
    }
  }

  // ====== 1.5) Adï¼šå¿…åˆªï¼ˆå’Œ Product ä¸€æ¨£è™•ç†ï¼‰ ======
  if(TBL.Ad){
    const ads = await queryAll(TBL.Ad, { seller: ptrUser(uid) }, token); // ğŸ‘ˆ å‡è¨­æ¬„ä½ä¹Ÿæ˜¯ seller
    for(const ad of ads){
      const r = await fetch(`${API}/classes/${TBL.Ad}/${ad.objectId}`, {
        method:'DELETE',
        headers:{ 'X-LC-Id':APP_ID,'X-LC-Key':APP_KEY,'X-LC-Session':token }
      });
      if(!r.ok){
        const d = await r.json().catch(()=>({}));
        throw new Error(d.error || `å»£å‘Šåˆªé™¤å¤±æ•—ï¼ˆ${ad.objectId}ï¼‰`);
      }
    }
  }
  // ====== 2) å…¶å®ƒé¡åˆ¥ï¼šç›¡åŠ›åˆªï¼ˆéŒ¯èª¤åªè¨˜éŒ„ï¼Œä¸æ“‹æµç¨‹ï¼‰ ======
  const softDelete = async (cls, ids)=>{
    for(const id of ids){
      try{
        const rr = await fetch(`${API}/classes/${cls}/${id}`, {
          method:'DELETE',
          headers:{ 'X-LC-Id':APP_ID,'X-LC-Key':APP_KEY,'X-LC-Session':token }
        });
        if(!rr.ok) await rr.json(); // è§¸ç™¼ catch
      }catch(e){ console.warn(`[softDelete] ${cls}/${id} å¤±æ•—ï¼š`, e?.message||e); }
    }
  };

  // Favoriteï¼ˆè‡ªå·±å»ºç«‹çš„æ”¶è—ï¼‰
  if(TBL.Favorite){
    const favs = await queryAll(TBL.Favorite, { [FIELDS.favUser]: ptrUser(uid) }, token);
    await softDelete(TBL.Favorite, favs.map(x=>x.objectId));
  }

  // Messageï¼ˆè‡ªå·±æ”¶/ç™¼çš„è¨Šæ¯ï¼‰
  if(TBL.Message){
    const msgsFrom = await queryAll(TBL.Message, { [FIELDS.msgFrom]: ptrUser(uid) }, token);
    const msgsTo   = await queryAll(TBL.Message, { [FIELDS.msgTo]:   ptrUser(uid) }, token);
    const msgIds = [...new Set([...msgsFrom, ...msgsTo].map(x=>x.objectId))];
    await softDelete(TBL.Message, msgIds);
  }

  // Orderï¼ˆæ­·å²å–®å…¨ç§»é™¤ï¼›å¾…è™•ç†æœƒåœ¨å‰ç½® hasPendingStuff æ“‹ä½ï¼‰
  if(TBL.Order){
    const ordersA = await queryAll(TBL.Order, { [FIELDS.orderBuyer]: ptrUser(uid) }, token);
    const ordersB = await queryAll(TBL.Order, { [FIELDS.orderSeller]: ptrUser(uid) }, token);
    const orderIds = [...new Set([...ordersA, ...ordersB].map(x=>x.objectId))];
    await softDelete(TBL.Order, orderIds);
  }

  // Appealï¼ˆæ­·å²ç”³è¨´ï¼‰
  if(TBL.Appeal){
    const appeals = await queryAll(TBL.Appeal, {
      "$or":[ { [FIELDS.appealBy]: ptrUser(uid) }, { [FIELDS.appealAgainst]: ptrUser(uid) } ]
    }, token);
    await softDelete(TBL.Appeal, appeals.map(x=>x.objectId));
  }
}

/* ========== å–ä»£åŸæœ¬çš„ deleteAccount() ========== */
async function deleteAccount(){
  if(!confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤å¸³è™Ÿå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;

  const token = localStorage.getItem('sg_token') || '';
  const me = JSON.parse(localStorage.getItem('sg_user')||'null');
  if(!token || !me){ alert('å°šæœªç™»å…¥'); return; }

  try{
    // A. æœ‰ç„¡å¾…è™•ç†è¨‚å–® / ç”³è¨´ï¼ˆæœ‰å‰‡æ“‹ï¼‰
    const { pendingOrders, pendingAppeals } = await hasPendingStuff(me.objectId, token);
    if(pendingOrders > 0 || pendingAppeals > 0){
      alert(`ç„¡æ³•åˆªé™¤ï¼šå°šæœ‰æœªè™•ç†${[
        pendingOrders?`è¨‚å–® ${pendingOrders} ç­†`:'',
        pendingAppeals?`ç”³è¨´ ${pendingAppeals} ç­†`:''
      ].filter(Boolean).join('ã€')}ã€‚`);
      return;
    }

    // B. å…ˆåšé€£é–åˆªï¼ˆå•†å“ç‚ºå¿…åˆªï¼Œå¤±æ•—æœƒ throwï¼‰
    await cascadeDeleteAll(me, token);

    // C. å˜—è©¦çœŸæ­£åˆª _Userï¼ˆSDKï¼‰
    try{
      await deleteSelfViaSDK();   // ä½ ç¾æœ‰çš„å‡½å¼
    }catch(e){
      console.warn('åˆª _User å¤±æ•—ï¼Œé€²å…¥åŒ¿ååŒ–æµç¨‹ï¼š', e?.message||e);
      // D. åˆªä¸æ‰å°±åŒ¿ååŒ–åœç”¨ï¼ˆé‡‹æ”¾ username / email ä»¥åˆ©é‡è¨»å†Šï¼‰
      await anonymizeSelf();
    }

    // E. çµå°¾ï¼šæ¸…ç™»å…¥ & å°å›
    localStorage.removeItem('sg_token');
    localStorage.removeItem('sg_user');
    alert('å¸³è™Ÿèˆ‡è³‡æ–™å·²åˆªé™¤ï¼ˆæˆ–å·²åŒ¿ååŒ–åœç”¨ï¼‰');
    location.href = 'shopping.html';

  }catch(err){
    alert('åˆªé™¤å¤±æ•—ï¼š' + (err?.message || err));
  }
}

/* ================== ç™¼ä½ˆå•†å“ ================== */
function openPublish(){ specList.innerHTML=''; addSpec(); document.getElementById('publishDlg').style.display='flex'; }
function closePublish(){ document.getElementById('publishDlg').style.display='none'; pbErr.textContent=''; }
function addSpec(){
  const row = document.createElement('div');
  row.className = 'spec-row';
  row.innerHTML = `
    <input class="input sp-name"  type="text"   placeholder="è¦æ ¼åç¨±ï¼ˆä¾‹ï¼šM / ç´…è‰²ï¼‰" data-k="name">
    <input class="input sp-price" type="number" min="0" step="1" placeholder="åƒ¹æ ¼" data-k="price">
    <input class="file  sp-pay"   type="file"   accept="image/*" data-k="pay">
    <button class="btn sp-del" onclick="this.parentElement.remove()">åˆªé™¤</button>`;
  specList.appendChild(row); applyPriceMode();
}
function togglePriceMode(){ applyPriceMode(); }
function applyPriceMode(){
  const same = document.getElementById('samePrice').checked;
  document.getElementById('samePriceRow').style.display = same ? 'flex' : 'none';
  document.querySelectorAll('#specList .spec-row').forEach(row=>{
    row.style.display = 'grid';
    row.style.gridTemplateColumns = same ? '1.2fr 0fr 0fr auto' : '1.2fr .8fr 1fr auto';
    row.querySelectorAll('.sp-price, .sp-pay').forEach(el=>{ el.style.display = same ? 'none' : 'block'; });
  });
}
async function uploadOne(file){
  const base64 = await fileToBase64(file);
  const r = await fetch(`${API}/files/${encodeURIComponent(file.name)}`,{
    method:'POST', headers:{'Content-Type':'application/json','X-LC-Id':APP_ID,'X-LC-Key':APP_KEY}, body: JSON.stringify({ base64 })
  });
  const data = await r.json(); if(!r.ok) throw new Error(data.error || 'æª”æ¡ˆä¸Šå‚³å¤±æ•—'); return data.url;
}
async function uploadMany(fileList, limit=5){
  const files = Array.from(fileList||[]).slice(0, limit); const urls=[];
  for(const f of files){ urls.push(await uploadOne(f)); } return urls;
}
function toLCFile(url, name){ return { "__type":"File", "url":url, "name": name || ("pay_"+Date.now()) }; }
async function createProduct(){
  const err = v => pbErr.textContent = v || ''; err('');
  const token = localStorage.getItem('sg_token');
  const me = JSON.parse(localStorage.getItem('sg_user')||'null');
  const title = pbTitle.value.trim(), summary = pbSummary.value.trim(), detail = pbDetail.value.trim();
  if(!title){ err('è«‹è¼¸å…¥å•†å“æ¨™é¡Œ'); return; }

  try{
    const coverFile  = document.getElementById('pbCover').files[0];
    const imgsFile   = document.getElementById('pbImages').files;
    const detailFile = document.getElementById('pbDetailImages').files;
    const coverUrl   = coverFile ? await uploadOne(coverFile) : '';
    const imagesUrl  = await uploadMany(imgsFile, 5);
    const detailUrls = await uploadMany(detailFile, 12);

    const same = document.getElementById('samePrice').checked;
    let price=null, commonPayUrl='', commonPayFile=undefined;
    if(same){
      const p = document.getElementById('pbPrice').value;
      if(p===''){ err('è«‹è¼¸å…¥å•†å“åƒ¹æ ¼'); return; }
      price = Number(p);
      const payFile = document.getElementById('pbPayCode').files[0];
      if(payFile){ const payUrl = await uploadOne(payFile); commonPayUrl = payUrl; commonPayFile = toLCFile(payUrl, payFile.name); }
    }

    const variants = [];
    for(const row of document.querySelectorAll('#specList .spec-row')){
      const name = row.querySelector('[data-k="name"]').value.trim();
      if(!name) continue;
      if(!same){
        const p = row.querySelector('[data-k="price"]').value; if(p===''){ err('è¦æ ¼åƒ¹æ ¼æœªå¡«'); return; }
        const v = { name, price: Number(p) };
        const payF = row.querySelector('[data-k="pay"]').files[0];
        if(payF){ const payUrl = await uploadOne(payF); v.payCodeUrl = payUrl; v.payCode = toLCFile(payUrl, payF.name); }
        variants.push(v);
      }else{ variants.push({ name }); }
    }
    if(variants.length===0){ err('è«‹è‡³å°‘æ–°å¢ä¸€å€‹è¦æ ¼'); return; }

// â† åœ¨é€™è£¡åŠ  â–¼â–¼
const pos = (document.querySelector('input[name="pbImgPos"]:checked') || {}).value || 'top';

// æ¥è‘—æ‰å»ºç«‹ payload
const payload = {
  title, summary, description: detail,
  samePrice: same, price: same?price:undefined,
  commonPayUrl: same?commonPayUrl:undefined, commonPayCode: same?commonPayFile:undefined,
  imageUrl: coverUrl || imagesUrl[0] || '',
  images: imagesUrl,
  detailImages: detailUrls,

  // æ–°å¢çš„å…©å€‹æ¬„ä½
  detailImagePos: pos,              // 'top' | 'middle' | 'bottom'

  variants,
  seller: { "__type":"Pointer", "className":"_User", "objectId": me.objectId },
  status: "published", currency: "CNÂ¥",
  ACL: { "*": { "read": true }, [me.objectId]: { "read": true, "write": true } }
};

    const res = await fetch(`${API}/classes/Product`,{
      method:'POST', headers:{ 'Content-Type':'application/json','X-LC-Id': APP_ID,'X-LC-Key': APP_KEY,'X-LC-Session': token }, body: JSON.stringify(payload)
    });
    const data = await res.json(); if(!res.ok) throw new Error(data.error || 'ç™¼ä½ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    closePublish(); await loadMyProducts(); alert('ğŸ‰ å•†å“å·²ç™¼ä½ˆæˆåŠŸï¼');
  }catch(e){ console.error(e); err(e.message || 'ç™¼ä½ˆå¤±æ•—'); }
}
// åˆ‡æ›ã€Œç½®ä¸­ã€æ™‚é¡¯ç¤º/éš±è—è¡Œè™Ÿè¼¸å…¥
document.addEventListener('change', (e)=>{
  if(e.target && e.target.name === 'pbImgPos'){
    const v = e.target.value;
    document.getElementById('pbMiddleBox').style.display = (v === 'middle') ? 'inline-flex' : 'none';
  }
});
/* ================== å•†å“æ¸…å–® ================== */
function renderMyProducts(list){
  const box = document.getElementById('myProducts');
  if(!list || !list.length){ box.innerHTML = `<div class="muted" style="padding:6px 2px">å°šæœªç™¼ä½ˆå•†å“</div>`; return; }
  box.innerHTML = '';
  list.forEach(p=>{
    const card = document.createElement('div'); card.className = 'pcard';
    const img = p.imageUrl || (p.images && p.images[0]) || 'https://via.placeholder.com/320x240?text=%F0%9F%8C%9E';
    const link = `shuser.html?id=${p.objectId}`;
    const price = (p.samePrice && typeof p.price==='number') ? p.price : (Array.isArray(p.variants)&&p.variants[0] ? p.variants[0].price : 0);
    card.innerHTML = `
      <a href="${link}" style="text-decoration:none;color:inherit">
        <img class="pthumb" src="${img}" alt="">
        <div class="pbody">
          <div class="ptitle" title="${p.title || ''}">${p.title || 'æœªå‘½åå•†å“'}</div>
          <div class="pprice">${CURRENCY_SIGN}${money(Number(price) || 0)}</div>
        </div>
      </a>
      <div class="pactions">
        <button class="pdel" onclick="deleteProduct('${p.objectId}')">åˆªé™¤</button>
      </div>`;
    box.appendChild(card);
  });
}
async function loadMyProducts(){
  const token = localStorage.getItem('sg_token');
  const me = JSON.parse(localStorage.getItem('sg_user')||'null');
  if(!me) return;
  const where = encodeURIComponent(JSON.stringify({ seller: { "__type":"Pointer", "className":"_User", "objectId": me.objectId } }));
  const res = await fetch(`${API}/classes/Product?where=${where}&order=-createdAt`, {
    headers:{ 'X-LC-Id': APP_ID, 'X-LC-Key': APP_KEY, 'X-LC-Session': token }
  });
  const data = await res.json();
  if(res.ok) renderMyProducts(data.results || []);
  else console.warn('loadMyProducts error', data);
}
async function deleteProduct(objectId){
  if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å•†å“å—ï¼Ÿ')) return;
  const token = localStorage.getItem('sg_token');
  try{
    const res = await fetch(`${API}/classes/Product/${objectId}`, {
      method:'DELETE', headers:{ 'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY, 'X-LC-Session': token }
    });
    if(!res.ok){ const err = await res.json().catch(()=>({})); throw new Error(err.error || 'åˆªé™¤å¤±æ•—ï¼ˆè«‹æª¢æŸ¥ CLP/ACLï¼‰'); }
    await loadMyProducts();
  }catch(e){ alert(e.message); }
}
loadMyProducts();
setInterval(loadMyProducts, 6000);

/* ================== å•Ÿå‹• ================== */
fetchMe().then(u => { if(u) renderProfile(u); });
</script>
<script>
  function openFavorites(){
  document.getElementById('favoritesDlg').style.display = 'flex';
  loadFavorites();
}
function closeFavorites(){
  document.getElementById('favoritesDlg').style.display = 'none';
}
//===============================

async function deleteSelfViaSDK(){
  const token = localStorage.getItem('sg_token');
  if(!token) throw new Error('æœªç™»å…¥æˆ–ç¼ºå°‘ Session');

  try{
    await AV.User.become(token);   // ç”¨ç¾æœ‰ Session è®Šæˆç•¶å‰ç”¨æˆ¶ï¼ˆä½ ä¸æ˜¯ç”¨ SDK ç™»å…¥ï¼‰
    const me = AV.User.current();
    if(!me) throw new Error('ç„¡æ³•å–å¾—ç•¶å‰ç”¨æˆ¶ï¼ˆbecome å¤±æ•—ï¼‰');
    await me.destroy();            // ç”± SDK åˆªé™¤è‡ªå·±
  }catch(err){
    // å¸¸è¦‹ï¼š_User CLP æœªé–‹ã€Œåˆªé™¤ï¼šå·²ç™»å…¥ç”¨æˆ¶ã€ã€æˆ–è©² User çš„ ACL æ²’çµ¦è‡ªå·± delete
    throw new Error('åˆªé™¤ç”¨æˆ¶å¤±æ•—ï¼š' + (err && err.message ? err.message : err));
  }
}
// æ¨¡æ“¬æ”¶è—æ¸…å–®ï¼ˆæ­£å¼å¯å¾å¾Œç«¯è®€å–æˆ– localStorageï¼‰
async function loadFavorites(){
  const box = document.getElementById('favProducts');
  box.innerHTML = '<div class="muted">è¼‰å…¥ä¸­â€¦</div>';

  const token = localStorage.getItem('sg_token');
  const me = JSON.parse(localStorage.getItem('sg_user')||'null');
  if(!me){ box.innerHTML='<div class="muted">è«‹å…ˆç™»å…¥</div>'; return; }

  // è®€ Favoriteï¼Œå¤¾å¸¶ product
  const where = encodeURIComponent(JSON.stringify({
    user: { "__type":"Pointer", "className":"_User", "objectId": me.objectId }
  }));
  const url = `${API}/classes/Favorite?where=${where}&include=product&order=-createdAt`;
  const res = await fetch(url, {
    headers:{ 'X-LC-Id':APP_ID, 'X-LC-Key':APP_KEY, 'X-LC-Session':token }
  });
  const data = await res.json();

  if(!res.ok){ box.innerHTML=`<div class="muted">${data.error||'è®€å–å¤±æ•—'}</div>`; return; }
  const list = data.results||[];
  if(!list.length){ box.innerHTML='<div class="muted">æš«ç„¡æ”¶è—å•†å“</div>'; return; }

  box.innerHTML = '';
  list.forEach(f=>{
    const p = f.product; if(!p) return;
    const img   = p.imageUrl || (p.images && p.images[0]) || 'https://via.placeholder.com/320x240?text=%F0%9F%8C%9E';
    const link  = `shuser.html?id=${p.objectId}`;
    const price = (p.samePrice && typeof p.price==='number')
      ? p.price
      : ((Array.isArray(p.variants)&&p.variants[0]) ? Number(p.variants[0].price||0) : 0);
    const ioAmt = price / IO_TO_CNY;

    const card = document.createElement('div');
    card.className = 'pcard';
    card.innerHTML = `
      <a href="${link}" style="text-decoration:none;color:inherit;display:block">
        <img class="pthumb" src="${img}" alt="">
        <div class="pbody">
          <div class="ptitle" title="${p.title||''}">${p.title||'æœªå‘½åå•†å“'}</div>
          <div class="pprice">io$: ${fmtIo(ioAmt)} &nbsp;&nbsp;ï½œ&nbsp;&nbsp; ${CURRENCY_SIGN}${money(price)}</div>
          <div class="muted" style="margin-top:4px;font-size:12px">æ”¶è—æ–¼ ${fmtDate(f.createdAt)}</div>
        </div>
      </a>`;
    box.appendChild(card);
  });
}
async function anonymizeSelf(){
  const token = localStorage.getItem('sg_token') || '';
  if(!token) throw new Error('æœªç™»å…¥');
  // å–å¾—è‡ªå·±çš„ id
  await AV.User.become(token);
  const me = AV.User.current();
  if(!me) throw new Error('æ‰¾ä¸åˆ°ç•¶å‰ç”¨æˆ¶');

  const payload = {
    username: `deleted_${me.id}_${Date.now()}`,
    email: '',
    mobilePhoneNumber: '',
    nickname: '(deleted)',
    avatarUrl: '',
    authData: null,
    disabled: true
  };
  const r = await fetch(`${API}/users/${me.id}`, {
    method: 'PUT',
    headers: {
      'Content-Type':'application/json',
      'X-LC-Id': APP_ID,
      'X-LC-Key': APP_KEY,
      'X-LC-Session': token
    },
    body: JSON.stringify(payload)
  });
  if(!r.ok){
    const d = await r.json().catch(()=>({}));
    throw new Error(d.error || 'åŒ¿ååŒ–å¤±æ•—');
  }
}
</script>
<script src="im.js?v=0.0.1"></script>
<!--=================-->
<p style="text-align: center; font-size: 13px; color: #999; margin-top: 40px;">
  ğŸ¾ Â© 2024 yinnlimçš„å°å®‡å®™ï½œå…§å®¹èˆ‡è¨­è¨ˆçš†ç”±ç³–ç³–æœ¬äººç”¨æ„›è£½ä½œ ğŸ’<br>
  æœªç¶“æˆæ¬Šè«‹å‹¿éš¨æ„ä½¿ç”¨ã€ç›œè½‰å–” ğŸ™…â€â™€ï¸ è¬è¬ä½ çš„å°Šé‡èˆ‡æº«æŸ” ğŸ’Œ
</p>
</body>
</html>